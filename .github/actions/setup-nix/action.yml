name: setup-nix
description: setup nix using nothing-but-nix pattern with space reclamation and github actions cache

inputs:
  system:
    description: nix system to configure (e.g., x86_64-linux, aarch64-darwin)
    type: string
    required: true
  sandbox:
    description: enable nix sandbox builds
    type: string
    default: "true"
  cache-key:
    description: primary cache key (auto-generated from nix files if not provided)
    type: string
    required: false
    default: ""
  gc-max-store-size-linux:
    description: max nix store size on linux before garbage collection (e.g., 1G, 2G)
    type: string
    default: "1G"
  gc-max-store-size-macos:
    description: max nix store size on macos before garbage collection (e.g., 2G, 3G)
    type: string
    default: "2G"

outputs:
  cache-hit:
    description: whether the primary cache key was hit
    value: ${{ steps.cache.outputs.hit-primary-key }}
  cache-key:
    description: the cache key that was used
    value: ${{ steps.cache.outputs.primary-key }}

runs:
  using: composite
  steps:
    - name: reclaim space (linux)
      if: runner.os == 'Linux'
      uses: wimpysworld/nothing-but-nix@main
      with:
        hatchet-protocol: carve
        nix-permission-edict: true

    - name: reclaim space (darwin)
      if: runner.os == 'macOS'
      shell: bash
      run: |
        echo "::group::disk space (before)"
        sudo df -h
        echo "::endgroup::"

        echo "::group::disable mds"
        sudo mdutil -i off -a || echo "mdutil failed"
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist \
         || echo "launchctl unload failed"
        echo "::endgroup::"

        echo "Background space expansion started. /nix will grow as space becomes available."
        sudo rm -rf \
          /Applications/Xcode_* \
          /Library/Developer/CoreSimulator \
          /Library/Frameworks \
          /Users/runner/.dotnet \
          /Users/runner/.rustup \
          /Users/runner/Library/Android \
          /Users/runner/Library/Caches \
          /Users/runner/Library/Developer/CoreSimulator \
          /Users/runner/hostedtoolcache &

    - name: install nix
      uses: nixbuild/nix-quick-install-action@v34
      with:
        nix_conf: |
          sandbox = ${{ inputs.sandbox }}
          system = ${{ inputs.system }}
          keep-env-derivations = true
          keep-outputs = true

    - name: setup cache
      id: cache
      uses: nix-community/cache-nix-action@v6
      with:
        primary-key: ${{ inputs.cache-key != '' && inputs.cache-key || format('nix-{0}-{1}', runner.os, hashFiles('**/*.nix', '**/flake.lock')) }}
        restore-prefixes-first-match: ${{ format('nix-{0}-', runner.os) }}
        gc-max-store-size-linux: ${{ inputs.gc-max-store-size-linux }}
        gc-max-store-size-macos: ${{ inputs.gc-max-store-size-macos }}
        purge: true
        purge-prefixes: ${{ format('nix-{0}-', runner.os) }}
        purge-created: 0
        purge-last-accessed: 0
        purge-primary-key: never

    - name: post setup-nix
      if: runner.os == 'macOS'
      uses: srz-zumix/post-run-action@v2
      with:
        shell: bash -e {0}
        post-run: |
          echo "::group::disk space (after)"
          sudo df -h
          echo "::endgroup::"
