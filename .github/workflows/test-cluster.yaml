name: Test Cluster
on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: "Run the workflow with tmate.io debugging enabled"
        required: false
        type: boolean
        default: false
      force_run:
        description: "Force execution even if already successful"
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      debug_enabled:
        description: "Enable tmate debugging"
        required: false
        type: string
        default: "false"
      force_run:
        description: "Force execution even if already successful"
        required: false
        type: string
        default: "false"

concurrency:
  group: test-cluster-${{ github.event.pull_request.number || github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

permissions:
  contents: read

env:
  CACHIX_BINARY_CACHE: cameronraysmith

jobs:
  integration:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check execution cache
        id: cache
        uses: ./.github/actions/cached-ci-job
        with:
          check-name: test-cluster
          hash-sources: 'kubernetes/**/* justfile flake.nix flake.lock secrets/** scripts/k3d-test-coverage.sh .github/workflows/test-cluster.yaml .github/actions/setup-nix/action.yml'
          force-run: ${{ inputs.force_run }}

      - name: Setup Nix
        if: steps.cache.outputs.should-run == 'true'
        uses: ./.github/actions/setup-nix
        with:
          installer: full
          hatchet: holster
          system: x86_64-linux

      - name: Verify Docker available
        if: steps.cache.outputs.should-run == 'true'
        run: |
          docker version
          docker info

      - name: Run k3d integration tests
        if: steps.cache.outputs.should-run == 'true'
        run: nix develop .#kubernetes --accept-flake-config -c just k3d-integration-ci

      - name: Create job result marker
        if: success() && steps.cache.outputs.should-run == 'true'
        run: |
          mkdir -p "${{ steps.cache.outputs.cache-path }}"
          cat > "${{ steps.cache.outputs.cache-path }}/marker" <<EOF
          {
            "success": true,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "cache_key": "${{ steps.cache.outputs.cache-key }}",
            "workflow_run_id": "${{ github.run_id }}"
          }
          EOF

      - name: Save job result to cache
        if: success() && steps.cache.outputs.should-run == 'true' && steps.cache.outputs.cache-source == 'none'
        uses: actions/cache/save@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5
        with:
          path: ${{ steps.cache.outputs.cache-path }}
          key: ${{ steps.cache.outputs.cache-key }}

      - name: Collect failure diagnostics
        if: failure()
        run: |
          nix develop .#kubernetes --accept-flake-config -c bash -c '
            echo "=== k3d cluster status ==="
            k3d cluster list || true

            echo ""
            echo "=== Docker containers ==="
            docker ps -a || true

            echo ""
            echo "=== sops-age-key secret (structure only) ==="
            kubectl get secret sops-age-key -n sops-secrets-operator -o jsonpath="{.data}" 2>/dev/null | jq -r "keys" || echo "sops-age-key secret not found"

            echo ""
            echo "=== SopsSecret CRs ==="
            kubectl get sopssecrets -A 2>/dev/null || echo "No SopsSecrets found"

            echo ""
            echo "=== step-ca secrets ==="
            kubectl get secrets -n step-ca 2>/dev/null || echo "step-ca namespace not found"

            echo ""
            echo "=== sops-secrets-operator logs ==="
            kubectl logs -n sops-secrets-operator -l app.kubernetes.io/name=sops-secrets-operator --tail=50 2>/dev/null || echo "sops-secrets-operator logs not available"

            echo ""
            echo "=== sops-secrets-operator pod status ==="
            kubectl get pods -n sops-secrets-operator -o wide 2>/dev/null || echo "sops-secrets-operator namespace not found"

            echo ""
            echo "=== k3d server logs (last 50 lines) ==="
            docker logs k3d-dev-server-0 --tail 50 2>&1 || true

            echo ""
            echo "=== ArgoCD Applications ==="
            kubectl get applications -n argocd -o yaml 2>/dev/null || echo "ArgoCD not deployed"

            echo ""
            echo "=== Non-running pods ==="
            kubectl get pods -A --field-selector=status.phase!=Running 2>/dev/null || echo "kubectl not available"

            echo ""
            echo "=== Pod events (warnings/errors) ==="
            kubectl get events -A --field-selector=type!=Normal --sort-by=.lastTimestamp 2>/dev/null | tail -50 || true
          '

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: chainsaw-reports
          path: |
            /tmp/chainsaw-*/
          if-no-files-found: ignore
          retention-days: 7
