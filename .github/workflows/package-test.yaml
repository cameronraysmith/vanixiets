name: Package Test

on:
  workflow_dispatch:
    inputs:
      package-name:
        description: "Name of the package to test"
        required: true
        type: string
      package-path:
        description: "Path to the package directory"
        required: true
        type: string
      debug-enabled:
        description: "Run with tmate.io debugging enabled"
        required: false
        type: boolean
        default: false
      nix-installer:
        description: "Nix installer strategy (quick or full)"
        required: false
        type: string
        default: "quick"

  workflow_call:
    inputs:
      package-name:
        description: "Name of the package to test"
        required: true
        type: string
      package-path:
        description: "Path to the package directory"
        required: true
        type: string
      debug-enabled:
        description: "Run with tmate.io debugging enabled"
        required: false
        type: string
        default: "false"
      nix-installer:
        description: "Nix installer strategy (quick or full)"
        required: false
        type: string
        default: "quick"
    secrets:
      SOPS_AGE_KEY:
        required: true

defaults:
  run:
    shell: bash

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    steps:
      - name: checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check execution cache
        id: cache
        uses: ./.github/actions/cached-ci-job
        with:
          check-name: ${{ inputs.package-name }}-test-{hash}
          path-filters: 'packages/${{ inputs.package-name }}/**/*|bun\.lock$|\.github/workflows/package-test\.yaml$'
          force-run: ${{ inputs.debug-enabled == 'true' && 'true' || 'false' }}

      - name: setup nix
        if: steps.cache.outputs.should-run == 'true'
        uses: ./.github/actions/setup-nix
        with:
          installer: ${{ inputs.nix-installer }}
          system: x86_64-linux

      - name: install dependencies
        if: steps.cache.outputs.should-run == 'true'
        run: nix develop --command bun install

      - name: run unit tests with coverage
        if: steps.cache.outputs.should-run == 'true'
        run: nix develop --command just ${{ inputs.package-name }}-test-coverage

      - name: build for e2e tests
        if: steps.cache.outputs.should-run == 'true'
        run: nix develop --command just ${{ inputs.package-name }}-build

      - name: run e2e tests
        if: steps.cache.outputs.should-run == 'true'
        run: nix develop --command just ${{ inputs.package-name }}-test-e2e

      - name: upload test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        with:
          name: ${{ inputs.package-name }}-playwright-report
          path: packages/${{ inputs.package-name }}/playwright-report/
          retention-days: 7

      - name: upload coverage
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        with:
          name: ${{ inputs.package-name }}-coverage
          path: packages/${{ inputs.package-name }}/coverage/
          retention-days: 7
