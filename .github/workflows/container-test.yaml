name: Container Build Test

on:
  workflow_dispatch:
    inputs:
      container:
        description: "Container name (fd or rg)"
        required: true
        type: choice
        options:
          - fd
          - rg
        default: fd
      target:
        description: "Target architecture"
        required: true
        type: choice
        options:
          - x86_64
          - aarch64
          - both
        default: both
      build_mode:
        description: "Build mode"
        required: true
        type: choice
        options:
          - single-runner-cross
          - native-runners
        default: single-runner-cross
      test_load:
        description: "Test loading to Docker daemon"
        required: false
        type: boolean
        default: true
      debug_enabled:
        description: "Enable tmate debug session"
        required: false
        type: boolean
        default: false

concurrency:
  group: container-test-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

permissions:
  contents: read
  packages: write

env:
  CACHIX_BINARY_CACHE: cameronraysmith

jobs:
  # Single runner mode: builds both architectures using pkgsCross
  # x86_64 is native, aarch64 is cross-compiled (both at native speed)
  build-cross:
    if: inputs.build_mode == 'single-runner-cross'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          system: x86_64-linux
          enable-cachix: true
          cachix-name: ${{ env.CACHIX_BINARY_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Setup tmate debug session
        if: inputs.debug_enabled
        uses: mxschmitt/action-tmate@v3

      - name: Build x86_64 container (native)
        if: inputs.target == 'x86_64' || inputs.target == 'both'
        run: |
          echo "Building ${{ inputs.container }}Container-x86_64 (native on x86_64-linux)"
          nix build ".#${{ inputs.container }}Container-x86_64" -o result-x86_64

          echo "=== Container metadata ==="
          jq '.arch' result-x86_64
          jq '.layers | length' result-x86_64

      - name: Build aarch64 container (cross-compiled)
        if: inputs.target == 'aarch64' || inputs.target == 'both'
        run: |
          echo "Building ${{ inputs.container }}Container-aarch64 (cross-compiled via pkgsCross)"
          nix build ".#${{ inputs.container }}Container-aarch64" -o result-aarch64

          echo "=== Container metadata ==="
          jq '.arch' result-aarch64
          jq '.layers | length' result-aarch64

      - name: Verify architecture metadata
        run: |
          echo "=== Architecture Verification ==="
          if [[ -f result-x86_64 ]]; then
            ARCH=$(jq -r '.arch' result-x86_64)
            echo "x86_64 container arch: $ARCH"
            [[ "$ARCH" == "amd64" ]] || { echo "ERROR: Expected amd64"; exit 1; }
          fi
          if [[ -f result-aarch64 ]]; then
            ARCH=$(jq -r '.arch' result-aarch64)
            echo "aarch64 container arch: $ARCH"
            [[ "$ARCH" == "arm64" ]] || { echo "ERROR: Expected arm64"; exit 1; }
          fi
          echo "All architecture checks passed"

      - name: Test manifest evaluation
        if: inputs.target == 'both'
        run: |
          echo "Evaluating multi-arch manifest..."
          nix eval ".#${{ inputs.container }}Manifest" --apply 'x: x.name' 2>&1 || true
          echo "Manifest evaluation complete"

      - name: Test copyToDockerDaemon (x86_64 only - native arch)
        if: inputs.test_load && (inputs.target == 'x86_64' || inputs.target == 'both')
        run: |
          echo "Loading x86_64 container to Docker daemon..."
          nix run ".#${{ inputs.container }}Container-x86_64.copyToDockerDaemon" 2>&1 || {
            echo "::warning::copyToDockerDaemon failed - container image built successfully"
          }

      - name: Report disk usage
        if: always()
        run: df -h

  # Native runner mode: uses separate runners per architecture
  setup-matrix:
    if: inputs.build_mode == 'native-runners'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          if [[ "${{ inputs.target }}" == "both" ]]; then
            echo 'matrix={"include":[{"target":"x86_64","runner":"ubuntu-latest"},{"target":"aarch64","runner":"ubuntu-24.04-arm"}]}' >> $GITHUB_OUTPUT
          elif [[ "${{ inputs.target }}" == "x86_64" ]]; then
            echo 'matrix={"include":[{"target":"x86_64","runner":"ubuntu-latest"}]}' >> $GITHUB_OUTPUT
          else
            echo 'matrix={"include":[{"target":"aarch64","runner":"ubuntu-24.04-arm"}]}' >> $GITHUB_OUTPUT
          fi

  build-native:
    if: inputs.build_mode == 'native-runners'
    needs: setup-matrix
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.setup-matrix.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          system: ${{ matrix.target == 'x86_64' && 'x86_64-linux' || 'aarch64-linux' }}
          enable-cachix: true
          cachix-name: ${{ env.CACHIX_BINARY_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Setup tmate debug session
        if: inputs.debug_enabled
        uses: mxschmitt/action-tmate@v3

      - name: Build container (native)
        run: |
          echo "Building ${{ inputs.container }}Container-${{ matrix.target }} (native on ${{ matrix.runner }})"
          nix build ".#${{ inputs.container }}Container-${{ matrix.target }}" -o result-container

          echo "=== Container metadata ==="
          jq '.arch' result-container
          jq '.layers | length' result-container

      - name: Verify architecture
        run: |
          EXPECTED_ARCH="${{ matrix.target == 'x86_64' && 'amd64' || 'arm64' }}"
          ACTUAL_ARCH=$(jq -r '.arch' result-container)
          echo "Expected: $EXPECTED_ARCH, Actual: $ACTUAL_ARCH"
          [[ "$ACTUAL_ARCH" == "$EXPECTED_ARCH" ]] || { echo "ERROR: Architecture mismatch"; exit 1; }

      - name: Test copyToDockerDaemon
        if: inputs.test_load
        run: |
          echo "Loading container to Docker daemon..."
          nix run ".#${{ inputs.container }}Container-${{ matrix.target }}.copyToDockerDaemon" 2>&1 || {
            echo "::warning::copyToDockerDaemon failed - container image built successfully"
          }

      - name: Report disk usage
        if: always()
        run: df -h
