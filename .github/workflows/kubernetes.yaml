name: Kubernetes
on:
  push:
    branches:
      - nix-50f
    paths:
      - 'kubernetes/**'
      - 'justfile'
      - 'flake.nix'
      - 'flake.lock'
      - 'secrets/**'
      - '.github/workflows/kubernetes.yaml'
      - '.github/actions/setup-nix/**'
  pull_request:
    branches:
      - main
    paths:
      - 'kubernetes/**'
      - 'justfile'
      - 'flake.nix'
      - 'flake.lock'
      - 'secrets/**'
      - '.github/workflows/kubernetes.yaml'
      - '.github/actions/setup-nix/**'
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: "Run the workflow with tmate.io debugging enabled"
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      debug_enabled:
        description: "Enable tmate debugging"
        required: false
        type: string
        default: "false"

concurrency:
  group: kubernetes-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

permissions:
  contents: read

env:
  CACHIX_BINARY_CACHE: cameronraysmith

jobs:
  integration:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          installer: full
          hatchet: holster
          system: x86_64-linux

      - name: Verify Docker available
        run: |
          docker version
          docker info

      - name: Run k3d integration tests
        run: nix develop .#kubernetes --accept-flake-config -c just k3d-integration-ci

      - name: Collect failure diagnostics
        if: failure()
        run: |
          nix develop .#kubernetes --accept-flake-config -c bash -c '
            echo "=== k3d cluster status ==="
            k3d cluster list || true

            echo ""
            echo "=== Docker containers ==="
            docker ps -a || true

            echo ""
            echo "=== k3d server logs (last 100 lines) ==="
            docker logs k3d-dev-server-0 --tail 100 2>&1 || true

            echo ""
            echo "=== ArgoCD Applications ==="
            kubectl get applications -n argocd -o yaml 2>/dev/null || echo "ArgoCD not deployed"

            echo ""
            echo "=== Non-running pods ==="
            kubectl get pods -A --field-selector=status.phase!=Running 2>/dev/null || echo "kubectl not available"

            echo ""
            echo "=== Pod events (warnings/errors) ==="
            kubectl get events -A --field-selector=type!=Normal --sort-by=.lastTimestamp 2>/dev/null | tail -50 || true
          '

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: chainsaw-reports
          path: |
            /tmp/chainsaw-*/
          if-no-files-found: ignore
          retention-days: 7
