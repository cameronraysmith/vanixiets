name: Test Composite Actions

on:
  workflow_dispatch:
    inputs:
      test-scenario:
        description: 'Test scenario to run'
        required: false
        type: choice
        options:
          - all
          - cache-hit
          - cache-miss
          - path-filters
          - validation
        default: all
  pull_request:
    paths:
      - '.github/actions/**'
      - '.github/workflows/test-composite-actions.yaml'

concurrency:
  group: test-composite-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test-cache-hit:
    name: Test cache hit scenario
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      (inputs.test-scenario == 'all' || inputs.test-scenario == 'cache-hit') ||
      github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Test cached-ci-job action
        id: cache-test
        uses: ./.github/actions/cached-ci-job
        with:
          check-name: test-cache-hit
          path-filters: '\.md$'

      - name: Validate outputs
        run: |
          echo "=== Composite Action Outputs ==="
          echo "should-run: ${{ steps.cache-test.outputs.should-run }}"
          echo "relevant-changes: ${{ steps.cache-test.outputs.relevant-changes }}"
          echo "cache-key: ${{ steps.cache-test.outputs.cache-key }}"
          echo "cache-path: ${{ steps.cache-test.outputs.cache-path }}"

          # Validate required outputs present
          if [ -z "${{ steps.cache-test.outputs.should-run }}" ]; then
            echo "❌ Missing required output: should-run"
            exit 1
          fi

          if [ -z "${{ steps.cache-test.outputs.cache-key }}" ]; then
            echo "❌ Missing required output: cache-key"
            exit 1
          fi

          if [ -z "${{ steps.cache-test.outputs.cache-path }}" ]; then
            echo "❌ Missing required output: cache-path"
            exit 1
          fi

          echo "✅ All required outputs present"

      - name: Validate cache key format
        run: |
          KEY="${{ steps.cache-test.outputs.cache-key }}"
          if ! echo "$KEY" | grep -qE '^job-result-.*-[a-f0-9]{8}$'; then
            echo "❌ Invalid cache key format: $KEY"
            echo "Expected: job-result-{name}-{8-char-sha}"
            exit 1
          fi
          echo "✅ Cache key format valid: $KEY"

  test-path-filters:
    name: Test path filter logic
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      (inputs.test-scenario == 'all' || inputs.test-scenario == 'path-filters') ||
      github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Test with specific path filters
        id: filter-test
        uses: ./.github/actions/cached-ci-job
        with:
          check-name: test-path-filters
          path-filters: '\.nix$|flake\.lock'

      - name: Validate path filter outputs
        run: |
          echo "=== Path Filter Outputs ==="
          echo "relevant-changes: ${{ steps.filter-test.outputs.relevant-changes }}"
          echo "any-changed: ${{ steps.filter-test.outputs.any-changed }}"

          if [ -z "${{ steps.filter-test.outputs.relevant-changes }}" ]; then
            echo "❌ Missing relevant-changes output"
            exit 1
          fi

          echo "✅ Path filter outputs valid"
