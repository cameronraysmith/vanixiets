name: Test Composite Actions

on:
  workflow_dispatch:
    inputs:
      test-job:
        description: 'Specific test job to run (leave at "all" to run all tests)'
        required: false
        type: choice
        options:
          - all
          - test-cache-hit
          - test-path-filters
          - test-workflow-change-detection
          - test-force-run
          - test-check-name-sanitization
        default: all

concurrency:
  group: test-composite-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-cache-hit:
    name: Test cache hit scenario
    runs-on: ubuntu-latest
    if: inputs.test-job == 'all' || inputs.test-job == 'test-cache-hit'
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Test cached-ci-job action
        id: cache-test
        uses: ./.github/actions/cached-ci-job
        with:
          check-name: test-cache-hit
          path-filters: '\.md$'

      - name: Validate outputs
        run: |
          echo "=== Composite Action Outputs ==="
          echo "should-run: ${{ steps.cache-test.outputs.should-run }}"
          echo "relevant-changes: ${{ steps.cache-test.outputs.relevant-changes }}"
          echo "cache-key: ${{ steps.cache-test.outputs.cache-key }}"
          echo "cache-path: ${{ steps.cache-test.outputs.cache-path }}"

          # Validate required outputs present
          if [ -z "${{ steps.cache-test.outputs.should-run }}" ]; then
            echo "⊘ Missing required output: should-run"
            exit 1
          fi

          if [ -z "${{ steps.cache-test.outputs.cache-key }}" ]; then
            echo "⊘ Missing required output: cache-key"
            exit 1
          fi

          if [ -z "${{ steps.cache-test.outputs.cache-path }}" ]; then
            echo "⊘ Missing required output: cache-path"
            exit 1
          fi

          echo "● All required outputs present"

      - name: Validate cache key format
        run: |
          KEY="${{ steps.cache-test.outputs.cache-key }}"
          if ! echo "$KEY" | grep -qE '^job-result-.*-[a-f0-9]{12}$'; then
            echo "⊘ Invalid cache key format: $KEY"
            echo "Expected: job-result-{name}-{12-char-sha}"
            exit 1
          fi
          echo "● Cache key format valid: $KEY"

  test-path-filters:
    name: Test path filter logic
    runs-on: ubuntu-latest
    if: inputs.test-job == 'all' || inputs.test-job == 'test-path-filters'
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Test with specific path filters
        id: filter-test
        uses: ./.github/actions/cached-ci-job
        with:
          check-name: test-path-filters
          path-filters: '\.nix$|flake\.lock'

      - name: Validate path filter outputs
        run: |
          echo "=== Path Filter Outputs ==="
          echo "relevant-changes: ${{ steps.filter-test.outputs.relevant-changes }}"
          echo "any-changed: ${{ steps.filter-test.outputs.any-changed }}"

          if [ -z "${{ steps.filter-test.outputs.relevant-changes }}" ]; then
            echo "⊘ Missing relevant-changes output"
            exit 1
          fi

          echo "● Path filter outputs valid"

  test-workflow-change-detection:
    name: Test workflow change detection
    runs-on: ubuntu-latest
    if: inputs.test-job == 'all' || inputs.test-job == 'test-workflow-change-detection'
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Test action with path filter that won't match
        id: workflow-test
        uses: ./.github/actions/cached-ci-job
        with:
          check-name: test-workflow-change
          path-filters: '^packages/nonexistent/'

      - name: Validate workflow change detected when test workflow modified
        env:
          RELEVANT_CHANGES: ${{ steps.workflow-test.outputs.relevant-changes }}
          ALL_CHANGED: ${{ steps.workflow-test.outputs.all-changed-files }}
        run: |
          echo "=== Workflow Change Detection ==="
          echo "Relevant changes: $RELEVANT_CHANGES"
          echo "All changed files: $ALL_CHANGED"

          # This test workflow is in the changeset on PR
          # Even though path-filters won't match, workflow change should force relevant-changes=true
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "$RELEVANT_CHANGES" = "true" ]; then
              echo "● Workflow change correctly detected on PR"
            else
              echo "⚠️ Workflow change not detected (may not be in changeset)"
              # Don't fail - workflow might not be in this PR's changeset
            fi
          else
            echo "ℹ️ Skipping workflow change validation (not a PR event)"
          fi

  test-force-run:
    name: Test force-run parameter
    runs-on: ubuntu-latest
    if: inputs.test-job == 'all' || inputs.test-job == 'test-force-run'
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Test with force-run enabled
        id: force-test
        uses: ./.github/actions/cached-ci-job
        with:
          check-name: test-force-run
          force-run: 'true'

      - name: Validate force-run behavior
        env:
          SHOULD_RUN: ${{ steps.force-test.outputs.should-run }}
          CACHE_SOURCE: ${{ steps.force-test.outputs.cache-source }}
        run: |
          echo "=== Force-Run Validation ==="
          echo "should-run: $SHOULD_RUN"
          echo "cache-source: $CACHE_SOURCE"

          if [ "$SHOULD_RUN" != "true" ]; then
            echo "⊘ force-run=true should set should-run=true"
            exit 1
          fi

          if [ "$CACHE_SOURCE" != "none" ]; then
            echo "⊘ force-run=true should set cache-source=none"
            exit 1
          fi

          echo "● Force-run parameter working correctly"

  test-check-name-sanitization:
    name: Test check name sanitization
    runs-on: ubuntu-latest
    if: inputs.test-job == 'all' || inputs.test-job == 'test-check-name-sanitization'
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Test with matrix-style check name
        id: matrix-test
        uses: ./.github/actions/cached-ci-job
        with:
          check-name: 'test-job (ubuntu-latest, 3.11)'

      - name: Validate check name sanitization
        env:
          CACHE_KEY: ${{ steps.matrix-test.outputs.cache-key }}
        run: |
          echo "=== Check Name Sanitization ==="
          echo "Cache key: $CACHE_KEY"

          # Should sanitize: remove parens, convert ", " to "-", collapse dashes
          # Expected: job-result-test-job-ubuntu-latest-3.11-{12-char-sha}
          if echo "$CACHE_KEY" | grep -q '('; then
            echo "⊘ Cache key contains parentheses: $CACHE_KEY"
            exit 1
          fi

          if echo "$CACHE_KEY" | grep -q ', '; then
            echo "⊘ Cache key contains comma-space: $CACHE_KEY"
            exit 1
          fi

          if ! echo "$CACHE_KEY" | grep -qE '^job-result-test-job-ubuntu-latest-3\.11-[a-f0-9]{12}$'; then
            echo "⊘ Cache key not properly sanitized: $CACHE_KEY"
            echo "Expected: job-result-test-job-ubuntu-latest-3.11-{12-char-sha}"
            exit 1
          fi

          echo "● Check name sanitization working correctly"
