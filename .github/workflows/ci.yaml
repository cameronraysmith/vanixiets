name: multi-user architecture CI
on:
  workflow_dispatch:
    inputs:
      job:
        description: specific job to run (leave empty to run all)
        required: false
        type: string
  workflow_call:
    inputs:
      target_configs:
        description: comma-separated list of configs to build
        required: false
        type: string
      cache_control:
        description: cache control (use_cache, skip_cache)
        required: false
        type: string
        default: use_cache
      job_selection:
        description: comma-separated list of jobs to run
        required: false
        type: string

defaults:
  run:
    shell: bash

env:
  CACHIX_BINARY_CACHE: cameronraysmith

jobs:
  # job 0: skip-check
  # prevents duplicate workflow runs on same commit hash
  skip-check:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@f75f66ce1886f00957d99748a42c724f4330bdcf # ratchet:fkirc/skip-duplicate-actions@v5
        with:
          skip_after_successful_duplicate: 'true'
          do_not_skip: '["schedule"]'
          concurrent_skipping: 'never'
          cancel_others: 'false'

  # job 1: bootstrap-verification
  # validates Makefile bootstrap workflow on clean ubuntu system
  bootstrap-verification:
    needs: skip-check
    if: |
      needs.skip-check.outputs.should_skip != 'true' &&
      (github.event_name != 'workflow_dispatch' ||
       inputs.job == '' ||
       inputs.job == 'bootstrap-verification')
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5

      - name: run make bootstrap
        run: make bootstrap

      - name: verify nix installed
        run: |
          if ! command -v nix &> /dev/null; then
            echo "nix not found in PATH"
            exit 1
          fi
          echo "nix found at: $(command -v nix)"
          nix --version

      - name: verify direnv configured
        run: |
          if ! command -v direnv &> /dev/null; then
            echo "direnv not found in PATH"
            exit 1
          fi
          echo "direnv found at: $(command -v direnv)"

      - name: run make verify
        run: make verify

      - name: run make setup-user
        run: make setup-user

      - name: verify age key generated
        run: |
          if [ ! -f ~/.config/sops/age/keys.txt ]; then
            echo "age key not generated"
            exit 1
          fi
          echo "age key generated successfully"
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh && \
          nix shell nixpkgs#age -c age-keygen -y ~/.config/sops/age/keys.txt

  # job 2: config-validation
  # tests config.nix user definitions (phase 1)
  config-validation:
    needs: skip-check
    if: |
      needs.skip-check.outputs.should_skip != 'true' &&
      (github.event_name != 'workflow_dispatch' ||
       inputs.job == '' ||
       inputs.job == 'config-validation')
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5

      - name: setup nix
        uses: ./.github/actions/setup-nix
        with:
          system: x86_64-linux
          enable-cachix: true
          cachix-name: ${{ env.CACHIX_BINARY_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: validate user definitions
        run: |
          echo "validating config.nix user definitions through darwin configurations..."

          # verify crs58 is configured in stibnite
          echo "testing stibnite users..."
          STIBNITE_USERS=$(nix eval .#darwinConfigurations.stibnite.config.users.users --apply 'x: builtins.attrNames x' --json)
          if echo "$STIBNITE_USERS" | grep -q '"crs58"'; then
            echo "  ✅ crs58 user exists in stibnite"
          else
            echo "  ❌ crs58 user missing in stibnite"
            exit 1
          fi

          # verify cameron is configured in blackphos (once migrated) or crs58 for now
          echo "testing blackphos users..."
          BLACKPHOS_USERS=$(nix eval .#darwinConfigurations.blackphos.config.users.users --apply 'x: builtins.attrNames x' --json)
          if echo "$BLACKPHOS_USERS" | grep -q '"crs58"'; then
            echo "  ✅ crs58 user exists in blackphos (admin user configured)"
          else
            echo "  ❌ no admin user found in blackphos"
            exit 1
          fi

          # verify primary user is set correctly in stibnite
          STIBNITE_PRIMARY=$(nix eval .#darwinConfigurations.stibnite.config.system.primaryUser --raw)
          if [ "$STIBNITE_PRIMARY" = "crs58" ]; then
            echo "  ✅ stibnite primary user is crs58"
          else
            echo "  ❌ stibnite primary user is $STIBNITE_PRIMARY (expected crs58)"
            exit 1
          fi

          echo "✅ user definitions validated successfully"

  # job 3: autowiring-validation
  # verifies nixos-unified automatic config discovery
  autowiring-validation:
    needs: skip-check
    if: |
      needs.skip-check.outputs.should_skip != 'true' &&
      (github.event_name != 'workflow_dispatch' ||
       inputs.job == '' ||
       inputs.job == 'autowiring-validation')
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5

      - name: setup nix
        uses: ./.github/actions/setup-nix
        with:
          system: x86_64-linux
          enable-cachix: true
          cachix-name: ${{ env.CACHIX_BINARY_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: verify autowired outputs
        run: |
          echo "verifying nixos-unified autowiring..."

          # check darwin configs
          echo "checking darwinConfigurations..."
          DARWIN_CONFIGS=$(nix eval .#darwinConfigurations --apply 'x: builtins.attrNames x' --json)
          if [ -n "$DARWIN_CONFIGS" ] && [ "$DARWIN_CONFIGS" != "[]" ]; then
            echo "✅ darwinConfigurations detected: $DARWIN_CONFIGS"
          else
            echo "❌ darwinConfigurations not found"
            exit 1
          fi

          # check nixos configs
          echo "checking nixosConfigurations..."
          NIXOS_CONFIGS=$(nix eval .#nixosConfigurations --apply 'x: builtins.attrNames x' --json)
          if [ -n "$NIXOS_CONFIGS" ] && [ "$NIXOS_CONFIGS" != "[]" ]; then
            echo "✅ nixosConfigurations detected: $NIXOS_CONFIGS"
          else
            echo "❌ nixosConfigurations not found"
            exit 1
          fi

          # verify standalone home configurations exist
          echo ""
          echo "verifying standalone home configurations..."
          HOME_CONFIGS=$(nix eval .#legacyPackages.x86_64-linux.homeConfigurations --apply 'x: builtins.attrNames x' --json)

          # check for expected home configs
          for config in "runner@stibnite" "runner@blackphos" "raquel@blackphos"; do
            if echo "$HOME_CONFIGS" | grep -q "\"$config\""; then
              echo "  ✅ $config exists"
            else
              echo "  ❌ $config missing"
              exit 1
            fi
          done

          echo "✅ all expected homeConfigurations found"

  # job 5: secrets-workflow
  # tests sops-nix mechanics with ephemeral test keys
  secrets-workflow:
    needs: skip-check
    if: |
      needs.skip-check.outputs.should_skip != 'true' &&
      (github.event_name != 'workflow_dispatch' ||
       inputs.job == '' ||
       inputs.job == 'secrets-workflow')
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5

      - name: setup nix
        uses: ./.github/actions/setup-nix
        with:
          system: x86_64-linux
          enable-cachix: true
          cachix-name: ${{ env.CACHIX_BINARY_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: generate ephemeral test age key
        run: |
          mkdir -p test-secrets
          nix develop --command age-keygen -o test-secrets/test-key.txt
          TEST_AGE_PUBLIC=$(nix develop --command age-keygen -y test-secrets/test-key.txt)
          echo "generated test age key"
          echo "public key: $TEST_AGE_PUBLIC"
          echo "TEST_AGE_PUBLIC=$TEST_AGE_PUBLIC" >> $GITHUB_ENV

      - name: create test .sops.yaml
        run: |
          cat > test-secrets/.sops.yaml <<EOF
          creation_rules:
            - path_regex: .*\.yaml$
              key_groups:
                - age:
                  - $TEST_AGE_PUBLIC
          EOF
          echo "created test .sops.yaml"

      - name: create and encrypt test secret
        run: |
          cd test-secrets
          echo "test_secret: test-value-12345" > test.yaml
          nix develop --command sops -e -i test.yaml
          echo "encrypted test secret"

      - name: verify decryption
        run: |
          cd test-secrets
          SOPS_AGE_KEY_FILE=test-key.txt \
            nix develop --command sops -d test.yaml | grep -q "test_secret: test-value-12345"
          echo "✅ test secret decryption successful"

      - name: validate sops structure
        run: |
          if [ -f .sops.yaml ]; then
            echo "✅ .sops.yaml exists in repository"
            nix develop --command sops --version
          else
            echo "⚠️  .sops.yaml not found (may need creation)"
          fi

      - name: cleanup test secrets
        if: always()
        run: |
          rm -rf test-secrets
          echo "✅ ephemeral test secrets cleaned up"

  # job 6: justfile-activation
  # validates user experience: justfile recipes, configuration discovery, and activation workflows
  justfile-activation:
    needs: skip-check
    if: |
      needs.skip-check.outputs.should_skip != 'true' &&
      (github.event_name != 'workflow_dispatch' ||
       inputs.job == '' ||
       inputs.job == 'justfile-activation')
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5

      - name: setup nix
        uses: ./.github/actions/setup-nix
        with:
          system: x86_64-linux
          enable-cachix: true
          cachix-name: ${{ env.CACHIX_BINARY_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: test justfile recipes
        run: |
          # capture output once to avoid running nix develop twice
          JUST_OUTPUT=$(nix develop --command just --list 2>&1)
          echo "$JUST_OUTPUT"

          # verify core recipes exist
          echo ""
          echo "verifying core recipes..."
          for recipe in activate verify check lint; do
            if echo "$JUST_OUTPUT" | grep -q "\b$recipe\b"; then
              echo "✅ $recipe recipe found"
            else
              echo "❌ $recipe recipe not found"
              exit 1
            fi
          done

      - name: validate flake structure
        run: |
          echo "validating flake structure with nix flake check..."
          nix develop --command just check

      - name: test home configurations (dry-run)
        run: |
          echo "discovering home configurations..."

          # find all home configs dynamically from filesystem
          HOME_CONFIGS=$(find configurations/home -name "*.nix" -type f | \
            sed 's|configurations/home/||' | \
            sed 's|\.nix$||' | \
            sort)

          if [ -z "$HOME_CONFIGS" ]; then
            echo "⚠️  no home configurations found"
            exit 0
          fi

          echo "found configurations:"
          echo "$HOME_CONFIGS" | while read config; do
            echo "  - $config"
          done
          echo ""

          # test each config with dry-run
          echo "testing activation with dry-run..."
          echo "$HOME_CONFIGS" | while read config; do
            echo "testing: just -n activate $config"
            if nix develop --command just -n activate "$config"; then
              echo "  ✅ $config dry-run succeeds"
            else
              echo "  ❌ $config dry-run failed"
              exit 1
            fi
          done

          echo ""
          echo "✅ all home configurations validated"

      - name: verify configuration outputs
        run: |
          echo "verifying all configurations are exposed in flake outputs..."

          # get flake outputs using nix eval (nix flake show --json doesn't work with complex flake structures)
          DARWIN_CONFIGS=$(nix eval .#darwinConfigurations --apply 'x: builtins.attrNames x' --json 2>/dev/null | jq -r '.[]? // empty' || echo "")
          NIXOS_CONFIGS=$(nix eval .#nixosConfigurations --apply 'x: builtins.attrNames x' --json 2>/dev/null | jq -r '.[]? // empty' || echo "")

          echo "darwin configs in flake: $(echo "$DARWIN_CONFIGS" | tr '\n' ' ')"
          echo "nixos configs in flake: $(echo "$NIXOS_CONFIGS" | tr '\n' ' ')"
          echo ""

          # check each configuration file has corresponding output
          MISSING=0

          # check darwin configs
          for config_file in configurations/darwin/*.nix; do
            if [ -f "$config_file" ]; then
              config=$(basename "$config_file" .nix)
              if echo "$DARWIN_CONFIGS" | grep -q "^$config$"; then
                echo "✅ darwin:$config"
              else
                echo "❌ darwin:$config missing from flake outputs"
                MISSING=1
              fi
            fi
          done

          # check nixos configs (handles both direct .nix and directory/default.nix patterns)
          for config_file in configurations/nixos/*/default.nix configurations/nixos/*.nix; do
            if [ -f "$config_file" ]; then
              if [[ "$config_file" =~ configurations/nixos/([^/]+)/default.nix ]]; then
                config="${BASH_REMATCH[1]}"
              else
                config=$(basename "$config_file" .nix)
              fi
              if echo "$NIXOS_CONFIGS" | grep -q "^$config$"; then
                echo "✅ nixos:$config"
              else
                echo "❌ nixos:$config missing from flake outputs"
                MISSING=1
              fi
            fi
          done

          if [ $MISSING -eq 1 ]; then
            echo ""
            echo "❌ some configurations are not exposed in flake outputs"
            exit 1
          fi

          echo ""
          echo "✅ all configurations properly exposed"

  # job 7: nix
  # builds all flake outputs via omnix (nixos configs, home configs, checks, devshells)
  # matrix strategy: test all flake-supported systems on their native platforms
  # pattern adapted from: https://github.com/Defelo/nixpkgs-review-gha
  nix:
    needs: skip-check
    if: |
      needs.skip-check.outputs.should_skip != 'true' &&
      (github.event_name != 'workflow_dispatch' ||
       inputs.job == '' ||
       inputs.job == 'nix')
    strategy:
      fail-fast: false # allow each system to test independently
      matrix:
        system:
          - x86_64-linux # standard linux (ubuntu-latest)
          - aarch64-linux # arm linux (ubuntu-24.04-arm)
          # - aarch64-darwin  # apple silicon macOS (macos-latest)
    # dynamic runner selection based on system architecture
    runs-on: >-
      ${{ (matrix.system == 'x86_64-linux' && 'ubuntu-latest')
      || (matrix.system == 'aarch64-linux' && 'ubuntu-24.04-arm')
      || (matrix.system == 'aarch64-darwin' && 'macos-latest') }}
    steps:
      - name: checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5

      - name: setup nix
        uses: ./.github/actions/setup-nix
        with:
          system: ${{ matrix.system }}
          enable-cachix: true
          cachix-name: ${{ env.CACHIX_BINARY_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: build all outputs via omnix
        run: |
          echo "building all flake outputs for ${{ matrix.system }} via om ci..."
          if [ "${{ matrix.system }}" = "aarch64-darwin" ]; then
            # for darwin: build and push to cachix (including build deps for cache efficiency)
            nix develop --command om ci run --systems "${{ matrix.system }}" --include-all-dependencies | tee /dev/stderr | cachix push ${{ env.CACHIX_BINARY_CACHE }}
          else
            # for linux: just build (we're happy to rebuild these)
            nix develop --command om ci run --systems "${{ matrix.system }}"
          fi
          echo "✅ all outputs built successfully for ${{ matrix.system }}"

      - name: report disk usage
        if: always()
        run: df -h

  # Documentation testing
  docs-test:
    needs: nix
    if: |
      !cancelled() &&
      (github.event_name != 'workflow_dispatch' ||
       inputs.job == '' ||
       inputs.job == 'docs-test')
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5

      - name: setup nix
        uses: ./.github/actions/setup-nix
        with:
          system: x86_64-linux
          enable-cachix: true
          cachix-name: ${{ env.CACHIX_BINARY_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: install dependencies
        run: nix develop --command bun install

      - name: run unit tests with coverage
        run: nix develop --command just docs-test-coverage

      - name: build for e2e tests
        run: nix develop --command just docs-build

      - name: run e2e tests
        run: nix develop --command just docs-test-e2e

      - name: upload test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        with:
          name: docs-playwright-report
          path: packages/docs/playwright-report/
          retention-days: 7

      - name: upload coverage
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        with:
          name: docs-coverage
          path: packages/docs/coverage/
          retention-days: 7

  # Documentation deployment (conditional)
  docs-deploy:
    needs: docs-test
    if: |
      !cancelled() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://docs.example.com
    steps:
      - name: checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # ratchet:actions/checkout@v5

      - name: setup nix
        uses: ./.github/actions/setup-nix
        with:
          system: x86_64-linux

      - name: install dependencies
        run: nix develop --command bun install

      - name: build documentation
        run: nix develop --command just docs-build

      - name: deploy to cloudflare workers
        run: |
          nix develop --command sops exec-env secrets/shared.yaml '
            cd packages/docs && bunx wrangler deploy
          '
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
