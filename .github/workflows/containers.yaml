name: Container Images

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Primary version tag (e.g., 1.0.0)"
        required: false
        type: string
        default: "latest"
      tags:
        description: "Additional tags, comma-separated (applied via crane, no re-upload)"
        required: false
        type: string
        default: ""
      push:
        description: "Push images to registry"
        required: false
        type: boolean
        default: false
      debug_enabled:
        description: "Enable tmate debug session"
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      version:
        description: "Primary version tag"
        required: true
        type: string
      tags:
        description: "Additional tags, comma-separated"
        required: false
        type: string
        default: ""
      push:
        description: "Push images to registry"
        required: false
        type: boolean
        default: true

concurrency:
  group: container-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

permissions:
  contents: read
  packages: write

env:
  CACHIX_BINARY_CACHE: cameronraysmith

jobs:
  # Job 1: Discover containers and targets from Nix
  discover:
    runs-on: ubuntu-latest
    outputs:
      build-matrix: ${{ steps.matrix.outputs.build }}
      manifest-matrix: ${{ steps.matrix.outputs.manifest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          system: x86_64-linux
          enable-cachix: true
          cachix-name: ${{ env.CACHIX_BINARY_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Discover container matrix from Nix
        id: matrix
        run: |
          echo "Evaluating containerMatrix from flake..."
          BUILD=$(nix eval .#containerMatrix.build --json)
          MANIFEST=$(nix eval .#containerMatrix.manifest --json)
          echo "Build matrix: $BUILD"
          echo "Manifest list: $MANIFEST"
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "manifest=$MANIFEST" >> $GITHUB_OUTPUT

  # Job 2: Build containers (parallel matrix over container Ã— target)
  # Uses single ubuntu-latest runner with pkgsCross for all architectures
  build:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.discover.outputs.build-matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          system: x86_64-linux
          enable-cachix: true
          cachix-name: ${{ env.CACHIX_BINARY_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Setup tmate debug session
        if: inputs.debug_enabled
        uses: mxschmitt/action-tmate@c0afd6f790e3a5564914980036ebf83216678101 # v3

      - name: Build ${{ matrix.container }} for ${{ matrix.target }}
        run: |
          echo "Building ${{ matrix.container }}Container-${{ matrix.target }}"
          echo "Using pkgsCross (x86_64 native, aarch64 cross-compiled)"
          nix build ".#${{ matrix.container }}Container-${{ matrix.target }}" -L

      - name: Verify architecture metadata
        run: |
          RESULT=$(nix build ".#${{ matrix.container }}Container-${{ matrix.target }}" --no-link --print-out-paths)
          ARCH=$(jq -r '.arch' "$RESULT")
          echo "Container: ${{ matrix.container }}"
          echo "Target: ${{ matrix.target }}"
          echo "OCI arch: $ARCH"

          # Verify correct architecture
          if [[ "${{ matrix.target }}" == "x86_64" && "$ARCH" != "amd64" ]]; then
            echo "ERROR: Expected amd64, got $ARCH"
            exit 1
          elif [[ "${{ matrix.target }}" == "aarch64" && "$ARCH" != "arm64" ]]; then
            echo "ERROR: Expected arm64, got $ARCH"
            exit 1
          fi
          echo "Architecture verified"

  # Job 3: Push manifests (parallel matrix over containers)
  # Only runs if push input is true
  manifest:
    needs: [discover, build]
    if: inputs.push
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJSON(needs.discover.outputs.manifest-matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          system: x86_64-linux
          enable-cachix: true
          cachix-name: ${{ env.CACHIX_BINARY_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Push ${{ matrix.container }} manifest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
          TAGS: ${{ inputs.tags }}
        run: |
          echo "Pushing multi-arch manifest for ${{ matrix.container }}"
          echo "Version: $VERSION"
          echo "Additional tags: ${TAGS:-none}"
          nix run --impure ".#${{ matrix.container }}Manifest"
