# ZeroTier Quick Reference for clan-core

## Member Admission at a Glance

**Model**: Join-first, authorize-second (asynchronous)

- Machine joins network → queued as "unauthorized"
- Controller authorizes on boot via `zerotier-inventory-autoaccept` service
- No pre-authorization possible; authorization happens post-join

## Three Identifiers

| Identifier | Format | Purpose | Example |
|-----------|--------|---------|---------|
| Node ID | 10 hex chars | Unique machine identity | `9344f769935d` |
| Network ID | 16 hex chars | Shared network (fixed by controller) | `0e28cb903344475e` |
| IPv6 Address | Full IPv6 | Deterministic from network ID + node ID | `fd0e28cb903344475e:9993:9344:f769:935d:bbe3:cbc5` |

**IPv6 is computed**: `fd<network_id>:9993:<node_id>` (deterministic from network ID + node ID, no random component)

## To Admit blackphos (Example)

### Step 1: Get Information (one-time per controller)
```bash
# From controller
cat /etc/zerotier/network-id  # e.g., 0e28cb903344475e
```

### Step 2: Configure blackphos in clan inventory
```nix
# clan.nix or machines/inventory.nix
inventory.instances.zerotier = {
  roles.controller.machines.cinnabar = { };
  roles.peer.machines.blackphos = { };  # ← Add this
  roles.peer.tags.all = { };
};
```

### Step 3: Deploy (controller first, then peer)
```bash
clan machines update cinnabar  # Controller deployment
clan machines update blackphos  # Peer deployment
```

### Step 4: Verify
```bash
# On blackphos
cat /etc/zerotier/ip  # Verify it has joined

# On controller
zerotier-members list  # Verify blackphos appears as authorized
```

## For External Machines (Not in clan inventory)

If blackphos already exists with a ZeroTier identity outside clan:

1. Get blackphos's IPv6:
   ```bash
   ssh root@blackphos zerotier-cli info  # or cat /etc/zerotier/ip
   ```

2. Add to controller config:
   ```nix
   inventory.instances.zerotier = {
     roles.controller.machines.cinnabar.settings.allowedIps = [
       "fd0e28cb903344475e:9993:9344:f769:935d:bbe3:cbc5"  # blackphos IPv6
     ];
   };
   ```

3. Redeploy controller:
   ```bash
   clan machines update cinnabar
   ```

## Manual Authorization (Emergency)

```bash
ssh root@cinnabar zerotier-members allow --member-ip <ipv6>
# OR
ssh root@cinnabar zerotier-members allow <10-char-member-id>
```

## Files Generated by clan

Per-machine, automatically:
- `vars/<machine>/zerotier/zerotier-identity-secret` (private key)
- `vars/<machine>/zerotier/zerotier-ip` (computed IPv6)
- `vars/<machine>/zerotier/zerotier-network-id` (controller only)

No manual intervention needed; clan generates and stores these.

## Key Tools

- `zerotier-members`: CLI for authorization (installed on controller only)
  - `zerotier-members list`: Show all members
  - `zerotier-members allow --member-ip <ipv6>`: Authorize by IPv6
  - `zerotier-members allow <member-id>`: Authorize by member ID

- `zerotier-cli`: ZeroTier daemon control
  - `zerotier-cli info`: Show local node ID
  - `zerotier-cli listnetworks`: Show joined networks

## Roles

- **Controller**: Network manager (exactly 1 per network, creates network ID)
- **Peer**: Regular node in network
- **Moon** (optional): Relay node for NAT traversal, needs `stableEndpoints` setting

## Common Issues

| Problem | Check | Fix |
|---------|-------|-----|
| Machine not authorized | `zerotier-members list` on controller | Redeploy controller or run `zerotier-members allow --member-ip <ipv6>` |
| IPv6 mismatch | Network ID different on peers | All must use same network ID; cluster network IDs if creating separate networks |
| Can't join network | Network ID known but status shows "requesting membership" | Wait for controller to boot and authorize, or manually authorize |

---

**For detailed research**: See `zerotier-member-admission-research.md`
