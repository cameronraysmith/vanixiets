================================================================================
CLAN INVENTORY EXTRAMODULES RESEARCH - COMPLETE
================================================================================

RESEARCH OBJECTIVES
====================
Research how clan inventory extraModules can reference home-manager modules in
dendritic architecture, specifically determining if consolidation of all
home-manager modules in clan inventory services is possible.

CRITICAL QUESTION
==================
Can clan inventory service extraModules reference flake-exported modules?

ANSWER: PARTIAL YES
====================
- Cannot directly reference inputs.self.modules.homeManager.* in inventory context
  (violates JSON serialization requirement)
- CAN access dendritic modules via extraSpecialArgs pass-through in NixOS layer
- This pattern is proven working in test-clan implementation with both cameron.nix
  and crs58.nix successfully importing all dendritic home-manager aggregates

RESEARCH DEPTH LEVEL: VERY THOROUGH
====================================
- Examined 4 major clan implementations (test-clan, clan-infra, qubasa, pinpox)
- Reviewed clan-core documentation and users service implementation
- Analyzed JSON serialization boundary in inventory evaluation pipeline
- Tested and validated 4 distinct reference patterns

KEY FINDINGS
============

1. JSON SERIALIZATION REQUIREMENT (Critical)
   - Inventory evaluation pipeline requires JSON serialization
   - File paths: ✅ JSON-serializable (stored as strings)
   - Lambdas/functions: ❌ Not JSON-serializable at inventory level
   - inputs.self references: ❌ Not JSON-serializable at inventory level
   - BUT: Inline NixOS modules ARE JSON-serializable, and non-serializable
     expressions within them are OK (evaluated after JSON step)

2. FOUR VALID REFERENCE PATTERNS
   
   Pattern 1 - File Paths (Simplest)
   Status: ✅ Works everywhere
   Cons: Cannot access dendritic modules directly
   Example: roles.default.extraModules = [ ./users/lhebendanz.nix ];
   
   Pattern 2 - Self-Referenced Modules (Limited)
   Status: ⚠️ Works only if JSON-serializable
   Example: roles.default.extraModules = [ self.nixosModules.borgbackup ];
   
   Pattern 3 - Inline Modules (More Flexible)
   Status: ✅ Works - inline attrset is JSON-serializable
   Cons: Still cannot directly access dendritic modules
   
   Pattern 4 - Inline + extraSpecialArgs (Full Consolidation - TEST-CLAN)
   Status: ✅ WORKS - proves consolidation is possible
   Pattern: Pass flake context via extraSpecialArgs to home-manager layer
   Result: Can reference inputs.self.modules.homeManager.* in home-manager context
   Evidence: Test-clan cameron.nix and crs58.nix both use this pattern

3. TEST-CLAN PROVES CONSOLIDATION WORKS
   - Both user services successfully import all dendritic aggregates
   - Pattern: Inline NixOS module containing home-manager configuration
   - Key technique: Pass inputs.self through extraSpecialArgs
   - Result: Single source of truth for user configuration (no duplication)
   
   Files:
   - /Users/crs58/projects/nix-workspace/test-clan/modules/clan/inventory/
     services/users/cameron.nix
   - /Users/crs58/projects/nix-workspace/test-clan/modules/clan/inventory/
     services/users/crs58.nix

4. REFERENCE IMPLEMENTATIONS CONFIRM STANDARD
   
   Qubasa Clan Infra (File-based pattern)
   - Uses Pattern 1: roles.default.extraModules = [ ./users/lhebendanz.nix ]
   - Shows inline lambda attempt was tried and deemed not to work (commented out)
   - Represents simpler approach without consolidation
   
   Pinpox Clan Nixos (Programmatic file paths)
   - Uses file path construction: ./modules + "/${m}"
   - Confirms file-based pattern as standard practice
   - No direct flake references used
   
   Clan-Infra (Non-dendritic reference)
   - Also uses file path imports in extraModules
   - Shows pattern is standard across all clan usage

5. ARCHITECTURAL CONSTRAINTS
   
   Constraint 1: Inventory must be JSON-serializable
   - Prevents direct inputs.* and self.modules.* references
   - Workaround: Pass context through extraSpecialArgs in NixOS layer
   
   Constraint 2: extraSpecialArgs scope limited
   - Only affects the module defining it and its descendants
   - home-manager context receives what's passed in extraSpecialArgs
   
   Constraint 3: Users service currently NixOS-only
   - Darwin machines use extraModules workaround (as in test-clan)
   - Pattern still works via inline NixOS module

CONSOLIDATION FEASIBILITY
==========================
Answer: YES, consolidation is possible and proven working

Current Status:
- ✅ Test-clan demonstrates it's possible and functional
- ✅ All dendritic aggregates successfully imported via inventory
- ✅ Both cameron and crs58 users fully consolidated
- ✅ No duplicate configuration between home-manager and inventory layers

Prerequisites Met:
- ✅ Flake exports modules (dendritic flake-parts with import-tree)
- ✅ Home-manager integrated via extraModules
- ✅ Inputs available in inventory context
- ✅ Pattern is stable and proven

RECOMMENDED PATTERN FOR CONSOLIDATION
=====================================

Pattern 2: Via extraSpecialArgs (TEST-CLAN APPROACH)

Structure:
  roles.default.extraModules = [
    inputs.home-manager.nixosModules.home-manager
    (
      { pkgs, ... }:
      {
        # NixOS layer configuration
        users.users.cameron.shell = pkgs.zsh;
        programs.zsh.enable = true;
        
        # Bridge to home-manager layer
        home-manager = {
          extraSpecialArgs = {
            flake = inputs.self // { inherit inputs; };  # KEY: Pass flake context
          };
          
          # Home-manager layer - can now access dendritic modules
          users.cameron = {
            imports = [
              inputs.self.modules.homeManager."users/crs58"
              inputs.self.modules.homeManager.ai
              inputs.self.modules.homeManager.core
              inputs.self.modules.homeManager.development
              inputs.self.modules.homeManager.packages
              inputs.self.modules.homeManager.shell
              inputs.self.modules.homeManager.terminal
              inputs.self.modules.homeManager.tools
              # External modules
              inputs.lazyvim-nix.homeManagerModules.default
              inputs.nix-index-database.homeModules.nix-index
            ];
          };
        };
      }
    )
  ];

Advantages:
- Single source of truth (dendritic modules)
- Full module reuse across home-manager and inventory
- Enables complete consolidation
- Matches proven test-clan implementation

Disadvantages:
- More complex structure than file-based pattern
- Inline module (though this is acceptable - non-serializable expressions
  are evaluated AFTER JSON step)

DOCUMENTATION PRODUCED
======================

1. Full Research Document (623 lines)
   File: /Users/crs58/projects/nix-workspace/infra/docs/notes/research/
         clan-inventory-extramodules-research.md
   Contains: Executive summary, detailed analysis of all patterns, JSON
   serialization deep dive, consolidation feasibility, evidence from examples,
   recommended patterns, summary table, complete file list

2. Quick Reference Guide (95 lines)
   File: /Users/crs58/projects/nix-workspace/infra/docs/notes/research/
         clan-inventory-quickref.md
   Contains: Quick answer, pattern summaries, JSON serialization boundary,
   test-clan proof, infra-specific recommendations, architectural constraints

EVIDENCE SOURCES EXAMINED
=========================

Test-Clan Implementation (Our Validation):
- modules/clan/inventory/services/users/cameron.nix
- modules/clan/inventory/services/users/crs58.nix
- modules/home/configurations.nix
- modules/machines/darwin/blackphos/default.nix
- modules/home/tools/agents-md.nix
- modules/home/modules/_agents-md.nix

Clan-Core (Source & Documentation):
- docs/site/guides/inventory/inventory.md
- docs/site/guides/services/introduction-to-services.md
- docs/site/getting-started/add-users.md
- clanServices/users/default.nix

Reference Implementations:
- qubasa-clan-infra/clan.nix (file-based pattern)
- qubasa-clan-infra/users/lhebendanz.nix
- pinpox-clan-nixos/inventory.nix (programmatic paths)
- clan-infra/flake.nix (traditional pattern)

NEXT STEPS FOR INFRA REPOSITORY
================================

1. Review test-clan pattern proof in cameron.nix and crs58.nix
2. Apply Pattern 2 to infra's user services (if created)
3. Consolidate with dendritic modules (same as test-clan)
4. Test on nixos machines first (users service limitation)
5. Verify darwin compatibility via extraModules workaround

CONCLUSION
==========

Clan inventory extraModules CAN reference dendritic flake modules through the
extraSpecialArgs mechanism. The JSON serialization boundary is NOT a blocker
because inline NixOS modules (which are JSON-serializable) can contain
non-serializable expressions that pass flake context downstream.

Test-clan provides a working implementation that proves this pattern is stable,
functional, and enables complete consolidation of home-manager configuration
across both standalone home-manager contexts and clan inventory services.

================================================================================
