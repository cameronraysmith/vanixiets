# Research: Clan Boundaries for Documentation

**Date**: 2025-12-01
**Purpose**: Define what clan manages vs. what it doesn't for Story 8.2 documentation
**Status**: Complete

## Executive Summary

Clan is a **multi-machine coordination and deployment framework** that sits atop NixOS/nix-darwin.
It provides machine inventory, service orchestration, secrets/vars generation, and deployment tooling.
Clan does NOT replace traditional nix ecosystem tools like home-manager, terranix, or nixpkgs overlays - it orchestrates them.

### Core Insight

Clan manages the **coordination layer** between machines and services.
Infrastructure provisioning (terranix/terraform), user environments (home-manager), and system configuration (nixos/nix-darwin) are managed OUTSIDE clan but orchestrated BY clan.

---

## 1. Clan Capabilities Summary

### What Clan Provides (from clan-core documentation)

Based on `/Users/crs58/projects/nix-workspace/clan-core/README.md` and official docs:

1. **Full-Stack System Deployment**: Multi-machine coordination and deployment
2. **Overlay Networks**: Zerotier/VPN service orchestration across machines
3. **Virtual Machine Integration**: VM testing and integration
4. **Robust Backup Management**: Backup service coordination
5. **Intuitive Secret Management**: Vars/generators system for secrets

### What Clan Actually Manages (in our implementation)

From `/Users/crs58/projects/nix-workspace/infra/modules/clan/`:

**Machine Registry** (`clan.machines.*`):
- Machine definitions and imports
- Links machines to their nixos/darwin configurations
- Provides deployment targets

**Inventory** (`clan.inventory.*`):
- Machine inventory declarations
- Service instance assignments
- Role-based service deployment

**Vars/Generators** (tier 1 secrets):
- SSH host keys
- Zerotier identities
- ZFS/LUKS passphrases
- Tor hidden service keys
- Generated via `clan vars generate`, stored in `vars/`

**Deployment Tooling**:
- `clan machines install` - initial machine installation
- `clan machines update` - configuration deployment
- `clan vars generate` - secrets generation
- Integration with kexec for remote installation

**Service Orchestration**:
- Services defined in `modules/clan/inventory/services/`
- Role assignment (controller, peer, default, etc.)
- Multi-machine coordination (e.g., zerotier controller + peers)

---

## 2. Clan Boundaries: What Clan Does NOT Manage

### Infrastructure Provisioning (Terranix/Terraform)

**Managed by**: Terranix modules in `modules/terranix/`
**Pattern**: clan-infra production pattern

Clan does NOT:
- Create cloud resources (VMs, networks, DNS)
- Manage Terraform state
- Provision infrastructure

We DO:
- Use terranix to define infrastructure declaratively
- Integrate terranix flakeModule alongside clan flakeModule
- Call `clan machines install` from terraform provisioners after resources exist

**Evidence from clan-infra**:
```nix
# clan-infra uses terranix separately from clan
inputs.terranix.url = "github:terranix/terranix";
```

Terraform/terranix creates the infrastructure, clan deploys to it.

### User Environment Configuration (Home-Manager)

**Managed by**: Home-manager modules in `modules/home/`
**Pattern**: Integrated via nix-darwin/nixos modules

Clan does NOT:
- Define user dotfiles
- Manage shell configurations
- Configure user applications

We DO:
- Use home-manager as a NixOS/nix-darwin module
- Define user configurations in `modules/home/users/`
- Deploy home configurations alongside system configurations

**Evidence from our implementation**:
```
modules/home/
├── ai/                  # Claude Code, MCP servers
├── core/                # SSH, XDG, fonts
├── development/         # Dev tools
└── users/               # User-specific configs
```

Home-manager is OUTSIDE clan's scope but integrated WITH clan deployments.

### User-Level Secrets (sops-nix)

**Managed by**: sops-nix (tier 2 secrets)
**Pattern**: Two-tier secrets architecture validated in test-clan

Clan does NOT:
- Manage user identity secrets (GitHub tokens, API keys)
- Deploy user-level encrypted configs
- Handle per-user age keys

We DO:
- Use sops-nix for user secrets SEPARATELY from clan vars
- Define `.sops.yaml` encryption rules outside clan
- Deploy via home-manager sops integration

**Key distinction** (from test-clan architecture):
- Tier 1 (clan vars): System secrets, generated by clan
- Tier 2 (sops-nix): User secrets, manually created and encrypted

### Nixpkgs Configuration (Overlays, Unfree)

**Managed by**: Nixpkgs modules in `modules/nixpkgs/`
**Pattern**: Dendritic overlay composition

Clan does NOT:
- Define package overlays
- Configure nixpkgs.config (allowUnfree, etc.)
- Manage package versions

We DO:
- Use `pkgsForSystem` to provide pre-configured nixpkgs to clan
- Define overlays in `modules/nixpkgs/overlays/`
- Configure via flake-parts nixpkgs configuration

**Evidence from test-clan**:
```nix
# modules/clan/meta.nix
clan.pkgsForSystem = system: inputs.self.legacyPackages.${system} or null;
```

Clan receives nixpkgs instances; it doesn't configure them.

### System Configuration (NixOS/nix-darwin)

**Managed by**: Machine modules in `modules/machines/`
**Pattern**: Machine-specific configurations

Clan does NOT:
- Define system services (nginx, postgres, etc.)
- Configure system defaults
- Manage nix daemon settings

We DO:
- Import machine configurations via `clan.machines.<name>.imports`
- Define system modules in `modules/system/`
- Use clan as the deployment mechanism

**Evidence**:
```nix
# modules/clan/machines.nix
clan.machines.cinnabar = {
  imports = [ config.flake.modules.nixos."machines/nixos/cinnabar" ];
};
```

Machine definitions reference configurations defined outside clan.

---

## 3. Integration Points: Where Clan Meets Other Tools

### Clan + Terranix

**Integration mechanism**: Flake modules imported side-by-side

```nix
# modules/clan/core.nix
imports = [
  inputs.clan-core.flakeModules.default
  inputs.terranix.flakeModule
];
```

**Data flow**:
1. Terranix creates infrastructure (Hetzner VMs, GCP instances)
2. Terraform provisioner runs `clan machines install <machine>`
3. Clan deploys NixOS configuration to provisioned infrastructure

**Boundary**: Terranix provisions, clan deploys.

### Clan + Home-Manager

**Integration mechanism**: Home-manager as NixOS/nix-darwin module

```nix
# Machine configuration
imports = [
  inputs.home-manager.nixosModules.home-manager  # or darwinModules
];

home-manager.users.<username> = { ... };
```

**Data flow**:
1. Machine configuration imports home-manager module
2. Clan deploys machine configuration
3. Home-manager activates as part of system activation

**Boundary**: Home-manager configures users, clan coordinates deployment.

### Clan + sops-nix

**Integration mechanism**: Two-tier secrets architecture

```
Tier 1 (Clan vars):
- Generated via `clan vars generate`
- Encrypted with machine age keys
- Deployed to /run/secrets/vars/

Tier 2 (sops-nix):
- Manually created via `sops` CLI
- Encrypted with user age keys
- Deployed via home-manager sops integration
```

**Data flow**:
1. Clan vars deployed to system
2. sops-nix secrets deployed to home-manager
3. Services reference both tiers as needed

**Boundary**: Clan generates system secrets, sops-nix manages user secrets.

### Clan + Flake-parts

**Integration mechanism**: Clan as flake-parts module

```nix
flake-parts.lib.mkFlake { inherit inputs; } {
  imports = [ inputs.clan-core.flakeModules.default ];
  clan = { ... };  # Clan configuration
};
```

**Data flow**:
1. Flake-parts provides module system
2. Clan exposes `clan.*` options
3. Other flake-parts modules coexist (terranix, treefmt, etc.)

**Boundary**: Flake-parts is the framework, clan is one module among many.

---

## 4. Gray Areas and Clarifications

### Terranix Integration

**Question**: Is terranix integration a clan feature?

**Answer**: NO. Terranix is a separate tool integrated via flake-parts.

**Evidence from clan-infra**: Terranix is imported as a separate flakeModule and used independently.
Clan machines install script is called FROM terraform provisioners, not BY clan.

**Our pattern**:
```nix
# modules/terranix/base.nix
data.external.hetzner-api-token = {
  program = [ ... "clan secrets get hetzner-api-token" ... ];
};
```

Terranix USES clan secrets, but terranix itself is outside clan.

### Home-Manager Integration

**Question**: Does clan manage home-manager configurations?

**Answer**: NO. Home-manager is integrated as a NixOS/nix-darwin module, not a clan feature.

**Evidence**:
- Clan-infra doesn't use home-manager extensively
- test-clan uses home-manager via `darwinModules.home-manager`
- Home configs defined in `modules/home/`, not `modules/clan/`

**Key insight**: When you run `clan machines update`, home-manager activates as part of system activation, but clan doesn't know about home-manager specifically.

### Service Definitions

**Question**: Are clan services the same as NixOS services?

**Answer**: NO. Clan services are ORCHESTRATION abstractions over NixOS services.

**Evidence from clan docs** (`add-services.md`):
> A service in clan is a self-contained, reusable unit of system configuration that provides a specific piece of functionality across one or more machines.

Clan services:
- Define roles (controller, peer, etc.)
- Map machines to roles
- Coordinate multi-machine deployments

NixOS services:
- Configure actual system services (systemd units, config files)
- Defined in `services.*` options

**Example**:
```nix
# Clan service (orchestration)
inventory.instances.zerotier = {
  roles.controller.machines."cinnabar" = { };
  roles.peer.tags.all = { };
};

# This generates NixOS service config on each machine
# But the NixOS service itself is defined elsewhere
```

### Zerotier Coordination

**Question**: Does clan provide the zerotier service or just coordinate it?

**Answer**: Clan provides SERVICE ORCHESTRATION via inventory roles.

**Evidence from our implementation**:
```nix
# modules/clan/inventory/services/zerotier.nix
inventory.instances.zerotier = {
  roles.controller.machines = { "cinnabar" = { }; };
  roles.peer.machines = { /* ... */ };
};
```

Clan assigns roles and coordinates multi-machine zerotier deployment.
The actual zerotier NixOS service is provided by nixpkgs `services.zerotierone`.

---

## 5. Common Misconceptions

### Misconception 1: "Clan manages infrastructure provisioning"

**Reality**: Clan deploys to infrastructure, it doesn't provision infrastructure.

Terranix/terraform create VMs, networks, DNS records.
Clan installs NixOS and deploys configurations to those resources.

### Misconception 2: "Clan replaces home-manager"

**Reality**: Clan coordinates machine deployments which may include home-manager.

Home-manager configurations are defined outside clan.
Clan's `machines update` deploys the full machine config including home-manager.

### Misconception 3: "Clan secrets replace sops-nix"

**Reality**: Clan vars are system-level generated secrets, sops-nix handles user-level manually-created secrets.

Two-tier architecture:
- Tier 1 (clan vars): SSH keys, zerotier IDs, LUKS passphrases
- Tier 2 (sops-nix): GitHub tokens, API keys, user credentials

### Misconception 4: "Clan provides NixOS services"

**Reality**: Clan orchestrates deployment of NixOS services across machines.

Clan inventory assigns machines to service roles.
NixOS modules define the actual service configuration.

### Misconception 5: "Dendritic flake-parts is a clan feature"

**Reality**: Dendritic is a flake-parts pattern, independent of clan.

Clan is ONE flake-parts module imported alongside others.
Dendritic provides auto-discovery for ALL modules, not just clan.

---

## 6. Documentation Recommendations for Story 8.2

### Architecture Documentation Should Explain

1. **Clan as coordination layer**:
   - Clan sits between flake-parts (outer framework) and NixOS/nix-darwin (inner system)
   - Clan coordinates multi-machine deployments, doesn't replace system configuration

2. **Clear boundaries**:
   - Infrastructure provisioning: Terranix (outside clan)
   - User environments: Home-manager (outside clan, deployed by clan)
   - User secrets: sops-nix (outside clan, parallel to clan vars)
   - System configuration: NixOS/nix-darwin modules (outside clan, imported by clan)
   - Nixpkgs config: Flake-level nixpkgs (outside clan, provided to clan)

3. **Integration patterns**:
   - Terranix → creates infrastructure → clan deploys to it
   - Clan machines → imports system configs → includes home-manager
   - Clan vars → generates system secrets → sops-nix handles user secrets

4. **Service orchestration vs. service implementation**:
   - Clan inventory: Which machines run which services
   - NixOS modules: How services are actually configured
   - Clan doesn't provide services, it coordinates them

### Key Concepts to Emphasize

**Clan is an orchestration framework, not a replacement framework.**

Analogy: Kubernetes orchestrates containers but doesn't replace Docker.
Clan orchestrates NixOS deployments but doesn't replace NixOS modules.

**Two-tier secrets architecture**:
- System tier (clan vars): Generated, machine-specific
- User tier (sops-nix): Manual, user-specific

**Dendritic + clan are orthogonal**:
- Dendritic: Module organization pattern (applies to all modules)
- Clan: Multi-machine coordination (one module among many)

### Documentation Structure Suggestions

```
## Architecture Overview
- Flake-parts framework
  - Clan module (multi-machine coordination)
  - Terranix module (infrastructure provisioning)
  - Other modules (formatting, checks, etc.)

## What Clan Manages
- Machine inventory and deployment
- Service orchestration across machines
- System-level secret generation (clan vars)
- Deployment tooling (install, update)

## What Clan Does NOT Manage
- Infrastructure provisioning (terranix)
- User environments (home-manager)
- User secrets (sops-nix)
- System configuration (nixos/nix-darwin modules)
- Package overlays (nixpkgs modules)

## Integration Patterns
- [Detailed patterns for each integration point]

## Common Questions
- [Address misconceptions directly]
```

---

## 7. Clan Capabilities vs. Our Usage Matrix

| Capability | Clan Provides | We Use | Notes |
|------------|---------------|--------|-------|
| Machine definitions | ✓ | ✓ | `clan.machines.*` |
| Inventory system | ✓ | ✓ | `clan.inventory.*` |
| Service orchestration | ✓ | ✓ | Zerotier, tor, internet, users |
| Vars/generators | ✓ | ✓ | SSH keys, zerotier IDs, LUKS passphrases |
| Deployment tools | ✓ | ✓ | `clan machines install/update` |
| Secrets encryption | ✓ | ✓ | Via vars system (tier 1) |
| Infrastructure provisioning | ✗ | Terranix | Clan deploys TO infrastructure |
| User environments | ✗ | Home-manager | Deployed WITH clan, not BY clan |
| User secrets | ✗ | sops-nix | Tier 2 secrets architecture |
| System services | ✗ | NixOS modules | Clan orchestrates, doesn't define |
| Nixpkgs config | ✗ | Flake-level | Provided TO clan via pkgsForSystem |
| VM testing | ✓ | Partial | Available but not heavily used |
| Backup services | ✓ | Not yet | Available for future use |

---

## 8. References

### Primary Sources
- `/Users/crs58/projects/nix-workspace/clan-core/README.md`
- `/Users/crs58/projects/nix-workspace/clan-core/docs/site/getting-started/add-machines.md`
- `/Users/crs58/projects/nix-workspace/clan-core/docs/site/getting-started/add-services.md`
- `/Users/crs58/projects/nix-workspace/clan-core/docs/site/guides/vars/vars-overview.md`
- `/Users/crs58/projects/nix-workspace/clan-core/docs/site/guides/vars/vars-concepts.md`
- `/Users/crs58/projects/nix-workspace/clan-core/docs/site/guides/flake-parts.md`

### Implementation References
- `/Users/crs58/projects/nix-workspace/clan-infra/` - Production clan usage
- `/Users/crs58/projects/nix-workspace/test-clan/` - Our validation implementation
- `/Users/crs58/projects/nix-workspace/infra/` - Migration target

### Architecture Documentation
- `/Users/crs58/projects/nix-workspace/test-clan/docs/architecture/secrets-and-vars-architecture.md`
- `/Users/crs58/projects/nix-workspace/test-clan/docs/architecture/dendritic-pattern.md`

---

## Conclusion

Clan is a **multi-machine coordination and deployment framework**.
It manages the orchestration layer (which machines run which services) but NOT the implementation layer (how those services are configured).

Infrastructure provisioning (terranix), user environments (home-manager), user secrets (sops-nix), and system configuration (nixos/nix-darwin) are all OUTSIDE clan's scope but integrated WITH clan deployments.

This research should inform Story 8.2 documentation to clearly communicate:
1. What clan is (coordination framework)
2. What clan manages (inventory, deployment, system secrets)
3. What clan doesn't manage (infra, users, user secrets, system config)
4. How clan integrates with other tools (terranix, home-manager, sops-nix)

The key mental model: **Clan orchestrates NixOS deployments across machines; it doesn't replace the underlying NixOS ecosystem.**
