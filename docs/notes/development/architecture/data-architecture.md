# Data Architecture

## Clan Vars Storage Structure

**Machine-Scoped Secrets** (default):
```
sops/machines/<machine-name>/
├── secrets/                    # Encrypted secrets (age encryption)
│   ├── zerotier-identity-secret
│   ├── openssh.id_ed25519
│   ├── ssh-key-crs58.id_ed25519      # Per-user secret (naming convention)
│   └── ssh-key-raquel.id_ed25519
└── facts/                      # Public facts (unencrypted)
    ├── zerotier-ip             # IPv6 address in zerotier network
    ├── zerotier-network-id     # Network ID for peers to join
    └── openssh.id_ed25519.pub  # SSH public host key
```

**Shared Secrets** (`share = true` in generator):
```
sops/shared/<generator-name>/
├── openssh-ca.id_ed25519           # SSH CA private key (shared across all machines)
└── openssh-ca.id_ed25519.pub       # SSH CA public key
```

**Terraform State** (git-ignored, sensitive):
```
terraform/
├── terraform.tfstate           # Current infrastructure state
├── terraform.tfstate.backup    # Previous state (automatic backup)
└── .terraform/                 # Provider plugins and modules
```

## Inventory Data Model

**Machine Definition**:
```nix
{
  machineName = {
    tags = [ "platform" "environment" "role" ];  # Tag-based categorization
    machineClass = "nixos" | "darwin";            # Platform type
    installedAt = <timestamp>;                    # Installation timestamp (clan-managed)
  };
}
```

**Service Instance Definition**:
```nix
{
  instanceName = {
    module = {
      name = "service-name";        # Service module name (e.g., "zerotier")
      input = "clan-core" | "self"; # Flake input providing module
    };
    roles = {
      roleName = {
        machines = { machineName = { settings = {}; }; };  # Explicit machine assignment
        tags."tagName" = { settings = {}; };               # Tag-based assignment
        settings = {};                                      # Role-wide settings
      };
    };
    settings = {};  # Instance-wide settings
  };
}
```

**Configuration Hierarchy** (instance → role → machine):
1. Instance-wide settings apply to all roles
2. Role-wide settings override instance settings
3. Machine-specific settings override role settings

## Hardware Configuration Data

**NixOS Hardware** (generated by nixos-generate-config):
```nix
# machines/nixos/cinnabar/hardware-configuration.nix
{
  boot.initrd.availableKernelModules = [ "xhci_pci" "virtio_pci" "virtio_scsi" "sd_mod" ];
  boot.kernelModules = [ "kvm-amd" ];

  # Disko-managed, included for reference only
  fileSystems."/" = {
    device = "/dev/disk/by-label/zfs";
    fsType = "zfs";
  };

  # Platform
  nixpkgs.hostPlatform = "x86_64-linux";
}
```

**Darwin Hardware** (manual specification):
```nix
# machines/darwin/blackphos/default.nix
{
  # Platform
  nixpkgs.hostPlatform = "aarch64-darwin";

  # macOS-specific settings
  system.stateVersion = 5;
  networking.computerName = "blackphos";
  networking.localHostName = "blackphos";
}
```
