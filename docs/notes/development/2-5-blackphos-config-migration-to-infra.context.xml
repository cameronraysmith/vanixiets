<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>5</storyId>
    <title>Blackphos config migration to infra</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/2-5-blackphos-config-migration-to-infra.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>validate blackphos configuration in infra after Story 2.3 migration</iWant>
    <soThat>blackphos can be confidently deployed from the production infra repository with verified feature parity</soThat>
    <tasks>
      <task id="1" title="Build Validation" ac="1">
        <subtask>Execute darwin build command: nix build .#darwinConfigurations.blackphos.system</subtask>
        <subtask>Verify exit code 0</subtask>
        <subtask>Verify ./result symlink created</subtask>
        <subtask>Document build time and any warnings</subtask>
      </task>
      <task id="2" title="Package Validation" ac="2">
        <subtask>Extract derivation count from darwin build</subtask>
        <subtask>Build raquel home-manager configuration (expect 105 derivations)</subtask>
        <subtask>Verify raquel baseline packages present (gh, just, ripgrep, fd, bat, eza)</subtask>
        <subtask>Document any differences from Epic 1 baseline</subtask>
      </task>
      <task id="3" title="Zerotier Validation" ac="3">
        <subtask>Review modules/machines/darwin/blackphos/_zerotier.nix</subtask>
        <subtask>Verify network ID: db4344343b14b903</subtask>
        <subtask>Verify activation script syntax</subtask>
        <subtask>Verify homebrew cask: zerotier-one</subtask>
        <subtask>Document zerotier join workflow for Story 2.7</subtask>
      </task>
      <task id="4" title="Secrets Validation" ac="4">
        <subtask>Verify secrets file exists: secrets/home-manager/users/raquel/secrets.yaml</subtask>
        <subtask>Test decryption: sops -d secrets/home-manager/users/raquel/secrets.yaml</subtask>
        <subtask>Count and verify 5 secrets (github-token, ssh-signing-key, ssh-public-key, bitwarden-email, atuin-key)</subtask>
        <subtask>Verify sops.templates.allowed_signers in raquel module</subtask>
      </task>
      <task id="5" title="Configuration Evaluation" ac="5">
        <subtask>Execute nix eval command on darwin configuration</subtask>
        <subtask>Verify no errors and JSON output received</subtask>
        <subtask>Check for evaluation warnings</subtask>
        <subtask>Document any evaluation issues</subtask>
      </task>
      <task id="6" title="Darwin Features Validation" ac="6">
        <subtask>Verify aarch64-darwin platform</subtask>
        <subtask>Verify crs58 primary user (homebrew management)</subtask>
        <subtask>Verify TouchID sudo enabled</subtask>
        <subtask>Verify SSH MaxAuthTries 20 (Bitwarden workaround)</subtask>
        <subtask>Verify zsh enabled system-wide</subtask>
        <subtask>Verify documentation enabled</subtask>
      </task>
      <task id="7" title="Documentation and Commit" ac="7">
        <subtask>Complete Dev Notes with validation results</subtask>
        <subtask>Add references to Epic 1 Stories 1.8, 1.12</subtask>
        <subtask>Document zerotier darwin pattern for Story 2.6 reuse</subtask>
        <subtask>Update sprint-status.yaml (drafted → review)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1" title="Configuration Builds Successfully">
      <description>Verify blackphos darwin configuration builds without errors</description>
      <verification>nix build .#darwinConfigurations.blackphos.system - exit code 0, ./result symlink created</verification>
    </ac>
    <ac id="2" title="Zero-Regression Package Validation">
      <description>Verify package counts match Epic 1 baseline with no regressions</description>
      <verification>Darwin derivation count ~270, raquel HM 105 derivations, baseline packages present</verification>
    </ac>
    <ac id="3" title="Zerotier Darwin Integration Validated">
      <description>Verify zerotier configuration is correct for darwin platform</description>
      <verification>Network ID db4344343b14b903, homebrew cask zerotier-one, activation script present</verification>
    </ac>
    <ac id="4" title="raquel User Secrets Present and Accessible">
      <description>Verify raquel's 5 secrets are properly encrypted with infra age keys</description>
      <verification>sops -d succeeds, 5 secrets present (github-token, ssh-signing-key, ssh-public-key, bitwarden-email, atuin-key)</verification>
    </ac>
    <ac id="5" title="Configuration Evaluation Succeeds">
      <description>Verify nix evaluation completes without module resolution errors</description>
      <verification>nix eval .#darwinConfigurations.blackphos.config.system.build.toplevel --json succeeds</verification>
    </ac>
    <ac id="6" title="Darwin-Specific Features Validated">
      <description>Verify darwin-specific configuration settings are correct</description>
      <verification>Platform aarch64-darwin, primaryUser crs58, TouchID enabled, MaxAuthTries 20, zsh enabled, docs enabled</verification>
    </ac>
    <ac id="7" title="Documentation Complete for Story 2.6 Handoff">
      <description>Document validation results and prepare for Story 2.6 (stibnite) which uses blackphos as template</description>
      <verification>Dev Notes complete, Epic 1 cross-references, zerotier pattern documented, Story 2.6 guidance present</verification>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/notes/development/epics/epic-2-infrastructure-architecture-migration.md</path>
        <title>Epic 2: Infrastructure Architecture Migration</title>
        <section>Story 2.5 Definition (lines 138-155)</section>
        <snippet>Story definition: migrate blackphos config from test-clan to infra, validate 270 packages, zerotier darwin integration, raquel user config. Strategy: "Rip the Band-Aid" - copy validated patterns from test-clan.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-8-migrate-blackphos-from-infra-to-test-clan.md</path>
        <title>Story 1.8: Migrate blackphos from infra to test-clan</title>
        <section>Complete story - original migration patterns</section>
        <snippet>Dendritic pattern validated for darwin. Multi-user config (crs58 admin, raquel primary). Home-manager integrated via darwinModules. 270 packages preserved. Zero regressions. Pattern documented for Epic 2-6 reuse.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-12-deploy-blackphos-zerotier-integration.md</path>
        <title>Story 1.12: Deploy blackphos and Integrate into Zerotier Network</title>
        <section>Complete story - zerotier darwin pattern, physical deployment</section>
        <snippet>First physical deployment in Epic 1. Zerotier darwin via homebrew cask + activation script. Network ID db4344343b14b903. 3+ weeks production stability. Heterogeneous networking validated (nixos ↔ nix-darwin).</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/2-3-wholesale-migration-test-clan-to-infra.md</path>
        <title>Story 2.3: Wholesale migration from test-clan to infra</title>
        <section>Predecessor - source of blackphos configuration</section>
        <snippet>Configuration wholesale migration complete. All dendritic modules, clan config, preserved components migrated. blackphos darwin config exists at modules/machines/darwin/blackphos/.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/2-4-home-manager-secrets-migration.md</path>
        <title>Story 2.4: Home-manager secrets migration</title>
        <section>Predecessor - secrets re-encrypted</section>
        <snippet>raquel's 5 secrets re-encrypted with infra age keys. Correct sops command: sops updatekeys -y. Build validation passed. Secret count: 5 (includes ssh-public-key for allowed_signers).</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/architecture/deployment-architecture.md</path>
        <title>Deployment Architecture</title>
        <section>Darwin Deployment</section>
        <snippet>Darwin deployment workflow: darwin-rebuild switch --flake .#blackphos. Initial setup requires clan inventory registration and vars generation. Post-deployment validation checklist documented.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/sprint-status.yaml</path>
        <title>Sprint Status</title>
        <section>story-2-5 entry (line 371)</section>
        <snippet>story-2-5: drafted. Validation story (NOT implementation) - config exists from Story 2.3. 7 ACs covering: build, packages, zerotier, secrets, eval, darwin features, docs.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>modules/machines/darwin/blackphos/default.nix</path>
        <kind>darwin-module</kind>
        <symbol>flake.modules.darwin."machines/darwin/blackphos"</symbol>
        <lines>1-217</lines>
        <reason>Primary blackphos darwin configuration - all 7 ACs validate this file</reason>
      </artifact>
      <artifact>
        <path>modules/machines/darwin/blackphos/_zerotier.nix</path>
        <kind>darwin-module</kind>
        <symbol>zerotier activation script</symbol>
        <lines>1-100</lines>
        <reason>AC3 validation target - zerotier network join via homebrew cask + activation script</reason>
      </artifact>
      <artifact>
        <path>modules/home/users/raquel/default.nix</path>
        <kind>home-manager-module</kind>
        <symbol>flake.modules.homeManager."users/raquel"</symbol>
        <lines>1-65</lines>
        <reason>AC4 validation target - raquel home-manager with sops-nix secrets integration</reason>
      </artifact>
      <artifact>
        <path>secrets/home-manager/users/raquel/secrets.yaml</path>
        <kind>secrets-file</kind>
        <symbol>raquel sops-encrypted secrets</symbol>
        <lines>1-38</lines>
        <reason>AC4 validation target - 5 secrets encrypted with infra age keys</reason>
      </artifact>
      <artifact>
        <path>modules/clan/machines.nix</path>
        <kind>clan-config</kind>
        <symbol>clan.machines.blackphos</symbol>
        <lines>20-22</lines>
        <reason>blackphos clan machine registration - imports darwin module</reason>
      </artifact>
      <artifact>
        <path>modules/clan/inventory/machines.nix</path>
        <kind>clan-config</kind>
        <symbol>clan.inventory.machines.blackphos</symbol>
        <lines>42-50</lines>
        <reason>blackphos inventory entry - tags: darwin, workstation, laptop</reason>
      </artifact>
      <artifact>
        <path>.sops.yaml</path>
        <kind>sops-config</kind>
        <symbol>home-manager encryption rules</symbol>
        <lines>50-64</lines>
        <reason>AC4 - encryption rules for raquel secrets (raquel-user age key)</reason>
      </artifact>
      <artifact>
        <path>modules/darwin/</path>
        <kind>directory</kind>
        <symbol>flake.modules.darwin.base</symbol>
        <lines>directory</lines>
        <reason>Base darwin modules imported by blackphos (ssh-known-hosts, homebrew, etc.)</reason>
      </artifact>
    </code>
    <dependencies>
      <dep>
        <ecosystem>nix-flake</ecosystem>
        <name>nix-darwin</name>
        <usage>Darwin system configuration via inputs.nix-darwin.lib.darwinSystem</usage>
      </dep>
      <dep>
        <ecosystem>nix-flake</ecosystem>
        <name>home-manager</name>
        <usage>User environment management via inputs.home-manager.darwinModules.home-manager</usage>
      </dep>
      <dep>
        <ecosystem>nix-flake</ecosystem>
        <name>sops-nix</name>
        <usage>Secrets management - raquel secrets decryption via sops module</usage>
      </dep>
      <dep>
        <ecosystem>nix-flake</ecosystem>
        <name>clan-core</name>
        <usage>Machine inventory, vars generation, service instances</usage>
      </dep>
      <dep>
        <ecosystem>nix-flake</ecosystem>
        <name>srvos</name>
        <usage>Server hardening patterns via inputs.srvos.darwinModules.server</usage>
      </dep>
      <dep>
        <ecosystem>nix-flake</ecosystem>
        <name>lazyvim-nix</name>
        <usage>LazyVim home-manager module for raquel</usage>
      </dep>
      <dep>
        <ecosystem>nix-flake</ecosystem>
        <name>nix-index-database</name>
        <usage>Command-not-found via comma for raquel</usage>
      </dep>
      <dep>
        <ecosystem>homebrew</ecosystem>
        <name>zerotier-one</name>
        <usage>Zerotier network via homebrew cask (darwin zerotier pattern)</usage>
      </dep>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="validation-only">Story 2.5 is a VALIDATION story - all code already exists from Story 2.3. No implementation required, only verification against 7 acceptance criteria.</constraint>
    <constraint type="predecessor">Story 2.3 (done) - wholesale migration source. Story 2.4 (done) - secrets re-encrypted with infra age keys.</constraint>
    <constraint type="successor">Story 2.6 (backlog) - stibnite uses blackphos as template. Story 2.7 (backlog) - physical deployment requires Story 2.5 validation pass.</constraint>
    <constraint type="zero-regression">Package counts must match Epic 1 baseline: ~270 darwin packages, 105 raquel HM packages. No functionality loss from test-clan.</constraint>
    <constraint type="zerotier-network">Network ID db4344343b14b903 (cinnabar controller). blackphos is peer. Homebrew cask + activation script pattern (no native nix-darwin zerotier module).</constraint>
    <constraint type="secrets-architecture">Two-tier secrets: System-level (clan vars) + user-level (sops-nix). raquel uses sops-nix with infra age keys.</constraint>
    <constraint type="machine-context">blackphos: nix-darwin (aarch64-darwin), raquel primary user (UID 506), crs58 admin (UID 502), zerotier peer</constraint>
    <constraint type="production-stability">Epic 1 Story 1.12 validated 3+ weeks production stability on blackphos. Zero regressions expected.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>darwinConfigurations.blackphos</name>
      <kind>nix-flake-output</kind>
      <signature>darwinConfigurations.blackphos.system</signature>
      <path>flake.nix (via clan + dendritic modules)</path>
    </interface>
    <interface>
      <name>homeConfigurations.aarch64-darwin.raquel</name>
      <kind>nix-flake-output</kind>
      <signature>homeConfigurations.aarch64-darwin.raquel.activationPackage</signature>
      <path>modules/flake-parts/configurations.nix</path>
    </interface>
    <interface>
      <name>clan.machines.blackphos</name>
      <kind>clan-machine</kind>
      <signature>clan.machines.blackphos.imports</signature>
      <path>modules/clan/machines.nix:20-22</path>
    </interface>
    <interface>
      <name>sops.secrets (raquel)</name>
      <kind>sops-nix</kind>
      <signature>sops.secrets.{github-token,ssh-signing-key,ssh-public-key,bitwarden-email,atuin-key}</signature>
      <path>modules/home/users/raquel/default.nix:22-32</path>
    </interface>
    <interface>
      <name>sops.templates.allowed_signers</name>
      <kind>sops-nix-template</kind>
      <signature>sops.templates."allowed_signers".path</signature>
      <path>modules/home/users/raquel/default.nix:36-42</path>
    </interface>
    <interface>
      <name>system.activationScripts.zerotierJoin</name>
      <kind>darwin-activation</kind>
      <signature>system.activationScripts.zerotierJoin.text</signature>
      <path>modules/machines/darwin/blackphos/_zerotier.nix:96-99</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <paragraph>This is a validation story - tests are the acceptance criteria verification commands themselves. Each AC specifies exact validation commands (nix build, sops -d, grep, nix eval). No unit tests required - AC verification IS the test. Pattern from Epic 1 Story 1.12: empirical validation via command execution and manual verification.</paragraph>
    </standards>
    <locations>
      <location>Story file AC verification commands (docs/notes/development/work-items/2-5-blackphos-config-migration-to-infra.md)</location>
      <location>modules/checks/ (if automated validation tests exist - Story 1.6 test harness)</location>
    </locations>
    <ideas>
      <idea ac="1">Execute nix build .#darwinConfigurations.blackphos.system - verify exit 0 and result symlink</idea>
      <idea ac="2">Execute nix build .#homeConfigurations.aarch64-darwin.raquel.activationPackage --dry-run - verify 105 derivations</idea>
      <idea ac="2">grep baseline packages in modules/home/users/raquel/default.nix (gh, just, ripgrep, fd, bat, eza)</idea>
      <idea ac="3">grep db4344343b14b903 in _zerotier.nix - verify network ID</idea>
      <idea ac="3">grep zerotier-one in homebrew.casks - verify cask present</idea>
      <idea ac="3">head -50 _zerotier.nix - verify activation script structure</idea>
      <idea ac="4">Execute sops -d secrets/home-manager/users/raquel/secrets.yaml - verify decryption succeeds</idea>
      <idea ac="4">Count secret keys (expect 5): github-token, ssh-signing-key, ssh-public-key, bitwarden-email, atuin-key</idea>
      <idea ac="5">Execute nix eval .#darwinConfigurations.blackphos.config.system.build.toplevel --json - verify no errors</idea>
      <idea ac="6">grep aarch64-darwin, primaryUser, touchIdAuth, MaxAuthTries, zsh.enable, documentation.enable in default.nix</idea>
      <idea ac="7">Verify Dev Notes section complete, Epic 1 references present, Story 2.6 guidance documented</idea>
    </ideas>
  </tests>

  <epicContext>
    <epicRef>docs/notes/development/epics/epic-2-infrastructure-architecture-migration.md</epicRef>
    <epicTitle>Epic 2: Infrastructure Architecture Migration</epicTitle>
    <phase>Phase 2: Active Darwin Workstations</phase>
    <storyPosition>First story in Phase 2 (Stories 2.5-2.8)</storyPosition>
    <previousStories>
      <story id="2.1" status="done">Identify infra-specific components to preserve</story>
      <story id="2.2" status="done">Prepare clan-01 branch for migration</story>
      <story id="2.3" status="done">Wholesale migration from test-clan to infra</story>
      <story id="2.4" status="done">Home-manager secrets migration</story>
    </previousStories>
    <nextStories>
      <story id="2.6" status="backlog">Stibnite config migration (uses blackphos as template)</story>
      <story id="2.7" status="backlog">Activate blackphos and stibnite from infra</story>
    </nextStories>
  </epicContext>

  <machineContext>
    <machine>blackphos</machine>
    <platform>nix-darwin (aarch64-darwin)</platform>
    <primaryUser>raquel (UID 506)</primaryUser>
    <adminUser>crs58 (UID 502)</adminUser>
    <networkRole>zerotier peer (controller: cinnabar)</networkRole>
    <zerotierNetwork>db4344343b14b903</zerotierNetwork>
    <packageCounts>
      <darwin>~270 packages (Epic 1 baseline)</darwin>
      <raquelHM>105 derivations</raquelHM>
    </packageCounts>
  </machineContext>

  <validationFocus>
    <note>This is a VALIDATION story, not implementation. All configuration already exists from Story 2.3 wholesale migration. Story 2.5 systematically verifies 7 acceptance criteria before Story 2.7 physical deployment.</note>
    <ac1>Darwin build succeeds without errors</ac1>
    <ac2>Package counts match Epic 1 (~270 darwin, 105 raquel HM packages)</ac2>
    <ac3>Zerotier network ID db4344343b14b903, homebrew cask, activation script</ac3>
    <ac4>raquel 5 secrets decrypt (github-token, ssh-signing-key, ssh-public-key, bitwarden-email, atuin-key)</ac4>
    <ac5>Nix eval succeeds without errors</ac5>
    <ac6>Darwin features (TouchID, SSH MaxAuthTries 20, zsh, documentation enabled)</ac6>
    <ac7>Documentation for Story 2.6 handoff (stibnite uses blackphos as template)</ac7>
  </validationFocus>
</story-context>
