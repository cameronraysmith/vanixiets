<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>Epic 1</epicId>
    <storyId>1.10E</storyId>
    <title>Enable Remaining Features Using sops-nix Secrets and Flake Inputs</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-10e-enable-remaining-features.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>enable the remaining 3 disabled home-manager features using flake.inputs (for packages/themes) and custom packages (from Story 1.10D)</iWant>
    <soThat>all production features are functional in test-clan demonstrating complete integration of sops-nix secrets + flake.inputs + custom packages</soThat>
    <tasks>
      <taskGroup id="1" name="Document Story 1.10C Implementations (AC-A, AC-B, AC-C)" effort="30 minutes">
        <task id="1.1">Review Story 1.10C SSH signing implementation (AC-A)</task>
        <task id="1.2">Review Story 1.10C MCP server implementation (AC-B)</task>
        <task id="1.3">Review Story 1.10C GLM wrapper implementation (AC-C)</task>
        <task id="1.4">Review Story 1.10C bonus features (Additional Documentation)</task>
      </taskGroup>
      <taskGroup id="2" name="Enable Remaining Features (AC-D, AC-E, AC-F)" effort="90 minutes">
        <task id="2.1">Add nix-ai-tools flake input (AC-D.1)</task>
        <task id="2.2">Enable claude-code package override (AC-D.2)</task>
        <task id="2.3">Add catppuccin-nix flake input (AC-E.1)</task>
        <task id="2.4">Enable catppuccin tmux theme (AC-E.2)</task>
        <task id="2.5">Enable ccstatusline feature (AC-F)</task>
      </taskGroup>
      <taskGroup id="3" name="Validate and Document (AC-G, AC-H)" effort="60 minutes">
        <task id="3.1">Build all configurations (AC-G.1)</task>
        <task id="3.2">Validate new features (AC-G.2)</task>
        <task id="3.3">Regression testing (AC-G.3)</task>
        <task id="3.4">Create Section 13 structure (AC-H.1)</task>
        <task id="3.5">Document Section 13.1 - sops-nix patterns (AC-H.2)</task>
        <task id="3.6">Document Section 13.2 - flake.inputs patterns (AC-H.3)</task>
        <task id="3.7">Document Section 13.3 - custom packages (AC-H.4)</task>
        <task id="3.8">Document Section 13.4 - features summary (AC-H.5)</task>
        <task id="3.9">Document Section 13.5 - build validation (AC-H.6)</task>
        <task id="3.10">Document Section 13.6 - Epic 2-6 migration guide (AC-H.7)</task>
        <task id="3.11">Verify Section 13 quality (AC-H.8)</task>
      </taskGroup>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-A" title="Document Story 1.10C SSH Signing Implementation (COMPLETED)" status="documentation-only">
      <description>Document git and jujutsu SSH signing feature enablement using sops-nix direct path pattern</description>
      <implementation>
        <feature>Git SSH signing (git.nix:24-28, commit f9e9e92)</feature>
        <feature>Jujutsu SSH signing (jujutsu.nix:41, commit 04c1617)</feature>
        <pattern>Pattern 1: Direct Path Access - config.sops.secrets.ssh-signing-key.path</pattern>
        <validation>
          <command>nix eval .#homeConfigurations.crs58.config.programs.git.signing.key</command>
          <expected>/run/user/1000/secrets/ssh-signing-key</expected>
        </validation>
        <validation>
          <command>nix eval .#homeConfigurations.crs58.config.programs.jujutsu.settings.user.signing-key</command>
          <expected>/run/user/1000/secrets/ssh-signing-key</expected>
        </validation>
        <validation>
          <command>nix build .#homeConfigurations.crs58.activationPackage</command>
          <expected>build succeeds</expected>
        </validation>
      </implementation>
      <documentation>
        <section>Section 13.1 Pattern 1 (Direct Path Access)</section>
        <content>Pattern overview, code examples (git.nix, jujutsu.nix), validation commands, use cases (SSH signing, GPG keys, certificates)</content>
        <effort>10 min (documentation only, feature already validated)</effort>
      </documentation>
    </criterion>

    <criterion id="AC-B" title="Document Story 1.10C MCP Server Implementation (COMPLETED)" status="documentation-only">
      <description>Document MCP server API key enablement using sops-nix templates + placeholders pattern</description>
      <implementation>
        <feature>Firecrawl API key (mcp-servers.nix:34-52, commit c63b61e)</feature>
        <feature>HuggingFace token (mcp-servers.nix:56-73, commit c63b61e)</feature>
        <pattern>Pattern 2: sops.templates with Placeholders - config.sops.placeholder."secret-name"</pattern>
        <validation>
          <command>nix eval .#homeConfigurations.crs58.config.sops.templates.mcp-firecrawl.content</command>
          <expected>JSON with FIRECRAWL_API_KEY placeholder</expected>
        </validation>
        <validation>
          <command>nix eval .#homeConfigurations.crs58.config.sops.templates.mcp-huggingface.content</command>
          <expected>JSON with Authorization Bearer placeholder</expected>
        </validation>
        <validation>
          <command>nix build .#homeConfigurations.crs58.activationPackage</command>
          <expected>build succeeds</expected>
        </validation>
      </implementation>
      <documentation>
        <section>Section 13.1 Pattern 2 (sops.templates with Placeholders)</section>
        <content>Pattern overview, code examples (firecrawl, huggingface), validation commands, use cases (MCP servers, application configs, API keys in JSON/TOML/YAML)</content>
        <effort>10 min (documentation only, features already validated)</effort>
      </documentation>
    </criterion>

    <criterion id="AC-C" title="Document Story 1.10C GLM Wrapper Implementation (COMPLETED)" status="documentation-only">
      <description>Document GLM wrapper enablement using sops-nix runtime cat pattern</description>
      <implementation>
        <feature>GLM wrapper (wrappers.nix:23-44, commit f6b01e3)</feature>
        <pattern>Pattern 3: Runtime Cat in Shell Scripts - $(cat ${config.sops.secrets.X.path})</pattern>
        <validation>
          <command>nix eval .#homeConfigurations.crs58.config.home.packages</command>
          <expected>includes claude-glm shell application</expected>
        </validation>
        <validation>
          <command>nix build .#homeConfigurations.crs58.activationPackage</command>
          <expected>build succeeds</expected>
        </validation>
        <validation type="runtime">
          <description>Activate homeConfiguration, run: claude-glm --version</description>
          <expected>claude CLI executes with GLM API key set</expected>
        </validation>
      </implementation>
      <documentation>
        <section>Section 13.1 Pattern 3 (Runtime Cat in Shell Scripts)</section>
        <content>Pattern overview, code example (GLM wrapper), validation commands (build + runtime), use cases (API key wrappers, proxy authentication, credential injection)</content>
        <effort>10 min (documentation only, feature already validated)</effort>
      </documentation>
    </criterion>

    <criterion id="AC-D" title="Enable claude-code Package Override" status="implementation-required">
      <description>Enable claude-code package from nix-ai-tools flake input (Pattern 5: flake.inputs package override)</description>
      <steps>
        <step id="1">Add nix-ai-tools flake input to flake.nix:
          inputs.nix-ai-tools = {
            url = "github:cameronraysmith/nix-ai-tools";
            inputs.nixpkgs.follows = "nixpkgs";
          };
        </step>
        <step id="2">Update flake.lock: cd ~/projects/nix-workspace/test-clan && nix flake lock</step>
        <step id="3">Uncomment package override in default.nix:24:
          programs.claude-code.package = flake.inputs.nix-ai-tools.packages.${pkgs.system}.claude-code;
        </step>
        <step id="4">Validate package override:
          nix eval .#homeConfigurations.crs58.config.programs.claude-code.package
          nix eval .#homeConfigurations.crs58.config.programs.claude-code.package.pname (expected: "claude-code")
          nix build .#homeConfigurations.crs58.config.programs.claude-code.package
        </step>
        <step id="5">Build homeConfiguration: nix build .#homeConfigurations.crs58.activationPackage</step>
        <step id="6">Document Pattern 5 in Section 13.2</step>
      </steps>
      <passCriteria>
        <item>nix-ai-tools flake input added to flake.nix</item>
        <item>flake.lock updated with nix-ai-tools dependency</item>
        <item>Package override uncommented in default.nix:24</item>
        <item>Package evaluation succeeds (derivation from nix-ai-tools)</item>
        <item>Package build succeeds</item>
        <item>homeConfiguration build succeeds</item>
        <item>Section 13.2 Pattern 5 documented with empirical evidence</item>
      </passCriteria>
      <effort>30 min</effort>
    </criterion>

    <criterion id="AC-E" title="Enable catppuccin tmux Theme" status="implementation-required">
      <description>Enable catppuccin tmux theme from catppuccin-nix flake input (Pattern 6: flake.inputs module import)</description>
      <steps>
        <step id="1">Add catppuccin-nix flake input to flake.nix:
          inputs.catppuccin-nix = {
            url = "github:catppuccin/nix";
          };
        </step>
        <step id="2">Update flake.lock: cd ~/projects/nix-workspace/test-clan && nix flake lock</step>
        <step id="3">Replace TODO in tmux.nix:40 with module import and configuration (36 lines from infra reference)</step>
        <step id="4">Validate theme configuration:
          nix eval .#homeConfigurations.crs58.config.programs.tmux.catppuccin.enable (expected: true)
          nix eval .#homeConfigurations.crs58.config.programs.tmux.catppuccin.flavor (expected: "mocha")
          nix build .#homeConfigurations.crs58.activationPackage
        </step>
        <step id="5">Visual validation (manual, post-deployment):
          - Activate homeConfiguration on test machine
          - Launch tmux session
          - Verify catppuccin mocha theme renders (blue/pink/purple/green color scheme)
          - Verify status bar modules display (directory, user, host, session)
        </step>
        <step id="6">Document Pattern 6 in Section 13.2</step>
      </steps>
      <passCriteria>
        <item>catppuccin-nix flake input added to flake.nix</item>
        <item>flake.lock updated with catppuccin-nix dependency</item>
        <item>Module import added to tmux.nix</item>
        <item>catppuccin configuration complete (flavor + extraConfig)</item>
        <item>Theme evaluation succeeds (enable=true, flavor="mocha")</item>
        <item>homeConfiguration build succeeds</item>
        <item>Visual validation checklist documented (for post-deployment testing)</item>
        <item>Section 13.2 Pattern 6 documented with empirical evidence</item>
      </passCriteria>
      <effort>45 min</effort>
    </criterion>

    <criterion id="AC-F" title="Enable ccstatusline Feature" status="implementation-required">
      <description>Enable ccstatusline status line feature using custom package from Story 1.10D (Pattern 7: custom package integration)</description>
      <prerequisites>
        <item>Package available: pkgs.ccstatusline (Story 1.10D)</item>
        <item>Settings configured: ccstatusline-settings.nix (175 lines, production-ready)</item>
      </prerequisites>
      <steps>
        <step id="1">Uncomment statusLine config in default.nix:
          programs.claude-code.settings.statusLine = {
            type = "command";
            command = "${pkgs.ccstatusline}/bin/ccstatusline";
            padding = 0;
          };
        </step>
        <step id="2">Validate package reference:
          nix eval .#homeConfigurations.crs58.config.programs.claude-code.settings.statusLine.command
          nix build .#ccstatusline
          nix eval .#ccstatusline.version
        </step>
        <step id="3">Validate settings integration:
          nix eval .#homeConfigurations.crs58.config.programs.ccstatusline-settings.segments (expected: array with 3 segments)
          nix eval .#homeConfigurations.crs58.config.programs.ccstatusline-settings.powerline_style (expected: true)
        </step>
        <step id="4">Build homeConfiguration: nix build .#homeConfigurations.crs58.activationPackage</step>
        <step id="5">Runtime validation (manual, post-deployment):
          - Activate homeConfiguration on test machine
          - Launch Claude Code CLI
          - Verify status line displays at top (3-line powerline: git branch, shell, directory)
          - Verify styling matches ccstatusline-settings.nix configuration
        </step>
        <step id="6">Regression prevention: nix build .#checks.aarch64-darwin.home-module-exports && nix build .#checks.aarch64-darwin.home-configurations-exposed</step>
        <step id="7">Document Pattern 7 in Section 13.3</step>
      </steps>
      <passCriteria>
        <item>statusLine config uncommented in default.nix</item>
        <item>Package reference evaluation succeeds</item>
        <item>ccstatusline package builds (Story 1.10D regression test)</item>
        <item>Settings configuration accessible</item>
        <item>homeConfiguration build succeeds</item>
        <item>Runtime validation checklist documented</item>
        <item>Story 1.10D checks still pass (zero regression)</item>
        <item>Section 13.3 Pattern 7 documented with empirical evidence</item>
      </passCriteria>
      <effort>15 min</effort>
    </criterion>

    <criterion id="AC-G" title="Build Validation" status="validation-required">
      <description>Validate all 4 configurations build successfully with new features enabled (zero regressions)</description>
      <buildMatrix>
        <configuration id="1">
          <name>homeConfigurations.crs58</name>
          <command>nix build .#homeConfigurations.crs58.activationPackage</command>
          <expected>build succeeds, all features configured</expected>
        </configuration>
        <configuration id="2">
          <name>homeConfigurations.raquel</name>
          <command>nix build .#homeConfigurations.raquel.activationPackage</command>
          <expected>build succeeds (inherits features via base modules)</expected>
        </configuration>
        <configuration id="3">
          <name>darwinConfigurations.blackphos</name>
          <command>nix build .#darwinConfigurations.blackphos.system</command>
          <expected>build succeeds (includes home-manager with features)</expected>
        </configuration>
        <configuration id="4">
          <name>nixosConfigurations.cinnabar</name>
          <command>nix build .#nixosConfigurations.cinnabar.config.system.build.toplevel</command>
          <expected>build succeeds (includes home-manager with features)</expected>
        </configuration>
      </buildMatrix>
      <featureValidation>
        <feature id="1" name="claude-code package override" ac="AC-D">
          <command>nix eval .#homeConfigurations.crs58.config.programs.claude-code.package.pname</command>
          <expected>"claude-code" from nix-ai-tools</expected>
        </feature>
        <feature id="2" name="catppuccin tmux theme" ac="AC-E">
          <command>nix eval .#homeConfigurations.crs58.config.programs.tmux.catppuccin.enable</command>
          <expected>true</expected>
        </feature>
        <feature id="2b" name="catppuccin tmux flavor" ac="AC-E">
          <command>nix eval .#homeConfigurations.crs58.config.programs.tmux.catppuccin.flavor</command>
          <expected>"mocha"</expected>
        </feature>
        <feature id="3" name="ccstatusline feature" ac="AC-F">
          <command>nix eval .#homeConfigurations.crs58.config.programs.claude-code.settings.statusLine.command</command>
          <expected>/nix/store/...-ccstatusline-.../bin/ccstatusline</expected>
        </feature>
      </featureValidation>
      <regressionTesting>
        <story id="1.10C" name="sops-nix secrets">
          <test>
            <command>nix eval .#homeConfigurations.crs58.config.sops.secrets.ssh-signing-key.sopsFile</command>
            <expected>path to secrets.yaml</expected>
          </test>
          <test>
            <command>nix eval .#homeConfigurations.crs58.config.programs.git.signing.key</command>
            <expected>/run/user/1000/secrets/ssh-signing-key (sops secret path)</expected>
          </test>
        </story>
        <story id="1.10D" name="pkgs-by-name custom packages">
          <test>
            <command>nix build .#checks.aarch64-darwin.home-module-exports</command>
            <expected>build succeeds</expected>
          </test>
          <test>
            <command>nix build .#checks.aarch64-darwin.home-configurations-exposed</command>
            <expected>build succeeds</expected>
          </test>
        </story>
        <story id="1.10DB" name="overlay architecture">
          <test>
            <command>nix eval .#darwinConfigurations.blackphos.pkgs.stable.hello.version</command>
            <expected>stable version (Layer 1 multi-channel)</expected>
          </test>
          <test>
            <command>nix eval .#darwinConfigurations.blackphos.pkgs.micromamba.version</command>
            <expected>stable version (Layer 2 hotfix)</expected>
          </test>
        </story>
      </regressionTesting>
      <passCriteria>
        <item>All 4 builds succeed (no evaluation errors)</item>
        <item>All 4 builds complete in reasonable time (< 10 min each)</item>
        <item>No new build failures introduced by feature enablement</item>
        <item>All new features validate successfully (AC D-F)</item>
        <item>All Story 1.10C validations pass (sops-nix working)</item>
        <item>All Story 1.10D validations pass (pkgs-by-name working)</item>
        <item>All Story 1.10DB validations pass (overlay layers working)</item>
        <item>Zero regressions from prior stories</item>
        <item>Build validation documented in Section 13.5 with evidence</item>
      </passCriteria>
      <effort>30 min</effort>
    </criterion>

    <criterion id="AC-H" title="Document Feature Enablement Patterns in Section 13" status="documentation-required">
      <description>Create comprehensive Section 13 in test-clan-validated-architecture.md documenting all 7 feature enablement patterns</description>
      <structure>
        <section id="13" title="Feature Enablement Patterns">
          <subsection id="13.1" title="sops-nix Secret Access Patterns">
            <pattern id="1" title="Direct Path Access">
              <useCase>Programs reading secret files directly</useCase>
              <example>Git/Jujutsu SSH signing</example>
              <implementation>config.sops.secrets.X.path</implementation>
              <codeExample>git.nix lines 24-28 with validation</codeExample>
            </pattern>
            <pattern id="2" title="sops.templates with Placeholders">
              <useCase>Structured config files with embedded secrets</useCase>
              <example>MCP server configs, rbw config</example>
              <implementation>config.sops.placeholder."X" in sops.templates</implementation>
              <codeExample>mcp-servers.nix with validation</codeExample>
            </pattern>
            <pattern id="3" title="Runtime Cat in Shell Scripts">
              <useCase>Shell wrappers with environment variables from secrets</useCase>
              <example>GLM wrapper</example>
              <implementation>$(cat ${config.sops.secrets.X.path})</implementation>
              <codeExample>wrappers.nix with validation</codeExample>
            </pattern>
            <pattern id="4" title="Activation Scripts">
              <useCase>Deploying secrets to non-XDG locations</useCase>
              <example>Atuin encryption key</example>
              <implementation>home.activation with install command</implementation>
              <codeExample>atuin.nix with validation</codeExample>
            </pattern>
          </subsection>
          <subsection id="13.2" title="flake.inputs Integration Patterns">
            <pattern id="5" title="Package Override">
              <useCase>Packages from external flakes</useCase>
              <example>claude-code from nix-ai-tools</example>
              <implementation>flake.inputs.X.packages.${pkgs.system}.Y</implementation>
              <codeExample>default.nix with validation</codeExample>
            </pattern>
            <pattern id="6" title="Module Import">
              <useCase>Home-manager modules from external flakes</useCase>
              <example>catppuccin theme</example>
              <implementation>imports = [ flake.inputs.X.homeManagerModules.Y ];</implementation>
              <codeExample>tmux.nix with validation</codeExample>
            </pattern>
          </subsection>
          <subsection id="13.3" title="Custom Package Integration">
            <pattern id="7" title="pkgs-by-name Custom Packages">
              <useCase>Custom derivations via pkgs-by-name</useCase>
              <example>ccstatusline</example>
              <implementation>${pkgs.X} reference to package from pkgs/by-name/</implementation>
              <codeExample>default.nix with validation</codeExample>
              <reference>Section 13.1 (Story 1.10D pkgs-by-name tutorial)</reference>
            </pattern>
          </subsection>
          <subsection id="13.4" title="Enabled Features Summary">
            <featureList>11 features total (all patterns documented)</featureList>
            <patternCoverage>4 sops-nix + 2 flake.inputs + 1 custom package</patternCoverage>
            <storyCoverage>Story 1.10C (Features 1-8), Story 1.10D (ccstatusline package), Story 1.10E (Features 9-11)</storyCoverage>
          </subsection>
          <subsection id="13.5" title="Build Validation">
            <buildCommands>All 4 configurations build commands</buildCommands>
            <featureInspection>Validation commands from AC G with expected outputs</featureInspection>
          </subsection>
          <subsection id="13.6" title="Epic 2-6 Migration Guide">
            <checklist>8-step feature enablement checklist</checklist>
            <effortEstimates>Estimated effort per pattern</effortEstimates>
            <riskAssessment>LOW (all patterns validated in Epic 1)</riskAssessment>
          </subsection>
        </section>
      </structure>
      <qualityTarget>
        <baseline>Match Story 1.10D/1.10DB Section 13 quality (9.5/10 clarity)</baseline>
        <item>Empirical examples (real code from implementation)</item>
        <item>Build validation commands with actual outputs</item>
        <item>Comprehensive tutorial (Epic 2-6 developers can execute)</item>
        <item>Production-ready guidance (9.5/10 clarity)</item>
        <item>Pattern coverage (all 7 enablement patterns documented)</item>
      </qualityTarget>
      <passCriteria>
        <item>Section 13 exists in test-clan-validated-architecture.md</item>
        <item>All 7 patterns documented with real code examples</item>
        <item>All 4 sops-nix patterns (direct path, templates, runtime cat, activation)</item>
        <item>Both flake.inputs patterns (package override, module import)</item>
        <item>Custom package pattern (pkgs-by-name integration)</item>
        <item>Build validation commands and outputs included</item>
        <item>Complete feature summary (11 features, pattern mapping)</item>
        <item>Epic 2-6 migration guide actionable</item>
        <item>Quality matches Story 1.10D/1.10DB baseline (9.5/10 clarity)</item>
        <item>Comprehensive tutorial (self-contained, production-ready)</item>
      </passCriteria>
      <effort>30 min</effort>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- PRD References -->
      <doc>
        <path>docs/notes/development/PRD/index.md</path>
        <title>infra Product Requirements Document - Table of Contents</title>
        <section>Overall project context</section>
        <snippet>Lists all PRD sections including success criteria, functional requirements, infrastructure requirements, and implementation planning for the infra migration project.</snippet>
      </doc>

      <!-- Architecture References -->
      <doc>
        <path>docs/notes/development/architecture/index.md</path>
        <title>Architecture - Table of Contents</title>
        <section>Overall architecture context</section>
        <snippet>Lists all architecture sections including architectural decisions, project structure, technology stack, implementation patterns, and deployment architecture for the dendritic + clan integration.</snippet>
      </doc>

      <!-- Epic 1 Reference -->
      <doc>
        <path>docs/notes/development/epics/epic-1-architectural-validation-migration-pattern-rehearsal-phase-0.md</path>
        <title>Epic 1: Architectural Validation + Migration Pattern Rehearsal (Phase 0)</title>
        <section>Story 1.10E (lines 1641-1838)</section>
        <snippet>Story 1.10E completes feature enablement arc by enabling remaining 3 features (claude-code, catppuccin, ccstatusline) using validated infrastructure from Stories 1.10C (sops-nix), 1.10D (pkgs-by-name), and 1.10DB (overlay architecture). 8 acceptance criteria covering documentation (AC A-C), feature enablement (AC D-F), validation (AC G), and comprehensive Section 13 (AC H). Estimated effort: 1.5-2 hours.</snippet>
      </doc>

      <!-- Story 1.10C References (sops-nix implementations) -->
      <doc>
        <path>docs/notes/development/work-items/1-10c-establish-sops-nix-secrets-home-manager.md</path>
        <title>Story 1.10C: Establish sops-nix Secrets for Home-Manager</title>
        <section>Complete story context</section>
        <snippet>DONE ✅ APPROVED ✅ (2025-11-16). Two-tier secrets architecture validated: System-level (clan vars, future) vs User-level (sops-nix, now). Implementation: 52 commits, sops.templates patterns, multi-user encryption, Pattern A integration. Module access pattern updates: git.nix, jujutsu.nix, mcp-servers.nix, wrappers.nix, atuin.nix, rbw.nix. Build validation: All 3 builds PASSED. Documentation: age-key-management.md (882 lines), Section 12 added to architecture doc (375 lines). 9/11 Story 1.10E features enabled using sops-nix patterns.</snippet>
      </doc>

      <!-- Story 1.10D References (pkgs-by-name pattern) -->
      <doc>
        <path>docs/notes/development/work-items/1-10d-validate-custom-package-overlays.md</path>
        <title>Story 1.10D: Validate Custom Package Overlays with pkgs-by-name Pattern</title>
        <section>Complete story context and Section 13.1</section>
        <snippet>DONE ✅ APPROVED ✅ (2025-11-16). Validates infra's custom package overlay pattern works with dendritic flake-parts + clan architecture. Test case: ccstatusline (production-ready derivation from infra). Drupol flat pattern validated (pkgs/by-name/ccstatusline/). Section 13.1 comprehensive tutorial (467 lines): pattern + ccstatusline example + infra migration guide. Three-layer pattern validated: pkgs/by-name/ (definition) → modules/nixpkgs.nix (export) → dendritic modules (consumption).</snippet>
      </doc>

      <!-- Story 1.10DB References (overlay architecture) -->
      <doc>
        <path>docs/notes/development/work-items/1-10db-execute-overlay-architecture-migration.md</path>
        <title>Story 1.10DB: Execute Overlay Architecture Migration from infra to test-clan</title>
        <section>Complete story context and Section 13.2</section>
        <snippet>DONE ✅ APPROVED ✅ (2025-11-16). 5-layer overlay migration to dendritic structure: Layer 1 (inputs - multi-channel), Layer 2 (hotfixes - platform hotfixes), Layer 3 (pkgs-by-name - custom packages from Story 1.10D), Layer 4 (overrides - package modifications), Layer 5 (flakeInputs - external integration). Documentation: Section 13.2 comprehensive (600 lines), empirical evidence, migration guide. Zero regressions: All Story 1.10D checks pass. Achieves 95% Epic 1 coverage with EMPIRICAL validation.</snippet>
      </doc>

      <!-- test-clan Validated Architecture (target for Section 13) -->
      <doc>
        <path>~/projects/nix-workspace/test-clan/docs/architecture/test-clan-validated-architecture.md</path>
        <title>test-clan Validated Architecture (TARGET DOCUMENTATION FILE)</title>
        <section>Section 12 (Two-tier secrets architecture), Section 13.1 (pkgs-by-name), Section 13.2 (Overlay preservation)</section>
        <snippet>Target file for Story 1.10E Section 13 documentation. Section 12 (Story 1.10C): Two-tier secrets architecture (system-level clan vars vs user-level sops-nix). Section 13.1 (Story 1.10D): pkgs-by-name pattern tutorial (467 lines, ccstatusline example). Section 13.2 (Story 1.10DB): Overlay architecture preservation (600 lines, 5-layer empirical validation). Story 1.10E will add Section 13 (Feature Enablement Patterns) documenting all 7 patterns.</snippet>
      </doc>
    </docs>

    <code>
      <!-- Story 1.10C Implementations (sops-nix patterns) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/git.nix</path>
        <kind>home-manager module</kind>
        <symbol>programs.git.signing</symbol>
        <lines>24-28</lines>
        <reason>Pattern 1 (Direct Path): SSH signing key configured via config.sops.secrets.ssh-signing-key.path (Story 1.10C commit f9e9e92)</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/git.nix</path>
        <kind>home-manager module</kind>
        <symbol>sops.templates.git-allowed-signers</symbol>
        <lines>36-49</lines>
        <reason>Pattern 2 (sops.templates): allowed_signers file generation via sops.placeholder (Story 1.10C bonus feature)</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/jujutsu.nix</path>
        <kind>home-manager module</kind>
        <symbol>user.signing-key</symbol>
        <lines>41</lines>
        <reason>Pattern 1 (Direct Path): SSH signing key configured via config.sops.secrets.ssh-signing-key.path (Story 1.10C commit 04c1617)</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/mcp-servers.nix</path>
        <kind>home-manager module</kind>
        <symbol>sops.templates.mcp-firecrawl</symbol>
        <lines>34-52</lines>
        <reason>Pattern 2 (sops.templates): Firecrawl API key embedded via config.sops.placeholder."firecrawl-api-key" (Story 1.10C commit c63b61e)</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/mcp-servers.nix</path>
        <kind>home-manager module</kind>
        <symbol>sops.templates.mcp-huggingface</symbol>
        <lines>56-73</lines>
        <reason>Pattern 2 (sops.templates): HuggingFace token embedded via config.sops.placeholder."huggingface-token" (Story 1.10C commit c63b61e)</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/wrappers.nix</path>
        <kind>home-manager module</kind>
        <symbol>claude-glm shell wrapper</symbol>
        <lines>23-44</lines>
        <reason>Pattern 3 (Runtime Cat): GLM wrapper reads secret at runtime via $(cat ${config.sops.secrets.glm-api-key.path}) (Story 1.10C commit f6b01e3)</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/wrappers.nix</path>
        <kind>home-manager module</kind>
        <symbol>sops.templates.rbw-config</symbol>
        <lines>54-85</lines>
        <reason>Pattern 2 (sops.templates): Bitwarden (rbw) email config via sops.placeholder (Story 1.10C bonus feature)</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/atuin.nix</path>
        <kind>home-manager module</kind>
        <symbol>home.activation.atuinKey</symbol>
        <lines>38-45</lines>
        <reason>Pattern 4 (Activation Scripts): Atuin encryption key deployment to non-XDG location via home.activation (Story 1.10C bonus feature)</reason>
      </artifact>

      <!-- Story 1.10D Implementation (custom package) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/pkgs/by-name/ccstatusline/package.nix</path>
        <kind>custom package</kind>
        <symbol>ccstatusline derivation</symbol>
        <lines>full file</lines>
        <reason>Pattern 7 (pkgs-by-name): Custom package created in Story 1.10D, enables status line feature in Story 1.10E AC F</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/ccstatusline-settings.nix</path>
        <kind>home-manager module</kind>
        <symbol>programs.ccstatusline-settings</symbol>
        <lines>full file (175 lines)</lines>
        <reason>ccstatusline settings configuration (3 segments: git, shell, directory). Production-ready, created in Story 1.10D</reason>
      </artifact>

      <!-- Story 1.10E Target Files (to be modified) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/flake.nix</path>
        <kind>flake configuration</kind>
        <symbol>inputs section</symbol>
        <lines>TBD</lines>
        <reason>ADD nix-ai-tools and catppuccin-nix flake inputs (AC D, AC E)</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/claude-code/default.nix</path>
        <kind>home-manager module</kind>
        <symbol>programs.claude-code.package</symbol>
        <lines>24</lines>
        <reason>UNCOMMENT package override for nix-ai-tools claude-code package (AC D, Pattern 5)</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/claude-code/default.nix</path>
        <kind>home-manager module</kind>
        <symbol>programs.claude-code.settings.statusLine</symbol>
        <lines>TBD</lines>
        <reason>UNCOMMENT statusLine config referencing pkgs.ccstatusline (AC F, Pattern 7)</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/tmux.nix</path>
        <kind>home-manager module</kind>
        <symbol>programs.tmux.catppuccin</symbol>
        <lines>40</lines>
        <reason>REPLACE TODO with catppuccin module import + 36-line configuration (AC E, Pattern 6)</reason>
      </artifact>

      <!-- Overlay Architecture (Story 1.10DB context) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/flake-parts/nixpkgs/_overlays/flakeInputs.nix</path>
        <kind>overlay</kind>
        <symbol>flakeInputs overlay</symbol>
        <lines>full file</lines>
        <reason>Layer 5 (Flake Input Overlays): External integration pattern established in Story 1.10DB, provides context for flake.inputs integration patterns in Story 1.10E</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/flake-parts/nixpkgs/default.nix</path>
        <kind>dendritic module</kind>
        <symbol>perSystem.overlays + pkgsDirectory</symbol>
        <lines>full file</lines>
        <reason>Hybrid pattern (overlays + pkgs-by-name coexistence) validated in Story 1.10DB, provides integration pattern for Story 1.10E flake.inputs overlays</reason>
      </artifact>
    </code>

    <dependencies>
      <nix>
        <ecosystem>test-clan</ecosystem>
        <packages>
          <package name="nix-ai-tools" source="github:cameronraysmith/nix-ai-tools" version="latest" pattern="Pattern 5 (flake.inputs package override)">
            Provides claude-code package for AC D enablement
          </package>
          <package name="catppuccin-nix" source="github:catppuccin/nix" version="latest" pattern="Pattern 6 (flake.inputs module import)">
            Provides catppuccin home-manager module for tmux theme (AC E enablement)
          </package>
          <package name="sops-nix" source="github:Mic92/sops-nix" version="current (from Story 1.10C)" pattern="Patterns 1-4 (sops-nix secret access)">
            User-level secrets infrastructure established in Story 1.10C (9/11 features already enabled)
          </package>
          <package name="ccstatusline" source="pkgs/by-name/ccstatusline/package.nix" version="custom (Story 1.10D)" pattern="Pattern 7 (custom package integration)">
            Custom package created in Story 1.10D, enables status line feature in AC F
          </package>
        </packages>
      </nix>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="1" priority="critical">
      <title>Zero Regression Requirement</title>
      <description>All Story 1.10C, 1.10D, and 1.10DB validations MUST still pass after Story 1.10E changes</description>
      <validation>
        <story id="1.10C">All sops-nix secrets functional (git signing, MCP servers, GLM wrapper, activation scripts)</story>
        <story id="1.10D">All pkgs-by-name checks pass (home-module-exports, home-configurations-exposed, ccstatusline builds)</story>
        <story id="1.10DB">All overlay layers functional (multi-channel access, hotfixes, custom packages, overrides, flake inputs)</story>
      </validation>
      <zeroTolerance>Breaking existing features is not acceptable</zeroTolerance>
    </constraint>

    <constraint id="2" priority="high">
      <title>Documentation Quality Baseline</title>
      <description>Section 13 MUST match Story 1.10D/1.10DB quality (9.5/10 clarity)</description>
      <requirements>
        <item>All code examples MUST be from actual implementation (empirical, not hypothetical)</item>
        <item>All validation commands MUST include expected outputs</item>
        <item>Tutorial MUST be comprehensive (Epic 2-6 developers can execute independently)</item>
        <item>Pattern coverage MUST be complete (all 7 patterns documented)</item>
      </requirements>
    </constraint>

    <constraint id="3" priority="high">
      <title>Pattern Coverage Completeness</title>
      <description>All 7 feature enablement patterns MUST be documented</description>
      <patterns>
        <pattern id="1">Direct Path Access (sops-nix)</pattern>
        <pattern id="2">sops.templates with Placeholders (sops-nix)</pattern>
        <pattern id="3">Runtime Cat in Shell Scripts (sops-nix)</pattern>
        <pattern id="4">Activation Scripts (sops-nix)</pattern>
        <pattern id="5">Package Override (flake.inputs)</pattern>
        <pattern id="6">Module Import (flake.inputs)</pattern>
        <pattern id="7">Custom Package Integration (pkgs-by-name)</pattern>
      </patterns>
      <requirement>Each pattern MUST have: real code example, validation commands, use case description</requirement>
    </constraint>

    <constraint id="4" priority="high">
      <title>Feature Enablement Verification</title>
      <description>Each enabled feature MUST build successfully and have validation commands</description>
      <features>
        <feature id="1">claude-code package (AC D) - flake.inputs package override</feature>
        <feature id="2">catppuccin tmux theme (AC E) - flake.inputs module import</feature>
        <feature id="3">ccstatusline (AC F) - custom package integration</feature>
      </features>
      <requirement>Build matrix MUST pass (all 4 configurations: crs58, raquel, blackphos, cinnabar)</requirement>
      <requirement>Runtime testing checklist documented for manual post-deployment validation</requirement>
    </constraint>

    <constraint id="5" priority="medium">
      <title>Epic 1 Coverage Target</title>
      <description>Story 1.10E completion achieves ~98% Epic 1 coverage</description>
      <coverage>
        <item>Architecture validation: 95% (Story 1.10DB complete - all 5 overlay layers)</item>
        <item>Feature enablement: 100% (all 11 features enabled - 9 from Story 1.10C + 2 from Story 1.10E)</item>
        <item>Pattern validation: 100% (all 7 patterns documented with empirical evidence)</item>
        <item>Epic 1 total: ~98% complete (Stories 1.11-1.14 remaining: home-manager refinement, GO/NO-GO, deployment, testing)</item>
      </coverage>
      <strategicValue>Epic 2-6 teams receive complete enablement guide for independent migration</strategicValue>
    </constraint>
  </constraints>

  <interfaces>
    <!-- flake.inputs Integration Patterns -->
    <interface>
      <name>nix-ai-tools Package Access</name>
      <kind>flake input package override</kind>
      <signature>flake.inputs.nix-ai-tools.packages.${pkgs.system}.claude-code</signature>
      <path>flake.nix inputs section + modules/home-manager/claude-code/default.nix:24</path>
      <pattern>Pattern 5: flake.inputs package override</pattern>
      <usage>Override programs.claude-code.package with package from external flake</usage>
    </interface>

    <interface>
      <name>catppuccin-nix Module Import</name>
      <kind>flake input module import</kind>
      <signature>flake.inputs.catppuccin-nix.homeManagerModules.catppuccin</signature>
      <path>flake.nix inputs section + modules/home-manager/tmux.nix imports</path>
      <pattern>Pattern 6: flake.inputs module import</pattern>
      <usage>Import catppuccin home-manager module for tmux theme configuration</usage>
    </interface>

    <!-- Custom Package Integration -->
    <interface>
      <name>ccstatusline Package Reference</name>
      <kind>custom package from pkgs-by-name</kind>
      <signature>${pkgs.ccstatusline}/bin/ccstatusline</signature>
      <path>modules/home-manager/claude-code/default.nix statusLine config</path>
      <pattern>Pattern 7: custom package integration</pattern>
      <usage>Reference custom package from pkgs/by-name/ auto-discovery for status line command</usage>
    </interface>

    <!-- sops-nix Secret Access Patterns (Story 1.10C context) -->
    <interface>
      <name>Direct Path Secret Access</name>
      <kind>sops-nix secret file path</kind>
      <signature>config.sops.secrets.ssh-signing-key.path</signature>
      <path>modules/home-manager/git.nix:24-28, jujutsu.nix:41</path>
      <pattern>Pattern 1: Direct path access</pattern>
      <usage>Programs reading secret files directly (git, jujutsu SSH signing)</usage>
    </interface>

    <interface>
      <name>sops.templates Secret Embedding</name>
      <kind>sops-nix template with placeholders</kind>
      <signature>config.sops.placeholder."secret-name"</signature>
      <path>modules/home-manager/mcp-servers.nix:34-73, wrappers.nix:54-85, git.nix:36-49</path>
      <pattern>Pattern 2: sops.templates with placeholders</pattern>
      <usage>Structured config files (JSON, TOML) with embedded secrets (MCP servers, rbw, allowed_signers)</usage>
    </interface>

    <interface>
      <name>Runtime Cat Secret Access</name>
      <kind>shell script secret reading</kind>
      <signature>$(cat ${config.sops.secrets.glm-api-key.path})</signature>
      <path>modules/home-manager/wrappers.nix:23-44</path>
      <pattern>Pattern 3: Runtime cat in shell scripts</pattern>
      <usage>Shell wrappers needing environment variables from secrets (GLM wrapper)</usage>
    </interface>

    <interface>
      <name>Activation Script Secret Deployment</name>
      <kind>home-manager activation script</kind>
      <signature>home.activation.atuinKey = lib.hm.dag.entryAfter ["writeBoundary"]</signature>
      <path>modules/home-manager/atuin.nix:38-45</path>
      <pattern>Pattern 4: Activation scripts</pattern>
      <usage>Deploying secrets to non-XDG locations during home-manager activation</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <framework>nix build (configuration validation)</framework>
      <framework>nix eval (attribute inspection)</framework>
      <framework>Manual runtime validation (visual confirmation post-deployment)</framework>
      <pattern>Story 1.10C established sops-nix testing standards (build + eval + manual validation)</pattern>
      <pattern>Story 1.10D established pkgs-by-name testing standards (checks.*.home-module-exports, checks.*.home-configurations-exposed)</pattern>
      <pattern>Story 1.10DB established overlay testing standards (multi-channel access, hotfix validation)</pattern>
      <standard>Zero regression testing: All prior story validations MUST still pass after changes</standard>
    </standards>

    <locations>
      <location>modules/checks/ (nix-unit tests from Story 1.6, auto-discovery pattern)</location>
      <location>Build validation via nix build .#homeConfigurations.* .#darwinConfigurations.* .#nixosConfigurations.*</location>
      <location>Attribute inspection via nix eval .#homeConfigurations.*.config.*</location>
      <location>Manual runtime validation checklist documented in story work item</location>
    </locations>

    <ideas>
      <idea id="1" ac="AC-D">
        <description>Validate claude-code package override from nix-ai-tools</description>
        <commands>
          <command>nix eval .#homeConfigurations.crs58.config.programs.claude-code.package.pname</command>
          <command>nix build .#homeConfigurations.crs58.config.programs.claude-code.package</command>
        </commands>
        <expected>Package name "claude-code", build succeeds</expected>
      </idea>

      <idea id="2" ac="AC-E">
        <description>Validate catppuccin tmux theme configuration</description>
        <commands>
          <command>nix eval .#homeConfigurations.crs58.config.programs.tmux.catppuccin.enable</command>
          <command>nix eval .#homeConfigurations.crs58.config.programs.tmux.catppuccin.flavor</command>
          <command>nix build .#homeConfigurations.crs58.activationPackage</command>
        </commands>
        <expected>enable=true, flavor="mocha", build succeeds</expected>
        <manualValidation>Visual confirmation: Launch tmux, verify catppuccin mocha theme renders (blue/pink/purple/green color scheme), status bar modules display correctly</manualValidation>
      </idea>

      <idea id="3" ac="AC-F">
        <description>Validate ccstatusline feature integration</description>
        <commands>
          <command>nix eval .#homeConfigurations.crs58.config.programs.claude-code.settings.statusLine.command</command>
          <command>nix build .#ccstatusline</command>
          <command>nix eval .#homeConfigurations.crs58.config.programs.ccstatusline-settings.segments</command>
        </commands>
        <expected>statusLine command references ccstatusline package, ccstatusline builds, settings have 3 segments</expected>
        <manualValidation>Runtime validation: Launch Claude Code CLI, verify status line displays at top (3-line powerline: git branch, shell, directory)</manualValidation>
      </idea>

      <idea id="4" ac="AC-G">
        <description>Regression testing - Story 1.10C sops-nix secrets</description>
        <commands>
          <command>nix eval .#homeConfigurations.crs58.config.sops.secrets.ssh-signing-key.sopsFile</command>
          <command>nix eval .#homeConfigurations.crs58.config.programs.git.signing.key</command>
        </commands>
        <expected>sopsFile path to secrets.yaml, signing.key path to sops secret</expected>
      </idea>

      <idea id="5" ac="AC-G">
        <description>Regression testing - Story 1.10D pkgs-by-name custom packages</description>
        <commands>
          <command>nix build .#checks.aarch64-darwin.home-module-exports</command>
          <command>nix build .#checks.aarch64-darwin.home-configurations-exposed</command>
        </commands>
        <expected>Both checks build successfully</expected>
      </idea>

      <idea id="6" ac="AC-G">
        <description>Regression testing - Story 1.10DB overlay architecture</description>
        <commands>
          <command>nix eval .#darwinConfigurations.blackphos.pkgs.stable.hello.version</command>
          <command>nix eval .#darwinConfigurations.blackphos.pkgs.micromamba.version</command>
        </commands>
        <expected>Layer 1 multi-channel access working (stable version), Layer 2 hotfix working (micromamba from stable)</expected>
      </idea>

      <idea id="7" ac="AC-G">
        <description>Build validation matrix - All 4 configurations</description>
        <commands>
          <command>nix build .#homeConfigurations.crs58.activationPackage</command>
          <command>nix build .#homeConfigurations.raquel.activationPackage</command>
          <command>nix build .#darwinConfigurations.blackphos.system</command>
          <command>nix build .#nixosConfigurations.cinnabar.config.system.build.toplevel</command>
        </commands>
        <expected>All 4 builds succeed, complete in reasonable time (< 10 min each)</expected>
      </idea>
    </ideas>
  </tests>

  <externalReferences>
    <!-- Flake Input Repositories -->
    <reference>
      <name>nix-ai-tools</name>
      <url>https://github.com/cameronraysmith/nix-ai-tools</url>
      <type>flake input (packages)</type>
      <purpose>Provides claude-code package for AC D (Pattern 5: flake.inputs package override)</purpose>
      <integration>Add to flake.nix inputs, reference in modules/home-manager/claude-code/default.nix</integration>
    </reference>

    <reference>
      <name>catppuccin-nix</name>
      <url>https://github.com/catppuccin/nix</url>
      <type>flake input (home-manager modules)</type>
      <purpose>Provides catppuccin theme home-manager module for AC E (Pattern 6: flake.inputs module import)</purpose>
      <integration>Add to flake.nix inputs, import module in modules/home-manager/tmux.nix</integration>
      <documentation>https://github.com/catppuccin/nix (theme configuration options, flavor settings)</documentation>
    </reference>

    <reference>
      <name>sops-nix</name>
      <url>https://github.com/Mic92/sops-nix</url>
      <type>nix library (secrets management)</type>
      <purpose>User-level secrets infrastructure (established in Story 1.10C, Patterns 1-4)</purpose>
      <status>Already integrated (Story 1.10C), 9/11 features enabled</status>
      <documentation>https://github.com/Mic92/sops-nix (secret management patterns, sops.templates documentation)</documentation>
    </reference>

    <!-- Dendritic + Clan Reference Implementations -->
    <reference>
      <name>drupol dendritic-infra</name>
      <url>https://github.com/drupol/dendritic-infra (local: ~/projects/nix-workspace/drupol-dendritic-infra)</url>
      <type>reference implementation</type>
      <purpose>PRIMARY dendritic flake-parts pattern reference (flat pkgs/by-name/, hybrid overlays + pkgsDirectory)</purpose>
      <relevance>Story 1.10D validated drupol pattern (pkgs-by-name), Story 1.10DB validated hybrid overlays pattern</relevance>
    </reference>

    <reference>
      <name>clan-infra</name>
      <url>https://git.clan.lol/clan/clan-infra (local: ~/projects/nix-workspace/clan-infra)</url>
      <type>reference implementation</type>
      <purpose>PRIMARY clan-core usage reference (machines, secrets, networking)</purpose>
      <relevance>Story 1.10C validated clan vars + sops-nix coexistence (two-tier secrets architecture)</relevance>
    </reference>

    <!-- infra Migration Source -->
    <reference>
      <name>infra repository</name>
      <url>local: ~/projects/nix-workspace/infra</url>
      <type>migration source</type>
      <purpose>Original implementation reference for features being enabled in test-clan</purpose>
      <files>
        <file>modules/home/profiles/claude-code/default.nix (original claude-code config with nix-ai-tools package override)</file>
        <file>modules/home/shell/tmux.nix (original tmux config with catppuccin theme, 36-line configuration)</file>
        <file>pkgs/by-name/ccstatusline/ (original ccstatusline package, migrated to test-clan in Story 1.10D)</file>
      </files>
    </reference>

    <!-- test-clan Validation Repository -->
    <reference>
      <name>test-clan</name>
      <url>local: ~/projects/nix-workspace/test-clan</url>
      <type>validation repository</type>
      <purpose>Epic 1 architectural validation target (dendritic flake-parts + clan-core integration)</purpose>
      <status>Stories 1.1-1.10DB complete (architecture + features + overlay layers validated)</status>
      <nextSteps>Story 1.10E: Enable remaining 3 features, document all 7 patterns in Section 13</nextSteps>
    </reference>
  </externalReferences>

  <relationshipToOtherStories>
    <dependency>
      <story>Story 1.10C (DONE ✅)</story>
      <relationship>Establishes sops-nix user-level secrets infrastructure (age encryption, multi-user support, sops.templates patterns). During implementation (61 commits, 2025-11-15 to 2025-11-16), 9 of 11 Story 1.10E features were already enabled using sops-nix patterns (direct path, sops.placeholder, runtime cat, activation scripts). Story 1.10E documents these implementations (AC A-C) and enables remaining flake.inputs-dependent features (AC D-F).</relationship>
      <impact>9/11 features already functional, only flake.inputs configuration + documentation remaining for Story 1.10E</impact>
    </dependency>

    <dependency>
      <story>Story 1.10D (DONE ✅)</story>
      <relationship>Validates custom package overlays with pkgs-by-name pattern, implementing ccstatusline package infrastructure (pkgs/by-name/ccstatusline/, production-ready derivation). Story 1.10E AC F enables ccstatusline feature by uncommenting statusLine config in claude-code/default.nix (Pattern 7: custom package integration).</relationship>
      <impact>ccstatusline package ready for Story 1.10E feature enablement (AC F)</impact>
    </dependency>

    <dependency>
      <story>Story 1.10DB (DONE ✅)</story>
      <relationship>Executes 5-layer overlay architecture migration from infra to test-clan dendritic structure (inputs, hotfixes, pkgs-by-name, overrides, flakeInputs). Layer 5 (flakeInputs overlay) establishes flake.inputs integration path for Story 1.10E AC D-E (nix-ai-tools, catppuccin-nix).</relationship>
      <impact>flake.inputs integration infrastructure validated, provides Pattern 5-6 foundation for Story 1.10E</impact>
    </dependency>

    <blocks>
      <story>Story 1.12 (backlog)</story>
      <relationship>GO/NO-GO decision benefits from complete feature enablement (claude-code package override, catppuccin theme, ccstatusline), but not critically blocked. Story 1.10E achieves ~98% Epic 1 coverage (architecture + features + patterns all validated), strengthens GO/NO-GO decision confidence.</relationship>
      <impact>Epic 1 completeness improves GO/NO-GO decision quality (Feature enablement: 100%, Pattern validation: 100%, Architecture validation: 95%)</impact>
    </blocks>

    <supports>
      <story>Epic 2-6 Migration (all future phases)</story>
      <relationship>Story 1.10E provides Epic 2-6 teams with complete feature enablement guide covering all 7 patterns (4 sops-nix + 2 flake.inputs + 1 custom package). Section 13 comprehensive tutorial enables independent migration execution.</relationship>
      <impact>Epic 2-6 teams can enable features in production machines (cinnabar, blackphos, rosegold, argentum, stibnite) using validated patterns with documented validation commands, estimated 6-12 hours time savings per phase</impact>
    </supports>
  </relationshipToOtherStories>

  <epicContext>
    <epicId>Epic 1</epicId>
    <epicTitle>Architectural Validation + Migration Pattern Rehearsal (Phase 0)</epicTitle>
    <phase>Phase 0 - test-clan validation and infrastructure deployment</phase>
    <objective>Validate dendritic flake-parts + clan-core integration patterns in test-clan before production migration (Epic 2-6)</objective>
    <strategicValue>
      Epic 1 achieves ~98% coverage after Story 1.10E:
      - Architecture validation: 95% (Story 1.10DB - all 5 overlay layers empirically validated)
      - Feature enablement: 100% (Story 1.10E - all 11 features enabled, 9 from Story 1.10C + 2 from Story 1.10E + ccstatusline)
      - Pattern validation: 100% (Story 1.10E Section 13 - all 7 patterns documented with empirical evidence)
      - Epic 1 total: ~98% (Stories 1.11-1.14 remaining: home-manager refinement, GO/NO-GO, deployment, testing)
    </strategicValue>
    <storiesRemaining>
      - Story 1.11: Refine home-manager architecture and document patterns (type-safe architecture, 12-18h)
      - Story 1.12: Execute GO/NO-GO decision framework (expanded validation: nixos + darwin + transformation)
      - Story 1.13: Physical deployment (if GO/CONDITIONAL GO)
      - Story 1.14: Testing & validation (comprehensive validation suite)
    </storiesRemaining>
    <goNoGoDecision>
      Story 1.12 decision gate determines entire migration approach based on:
      - Epic 1 validation completeness (~98% after Story 1.10E)
      - Test harness coverage (18 tests from Story 1.6)
      - Stability evidence (VPS deployment, zerotier networking, secrets management)
      - Pattern documentation quality (Section 13 comprehensive tutorial)
    </goNoGoDecision>
  </epicContext>

  <migrationNotes>
    <from>infra repository (nixos-unified-based architecture)</from>
    <to>test-clan repository (dendritic flake-parts + clan-core architecture)</to>
    <completedMigrations>
      <migration>Story 1.10C: sops-nix secrets infrastructure (9/11 features enabled)</migration>
      <migration>Story 1.10D: pkgs-by-name custom packages (ccstatusline package ready)</migration>
      <migration>Story 1.10DB: 5-layer overlay architecture (empirical validation complete)</migration>
    </completedMigrations>
    <remainingWork>
      <item>Story 1.10E: Enable remaining 3 features (claude-code, catppuccin, ccstatusline feature)</item>
      <item>Story 1.10E: Document all 7 patterns in Section 13 (comprehensive Epic 2-6 tutorial)</item>
      <item>Story 1.11+: home-manager refinement, GO/NO-GO, deployment, testing</item>
    </remainingWork>
    <patternEvolution>
      - Story 1.10BA: Structural Pattern A migration (aggregate namespaces, flake context access)
      - Story 1.10C: sops-nix patterns (4 secret access patterns validated)
      - Story 1.10D: pkgs-by-name pattern (Layer 3 custom packages)
      - Story 1.10DB: Overlay architecture patterns (Layers 1,2,4,5 empirical migration)
      - Story 1.10E: flake.inputs patterns (Patterns 5-6 package/module imports) + comprehensive Section 13
    </patternEvolution>
  </migrationNotes>

  <featureEnablementSummary>
    <totalFeatures>11</totalFeatures>
    <story1-10c>9 features enabled</story1-10c>
    <story1-10e>2 features enabled + 1 feature integration + 7 patterns documented</story1-10e>

    <pattern id="1" name="Direct Path Access (sops-nix)" story="1.10C">
      <features>
        <feature>Git SSH signing (git.nix:24-28)</feature>
        <feature>Jujutsu SSH signing (jujutsu.nix:41)</feature>
      </features>
      <status>✅ COMPLETE (Story 1.10C), documentation in AC A</status>
    </pattern>

    <pattern id="2" name="sops.templates with Placeholders (sops-nix)" story="1.10C">
      <features>
        <feature>MCP firecrawl API key (mcp-servers.nix:34-52)</feature>
        <feature>MCP huggingface token (mcp-servers.nix:56-73)</feature>
        <feature>Bitwarden (rbw) email config (wrappers.nix:54-85)</feature>
        <feature>Git allowed_signers (git.nix:36-49)</feature>
      </features>
      <status>✅ COMPLETE (Story 1.10C), documentation in AC B</status>
    </pattern>

    <pattern id="3" name="Runtime Cat in Shell Scripts (sops-nix)" story="1.10C">
      <features>
        <feature>GLM wrapper (wrappers.nix:23-44)</feature>
      </features>
      <status>✅ COMPLETE (Story 1.10C), documentation in AC C</status>
    </pattern>

    <pattern id="4" name="Activation Scripts (sops-nix)" story="1.10C">
      <features>
        <feature>Atuin encryption key (atuin.nix:38-45)</feature>
      </features>
      <status>✅ COMPLETE (Story 1.10C), documentation in Task 1.4</status>
    </pattern>

    <pattern id="5" name="Package Override (flake.inputs)" story="1.10E">
      <features>
        <feature>claude-code package (default.nix:24)</feature>
      </features>
      <status>❌ REMAINING (Story 1.10E AC D)</status>
    </pattern>

    <pattern id="6" name="Module Import (flake.inputs)" story="1.10E">
      <features>
        <feature>catppuccin tmux theme (tmux.nix:40)</feature>
      </features>
      <status>❌ REMAINING (Story 1.10E AC E)</status>
    </pattern>

    <pattern id="7" name="Custom Package Integration (pkgs-by-name)" story="1.10D + 1.10E">
      <features>
        <feature>ccstatusline (default.nix statusLine config)</feature>
      </features>
      <status>❌ REMAINING (Story 1.10E AC F, package ready from Story 1.10D)</status>
    </pattern>

    <documentation>
      <section id="13" title="Feature Enablement Patterns">
        <subsections>
          <subsection id="13.1">sops-nix Secret Access Patterns (Patterns 1-4)</subsection>
          <subsection id="13.2">flake.inputs Integration Patterns (Patterns 5-6)</subsection>
          <subsection id="13.3">Custom Package Integration (Pattern 7)</subsection>
          <subsection id="13.4">Enabled Features Summary (11 features, pattern mapping)</subsection>
          <subsection id="13.5">Build Validation (commands + expected outputs)</subsection>
          <subsection id="13.6">Epic 2-6 Migration Guide (8-step checklist, effort estimates)</subsection>
        </subsections>
        <qualityTarget>9.5/10 clarity (match Story 1.10D/1.10DB baseline)</qualityTarget>
        <length>Estimated 600-800 lines (comprehensive tutorial for Epic 2-6)</length>
      </section>
    </documentation>
  </featureEnablementSummary>
</story-context>
