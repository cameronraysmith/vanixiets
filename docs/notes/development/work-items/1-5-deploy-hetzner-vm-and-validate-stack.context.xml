<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>5</storyId>
    <title>Deploy Hetzner VM and validate infrastructure stack</title>
    <status>drafted</status>
    <generatedAt>2025-11-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-5-deploy-hetzner-vm-and-validate-stack.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a system administrator</asA>
    <iWant>to provision and deploy hetzner-vm to Hetzner Cloud</iWant>
    <soThat>I can validate the complete infrastructure stack (terraform + clan + disko + NixOS) works end-to-end</soThat>
    <tasks>
- Navigate to test-clan repository and enter nix develop shell
- Initialize terraform (AC: #1)
- Review terraform plan (AC: #2)
- Provision Hetzner VM (AC: #3-4)
- Generate clan vars for hetzner-vm (AC: #5)
- Install NixOS via clan (AC: #6-7-8)
- Validate post-installation SSH access (AC: #9)
- Validate zerotier controller (AC: #10)
- Validate clan vars deployment (AC: #11)
- Validate btrfs filesystem structure (AC: #7)
- Check system logs for errors (AC: #12)
- Test system reboot (AC: #13)
- Document deployment experience
    </tasks>
  </story>

  <acceptanceCriteria>
1. Terraform initialized from test-clan repository: enter nix develop shell, then `terraform init`
2. Terraform plan reviewed and validated: `terraform plan` shows cx43 server creation, SSH key, hcloud provider
3. Hetzner VM (cx43, 8 vCPU, 16GB RAM at $9.99/month) provisioned via terraform: `terraform apply`
4. VM accessible via SSH with terraform-generated deployment key
5. Clan vars generated for hetzner-vm: `clan vars generate hetzner-vm`
6. NixOS installed via clan: `clan machines install hetzner-vm --target-host root@<ip> --update-hardware-config nixos-facter --yes`
7. System boots successfully with LUKS encryption (btrfs subvolumes: /root, /nix, /home)
8. Device path validated: /dev/sda confirmed as boot device
9. Post-installation SSH access works with clan-managed keys: `ssh root@<hetzner-ip>`
10. Zerotier controller operational: `ssh root@<hetzner-ip> "zerotier-cli info"`
11. Clan vars deployed correctly: `ssh root@<hetzner-ip> "ls -la /run/secrets/"`
12. No critical errors in system logs: `ssh root@<hetzner-ip> "journalctl -p err --no-pager"`
13. System survives reboot
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/notes/development/work-items/1-4-create-hetzner-terraform-config-and-host-modules.md</path>
        <title>Story 1.4: Create Hetzner VM terraform configuration and host modules (DONE - APPROVED)</title>
        <section>Dev Notes - Learnings from Previous Story</section>
        <snippet>Story 1.4 successfully created all terraform/terranix configuration and host modules. Critical findings: cx43 VM (8 vCPU, 16GB RAM) at $9.99/month for performant testing; vars errors BEFORE clan vars generate are EXPECTED and CORRECT; specialArgs pattern fixes infinite recursion; /dev/sda device path per srvos convention; secrets (tf-passphrase, hetzner-api-token) configured via clan secrets.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-4-create-hetzner-terraform-config-and-host-modules.md</path>
        <title>Story 1.4: Test Results and Validation</title>
        <section>Dev Agent Record - Completion Notes</section>
        <snippet>All 13 acceptance criteria met with comprehensive evidence. Terraform config generates successfully (nix build .#terraform). Generated terraform.tf.json reviewed: hcloud provider with API token from data.external, hcloud_server.hetzner-vm (cx43, debian-12, fsn1), null_resource.install-hetzner-vm calling clan machines install. Disko evaluates correctly: device=/dev/sda, partitions=[ESP,luks], btrfs subvolumes: /root, /nix, /home.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/epic-1-infrastructure-restructure-proposal.md</path>
        <title>Epic 1: Infrastructure Deployment Restructure Proposal</title>
        <section>Story 1.5: Deploy Hetzner VM and validate infrastructure stack</section>
        <snippet>Progressive validation strategy: Hetzner deployment must succeed before GCP (Story 1.8). This story performs first real infrastructure deployment, validating terraform/terranix + clan + disko + NixOS stack end-to-end. HIGH RISK because it creates real infrastructure with costs. Expected workflow: terraform apply (2-5 min) → clan vars generate (1-2 min) → clan machines install (10-30 min) → validation (15-30 min).</snippet>
      </doc>
      <doc>
        <path>docs/notes/implementation/clan-infra-terranix-pattern.md</path>
        <title>Clan-infra terranix pattern extraction</title>
        <section>State encryption with OpenTofu, Clan secrets in terraform, Machine deployment automation</section>
        <snippet>Proven patterns from clan-infra: OpenTofu state encryption via TF_ENCRYPTION with PBKDF2+AES-GCM using passphrase from clan secrets; data.external pattern fetches secrets at terraform runtime via clan secrets get (no plaintext in git/state); null_resource provisioner with local-exec runs clan machines install for automated NixOS deployment.</snippet>
      </doc>
    </docs>
    <code>
      <!-- Terraform/Terranix Configuration (from test-clan repository) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/terranix/base.nix</path>
        <kind>terranix-module</kind>
        <symbol>provider configuration and secrets integration</symbol>
        <lines>1-31</lines>
        <reason>Base terraform provider configuration with Hetzner Cloud API token fetched via clan secrets data.external pattern. Required for terraform authentication. Implements OpenTofu state encryption variable passphrase.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/terranix/hetzner.nix</path>
        <kind>terranix-module</kind>
        <symbol>hcloud_server.hetzner-vm, null_resource.install-hetzner-vm</symbol>
        <lines>1-42</lines>
        <reason>Hetzner Cloud server resource definition (cx43, fsn1, debian-12). Generates ED25519 SSH deployment key, registers with Hetzner, provisions VM. null_resource provisioner calls clan machines install for NixOS deployment. This is the core terraform configuration that Story 1.5 will execute via terraform apply.</reason>
      </artifact>

      <!-- Host Configuration (from test-clan repository) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/hosts/hetzner-vm/default.nix</path>
        <kind>nixos-module</kind>
        <symbol>hetzner-vm NixOS host configuration</symbol>
        <lines>1-38</lines>
        <reason>NixOS host configuration for hetzner-vm with srvos hardening (server + hardware-hetzner-cloud), systemd-networkd DHCP configuration, firewall. Base nix-settings and disko imports. This configuration will be deployed during clan machines install in AC #6.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/hosts/hetzner-vm/disko.nix</path>
        <kind>nixos-module</kind>
        <symbol>disko LUKS partition configuration with clan vars generator</symbol>
        <lines>1-79</lines>
        <reason>Declarative disk partitioning with LUKS encryption. Clan vars generator creates 64-char LUKS passphrase via pwgen. GPT partitions: EFI boot (512MB) + LUKS root. Btrfs subvolumes: /root, /nix, /home with zstd compression. Device path /dev/sda validated in Story 1.4. Critical for AC #7-8 validation.</reason>
      </artifact>

      <!-- Clan Integration (from test-clan repository) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/flake-parts/clan.nix</path>
        <kind>flake-module</kind>
        <symbol>clan inventory, terranix integration, specialArgs</symbol>
        <lines>19-20, 127-149</lines>
        <reason>Clan inventory machines configuration (hetzner-vm, gcp-vm), service instances (emergency-access, zerotier controller). Terranix integration with terraformWrapper.prefixText for state encryption (TF_ENCRYPTION env var). specialArgs pattern fixes infinite recursion per Story 1.4. Critical context for understanding terraform and clan integration.</reason>
      </artifact>
    </code>
    <dependencies>{{dependencies_artifacts}}</dependencies>
  </artifacts>

  <constraints>{{constraints}}</constraints>
  <interfaces>{{interfaces}}</interfaces>
  <tests>
    <standards>{{test_standards}}</standards>
    <locations>{{test_locations}}</locations>
    <ideas>{{test_ideas}}</ideas>
  </tests>
</story-context>
