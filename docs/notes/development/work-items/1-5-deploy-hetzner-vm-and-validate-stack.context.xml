<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>5</storyId>
    <title>Deploy Hetzner VM and validate infrastructure stack</title>
    <status>drafted</status>
    <generatedAt>2025-11-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-5-deploy-hetzner-vm-and-validate-stack.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a system administrator</asA>
    <iWant>to provision and deploy hetzner-vm to Hetzner Cloud</iWant>
    <soThat>I can validate the complete infrastructure stack (terraform + clan + disko + NixOS) works end-to-end</soThat>
    <tasks>
- Navigate to test-clan repository and enter nix develop shell
- Initialize terraform (AC: #1)
- Review terraform plan (AC: #2)
- Provision Hetzner VM (AC: #3-4)
- Generate clan vars for hetzner-vm (AC: #5)
- Install NixOS via clan (AC: #6-7-8)
- Validate post-installation SSH access (AC: #9)
- Validate zerotier controller (AC: #10)
- Validate clan vars deployment (AC: #11)
- Validate btrfs filesystem structure (AC: #7)
- Check system logs for errors (AC: #12)
- Test system reboot (AC: #13)
- Document deployment experience
    </tasks>
  </story>

  <acceptanceCriteria>
1. Terraform initialized from test-clan repository: enter nix develop shell, then `terraform init`
2. Terraform plan reviewed and validated: `terraform plan` shows cx43 server creation, SSH key, hcloud provider
3. Hetzner VM (cx43, 8 vCPU, 16GB RAM at $9.99/month) provisioned via terraform: `terraform apply`
4. VM accessible via SSH with terraform-generated deployment key
5. Clan vars generated for hetzner-vm: `clan vars generate hetzner-vm`
6. NixOS installed via clan: `clan machines install hetzner-vm --target-host root@<ip> --update-hardware-config nixos-facter --yes`
7. System boots successfully with LUKS encryption (btrfs subvolumes: /root, /nix, /home)
8. Device path validated: /dev/sda confirmed as boot device
9. Post-installation SSH access works with clan-managed keys: `ssh root@<hetzner-ip>`
10. Zerotier controller operational: `ssh root@<hetzner-ip> "zerotier-cli info"`
11. Clan vars deployed correctly: `ssh root@<hetzner-ip> "ls -la /run/secrets/"`
12. No critical errors in system logs: `ssh root@<hetzner-ip> "journalctl -p err --no-pager"`
13. System survives reboot
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/notes/development/work-items/1-4-create-hetzner-terraform-config-and-host-modules.md</path>
        <title>Story 1.4: Create Hetzner VM terraform configuration and host modules (DONE - APPROVED)</title>
        <section>Dev Notes - Learnings from Previous Story</section>
        <snippet>Story 1.4 successfully created all terraform/terranix configuration and host modules. Critical findings: cx43 VM (8 vCPU, 16GB RAM) at $9.99/month for performant testing; vars errors BEFORE clan vars generate are EXPECTED and CORRECT; specialArgs pattern fixes infinite recursion; /dev/sda device path per srvos convention; secrets (tf-passphrase, hetzner-api-token) configured via clan secrets.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-4-create-hetzner-terraform-config-and-host-modules.md</path>
        <title>Story 1.4: Test Results and Validation</title>
        <section>Dev Agent Record - Completion Notes</section>
        <snippet>All 13 acceptance criteria met with comprehensive evidence. Terraform config generates successfully (nix build .#terraform). Generated terraform.tf.json reviewed: hcloud provider with API token from data.external, hcloud_server.hetzner-vm (cx43, debian-12, fsn1), null_resource.install-hetzner-vm calling clan machines install. Disko evaluates correctly: device=/dev/sda, partitions=[ESP,luks], btrfs subvolumes: /root, /nix, /home.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/epic-1-infrastructure-restructure-proposal.md</path>
        <title>Epic 1: Infrastructure Deployment Restructure Proposal</title>
        <section>Story 1.5: Deploy Hetzner VM and validate infrastructure stack</section>
        <snippet>Progressive validation strategy: Hetzner deployment must succeed before GCP (Story 1.8). This story performs first real infrastructure deployment, validating terraform/terranix + clan + disko + NixOS stack end-to-end. HIGH RISK because it creates real infrastructure with costs. Expected workflow: terraform apply (2-5 min) → clan vars generate (1-2 min) → clan machines install (10-30 min) → validation (15-30 min).</snippet>
      </doc>
      <doc>
        <path>docs/notes/implementation/clan-infra-terranix-pattern.md</path>
        <title>Clan-infra terranix pattern extraction</title>
        <section>State encryption with OpenTofu, Clan secrets in terraform, Machine deployment automation</section>
        <snippet>Proven patterns from clan-infra: OpenTofu state encryption via TF_ENCRYPTION with PBKDF2+AES-GCM using passphrase from clan secrets; data.external pattern fetches secrets at terraform runtime via clan secrets get (no plaintext in git/state); null_resource provisioner with local-exec runs clan machines install for automated NixOS deployment.</snippet>
      </doc>
    </docs>
    <code>
      <!-- Terraform/Terranix Configuration (from test-clan repository) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/terranix/base.nix</path>
        <kind>terranix-module</kind>
        <symbol>provider configuration and secrets integration</symbol>
        <lines>1-31</lines>
        <reason>Base terraform provider configuration with Hetzner Cloud API token fetched via clan secrets data.external pattern. Required for terraform authentication. Implements OpenTofu state encryption variable passphrase.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/terranix/hetzner.nix</path>
        <kind>terranix-module</kind>
        <symbol>hcloud_server.hetzner-vm, null_resource.install-hetzner-vm</symbol>
        <lines>1-42</lines>
        <reason>Hetzner Cloud server resource definition (cx43, fsn1, debian-12). Generates ED25519 SSH deployment key, registers with Hetzner, provisions VM. null_resource provisioner calls clan machines install for NixOS deployment. This is the core terraform configuration that Story 1.5 will execute via terraform apply.</reason>
      </artifact>

      <!-- Host Configuration (from test-clan repository) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/hosts/hetzner-vm/default.nix</path>
        <kind>nixos-module</kind>
        <symbol>hetzner-vm NixOS host configuration</symbol>
        <lines>1-38</lines>
        <reason>NixOS host configuration for hetzner-vm with srvos hardening (server + hardware-hetzner-cloud), systemd-networkd DHCP configuration, firewall. Base nix-settings and disko imports. This configuration will be deployed during clan machines install in AC #6.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/hosts/hetzner-vm/disko.nix</path>
        <kind>nixos-module</kind>
        <symbol>disko LUKS partition configuration with clan vars generator</symbol>
        <lines>1-79</lines>
        <reason>Declarative disk partitioning with LUKS encryption. Clan vars generator creates 64-char LUKS passphrase via pwgen. GPT partitions: EFI boot (512MB) + LUKS root. Btrfs subvolumes: /root, /nix, /home with zstd compression. Device path /dev/sda validated in Story 1.4. Critical for AC #7-8 validation.</reason>
      </artifact>

      <!-- Clan Integration (from test-clan repository) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/flake-parts/clan.nix</path>
        <kind>flake-module</kind>
        <symbol>clan inventory, terranix integration, specialArgs</symbol>
        <lines>19-20, 127-149</lines>
        <reason>Clan inventory machines configuration (hetzner-vm, gcp-vm), service instances (emergency-access, zerotier controller). Terranix integration with terraformWrapper.prefixText for state encryption (TF_ENCRYPTION env var). specialArgs pattern fixes infinite recursion per Story 1.4. Critical context for understanding terraform and clan integration.</reason>
      </artifact>
    </code>
    <dependencies>
      <nix>
        <input name="nixpkgs" source="github:NixOS/nixpkgs/nixos-unstable" />
        <input name="flake-parts" source="github:hercules-ci/flake-parts" />
        <input name="clan-core" source="git+https://git.clan.lol/clan/clan-core" />
        <input name="terranix" source="github:terranix/terranix" />
        <input name="disko" source="github:nix-community/disko" />
        <input name="srvos" source="github:nix-community/srvos" />
      </nix>
      <terraform>
        <provider name="hcloud" source="hetznercloud/hcloud" description="Hetzner Cloud provider for VM provisioning" />
        <provider name="external" source="hashicorp/external" description="Executes clan secrets get for API token retrieval" />
        <provider name="tls" source="hashicorp/tls" description="Generates ED25519 SSH deployment key" />
        <provider name="null" source="hashicorp/null" description="Provisions NixOS via clan machines install" />
        <provider name="local" source="hashicorp/local" description="Stores SSH private key with 0600 permissions" />
      </terraform>
      <runtime>
        <tool name="opentofu" description="Terraform-compatible tool with native state encryption" />
        <tool name="clan" description="Clan CLI for secrets management and machine installation" />
        <tool name="jq" description="JSON processor for data.external script output" />
        <tool name="pwgen" description="Password generator for 64-char LUKS passphrase" />
      </runtime>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>All terraform commands MUST run inside nix develop shell (not nix run wrapper) per Story 1.4 implementation</constraint>
    <constraint>Vars errors BEFORE clan vars generate are EXPECTED and CORRECT - do not attempt to fix</constraint>
    <constraint>Secrets (tf-passphrase, hetzner-api-token) MUST be configured via clan secrets before terraform apply</constraint>
    <constraint>terraform apply will start billing at $9.99/month for cx43 VM - budget approved for ephemeral testing</constraint>
    <constraint>Device path /dev/sda validated in Story 1.4 per srvos hardware-hetzner-cloud convention</constraint>
    <constraint>Expected timing: terraform apply (2-5 min), clan vars generate (1-2 min), clan install (10-30 min), validation (15-30 min)</constraint>
    <constraint>This is HIGH RISK story - actual infrastructure deployment with irreversible costs</constraint>
    <constraint>Progressive validation: Hetzner must succeed before GCP (Story 1.8)</constraint>
    <constraint>Deployment workflow: cd ~/projects/nix-workspace/test-clan, nix develop, terraform commands</constraint>
    <constraint>specialArgs pattern (clan.specialArgs = inherit inputs) fixes infinite recursion - required for module evaluation</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Hetzner Cloud API</name>
      <kind>REST API</kind>
      <signature>Authentication via API token from clan secrets (data.external pattern)</signature>
      <path>modules/terranix/base.nix:16-27, modules/terranix/hetzner.nix</path>
    </interface>
    <interface>
      <name>Clan secrets CLI</name>
      <kind>command-line</kind>
      <signature>clan secrets get &lt;secret-name&gt; - fetches encrypted secret at runtime</signature>
      <path>modules/terranix/base.nix:22 (jq wrapper calling clan secrets get)</path>
    </interface>
    <interface>
      <name>Clan machines install</name>
      <kind>command-line</kind>
      <signature>clan machines install &lt;machine-name&gt; --target-host root@&lt;ip&gt; --update-hardware-config nixos-facter --yes</signature>
      <path>modules/terranix/hetzner.nix:39 (null_resource provisioner)</path>
    </interface>
    <interface>
      <name>Clan vars generators</name>
      <kind>nix-module</kind>
      <signature>clan.core.vars.generators.&lt;name&gt;.files.&lt;file&gt;.neededFor = "partitioning"</signature>
      <path>modules/hosts/hetzner-vm/disko.nix:4-13 (luks-password generator)</path>
    </interface>
    <interface>
      <name>Terraform state encryption</name>
      <kind>environment-variable</kind>
      <signature>TF_ENCRYPTION with PBKDF2 key provider and AES-GCM encryption method</signature>
      <path>modules/flake-parts/clan.nix:127-149 (terraformWrapper.prefixText)</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
Story 1.5 is an infrastructure deployment story, not a code development story. Testing focuses on operational validation through manual verification commands documented in acceptance criteria and tasks. Standards: (1) Run terraform init/plan/apply in sequence, verify each succeeds before proceeding. (2) Run clan vars generate, verify secrets/facts created in sops/ directory. (3) Run clan machines install, monitor installation logs for errors. (4) Execute SSH validation commands on deployed VM. (5) Check systemd service status and journal logs. (6) Test system reboot and verify services restore. All validation is imperative shell commands, not automated test suites. Success criteria: all 13 acceptance criteria pass with documented evidence.
    </standards>
    <locations>
      <location>~/projects/nix-workspace/test-clan (working directory for all deployment commands)</location>
      <location>Story 1.5 task checklist (manual validation tracking)</location>
      <location>Dev Notes documentation (record actual deployment experience)</location>
    </locations>
    <ideas>
      <idea ac="AC #1">Terraform initialization test: nix develop shell, terraform init, verify .terraform/ directory created with hcloud provider</idea>
      <idea ac="AC #2">Terraform plan validation: terraform plan output shows cx43 server, SSH key resources, hcloud provider with API token fetch</idea>
      <idea ac="AC #3-4">VM provisioning test: terraform apply creates Hetzner VM, capture IP, test SSH with deployment key</idea>
      <idea ac="AC #5">Clan vars generation test: clan vars generate hetzner-vm, verify sops/machines/hetzner-vm/ contains secrets and facts</idea>
      <idea ac="AC #6-7-8">NixOS installation test: clan machines install, monitor disko partitioning logs, verify /dev/sda device path, check btrfs subvolumes after installation</idea>
      <idea ac="AC #9">Post-install SSH test: ssh root@hetzner-ip (without -i flag), verify clan-managed keys work</idea>
      <idea ac="AC #10">Zerotier validation: ssh root@hetzner-ip "zerotier-cli info", verify controller role, capture network ID</idea>
      <idea ac="AC #11">Secrets deployment test: ssh root@hetzner-ip "ls -la /run/secrets/", verify sshd keys, zerotier identity, proper permissions</idea>
      <idea ac="AC #12">System logs check: ssh root@hetzner-ip "journalctl -p err --no-pager", investigate any critical errors</idea>
      <idea ac="AC #13">Reboot stability test: ssh root@hetzner-ip "reboot", wait 2-3 min, verify SSH+zerotier+services restored</idea>
      <idea ac="validation">Device path verification: compare disko.nix device="/dev/sda" with actual boot device via lsblk on deployed system</idea>
      <idea ac="validation">Vars error confirmation: verify no vars errors AFTER clan vars generate (expected before, resolved after)</idea>
      <idea ac="cost-tracking">Billing validation: check Hetzner Cloud console for cx43 VM billing start ($9.99/month), record actual costs</idea>
    </ideas>
  </tests>
</story-context>
