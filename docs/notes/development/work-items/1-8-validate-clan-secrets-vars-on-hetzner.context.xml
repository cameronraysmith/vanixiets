<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.8</storyId>
    <title>Validate and document clan secrets/vars workflow on Hetzner VMs</title>
    <status>drafted</status>
    <generatedAt>2025-11-07</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-8-validate-clan-secrets-vars-on-hetzner.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to validate the clan secrets/vars workflow and document operational patterns</iWant>
    <soThat>I understand the complete secrets lifecycle before proceeding to GCP deployment and can replicate these patterns in production</soThat>
    <tasks>
**Task 1: Validate SSH Host Key Persistence** (AC: #1)
- SSH to hetzner-ccx23: `ssh root@162.55.175.87`
- Record current SSH host key fingerprint: `ssh-keyscan 162.55.175.87`
- Check if SSH host keys in vars: `ls -la ~/projects/nix-workspace/test-clan/vars/per-machine/hetzner-ccx23/sshd/` (if exists)
- If SSH host keys NOT in vars:
  - Research clan-core sshd service module for SSH host key vars integration
  - Check if sshd-clan service instance generates SSH host key vars
  - If not automatic, document as known gap (may be acceptable)
- Execute rebuild test: `ssh root@162.55.175.87 "nixos-rebuild switch"`
- Verify SSH host key fingerprint unchanged: `ssh-keyscan 162.55.175.87` (compare to baseline)
- Test SSH connection works without host key warning
- Document findings: are SSH host keys persistent via vars or ephemeral?

**Task 2: Enhance TC-007 Secrets Test** (AC: #2)
- Read current TC-007 implementation: `~/projects/nix-workspace/test-clan/modules/checks/validation.nix`
- Design comprehensive vars lifecycle test:
  - Test 1: Vars directory structure exists (`vars/per-machine/`)
  - Test 2: Machine vars directories present for all 3 machines
  - Test 3: Expected var categories present (zerotier, emergency-access, state-version)
  - Test 4: Secret files have age recipients (machines + users symlinks)
  - Test 5: Public facts are readable (zerotier-ip/value, state-version/version/value)
  - Test 6: Vars generation is idempotent (re-running doesn't fail)
- Implement enhanced TC-007 test in `modules/checks/validation.nix`
- Run test: `nix flake check` (or `just test` from test-clan root)
- Verify test passes with current vars structure
- Verify enhanced TC-007 specifically: use `just test-quick` or `nix build .#checks.aarch64-darwin.secrets-generation`
- Commit enhanced test

**Task 3: Research Clan CLI Commands and Create Documentation** (AC: #3)
- Research clan-core official documentation
- Identify essential clan CLI commands
- Create test-clan/docs/notes/development/secrets-management.md (lowercase kebab-case)
- Add justfile recipes to test-clan/justfile
- Commit changes

**Task 4: Validate Vars Workflow End-to-End** (AC: #4)
- Navigate to test-clan and enter nix develop shell
- Inspect current vars for hetzner-ccx23
- Verify age encryption
- Test vars regeneration (backup first)
- Validate vars on VM (SSH to hetzner-ccx23)
- Document complete workflow with commands in story completion notes

**Task 5: Document Multi-Machine Vars Patterns** (AC: #5)
- Compare vars between machines
- Document machine role differences in secrets-management.md
- Document shared secrets model
- Add multi-machine coordination examples showing clan patterns in practice
- Update secrets-management.md with test-clan-specific examples

**Task 6: Validate Vars Generation Repeatable** (AC: #6)
- Document vars generation for new machine (use gcp-vm as example)
- Validate generated vars structure
- Document vars generation workflow in secrets-management.md
- Add example commands for adding new machine

**Task 7: Update Story 1.8 Completion Notes** (AC: all)
- Document what was ALREADY COMPLETE from Stories 1.5-1.7
- Document what Story 1.8 ACTUALLY validated
- Reference test-clan/docs/notes/development/secrets-management.md
- List files created/modified
- Mark story as done in sprint-status.yaml
    </tasks>
  </story>

  <acceptanceCriteria>
1. **SSH Host Key Persistence Validated:**
   - SSH host keys added to clan vars for hetzner-ccx23 (if not present)
   - Rebuild test: `nixos-rebuild switch` does NOT change SSH host key fingerprint
   - SSH connection works without host key warning after rebuild
   - Host keys stored in vars/per-machine/hetzner-ccx23/sshd/ (or appropriate location)

2. **Vars Lifecycle Test Enhanced (TC-007):**
   - Current TC-007 smoke test replaced with comprehensive vars lifecycle test
   - New test validates: vars directory structure, secret encryption (age recipients), public facts accessibility, vars generation repeatability
   - Test runs in test harness without requiring deployed infrastructure
   - Test passes in `nix flake check` (or `just test` for full test suite)

3. **Secrets Management Documentation and Justfile Recipes Created:**
   - test-clan/docs/notes/development/secrets-management.md created (lowercase kebab-case)
   - **Primary Source:** Document references clan-core official documentation as authoritative source
   - **Local Context:** Document explains test-clan-specific application of clan patterns
   - Essential clan CLI commands identified
   - Justfile recipes added for essential clan commands

4. **Vars Workflow Validation:**
   - Execute complete vars lifecycle on hetzner-ccx23
   - Document workflow steps with actual commands used
   - Prove repeatable workflow understanding

5. **Multi-Machine Vars Patterns Documented:**
   - Document how vars differ between machines
   - Document shared secrets and machine-specific encryption
   - Examples provided

6. **Vars Generation Repeatable:**
   - Demonstrate vars regeneration for new machine
   - Document `clan vars generate <machine>` workflow
   - Validate generated vars have correct structure and encryption
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Epic and Story Documentation -->
      <doc>
        <path>docs/notes/development/epics.md</path>
        <title>infra - Epic Breakdown</title>
        <section>Epic 1: Architectural Validation + Infrastructure Deployment (Phase 0)</section>
        <snippet>Epic 1 validates complete stack (terraform + clan + infrastructure) on real VMs before darwin migration. Story 1.8 validates clan secrets management and vars deployment on hetzner-vm before GCP deployment.</snippet>
      </doc>

      <!-- Previous Story Context -->
      <doc>
        <path>docs/notes/development/work-items/1-5-deploy-hetzner-vm-and-validate-stack.md</path>
        <title>Story 1.5: Deploy Hetzner VM and validate infrastructure stack</title>
        <section>Completion Notes</section>
        <snippet>Clan vars already generated for all 3 machines, deployed to /run/secrets/vars/ on VMs. Zerotier identity persistent, LUKS working via vars.</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/work-items/1-6-implement-comprehensive-test-harness-for-test-clan.md</path>
        <title>Story 1.6: Implement comprehensive test harness</title>
        <section>Test Architecture</section>
        <snippet>18 tests implemented (12 nix-unit + 4 runCommand + 2 runNixOSTest). TC-007 is currently a smoke test validating clan CLI availability only.</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/work-items/1-7-execute-dendritic-refactoring-in-test-clan-using-test-harness.md</path>
        <title>Story 1.7: Execute dendritic refactoring</title>
        <section>Completion Notes</section>
        <snippet>Pure dendritic flake-parts pattern achieved with import-tree auto-discovery. All tests passing, zero regressions confirmed.</snippet>
      </doc>

      <!-- test-clan Repository Documentation -->
      <doc>
        <path>~/projects/nix-workspace/test-clan/README.md</path>
        <title>test-clan Repository README</title>
        <section>Architecture</section>
        <snippet>Pure dendritic flake-parts with import-tree. Clan-core + terranix integration. Vars in vars/per-machine/, secrets in sops/.</snippet>
      </doc>

      <!-- Authoritative Clan-core Documentation (MUST DEFER TO THESE) -->
      <doc>
        <path>~/projects/nix-workspace/clan-core/docs/site/guides/vars/vars-overview.md</path>
        <title>Clan Vars Overview</title>
        <section>AUTHORITATIVE SOURCE</section>
        <snippet>Upstream clan-core documentation for vars system. Story 1.8 documentation MUST reference this as primary source.</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/clan-core/docs/site/guides/vars/vars-concepts.md</path>
        <title>Clan Vars Concepts</title>
        <section>AUTHORITATIVE SOURCE</section>
        <snippet>Upstream clan-core documentation for vars architecture and concepts. Story 1.8 documentation MUST defer to this.</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/clan-core/docs/site/guides/vars/vars-backend.md</path>
        <title>Clan Vars Backend (sops)</title>
        <section>AUTHORITATIVE SOURCE</section>
        <snippet>Upstream documentation for vars backend and sops integration. Story 1.8 documentation references this for technical details.</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/clan-core/docs/site/guides/vars/vars-troubleshooting.md</path>
        <title>Clan Vars Troubleshooting</title>
        <section>AUTHORITATIVE SOURCE</section>
        <snippet>Upstream troubleshooting guide for vars issues. Story 1.8 documentation points users here for debugging.</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/clan-core/docs/site/guides/secrets.md</path>
        <title>Clan Secrets Management</title>
        <section>AUTHORITATIVE SOURCE</section>
        <snippet>Upstream clan-core secrets documentation. Story 1.8 documentation MUST reference this as canonical source for secrets workflow.</snippet>
      </doc>
    </docs>

    <code>
      <!-- Test-clan Repository Structure -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/flake.nix</path>
        <kind>flake</kind>
        <symbol>mkFlake</symbol>
        <lines>56-58</lines>
        <reason>Pure dendritic pattern using import-tree for auto-discovery of all modules</reason>
      </artifact>

      <!-- Clan Integration -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/clan/core.nix</path>
        <kind>module</kind>
        <symbol>imports</symbol>
        <lines>1-7</lines>
        <reason>Imports clan-core and terranix flakeModules - foundation for secrets/vars integration</reason>
      </artifact>

      <!-- Clan Inventory - Machine Definitions -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/machines.nix</path>
        <kind>module</kind>
        <symbol>clan.inventory.machines</symbol>
        <lines>1-30</lines>
        <reason>Machine inventory defining hetzner-ccx23, hetzner-cx43, gcp-vm with tags for service targeting</reason>
      </artifact>

      <!-- Service Instances Generating Vars -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/services/zerotier.nix</path>
        <kind>service-instance</kind>
        <symbol>clan.inventory.instances.zerotier</symbol>
        <lines>1-15</lines>
        <reason>Zerotier service instance: controller role on hetzner-ccx23, peer role on all machines. Generates zerotier vars.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/services/emergency-access.nix</path>
        <kind>service-instance</kind>
        <symbol>clan.inventory.instances.emergency-access</symbol>
        <lines>1-13</lines>
        <reason>Emergency access service instance for all machines. Generates emergency-access password vars.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/services/users.nix</path>
        <kind>service-instance</kind>
        <symbol>clan.inventory.instances.users-root</symbol>
        <lines>1-14</lines>
        <reason>Root user service instance for all machines. Generates user-password-root vars.</reason>
      </artifact>

      <!-- Current TC-007 Test Implementation (Needs Enhancement) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/checks/validation.nix</path>
        <kind>test</kind>
        <symbol>secrets-generation</symbol>
        <lines>71-103</lines>
        <reason>TC-007 current smoke test - only validates clan CLI availability. Story 1.8 must enhance to comprehensive vars lifecycle test.</reason>
      </artifact>

      <!-- Justfile (Needs Secrets/Vars Sections) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/justfile</path>
        <kind>build-config</kind>
        <symbol>justfile</symbol>
        <lines>1-77</lines>
        <reason>Current justfile with testing and building sections. Story 1.8 adds new ## secrets and ## vars sections for clan command recipes.</reason>
      </artifact>

      <!-- Vars Structure (Already Operational) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/vars/per-machine/hetzner-ccx23/</path>
        <kind>directory</kind>
        <symbol>vars-structure</symbol>
        <lines>N/A</lines>
        <reason>Operational vars structure: zerotier/, emergency-access/, initrd-ssh/, user-password-root/, luks-password/, state-version/, tor_tor/, zfs/. Generated by clan service instances.</reason>
      </artifact>

      <!-- Sops Secrets Structure -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/sops/</path>
        <kind>directory</kind>
        <symbol>sops-structure</symbol>
        <lines>N/A</lines>
        <reason>Clan secrets structure: sops/secrets/ (encrypted), sops/machines/ (machine age keys), sops/users/ (user age keys). Encryption backend for vars.</reason>
      </artifact>
    </code>

    <dependencies>
      <!-- Nix Flake Inputs from test-clan -->
      <nix>
        <package name="nixpkgs" version="nixos-unstable" />
        <package name="flake-parts" version="hercules-ci/flake-parts" />
        <package name="clan-core" version="git+https://git.clan.lol/clan/clan-core" />
        <package name="import-tree" version="github:vic/import-tree" />
        <package name="terranix" version="github:terranix/terranix" />
        <package name="disko" version="github:nix-community/disko" />
        <package name="srvos" version="github:nix-community/srvos" />
        <package name="treefmt-nix" version="github:numtide/treefmt-nix" />
        <package name="git-hooks" version="github:cachix/git-hooks.nix" />
        <package name="nix-unit" version="github:nix-community/nix-unit" />
      </nix>

      <!-- Development Tools in devShell -->
      <tools>
        <tool name="clan" description="Clan CLI for secrets/vars management (from clan-core)" />
        <tool name="just" description="Task runner for justfile recipes" />
        <tool name="jq" description="JSON processing for test scripts" />
        <tool name="age" description="Encryption tool (backend for clan secrets)" />
        <tool name="opentofu" description="Terraform alternative for infrastructure" />
      </tools>
    </dependencies>
  </artifacts>

  <constraints>
    **Story Scope (VALIDATION/DOCUMENTATION, not implementation):**
    - This story validates EXISTING infrastructure from Stories 1.5-1.7
    - NOT implementing vars infrastructure (already operational)
    - NOT creating test harness (18 tests already passing)
    - NOT refactoring architecture (pure dendritic already achieved)
    - Focus: validation, testing enhancement, documentation, operational understanding

    **Documentation Constraints (CRITICAL):**
    - MUST defer to clan-core official documentation as authoritative source
    - test-clan documentation shows APPLICATION of clan patterns, not reinvention
    - Reference ~/projects/nix-workspace/clan-core/docs/site/guides/vars/ for vars workflow
    - Reference ~/projects/nix-workspace/clan-core/docs/site/guides/secrets.md for secrets
    - NO uppercase/shouting filenames - use lowercase kebab-case
    - File location: test-clan/docs/notes/development/secrets-management.md

    **Justfile Integration Constraints:**
    - Add new ## secrets and ## vars sections to test-clan/justfile
    - Recipes delegate to clan CLI commands (just provides convenience)
    - Follow existing justfile patterns (## sections, # recipe docs)
    - Recipes make essential clan commands easily recallable

    **Test Enhancement Constraints:**
    - TC-007 currently smoke test only (clan CLI availability)
    - Must enhance to comprehensive vars lifecycle test
    - Test must run in check derivation (no deployed infrastructure required)
    - Test must validate: vars directory structure, secret encryption, public facts, idempotency
    - Test execution via: `nix flake check` or `just test` (full suite), `just test-quick` (fast tests only)

    **Operational Safety:**
    - NO cloud resource changes (infrastructure already deployed)
    - NO VM configuration changes (no nixos-rebuild on remote)
    - Read-only inspection of deployed systems
    - Test enhancements only
    - Zero-regression mandate does NOT apply (experimental test-clan repository)

    **Architectural Constraints (from Stories 1.6-1.7):**
    - Pure dendritic flake-parts pattern with import-tree auto-discovery
    - Clan-core integration via modules/clan/core.nix
    - Test harness in modules/checks/ with auto-discovery
    - Service instances define vars generation (zerotier, emergency-access, users-root, etc.)

    **Vars Workflow Constraints (from clan-core):**
    - Vars = Secrets (encrypted) + Facts (public)
    - Service instances generate vars via clan.inventory.instances
    - Encryption via age for admins group + machine keys
    - Deployment via sops-nix to /run/secrets/vars/ (tmpfs)
    - Generation command: clan vars generate &lt;machine&gt;

    **SSH Host Key Investigation:**
    - Question: Are SSH host keys persistent via vars or ephemeral?
    - Need to validate across nixos-rebuild switch
    - Acceptable outcomes: vars-managed (ideal), config-driven (acceptable), ephemeral (document gap)
    - Investigation only - NOT a blocker for story completion
  </constraints>

  <interfaces>
    **Clan CLI Commands (Essential for Story 1.8):**
    - clan secrets --help: Show secrets management commands
    - clan vars generate &lt;machine&gt;: Generate vars for specific machine
    - clan secrets list: List all secrets
    - clan secrets get &lt;secret&gt;: Retrieve specific secret value
    - clan secrets set &lt;secret&gt;: Store secret value

    **Clan Inventory API (Service Instance Configuration):**
    - clan.inventory.machines.&lt;name&gt;: Define machine with tags and machineClass
    - clan.inventory.instances.&lt;service&gt;: Define service instance
    - instance.module: {name, input} - service module reference
    - instance.roles.&lt;role&gt;.machines.&lt;name&gt;: Assign role to specific machine
    - instance.roles.&lt;role&gt;.tags.&lt;tag&gt;: Assign role to all machines with tag

    **Vars Directory Structure API:**
    - vars/per-machine/&lt;machine&gt;/: Per-machine vars root
    - vars/per-machine/&lt;machine&gt;/&lt;service&gt;/: Service-specific vars
    - Secret vars: users/ and machines/ symlinks to age recipients
    - Public facts: value files readable without decryption

    **Test Harness API (from Story 1.6):**
    - Test location: modules/checks/&lt;category&gt;.nix
    - Test execution: nix build .#checks.&lt;system&gt;.&lt;test-name&gt; or nix flake check
    - Test runner: justfile recipes (just test, just test-quick, just test-integration)
    - Test discovery: import-tree auto-discovery from modules/checks/

    **Justfile Recipe API (Pattern to Follow):**
    - Section headers: ## &lt;section-name&gt; (lowercase)
    - Recipe docs: # &lt;description&gt; (single line before recipe)
    - Recipe format: recipe-name arg1 arg2: (kebab-case names)
    - Command execution: @echo for output, direct commands for execution
  </interfaces>

  <tests>
    <standards>
Test framework: nix-unit for expression tests, runCommand for derivation tests, runNixOSTest for VM tests.
Test location: modules/checks/ with auto-discovery via import-tree.
Test execution: `nix flake check` (all tests), `just test` (full suite), `just test-quick` (fast tests), `just test-integration` (VM tests).
Test categories: regression (must pass), invariant (must pass), feature (expected state), integration (VM tests).
Test harness from Story 1.6: 18 tests operational, TC-007 is smoke test needing enhancement.
Test naming: TC-NNN format with descriptive names (e.g., TC-007: secrets-generation).
Test documentation: passthru.meta.description for each test explaining purpose.
    </standards>

    <locations>
~/projects/nix-workspace/test-clan/modules/checks/validation.nix (TC-007 location - enhance here)
~/projects/nix-workspace/test-clan/modules/checks/nix-unit.nix (expression evaluation tests)
~/projects/nix-workspace/test-clan/modules/checks/integration.nix (VM boot tests)
~/projects/nix-workspace/test-clan/modules/checks/performance.nix (CI performance tests)
~/projects/nix-workspace/test-clan/justfile (test execution recipes: test, test-quick, test-integration)
    </locations>

    <ideas>
**Enhanced TC-007: Vars Lifecycle Test (AC #2)**
- Test 1: Vars directory structure exists (vars/per-machine/)
- Test 2: Machine vars directories present for all 3 machines (hetzner-ccx23, hetzner-cx43, gcp-vm)
- Test 3: Expected var categories present (zerotier/, emergency-access/, state-version/, initrd-ssh/, user-password-root/)
- Test 4: Secret files have age recipients (check for users/ and machines/ symlinks)
- Test 5: Public facts are readable (zerotier-ip/value, state-version/version/value can be read)
- Test 6: Vars generation is idempotent (structure validates without requiring regeneration)

**TC-018: SSH Host Key Persistence (AC #1 - Optional)**
- Test: SSH host key fingerprint unchanged after nixos-rebuild switch
- Implementation: VM test that rebuilds and compares SSH fingerprints
- Defer if complex - investigation may be sufficient for Story 1.8

**Documentation Validation (AC #3)**
- Verify test-clan/docs/notes/development/secrets-management.md exists
- Check file references clan-core docs as authoritative source
- Validate justfile has ## secrets and ## vars sections
- Confirm recipes delegate to clan CLI commands

**Vars Workflow End-to-End Validation (AC #4)**
- Manual validation via SSH to hetzner-ccx23
- Inspect vars structure on deployed VM (/run/secrets/vars/)
- Verify age encryption (recipients correct)
- Document actual commands used (for reproducibility)

**Multi-Machine Pattern Documentation (AC #5)**
- Compare vars between hetzner-ccx23 (controller, LUKS) and hetzner-cx43 (peer, no LUKS)
- Document role-based vars differences (zerotier-network-id only on controller)
- Document machine-specific vars (luks-password, zfs/key on ccx23 only)
- Validate shared secret encryption (admins group + machine keys)
    </ideas>
  </tests>
</story-context>
