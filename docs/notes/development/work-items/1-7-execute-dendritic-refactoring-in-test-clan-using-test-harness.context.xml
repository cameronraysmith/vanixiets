<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>7</storyId>
    <title>Execute Dendritic Flake-Parts Refactoring in test-clan Using Test Harness</title>
    <status>Drafted</status>
    <generatedAt>2025-11-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-7-execute-dendritic-refactoring-in-test-clan-using-test-harness.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>A platform engineer validating infrastructure deployment patterns</asA>
    <iWant>To refactor test-clan from manual imports to full dendritic flake-parts compliance with automatic import-tree discovery, namespace exports, and self-composition</iWant>
    <soThat>The infrastructure codebase adopts scalable O(1) dendritic patterns while maintaining zero regression through comprehensive test-driven validation</soThat>
    <tasks>
      <task id="task-1" title="Refactoring Step 2.1 - Add import-tree Discovery">
        Replace manual imports in flake.nix with inputs.import-tree ./modules pattern.
        Update flake.nix outputs function signature.
        Run tests and validate FT-1 passes.
        Commit changes with descriptive message.
      </task>
      <task id="task-2" title="Refactoring Step 2.2 - Export Base Modules to Namespace">
        Create modules/base/default.nix with namespace exports pattern.
        Export base modules to config.flake.modules.nixos.base.*.
        Verify import-tree discovers the new default.nix.
        Run tests and validate base modules accessible.
        Commit changes.
      </task>
      <task id="task-3" title="Refactoring Step 2.3 - Refactor One Host Module">
        Update hetzner-ccx23 host module to use namespace imports.
        Replace relative paths with config.flake.modules.nixos.base pattern.
        Build and test hetzner-ccx23 configuration.
        Run VM test for hetzner-ccx23.
        Verify regression tests pass.
        Commit changes.
      </task>
      <task id="task-4" title="Refactoring Step 2.4 - Refactor Remaining Hosts">
        Apply namespace import pattern to hetzner-cx43 and gcp-vm.
        Build and test each configuration.
        Run full test suite after all hosts refactored.
        Verify ALL tests pass (regression, invariant, feature).
        Commit changes for each host.
      </task>
      <task id="task-5" title="Refactoring Step 2.5 - Assess Automatic Host Collection">
        Evaluate automatic nixosConfigurations generation feasibility.
        Research clan.machines integration requirements.
        Implement or defer with documented rationale.
        Commit decision and implementation (if applicable).
      </task>
      <task id="task-6" title="Final Validation and Merge">
        Run complete test suite to verify all tests pass.
        Validate terraform output equivalence.
        Run nix flake check for final validation.
        Merge feature branch to main with --no-ff.
        Update sprint-status.yaml marking Story 1.7 done.
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">All Regression Tests Passing Throughout Refactoring (RT-1, RT-2, RT-3) - Terraform output equivalent, NixOS closures equivalent, all machines build</criterion>
    <criterion id="AC2">All Invariant Tests Passing Throughout Refactoring (IT-1, IT-2, IT-3) - Clan inventory preserved, service targeting unchanged, specialArgs propagation maintained</criterion>
    <criterion id="AC3">All Feature Tests Passing After Refactoring (FT-1, FT-2, FT-3) - import-tree discovery works, namespace exports functional, self-composition implemented</criterion>
    <criterion id="AC4">All Integration Tests Passing After Refactoring (VT-1) - VMs boot successfully, base module features validated</criterion>
    <criterion id="AC5">Refactoring Steps Completed with Validation - All 5 steps (2.1-2.5) completed with tests passing at each step</criterion>
    <criterion id="AC6">Git Workflow and Rollback Safety - Feature branch used, per-step commits, test validation documented, merge after all tests pass</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/notes/development/work-items/1-6-implement-comprehensive-test-harness-for-test-clan.md"
           title="Story 1.6 Completion - Test Harness Implementation"
           section="Lessons Learned and Post-Implementation Investigation">
        Critical findings: withSystem pattern is correct and optimal for test-clan. Feature tests FT-1 and FT-2 define success criteria for dendritic implementation. Test harness validates zero regression through RT-1/2/3 and IT-1/2/3.
      </doc>
      <doc path="docs/notes/development/research/flake-parts-nix-unit-test-integration.md"
           title="Flake-Parts Testing Research"
           section="Section 11: Investigation Results and Section 6: Correct Implementation Pattern">
        Critical architectural constraints: perSystem evaluation happens BEFORE flake outputs exist. Tests needing flake outputs MUST use withSystem at flake level. nix-unit requires allowNetwork=true (fixed-output derivation) - withSystem is superior.
      </doc>
      <doc path="~/projects/nix-workspace/test-clan/README.md"
           title="test-clan Test Suite Documentation"
           section="Test Suite Overview">
        Comprehensive test suite with 8 checks per system. Feature tests FT-1 (dendritic-modules) and FT-2 (namespace-exports) currently fail as expected - will pass when dendritic refactoring is complete.
      </doc>
    </docs>

    <code>
      <artifact path="~/projects/nix-workspace/drupol-dendritic-infra/flake.nix"
               kind="reference-implementation"
               symbol="outputs"
               lines="64"
               reason="Production reference for dendritic flake-parts pattern using import-tree. Shows complete pattern: inputs.import-tree ./modules with automatic module discovery">
      </artifact>

      <artifact path="~/projects/nix-workspace/drupol-dendritic-infra/modules/flake-parts/host-machines.nix"
               kind="flake-parts-module"
               symbol="collectHostsModules"
               lines="1-37"
               reason="Automatic host collection pattern - filters modules by 'hosts/' prefix and generates nixosConfigurations. Demonstrates how to implement automatic host discovery">
      </artifact>

      <artifact path="~/projects/nix-workspace/drupol-dendritic-infra/modules/hosts/x13/default.nix"
               kind="host-module"
               symbol="flake.modules.nixos.hosts/x13"
               lines="7-48"
               reason="Reference host module structure showing namespace import pattern: 'with config.flake.modules.nixos; [ base bluetooth desktop ... ]'">
      </artifact>

      <artifact path="~/projects/nix-workspace/drupol-dendritic-infra/modules/base/network/default.nix"
               kind="base-module"
               symbol="flake.modules.nixos.base"
               lines="2-23"
               reason="Base module export pattern showing how to structure modules for namespace exports. Pattern: flake.modules.nixos.base = { ... }">
      </artifact>

      <artifact path="~/projects/nix-workspace/test-clan/flake.nix"
               kind="current-state"
               symbol="top@"
               lines="30-48"
               reason="Current test-clan flake structure with manual imports. This is the baseline to refactor. Uses top@ pattern for test access">
      </artifact>

      <artifact path="~/projects/nix-workspace/test-clan/modules/flake-parts/clan.nix"
               kind="current-state"
               symbol="clan.machines"
               lines="108-120"
               reason="Current manual machine registration. May be replaced with automatic collection in Step 2.5">
      </artifact>

      <artifact path="~/projects/nix-workspace/test-clan/modules/hosts/hetzner-ccx23/default.nix"
               kind="current-state"
               symbol="imports"
               lines="3-10"
               reason="Current relative path imports: ../../base/nix-settings.nix. Will be refactored to namespace imports: with config.flake.modules.nixos.base; [ nix-settings admins initrd-networking ]">
      </artifact>

      <artifact path="~/projects/nix-workspace/test-clan/tests/integration/feature.nix"
               kind="test"
               symbol="dendritic-modules, namespace-exports"
               lines="14-54"
               reason="Feature tests that define success criteria. FT-1 validates flake.dendriticModules exists. FT-2 validates flake.namespace structure. Currently fail - will pass after refactoring">
      </artifact>

      <artifact path="~/projects/nix-workspace/test-clan/tests/integration/regression.nix"
               kind="test"
               symbol="terraform-modules-exist, machine-configs-exist"
               lines="all"
               reason="Regression tests that MUST continue passing throughout refactoring. Validate existing functionality preserved">
      </artifact>

      <artifact path="~/projects/nix-workspace/test-clan/tests/integration/invariant.nix"
               kind="test"
               symbol="clan-inventory, nixos-configs"
               lines="all"
               reason="Invariant tests that validate architectural constraints. clan-core integration MUST be preserved">
      </artifact>
    </code>

    <dependencies>
      <nix>
        <input name="flake-parts" version="github:hercules-ci/flake-parts" />
        <input name="import-tree" version="github:vic/import-tree" note="Required for dendritic auto-discovery" />
        <input name="clan-core" version="git+https://git.clan.lol/clan/clan-core" note="Must preserve integration" />
        <input name="terranix" version="github:terranix/terranix" note="Must preserve integration" />
        <input name="disko" version="github:nix-community/disko" />
        <input name="srvos" version="github:nix-community/srvos" />
        <input name="nixpkgs" version="github:NixOS/nixpkgs/nixos-unstable" />
      </nix>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>CRITICAL: Must use withSystem pattern for any tests needing flake outputs (research doc Section 11)</constraint>
    <constraint>CRITICAL: Must avoid circular dependencies - perSystem evaluation happens BEFORE flake outputs exist</constraint>
    <constraint>CRITICAL: Each .nix file in dendritic structure must be a valid flake-parts module</constraint>
    <constraint>CRITICAL: Must maintain clan-core integration contract (specialArgs propagation, inventory structure)</constraint>
    <constraint>CRITICAL: Must maintain terranix integration (terranix modules must continue to work)</constraint>
    <constraint>ARCHITECTURAL: Use import-tree pattern for automatic module discovery: inputs.import-tree ./modules</constraint>
    <constraint>ARCHITECTURAL: Base modules must export to namespace: flake.modules.nixos.base.*</constraint>
    <constraint>ARCHITECTURAL: Host modules must use self-composition: with config.flake.modules.nixos; [ base ... ]</constraint>
    <constraint>SAFETY: Work on feature branch (feature/dendritic-refactoring), commit per step</constraint>
    <constraint>SAFETY: Do NOT deploy to production VMs until ALL tests pass</constraint>
    <constraint>VALIDATION: All regression tests (RT-1,2,3) must pass at each step</constraint>
    <constraint>VALIDATION: All invariant tests (IT-1,2,3) must pass at each step</constraint>
    <constraint>VALIDATION: Feature tests (FT-1,2) should pass after complete refactoring</constraint>
    <constraint>GIT WORKFLOW: Per-step atomic commits, rollback plan available</constraint>
  </constraints>

  <interfaces>
    <interface name="import-tree API"
              kind="flake-helper"
              signature="inputs.import-tree ./modules"
              path="https://github.com/vic/import-tree">
      Automatically imports all .nix files in ./modules as flake-parts modules. Each file becomes discoverable without manual registration.
    </interface>

    <interface name="flake-parts module namespace"
              kind="flake-output"
              signature="config.flake.modules.nixos.&lt;category&gt;.&lt;module&gt;"
              path="modules/*/default.nix">
      Namespace for exported modules. Accessed via 'with config.flake.modules.nixos; [ base ... ]' in host modules.
    </interface>

    <interface name="clan-core specialArgs"
              kind="nixos-module-arg"
              signature="{ inherit inputs; }"
              path="modules/flake-parts/clan.nix:19">
      specialArgs passed to all clan machines. MUST be preserved for clan-core integration.
    </interface>

    <interface name="clan inventory structure"
              kind="clan-api"
              signature="{ machines = {...}; instances = {...}; }"
              path="modules/flake-parts/clan.nix:21-103">
      Clan inventory defining machines and service instances. Structure MUST be preserved.
    </interface>

    <interface name="test harness withSystem pattern"
              kind="test-pattern"
              signature="withSystem system ({ pkgs, ... }: { checks = {...}; })"
              path="flake.nix:62-99">
      Correct pattern for accessing flake outputs in tests. Used in all test files.
    </interface>
  </interfaces>

  <tests>
    <standards>
      Test suite uses withSystem pattern at flake level (NOT nix-unit which requires allowNetwork=true).
      Tests organized in tests/integration/ directory.
      Four test categories: Regression (RT), Invariant (IT), Feature (FT), Integration (VT).
      All tests run via 'nix flake check' and individual builds via 'nix build .#checks.&lt;system&gt;.&lt;test-name&gt;'.

      CRITICAL PATTERN: Tests defined using withSystem to access both perSystem context (pkgs) and complete flake outputs (via top.config.flake).

      Test execution workflow:
      1. Individual test: nix build .#checks.x86_64-linux.terraform-modules-exist
      2. Full suite: nix flake check
      3. Validation: Each test must exit 0 (pass) or exit 1 (fail) with clear error messages
    </standards>

    <locations>
      tests/integration/regression.nix - RT-1, RT-2, RT-3
      tests/integration/invariant.nix - IT-1, IT-2, IT-3
      tests/integration/feature.nix - FT-1, FT-2 (EXPECTED TO FAIL until refactoring complete)
      tests/integration/vm-boot.nix - VT-1
      flake.nix:62-99 - Test integration using withSystem pattern
    </locations>

    <ideas>
      <idea criterion="AC1-RT1">Validate terraform-modules-exist test continues to pass (terranix integration preserved)</idea>
      <idea criterion="AC1-RT2">Validate machine-configs-exist test continues to pass (all 3 machines still build)</idea>
      <idea criterion="AC1-RT3">Verify NixOS closure equivalence between baseline and refactored versions</idea>
      <idea criterion="AC2-IT1">Validate clan-inventory test continues to pass (inventory structure preserved)</idea>
      <idea criterion="AC2-IT2">Verify zerotier service targeting unchanged (controller + peer roles)</idea>
      <idea criterion="AC2-IT3">Validate nixos-configs test continues to pass (specialArgs propagation works)</idea>
      <idea criterion="AC3-FT1">After Step 2.1: dendritic-modules test should PASS (import-tree discovers modules)</idea>
      <idea criterion="AC3-FT2">After Step 2.2: namespace-exports test should PARTIALLY PASS (base modules exported)</idea>
      <idea criterion="AC3-FT3">After Step 2.4: namespace-exports test should FULLY PASS (hosts use namespace imports)</idea>
      <idea criterion="AC4-VT1">VM test framework validates throughout (basic VM boot capability preserved)</idea>
      <idea criterion="AC5">Run full test suite after each refactoring step (2.1, 2.2, 2.3, 2.4, 2.5)</idea>
      <idea criterion="AC6">Validate git log shows atomic commits per step with descriptive messages</idea>
    </ideas>
  </tests>
</story-context>
