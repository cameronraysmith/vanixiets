<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>8</storyId>
    <title>Migrate blackphos from infra to test-clan management</title>
    <status>drafted</status>
    <generatedAt>2025-11-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-8-migrate-blackphos-from-infra-to-test-clan.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to migrate blackphos nix-darwin configuration from infra's nixos-unified pattern to test-clan's dendritic + clan pattern</iWant>
    <soThat>I can validate the complete transformation process and document the migration pattern for refactoring infra in Epic 2+</soThat>
    <tasks>
### Task 1: Investigate Current blackphos Configuration (1-2 hours)
- Read complete infra/configurations/darwin/blackphos.nix
- Read complete infra/configurations/home/raquel@blackphos.nix
- Identify all darwin modules used
- Identify all home modules used
- Check for secrets usage
- Document package list and configuration options

### Task 2: Study Reference Implementations (1-2 hours)
- Study mic92-clan-dotfiles/machines/evo/configuration.nix (darwin + sops-nix)
- Study test-clan dendritic pattern from Story 1.7
- Document home-manager integration patterns
- Document secrets management strategy

### Task 3: Create blackphos Darwin Module (2-3 hours)
- Create test-clan/modules/machines/darwin/blackphos/default.nix
- Convert configuration using dendritic flake-parts pattern
- Migrate all functionality from infra
- Build test: nix build .#darwinConfigurations.blackphos.system

### Task 4: Integrate Home-Manager for Both Users (2-3 hours)
- Create home-manager configurations for crs58 (admin) and raquel (primary)
- Migrate raquel's packages and config
- Disable LazyVim for raquel
- Build test with home-manager integration

### Task 5: Add blackphos to Clan Inventory (30 minutes - 1 hour)
- Add to test-clan inventory with tags and machineClass
- Register in clan.machines
- Verify inventory and darwinConfigurations

### Task 6: Migrate Secrets to Clan Vars (1-2 hours)
- Generate clan admin keypair
- Identify existing secrets
- Define generators for system values
- Generate vars for blackphos

### Task 7: Deploy to blackphos Hardware (2-3 hours)
- Pre-deployment safety (backup, package list)
- Deploy: darwin-rebuild switch
- Validate activation
- Post-deployment verification

### Task 8: Zero-Regression Validation (1-2 hours)
- Compare package lists
- Test raquel's workflows
- Verify all functionality
- Document differences

### Task 9: Document Transformation Pattern (1-2 hours)
- Document step-by-step transformation
- Capture common issues
- Note darwin-specific considerations
- Format for Epic 2+ reference</tasks>
  </story>

  <acceptanceCriteria>
### AC1: Blackphos Darwin Configuration Migrated to test-clan
- Darwin host module created at test-clan/modules/machines/darwin/blackphos/default.nix following dendritic pattern
- Configuration uses namespace imports (with config.flake.modules pattern)
- All existing functionality preserved (homebrew, desktop profile, touchID, stateVersion)
- Module exports to flake.modules.darwin."machines/darwin/blackphos" namespace
- Configuration builds: nix build .#darwinConfigurations.blackphos.system

### AC2: Home-Manager Integration for Users
- Home-manager integrated for both users (crs58, raquel)
- crs58: Minimal admin configuration
- raquel: Full home configuration migrated with packages and git config
- LazyVim disabled for raquel (mkForce false)
- Home-manager integration pattern documented

### AC3: Blackphos Added to Clan Inventory
- blackphos added to clan inventory (tags = ["darwin" "workstation" "laptop"], machineClass = "darwin")
- Clan machine registration in modules/clan/machines.nix
- Inventory evaluates: nix eval .#clan.inventory --json | jq '.machines.blackphos'

### AC4: Secrets Migrated to Clan Vars
- Existing secrets identified and documented
- Secrets migrated using clan vars generators pattern
- Clan admin keypair generated and users added
- Vars generated for blackphos
- Migration documented with rationale

### AC5: Configuration Builds and Deploys Successfully
- Configuration builds without errors
- Deployment to blackphos hardware successful
- System activates successfully
- All services start correctly
- Users can log in and home-manager activations succeed

### AC6: Zero-Regression Validation
- Pre/post migration package lists captured and compared
- All critical packages present
- raquel's daily workflows validated (terminal, git, dev tools, GUI apps)
- Any differences documented and justified

### AC7: Transformation Pattern Documented
- Migration process documented (nixos-unified → dendritic + clan)
- Module organization patterns captured
- Secrets migration approach documented
- Home-manager integration pattern documented
- Common issues and solutions documented
- Darwin-specific considerations noted</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/notes/development/epics.md</path>
        <title>Epic 1: Architectural Validation + Migration Pattern Rehearsal</title>
        <section>Story 1.8</section>
        <snippet>Migrate blackphos from infra to test-clan management - rehearses complete nixos-unified → dendritic + clan transformation on real darwin hardware, documenting the migration pattern as blueprint for Epic 2+</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-7-execute-dendritic-refactoring-in-test-clan-using-test-harness.md</path>
        <title>Story 1.7 Completion: Dendritic Pattern Validated</title>
        <section>Dev Notes - Previous Story Learnings</section>
        <snippet>Pure import-tree auto-discovery works perfectly, base module namespace merging validated, host modules use namespace imports (self-composition), zero regressions in nixos context</snippet>
      </doc>
      <doc>
        <path>CLAUDE.md</path>
        <title>infra Repository Overview</title>
        <section>Machine Fleet</section>
        <snippet>blackphos: nix-darwin laptop, primary user raquel, admin user crs58. Currently managed by infra using nixos-unified pattern.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>configurations/darwin/blackphos.nix</path>
        <kind>darwin-configuration</kind>
        <symbol>blackphos config</symbol>
        <lines>1-43</lines>
        <reason>Current nixos-unified darwin configuration to be migrated - includes homebrew casks, desktop profile, touchID, primary user crs58</reason>
      </artifact>
      <artifact>
        <path>configurations/home/raquel@blackphos.nix</path>
        <kind>home-configuration</kind>
        <symbol>raquel home config</symbol>
        <lines>1-47</lines>
        <reason>raquel's home-manager config to be migrated - includes git config, zsh, starship, dev tools (just, ripgrep, fd, bat, eza), LazyVim disabled</reason>
      </artifact>
      <artifact>
        <path>modules/darwin/default.nix</path>
        <kind>darwin-module</kind>
        <symbol>darwin base module</symbol>
        <lines>1-28</lines>
        <reason>Current darwin base module pattern using nixos-unified - shows home-manager integration, user configuration, imports structure</reason>
      </artifact>
      <artifact>
        <path>modules/home/default.nix</path>
        <kind>home-module</kind>
        <symbol>home base module</symbol>
        <lines>1-35</lines>
        <reason>Current home-manager base module - imports LazyVim, nix-index, sops, agents-md, and local modules</reason>
      </artifact>
      <artifact>
        <path>modules/home/darwin-only.nix</path>
        <kind>home-module</kind>
        <symbol>darwin-specific home config</symbol>
        <lines>1-20</lines>
        <reason>Darwin-specific home-manager configuration - imports zsh and colima, enables zsh by default</reason>
      </artifact>
    </code>
    <dependencies>
      <nix>
        <package name="nixpkgs" version="unstable"/>
        <package name="nix-darwin" version="latest"/>
        <package name="home-manager" version="latest"/>
        <package name="clan-core" version="main branch"/>
        <package name="flake-parts" version="latest"/>
        <package name="import-tree" version="latest"/>
        <package name="sops-nix" version="latest"/>
        <package name="mac-app-util" version="latest"/>
        <package name="lazyvim" version="latest"/>
        <package name="nix-index-database" version="latest"/>
      </nix>
      <homebrew>
        <cask>codelayer-nightly</cask>
        <cask>dbeaver-community</cask>
        <cask>docker-desktop</cask>
        <cask>gpg-suite</cask>
        <cask>inkscape</cask>
        <cask>keycastr</cask>
        <cask>meld</cask>
        <cask>postgres-unofficial</cask>
      </homebrew>
    </dependencies>
  </artifacts>

  <constraints>
## Development Constraints

### Dendritic Pattern Requirements (from Story 1.7)
- Use pure import-tree auto-discovery (flake.nix:58 pattern from test-clan)
- Export darwin modules to flake.modules.darwin namespace
- Use namespace imports (with config.flake.modules) not relative paths
- Follow test-clan dendritic structure validated in Story 1.7
- Keep flake.nix minimal (no manual imports)

### Home-Manager Integration
- Integrated approach recommended (Option A from story notes)
- Import inputs.home-manager.darwinModules.home-manager
- Configure home-manager.users.{crs58,raquel}
- Reference infra modules/darwin/default.nix for home-manager pattern
- raquel must have LazyVim disabled (lib.mkForce false)

### Clan Integration Patterns
- Manual machine registration required (clan.machines.blackphos in modules/clan/machines.nix)
- Inventory declaration in modules/clan/inventory/machines.nix
- machineClass = "darwin" (not "nixos")
- Tags: ["darwin" "workstation" "laptop"]

### Secrets Management Strategy
- Use clan vars generators pattern (NOT raw sops-nix like mic92)
- Clan vars uses sops-nix as encryption backend (clan-core docs: secrets.md)
- macOS explicitly supports clan vars (clan-core docs: macos.md line 10)
- Define generators using clan.core.vars.generators.&lt;name&gt; pattern
- Age keys at ~/.config/sops/age/keys.txt or SOPS_AGE_KEY env var
- Reference clan-core docs: guides/vars/vars-backend.md for generator examples

### Zero-Regression Mandate
- All existing functionality must be preserved
- Capture pre-migration package list for comparison
- Validate all raquel workflows (terminal, git, dev tools, homebrew apps)
- Document any differences with justification
- TouchID sudo authentication must work
- All homebrew casks must be accessible

### Darwin-Specific Considerations
- darwinConfigurations (not nixosConfigurations)
- darwin-rebuild (not nixos-rebuild)
- No disko (darwin uses existing APFS)
- No initrd (different boot process)
- Homebrew required for GUI applications
- Different system paths (/Library/ vs /etc/)
- System primaryUser must be set correctly (crs58 admin for blackphos)</constraints>

  <interfaces>
## Key Interfaces

### Dendritic Module Export Pattern
```nix
# modules/machines/darwin/blackphos/default.nix
{
  flake.modules.darwin."machines/darwin/blackphos" = { config, pkgs, ... }: {
    imports = with config.flake.modules.darwin; [
      base  # If darwin base modules exist
    ];
    # Configuration here
  };
}
```

### Clan Machine Registration
```nix
# modules/clan/machines.nix
clan.machines.blackphos = {
  imports = [ config.flake.modules.darwin."machines/darwin/blackphos" ];
};
```

### Clan Inventory Declaration
```nix
# modules/clan/inventory/machines.nix
clan.inventory.machines.blackphos = {
  tags = ["darwin" "workstation" "laptop"];
  machineClass = "darwin";
};
```

### Home-Manager Integration (Integrated Pattern)
```nix
imports = [
  inputs.home-manager.darwinModules.home-manager
];

home-manager.users.raquel = {
  imports = [ /* home modules */ ];
  # raquel's home config
};

home-manager.users.crs58 = {
  # minimal admin config
};
```

### Clan Vars Generator Pattern
```nix
clan.core.vars.generators.ssh-host-key = {
  files."ed25519_priv".secret = true;
  files."ed25519".secret = false;
  script = ''
    ssh-keygen -t ed25519 -N "" -f $out/ed25519
    mv $out/ed25519 $out/ed25519_priv
  '';
  runtimeInputs = [ pkgs.openssh ];
};

# Access in config:
services.openssh.hostKeys = [{
  path = config.clan.core.vars.generators.ssh-host-key.files.ed25519_priv.path;
  type = "ed25519";
}];
```</interfaces>

  <tests>
    <standards>
Tests should validate configuration builds, deployment success, and zero regressions. Use nix build commands to verify configurations compile. Capture package lists before and after migration for comparison. Test actual deployment to blackphos hardware with backup safety measures. Validate all user workflows and functionality post-migration.
    </standards>
    <locations>
- Configuration build tests: nix build .#darwinConfigurations.blackphos.system
- Clan inventory tests: nix eval .#clan.inventory --json | jq '.machines.blackphos'
- DarwinConfigurations list: nix eval .#darwinConfigurations --apply builtins.attrNames
- Package comparison: darwin-rebuild build --flake .#blackphos && nix-store -q --references result | sort
- Deployment test: darwin-rebuild switch --flake ~/projects/nix-workspace/test-clan#blackphos
    </locations>
    <ideas>
### Test Ideas Mapped to Acceptance Criteria

**AC1 Testing (Darwin Configuration Migration):**
- Build test: nix build .#darwinConfigurations.blackphos.system (should succeed without errors)
- Module export test: nix eval .#flake.modules.darwin --apply builtins.attrNames (should include "machines/darwin/blackphos")
- Namespace import test: Verify configuration uses config.flake.modules pattern not relative imports

**AC2 Testing (Home-Manager Integration):**
- Home config evaluation: nix eval .#darwinConfigurations.blackphos.config.home-manager.users --apply builtins.attrNames (should include "crs58" and "raquel")
- raquel package test: Verify raquel's packages include git, gh, just, ripgrep, fd, bat, eza
- LazyVim test: Verify programs.lazyvim.enable is false for raquel (mkForce false applied)

**AC3 Testing (Clan Inventory):**
- Inventory structure test: nix eval .#clan.inventory.machines.blackphos --json (should have tags and machineClass)
- Machine registration test: nix eval .#clan.machines --apply builtins.attrNames (should include "blackphos")
- Tags validation: Verify tags include "darwin", "workstation", "laptop"

**AC4 Testing (Secrets/Vars):**
- Clan vars generation: clan vars generate blackphos (should succeed and create vars)
- Secrets file existence: Verify vars/ directory contains blackphos-specific files
- Generator definitions: Verify clan.core.vars.generators defined in configuration

**AC5 Testing (Build and Deploy):**
- Pre-deployment build: nix build .#darwinConfigurations.blackphos.system (must succeed before deploy)
- Deployment: darwin-rebuild switch --flake ~/projects/nix-workspace/test-clan#blackphos
- Activation verification: Check system log for errors during activation
- Service status: Verify homebrew, touchID, home-manager services active

**AC6 Testing (Zero-Regression):**
- Package list capture: Before migration from infra, after migration from test-clan
- Package diff: diff pre-migration-packages.txt post-migration-packages.txt
- Workflow validation: raquel tests terminal (zsh + starship), git operations, dev tools, homebrew casks
- Functional equivalence: All critical functionality working, not byte-for-byte package identity

**AC7 Testing (Documentation):**
- Documentation existence: Verify transformation pattern documented (inline or separate file)
- Completeness check: Documentation covers all aspects listed in AC7
- Usability validation: Can Epic 2+ follow documented pattern for other machines?
    </ideas>
  </tests>
</story-context>
