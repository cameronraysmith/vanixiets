<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>8</storyId>
    <title>Migrate blackphos from infra to test-clan management</title>
    <status>drafted</status>
    <generatedAt>2025-11-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-8-migrate-blackphos-from-infra-to-test-clan.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to migrate blackphos nix-darwin configuration from infra's nixos-unified pattern to test-clan's dendritic + clan pattern</iWant>
    <soThat>I can validate the complete transformation process and document the migration pattern for refactoring infra in Epic 2+</soThat>
    <tasks>
### Task 1: Investigate Current blackphos Configuration (1-2 hours)
- Read complete infra/configurations/darwin/blackphos.nix
- Read complete infra/configurations/home/raquel@blackphos.nix
- Identify all darwin modules used
- Identify all home modules used
- Check for secrets usage
- Document package list and configuration options

### Task 2: Study Reference Implementations (1-2 hours)
- Study mic92-clan-dotfiles/machines/evo/configuration.nix (darwin + sops-nix)
- Study test-clan dendritic pattern from Story 1.7
- Document home-manager integration patterns
- Document secrets management strategy

### Task 3: Create blackphos Darwin Module (2-3 hours)
- Create test-clan/modules/machines/darwin/blackphos/default.nix
- Convert configuration using dendritic flake-parts pattern
- Migrate all functionality from infra
- Build test: nix build .#darwinConfigurations.blackphos.system

### Task 4: Integrate Home-Manager for Both Users (2-3 hours)
- Create home-manager configurations for crs58 (admin) and raquel (primary)
- Migrate raquel's packages and config
- Disable LazyVim for raquel
- Build test with home-manager integration

### Task 5: Add blackphos to Clan Inventory (30 minutes - 1 hour)
- Add to test-clan inventory with tags and machineClass
- Register in clan.machines
- Verify inventory and darwinConfigurations

### Task 6: Migrate Secrets to Clan Vars (1-2 hours)
- Generate clan admin keypair
- Identify existing secrets
- Define generators for system values
- Generate vars for blackphos

### Task 7: Deploy to blackphos Hardware (2-3 hours)
- Pre-deployment safety (backup, package list)
- Deploy: darwin-rebuild switch
- Validate activation
- Post-deployment verification

### Task 8: Zero-Regression Validation (1-2 hours)
- Compare package lists
- Test raquel's workflows
- Verify all functionality
- Document differences

### Task 9: Document Transformation Pattern (1-2 hours)
- Document step-by-step transformation
- Capture common issues
- Note darwin-specific considerations
- Format for Epic 2+ reference</tasks>
  </story>

  <acceptanceCriteria>
### AC1: Blackphos Darwin Configuration Migrated to test-clan

- [ ] Darwin host module created at test-clan/modules/machines/darwin/blackphos/default.nix following dendritic pattern
- [ ] Configuration uses namespace imports (with config.flake.modules pattern from Story 1.7)
- [ ] All existing functionality preserved:
  - Homebrew packages and casks (codelayer-nightly, dbeaver-community, docker-desktop, gpg-suite, inkscape, keycastr, meld, postgres-unofficial)
  - Desktop profile enabled (isDesktop = true equivalent)
  - TouchID authentication for sudo
  - System state version preserved (stateVersion = 4)
- [ ] Module exports to flake.modules.darwin."machines/darwin/blackphos" namespace
- [ ] Configuration builds: `nix build .#darwinConfigurations.blackphos.system`

**Implementation Notes:**
- Reference infra/configurations/darwin/blackphos.nix for current config
- Reference mic92-clan-dotfiles/machines/evo/ for darwin + clan pattern
- Use dendritic self-composition (namespace imports, not relative paths)
- System primaryUser = "crs58" (admin user for blackphos)

### AC2: Home-Manager Integration for Users

- [ ] Home-manager integrated for both users (crs58, raquel)
- [ ] crs58 (admin user): Minimal admin configuration
- [ ] raquel (primary user): Full home configuration migrated from infra/configurations/home/raquel@blackphos.nix
- [ ] raquel's preferred tools preserved (git, gh, just, ripgrep, fd, bat, eza)
- [ ] raquel's git config preserved (userName, userEmail)
- [ ] LazyVim disabled for raquel (mkForce false as in original)
- [ ] Home-manager integration pattern documented

**Implementation Notes:**
- Investigate clan-core home-manager integration (clan-core supports it but examples limited)
- Reference mic92-clan-dotfiles for home-manager patterns (uses nixosModules.home-manager)
- Option A: Integrated home-manager (via darwin configuration)
- Option B: Standalone home-manager (separate activation)
- Document chosen approach and rationale

### AC3: Blackphos Added to Clan Inventory

- [ ] blackphos added to test-clan clan inventory (modules/clan/inventory/machines.nix)
- [ ] Machine metadata:
  - tags = ["darwin", "workstation", "laptop"]
  - machineClass = "darwin"
  - description = "raquel's laptop (primary user), crs58 admin"
- [ ] Clan machine registration in modules/clan/machines.nix
- [ ] Inventory evaluates: `nix eval .#clan.inventory --json | jq '.machines.blackphos'`

**Implementation Notes:**
- Follow test-clan inventory pattern from Story 1.3-1.5
- blackphos is darwin, not nixos (different machineClass)

### AC4: Secrets Migrated to Clan Vars

- [ ] Existing infra secrets identified and documented (if any exist for blackphos)
- [ ] Secrets migrated to clan vars system:
  - **If existing sops secrets:** Use `clan secrets import-sops` to migrate
  - **If no existing secrets:** Define new generators using `clan.core.vars.generators` pattern
  - **For system-generated values:** Use clan vars generators (SSH host keys, certificates)
- [ ] Clan admin keypair generated: `clan secrets key generate`
- [ ] Admin user added to clan secrets: `clan secrets users add <user> --age-key <public_key>`
- [ ] Vars generated for blackphos: `clan vars generate blackphos`
- [ ] Secrets accessible via `config.clan.core.vars.generators.<name>.files.<file>.path`
- [ ] Migration documented with rationale

**Implementation Notes:**
- **clan vars uses sops-nix** as its default encryption backend (clan-core docs: secrets.md)
- **macOS supports vars** explicitly (clan-core docs: macos.md line 10)
- clan-core docs (secrets.md lines 1-2): "should use Vars directly instead" of raw sops-nix
- Generators pattern: prompts (user input) → script (generation logic) → files (output)
- Age keys stored at `~/.config/sops/age/keys.txt` (or `SOPS_AGE_KEY` env var)
- Reference: clan-core docs vars-backend.md for complete generator examples

### AC5: Configuration Builds and Deploys Successfully

- [ ] Configuration builds without errors: `nix build .#darwinConfigurations.blackphos.system`
- [ ] Deployment to blackphos hardware: `darwin-rebuild switch --flake ~/projects/nix-workspace/test-clan#blackphos`
- [ ] System activates successfully (no activation failures)
- [ ] All services start correctly (homebrew, touchID, etc.)
- [ ] Users can log in (crs58, raquel)
- [ ] Home-manager activations successful for both users

**Implementation Notes:**
- Deploy from blackphos machine itself (local deployment)
- Backup current system before deployment (Time Machine or snapshot)
- Test in VM first if possible (darwin VMs complex, may skip)

### AC6: Zero-Regression Validation

- [ ] Pre-migration package list captured: `darwin-rebuild --flake ~/projects/nix-workspace/infra#blackphos build && nix-store -q --references result | sort > pre-migration-packages.txt`
- [ ] Post-migration package list captured: `darwin-rebuild --flake ~/projects/nix-workspace/test-clan#blackphos build && nix-store -q --references result | sort > post-migration-packages.txt`
- [ ] Package diff analyzed: `diff pre-migration-packages.txt post-migration-packages.txt`
- [ ] All critical packages present in post-migration
- [ ] Any differences documented and justified
- [ ] raquel's daily workflows validated:
  - Terminal (zsh + starship)
  - Git operations
  - Development tools (just, ripgrep, fd, bat, eza)
  - GUI applications (homebrew casks working)

**Implementation Notes:**
- Focus on functional equivalence, not byte-for-byte package identity
- Some package path changes expected (different nix store paths)
- Validate critical functionality, not every package

### AC7: Transformation Pattern Documented

- [ ] Migration process documented (decide location: new doc vs inline notes)
- [ ] Documentation captures:
  - Step-by-step conversion process (nixos-unified → dendritic + clan)
  - Module organization patterns (where to place darwin modules, home configs)
  - Secrets migration approach (sops-nix handling)
  - Home-manager integration pattern chosen
  - Common issues encountered and solutions
  - Differences between nixos and darwin in clan context
- [ ] Documentation valuable for Epic 2+ (refactoring remaining infra machines)

**Implementation Notes:**
- May be inline completion notes rather than separate doc
- Focus on TRANSFORMATION PATTERN, not blackphos-specific details
- Answer: "How do I convert a machine from infra to dendritic + clan?"</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/notes/development/epics.md</path>
        <title>Epic 1: Architectural Validation + Migration Pattern Rehearsal</title>
        <section>Story 1.8</section>
        <snippet>Migrate blackphos from infra to test-clan management - rehearses complete nixos-unified → dendritic + clan transformation on real darwin hardware, documenting the migration pattern as blueprint for Epic 2+</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-7-execute-dendritic-refactoring-in-test-clan-using-test-harness.md</path>
        <title>Story 1.7 Completion: Dendritic Pattern Validated</title>
        <section>Dev Notes - Previous Story Learnings</section>
        <snippet>Pure import-tree auto-discovery works perfectly, base module namespace merging validated, host modules use namespace imports (self-composition), zero regressions in nixos context</snippet>
      </doc>
      <doc>
        <path>CLAUDE.md</path>
        <title>infra Repository Overview</title>
        <section>Machine Fleet</section>
        <snippet>blackphos: nix-darwin laptop, primary user raquel, admin user crs58. Currently managed by infra using nixos-unified pattern.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/PRD.md</path>
        <title>infra Product Requirements Document</title>
        <section>Executive Summary and Project Classification</section>
        <snippet>Level 3 brownfield infrastructure migration targeting 5-machine heterogeneous environment (1 x86_64 NixOS VPS + 4 aarch64 darwin workstations). Validation-first de-risking via Phase 0 test-clan validation before production deployment. Progressive validation gates with explicit go/no-go frameworks. Zero-regression requirement for all migrations.</snippet>
      </doc>
      <doc>
        <path>~/projects/nix-workspace/test-clan/README.md</path>
        <title>test-clan Repository Architecture</title>
        <section>Architecture and Structure</section>
        <snippet>Dendritic flake-parts architecture with pure import-tree auto-discovery. All modules automatically discovered without manual imports. Structure: modules/{clan,terranix,system,machines,checks}. Validates dendritic + clan-core integration. Machine definitions in modules/machines/darwin/ and modules/machines/nixos/. Clan inventory in modules/clan/inventory/machines.nix. Manual clan.machines registration required.</snippet>
      </doc>
      <doc>
        <path>~/projects/nix-workspace/clan-core/docs/site/guides/vars/vars-backend.md</path>
        <title>Clan Vars Generator Pattern Documentation</title>
        <section>Declare the generator</section>
        <snippet>clan.core.vars.generators pattern for managing machine-specific variables declaratively. Generator structure: prompts (user input), files (outputs with secret=true/false), script (generation logic), runtimeInputs (required tools). Example: root-password generator using mkpasswd to hash prompted password. File path exposed via config.clan.core.vars.generators.{name}.files.{file}.path for use in configuration.</snippet>
      </doc>
      <doc>
        <path>~/projects/nix-workspace/clan-core/docs/site/guides/macos.md</path>
        <title>Clan macOS Support Documentation</title>
        <section>Supported Features</section>
        <snippet>Clan supports macOS machines with 'clan machines update' for nix-darwin installations and full support for vars system. Darwin machines use machineClass = "darwin" in clan inventory. Configuration follows same clan patterns as NixOS with nix-darwin-specific adaptations.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>configurations/darwin/blackphos.nix</path>
        <kind>darwin-configuration</kind>
        <symbol>blackphos config</symbol>
        <lines>1-43</lines>
        <reason>Current nixos-unified darwin configuration to be migrated - includes homebrew casks, desktop profile, touchID, primary user crs58</reason>
      </artifact>
      <artifact>
        <path>configurations/home/raquel@blackphos.nix</path>
        <kind>home-configuration</kind>
        <symbol>raquel home config</symbol>
        <lines>1-47</lines>
        <reason>raquel's home-manager config to be migrated - includes git config, zsh, starship, dev tools (just, ripgrep, fd, bat, eza), LazyVim disabled</reason>
      </artifact>
      <artifact>
        <path>modules/darwin/default.nix</path>
        <kind>darwin-module</kind>
        <symbol>darwin base module</symbol>
        <lines>1-28</lines>
        <reason>Current darwin base module pattern using nixos-unified - shows home-manager integration, user configuration, imports structure</reason>
      </artifact>
      <artifact>
        <path>modules/home/default.nix</path>
        <kind>home-module</kind>
        <symbol>home base module</symbol>
        <lines>1-35</lines>
        <reason>Current home-manager base module - imports LazyVim, nix-index, sops, agents-md, and local modules</reason>
      </artifact>
      <artifact>
        <path>modules/home/darwin-only.nix</path>
        <kind>home-module</kind>
        <symbol>darwin-specific home config</symbol>
        <lines>1-20</lines>
        <reason>Darwin-specific home-manager configuration - imports zsh and colima, enables zsh by default</reason>
      </artifact>
    </code>
    <dependencies>
      <nix>
        <package name="nixpkgs" version="unstable"/>
        <package name="nix-darwin" version="latest"/>
        <package name="home-manager" version="latest"/>
        <package name="clan-core" version="main branch"/>
        <package name="flake-parts" version="latest"/>
        <package name="import-tree" version="latest"/>
        <package name="sops-nix" version="latest"/>
        <package name="mac-app-util" version="latest"/>
        <package name="lazyvim" version="latest"/>
        <package name="nix-index-database" version="latest"/>
      </nix>
      <homebrew>
        <cask>codelayer-nightly</cask>
        <cask>dbeaver-community</cask>
        <cask>docker-desktop</cask>
        <cask>gpg-suite</cask>
        <cask>inkscape</cask>
        <cask>keycastr</cask>
        <cask>meld</cask>
        <cask>postgres-unofficial</cask>
      </homebrew>
    </dependencies>
  </artifacts>

  <constraints>
## Development Constraints

### Dendritic Pattern Requirements (from Story 1.7)
- Use pure import-tree auto-discovery (flake.nix:58 pattern from test-clan)
- Export darwin modules to flake.modules.darwin namespace
- Use namespace imports (with config.flake.modules) not relative paths
- Follow test-clan dendritic structure validated in Story 1.7
- Keep flake.nix minimal (no manual imports)

### Home-Manager Integration
- Integrated approach recommended (Option A from story notes)
- Import inputs.home-manager.darwinModules.home-manager
- Configure home-manager.users.{crs58,raquel}
- Reference infra modules/darwin/default.nix for home-manager pattern
- raquel must have LazyVim disabled (lib.mkForce false)

### Clan Integration Patterns
- Manual machine registration required (clan.machines.blackphos in modules/clan/machines.nix)
- Inventory declaration in modules/clan/inventory/machines.nix
- machineClass = "darwin" (not "nixos")
- Tags: ["darwin" "workstation" "laptop"]

### Secrets Management Strategy
- Use clan vars generators pattern (NOT raw sops-nix like mic92)
- Clan vars uses sops-nix as encryption backend (clan-core docs: secrets.md)
- macOS explicitly supports clan vars (clan-core docs: macos.md line 10)
- Define generators using clan.core.vars.generators.&lt;name&gt; pattern
- Age keys at ~/.config/sops/age/keys.txt or SOPS_AGE_KEY env var
- Reference clan-core docs: guides/vars/vars-backend.md for generator examples

### Zero-Regression Mandate
- All existing functionality must be preserved
- Capture pre-migration package list for comparison
- Validate all raquel workflows (terminal, git, dev tools, homebrew apps)
- Document any differences with justification
- TouchID sudo authentication must work
- All homebrew casks must be accessible

### Darwin-Specific Considerations
- darwinConfigurations (not nixosConfigurations)
- darwin-rebuild (not nixos-rebuild)
- No disko (darwin uses existing APFS)
- No initrd (different boot process)
- Homebrew required for GUI applications
- Different system paths (/Library/ vs /etc/)
- System primaryUser must be set correctly (crs58 admin for blackphos)</constraints>

  <interfaces>
## Key Interfaces

### Dendritic Module Export Pattern
```nix
# modules/machines/darwin/blackphos/default.nix
{
  flake.modules.darwin."machines/darwin/blackphos" = { config, pkgs, ... }: {
    imports = with config.flake.modules.darwin; [
      base  # If darwin base modules exist
    ];
    # Configuration here
  };
}
```

### Clan Machine Registration
```nix
# modules/clan/machines.nix
clan.machines.blackphos = {
  imports = [ config.flake.modules.darwin."machines/darwin/blackphos" ];
};
```

### Clan Inventory Declaration
```nix
# modules/clan/inventory/machines.nix
clan.inventory.machines.blackphos = {
  tags = ["darwin" "workstation" "laptop"];
  machineClass = "darwin";
};
```

### Home-Manager Integration (Integrated Pattern)
```nix
imports = [
  inputs.home-manager.darwinModules.home-manager
];

home-manager.users.raquel = {
  imports = [ /* home modules */ ];
  # raquel's home config
};

home-manager.users.crs58 = {
  # minimal admin config
};
```

### Clan Vars Generator Pattern
```nix
clan.core.vars.generators.ssh-host-key = {
  files."ed25519_priv".secret = true;
  files."ed25519".secret = false;
  script = ''
    ssh-keygen -t ed25519 -N "" -f $out/ed25519
    mv $out/ed25519 $out/ed25519_priv
  '';
  runtimeInputs = [ pkgs.openssh ];
};

# Access in config:
services.openssh.hostKeys = [{
  path = config.clan.core.vars.generators.ssh-host-key.files.ed25519_priv.path;
  type = "ed25519";
}];
```</interfaces>

  <tests>
    <standards>
Tests should validate configuration builds, deployment success, and zero regressions. Use nix build commands to verify configurations compile. Capture package lists before and after migration for comparison. Test actual deployment to blackphos hardware with backup safety measures. Validate all user workflows and functionality post-migration.
    </standards>
    <locations>
- Configuration build tests: nix build .#darwinConfigurations.blackphos.system
- Clan inventory tests: nix eval .#clan.inventory --json | jq '.machines.blackphos'
- DarwinConfigurations list: nix eval .#darwinConfigurations --apply builtins.attrNames
- Package comparison: darwin-rebuild build --flake .#blackphos && nix-store -q --references result | sort
- Deployment test: darwin-rebuild switch --flake ~/projects/nix-workspace/test-clan#blackphos
    </locations>
    <ideas>
### Test Ideas Mapped to Acceptance Criteria

**AC1 Testing (Darwin Configuration Migration):**
- Build test: nix build .#darwinConfigurations.blackphos.system (should succeed without errors)
- Module export test: nix eval .#flake.modules.darwin --apply builtins.attrNames (should include "machines/darwin/blackphos")
- Namespace import test: Verify configuration uses config.flake.modules pattern not relative imports

**AC2 Testing (Home-Manager Integration):**
- Home config evaluation: nix eval .#darwinConfigurations.blackphos.config.home-manager.users --apply builtins.attrNames (should include "crs58" and "raquel")
- raquel package test: Verify raquel's packages include git, gh, just, ripgrep, fd, bat, eza
- LazyVim test: Verify programs.lazyvim.enable is false for raquel (mkForce false applied)

**AC3 Testing (Clan Inventory):**
- Inventory structure test: nix eval .#clan.inventory.machines.blackphos --json (should have tags and machineClass)
- Machine registration test: nix eval .#clan.machines --apply builtins.attrNames (should include "blackphos")
- Tags validation: Verify tags include "darwin", "workstation", "laptop"

**AC4 Testing (Secrets/Vars):**
- Clan vars generation: clan vars generate blackphos (should succeed and create vars)
- Secrets file existence: Verify vars/ directory contains blackphos-specific files
- Generator definitions: Verify clan.core.vars.generators defined in configuration

**AC5 Testing (Build and Deploy):**
- Pre-deployment build: nix build .#darwinConfigurations.blackphos.system (must succeed before deploy)
- Deployment: darwin-rebuild switch --flake ~/projects/nix-workspace/test-clan#blackphos
- Activation verification: Check system log for errors during activation
- Service status: Verify homebrew, touchID, home-manager services active

**AC6 Testing (Zero-Regression):**
- Package list capture: Before migration from infra, after migration from test-clan
- Package diff: diff pre-migration-packages.txt post-migration-packages.txt
- Workflow validation: raquel tests terminal (zsh + starship), git operations, dev tools, homebrew casks
- Functional equivalence: All critical functionality working, not byte-for-byte package identity

**AC7 Testing (Documentation):**
- Documentation existence: Verify transformation pattern documented (inline or separate file)
- Completeness check: Documentation covers all aspects listed in AC7
- Usability validation: Can Epic 2+ follow documented pattern for other machines?
    </ideas>
  </tests>
</story-context>
