<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.10C</storyId>
    <title>Establish sops-nix Secrets for Home-Manager</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-10c-establish-sops-nix-secrets-home-manager.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to establish sops-nix secrets management for home-manager user configurations</iWant>
    <soThat>test-clan users have secure access to personal secrets (API keys, git signing keys, tokens) using proven sops-nix pattern from infra repository</soThat>
    <tasks>
      - Task 1: Infrastructure Setup (AC1-AC3) - ✅ SKIP (Complete from Stories 1.1-1.10A)
      - Task 2: Configure sops-nix Infrastructure (AC4-AC6) - 1 hour estimated
        - 2.1: Create .sops.yaml with Multi-User Configuration
        - 2.2: Create Base sops-nix Module
        - 2.3: Create Per-User sops Modules
      - Task 3: Create and Encrypt Secrets (AC7-AC9) - 45 minutes estimated
        - 3.1: Create crs58 secrets.yaml
        - 3.2: Create raquel secrets.yaml
        - 3.3: Verify Secrets Encryption
      - Task 4: Update Module Access Patterns (AC10-AC15) - 1 hour estimated
        - 4.1: Update git.nix (all users)
        - 4.2: Update jujutsu.nix (if configured)
        - 4.3: Update mcp-servers.nix (crs58/cameron only)
        - 4.4: Update wrappers.nix (crs58/cameron only)
        - 4.5: Update atuin.nix (all users)
        - 4.6: Update/Create Bitwarden Module (all users)
        - 4.7: Commit Access Pattern Updates
      - Task 5: Build and Validate (AC16-AC18) - 30 minutes estimated
        - 5.1: Run Build Validation (AC16)
        - 5.2: Test sops-nix Deployment (AC17)
        - 5.3: Verify Multi-User Isolation (AC18)
      - Task 6: Integration and Testing (AC19-AC21) - 30 minutes estimated
        - 6.1: Validate Pattern A + sops-nix Integration (AC19)
        - 6.2: Verify Age Key Reuse Working (AC20)
        - 6.3: Test Import-Tree Discovery (AC21)
        - 6.4: Commit Integration Validation
      - Task 7: Documentation (AC22-AC24) - 45 minutes estimated
        - 7.1: Document Two-Tier Architecture (AC22)
        - 7.2: Create Operational Guide (AC23)
        - 7.3: Write Access Pattern Examples (AC24)
        - 7.4: Final Documentation Commit
    </tasks>
  </story>

  <acceptanceCriteria>
    ### A. Infrastructure Setup (AC1-AC3) - ✅ SKIP (Unchanged)

    **AC1: Admin Keypair** - ✅ COMPLETE (Stories 1.1-1.10A)
    - Admin age keypair exists (4 keys in ~/.config/sops/age/keys.txt)
    - Public keys available in sops/users/*/key.json

    **AC2: User Setup** - ✅ COMPLETE (Stories 1.1-1.10A)
    - crs58 sops user configured
    - Cameron/raquel share crs58 identity (single encryption key)

    **AC3: Directory Structure** - ✅ COMPLETE (Stories 1.1-1.10A)
    - sops/ infrastructure exists
    - Age keys configured and functional

    ### B. sops-nix Configuration (AC4-AC6) - UPDATED

    **AC4: Create .sops.yaml with Multi-User Encryption Configuration**
    - Extract age public keys from sops/users/*/key.json
    - Define creation_rules for per-user and shared secrets:
      - secrets/home-manager/users/crs58/.*\.yaml$ encrypted for admin + crs58-user
      - secrets/home-manager/users/raquel/.*\.yaml$ encrypted for admin + raquel-user
    - Configure admin recovery key
    - Multi-user encryption working (each user can only decrypt their secrets)

    **AC5: Create sops-nix Home-Manager Module Infrastructure**
    - Import sops-nix.homeManagerModules.sops in flake inputs
    - Create base sops module: modules/home/base/sops.nix
    - Configure sops.age.keyFile pointing to ${config.xdg.configHome}/sops/age/keys.txt
    - Set up base module for all users

    **AC6: Define User-Specific sops Secrets Declarations**
    - crs58: 7 secrets in modules/home/users/crs58/sops.nix
      - github-token, ssh-signing-key, glm-api-key, firecrawl-api-key, huggingface-token, bitwarden-email, atuin-key
    - raquel: 4 secrets in modules/home/users/raquel/sops.nix
      - github-token, ssh-signing-key, bitwarden-email, atuin-key
    - Conditional access via separate files (not runtime logic)
    - Set defaultSopsFile per user

    ### C. Secret Files Creation (AC7-AC9) - NEW

    **AC7: Create crs58 Secrets File**
    - Path: secrets/home-manager/users/crs58/secrets.yaml
    - Contents: All 7 secrets in YAML format
    - Encryption: sops -e (encrypted for crs58 + admin)
    - Source: Import from infra via sops decrypt + manual entry

    **AC8: Create raquel Secrets File**
    - Path: secrets/home-manager/users/raquel/secrets.yaml
    - Contents: 4 secrets subset
    - Encryption: sops -e (encrypted for raquel + admin)
    - Source: Import from infra via sops decrypt + manual entry

    **AC9: Verify Secrets Encryption**
    - Test decryption: sops -d secrets/home-manager/users/*/secrets.yaml
    - Verify age keys work correctly
    - Confirm multi-user encryption (each user can only decrypt their secrets)
    - File permissions correct (secret files encrypted, not plaintext)

    ### D. Module Access Pattern Updates (AC10-AC15) - UPDATED

    **AC10: Update development/git.nix (all users)**
    - Change: config.clan.core.vars.* → config.sops.secrets.*
    - SSH signing: config.sops.secrets.ssh-signing-key.path
    - GitHub token: config.sops.secrets.github-token.path
    - Works for crs58, cameron, raquel (Pattern A modules)

    **AC11: Update development/jujutsu.nix (all users)**
    - SSH signing: config.sops.secrets.ssh-signing-key.path
    - Works for crs58, cameron, raquel

    **AC12: Update ai/claude-code/mcp-servers.nix (crs58/cameron only)**
    - Firecrawl: config.sops.secrets.firecrawl-api-key.path
    - HuggingFace: config.sops.secrets.huggingface-token.path
    - Note: Only 2 MCP keys (no context7)
    - raquel doesn't access (no ai aggregate)

    **AC13: Update ai/claude-code/wrappers.nix (crs58/cameron only)**
    - GLM: config.sops.secrets.glm-api-key.path
    - raquel doesn't access (no ai aggregate)

    **AC14: Update shell/atuin.nix (all users)**
    - Atuin: config.sops.secrets.atuin-key.path
    - Works for crs58, cameron, raquel (development + shell aggregates)

    **AC15: Update/create Bitwarden module (all users)**
    - Bitwarden: config.sops.secrets.bitwarden-email.path
    - Works for crs58, cameron, raquel

    ### E. Build Validation (AC16-AC18) - UPDATED

    **AC16: Nix Build Validation**
    - nix flake check passes
    - nix build .#darwinConfigurations.blackphos.system succeeds
    - nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage succeeds
    - nix build .#homeConfigurations.aarch64-darwin.raquel.activationPackage succeeds
    - No evaluation errors related to sops

    **AC17: sops-nix Deployment Validation**
    - Secrets deployed to $XDG_RUNTIME_DIR/secrets.d/
    - Symlinks created in ~/.config/sops-nix/secrets/
    - File permissions correct (secret files mode 0400)
    - Paths resolve correctly in activation scripts

    **AC18: Multi-User Isolation Validation**
    - crs58 can access all 7 secrets
    - raquel can access only 4 secrets (no AI)
    - Verify raquel CANNOT decrypt crs58's AI API keys
    - Age key encryption working per user

    ### F. Integration Validation (AC19-AC21) - UPDATED

    **AC19: sops-nix Works with Pattern A Modules**
    - Pattern A home-manager modules access sops secrets cleanly
    - No conflicts between dendritic imports and sops access
    - Flake context (from Pattern A) enables sops usage
    - git.nix, mcp-servers.nix, wrappers.nix, atuin.nix all work

    **AC20: Age Key Integration**
    - Same age private key used by clan secrets AND sops-nix
    - Key location: ~/.config/sops/age/keys.txt
    - Public keys in .sops.yaml match sops/users/*/key.json
    - One keypair per user (simpler, consistent)

    **AC21: Import-Tree Discovers sops Modules**
    - sops-nix modules auto-discovered correctly
    - Dendritic namespace export works with sops config
    - Base sops module imported by user modules

    ### G. Documentation (AC22-AC24) - UPDATED

    **AC22: Two-Tier Secrets Architecture Documentation**
    - Document: System secrets (clan vars, future) vs User secrets (sops-nix, now)
    - Location: Architecture doc Section 12
    - Include: Age key reuse pattern, .sops.yaml configuration
    - Rationale: Clan vars NixOS-specific, sops-nix home-manager compatible

    **AC23: sops-nix Operational Guide**
    - Adding new secrets (edit + encrypt workflow)
    - Multi-user encryption (creation_rules)
    - Secret rotation (re-encryption)
    - Troubleshooting (common errors, solutions)
    - Age key extraction from clan (for .sops.yaml)

    **AC24: Access Pattern Examples**
    - Before/after: clan vars approach vs sops-nix approach
    - Code examples: git.nix, mcp-servers.nix, atuin.nix
    - Multi-user examples: crs58 vs raquel sops configuration
    - YAML secret file structure examples
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Internal Documentation References -->
      <doc>
        <path>docs/notes/development/epics/epic-1-architectural-validation-migration-pattern-rehearsal-phase-0.md</path>
        <title>Epic 1 - Story 1.10C Definition</title>
        <section>Story 1.10C: Establish sops-nix Secrets for Home-Manager (lines 894-1127)</section>
        <snippet>Complete story definition with architectural pivot context, two-tier secrets validation, acceptance criteria (24 ACs), and strategic value. Updated 2025-11-15 after clan vars incompatibility discovery.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/test-clan-validated-architecture.md</path>
        <title>test-clan Validated Architecture - Section 11</title>
        <section>Module System Architecture - Flake-Parts + Home-Manager Nesting (lines 728-1086)</section>
        <snippet>CRITICAL section explaining nested module systems (flake-parts outer, home-manager inner), access patterns (config.sops.* vs flake.config.*), Pattern A structure, and common anti-patterns. Must read before implementing home-manager modules with sops-nix.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-10ba-refactor-pattern-a.md</path>
        <title>Story 1.10BA - Pattern A Refactoring Foundation</title>
        <section>Complete Story (done)</section>
        <snippet>Story 1.10BA refactored 17 home-manager modules to Pattern A (explicit flake.modules pattern), providing flake context access required for sops-nix integration. All 6 modules updated in Story 1.10C are Pattern A modules from 1.10BA.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-10c-establish-sops-nix-secrets-home-manager.md</path>
        <title>Story 1.10C Work Item File</title>
        <section>Complete Story Definition</section>
        <snippet>Current story file with architectural pivot context, 24 acceptance criteria, 7 tasks with subtasks, secrets inventory (7 secrets), user distribution (crs58: 7, raquel: 4), security protocol, salvageable work analysis (66%), and estimated effort (4.5 hours).</snippet>
      </doc>

      <!-- External Reference Repositories -->
      <doc>
        <path>~/projects/nix-workspace/infra/modules/home/all/core/sops.nix</path>
        <title>infra sops-nix Base Module (Working Reference)</title>
        <section>Complete File</section>
        <snippet>Proven sops-nix home-manager module from infra repository. Configures age.keyFile using XDG paths (${config.xdg.configHome}/sops/age/keys.txt) and defaultSopsFile using flake.inputs.self. Pattern to replicate in test-clan.</snippet>
      </doc>
      <doc>
        <path>~/projects/nix-workspace/infra/modules/home/all/development/git.nix</path>
        <title>infra git.nix with sops-nix Integration (Working Reference)</title>
        <section>Complete File</section>
        <snippet>Working example of sops-nix integration in Pattern A home-manager module. Uses config.sops.secrets."${user.sopsIdentifier}/signing-key".path for SSH signing, demonstrates per-user secrets lookup, includes allowed_signers configuration. Model for test-clan git.nix update.</snippet>
      </doc>
      <doc>
        <path>~/projects/nix-workspace/infra/modules/home/all/tools/claude-code/mcp-servers.nix</path>
        <title>infra mcp-servers.nix with sops-nix Integration (Working Reference)</title>
        <section>Complete File (292 lines)</section>
        <snippet>Comprehensive sops-nix integration for MCP servers with API keys. Demonstrates: per-user secrets file (mcpSecretsFile), sops.secrets declarations (firecrawl, huggingface, context7), sops.templates for JSON config generation, secure secret injection via config.sops.placeholder. Model for test-clan mcp-servers.nix update.</snippet>
      </doc>
      <doc>
        <path>~/projects/nix-workspace/infra/.sops.yaml</path>
        <title>infra .sops.yaml Multi-User Configuration (Working Reference)</title>
        <section>Complete File</section>
        <snippet>Production .sops.yaml with multi-user encryption. Defines age keys with anchors (&admin, &admin-user, &raquel-user, &stibnite, &blackphos), creation_rules for per-user secrets (path_regex: secrets/users/{user}/.*\.yaml$), host-specific secrets, and shared secrets. Pattern to adapt for test-clan with extracted public keys from sops/users/*/key.json.</snippet>
      </doc>

      <!-- Additional Architecture Context -->
      <doc>
        <path>docs/notes/development/architecture/security-architecture.md</path>
        <title>Security Architecture Documentation</title>
        <section>Secrets Management</section>
        <snippet>General security architecture documentation for secrets management, encryption, and access control patterns. Context for two-tier secrets architecture decision.</snippet>
      </doc>
    </docs>

    <code>
      <!-- test-clan Current State - Modules Requiring Updates -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/development/git.nix</path>
        <kind>home-manager module (Pattern A)</kind>
        <symbol>flake.modules.homeManager.development</symbol>
        <lines>1-138</lines>
        <reason>Current: Uses config.clan.core.vars.generators.ssh-signing-key (line 25) - MUST UPDATE to config.sops.secrets.ssh-signing-key.path for sops-nix. Also needs github-token secret access. Pattern A structure ready for sops integration.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/development/jujutsu.nix</path>
        <kind>home-manager module (Pattern A)</kind>
        <symbol>flake.modules.homeManager.development (jujutsu config)</symbol>
        <lines>unknown</lines>
        <reason>UPDATE: Add config.sops.secrets.ssh-signing-key.path for SSH signing (if jujutsu configured for signing in test-clan).</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/ai/claude-code/mcp-servers.nix</path>
        <kind>home-manager module (Pattern A)</kind>
        <symbol>flake.modules.homeManager.ai (mcp config)</symbol>
        <lines>unknown</lines>
        <reason>UPDATE: Add sops.secrets declarations for firecrawl-api-key and huggingface-token, use sops.templates for JSON config generation. Reference infra mcp-servers.nix pattern (sops.placeholder usage). crs58/cameron only (raquel has no ai aggregate).</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/ai/claude-code/wrappers.nix</path>
        <kind>home-manager module (Pattern A)</kind>
        <symbol>flake.modules.homeManager.ai (wrappers config)</symbol>
        <lines>unknown</lines>
        <reason>UPDATE: Add config.sops.secrets.glm-api-key.path for GLM wrapper backend. crs58/cameron only.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/shell/atuin.nix</path>
        <kind>home-manager module (Pattern A)</kind>
        <symbol>flake.modules.homeManager.shell (atuin config)</symbol>
        <lines>unknown</lines>
        <reason>UPDATE: Add config.sops.secrets.atuin-key.path for shell history encryption. All users (crs58, raquel).</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/shell/rbw.nix</path>
        <kind>home-manager module (Pattern A)</kind>
        <symbol>flake.modules.homeManager.shell (bitwarden config)</symbol>
        <lines>unknown</lines>
        <reason>UPDATE: Add config.sops.secrets.bitwarden-email.path for Bitwarden email configuration. All users (crs58, raquel).</reason>
      </artifact>

      <!-- test-clan Infrastructure - sops/users Age Keys -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/sops/users/crs58/key.json</path>
        <kind>clan user age key</kind>
        <symbol>crs58 public key</symbol>
        <lines>unknown</lines>
        <reason>Extract public key for .sops.yaml using: jq -r '.[0].publickey' sops/users/crs58/key.json - Output: age1vn8fpkmkzkjttcuc3prq3jrp7t5fsrdqey74ydu5p88keqmcupvs8jtmv8</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/sops/users/raquel/key.json</path>
        <kind>clan user age key (MISSING)</kind>
        <symbol>raquel public key</symbol>
        <lines>N/A</lines>
        <reason>DOES NOT EXIST - must be created via clan command or copied from infra. Required for multi-user encryption in .sops.yaml. infra has raquel-user: age12w0rmmskrds6m334w7qrcmpms5lpe3llah6wf8ry5jtatvuxku2sarl8ut</reason>
      </artifact>

      <!-- test-clan Module Structure - Files to Create -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/base/sops.nix</path>
        <kind>home-manager module (Pattern A, NEW)</kind>
        <symbol>flake.modules.homeManager.base-sops</symbol>
        <lines>N/A (to be created)</lines>
        <reason>CREATE: Base sops-nix module for all users. Configure age.keyFile, provide common sops infrastructure. Reference infra modules/home/all/core/sops.nix pattern.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/users/crs58/sops.nix</path>
        <kind>home-manager module fragment (NEW)</kind>
        <symbol>crs58 sops secrets declarations</symbol>
        <lines>N/A (to be created)</lines>
        <reason>CREATE: Declare 7 sops secrets for crs58/cameron user (github-token, ssh-signing-key, glm-api-key, firecrawl-api-key, huggingface-token, bitwarden-email, atuin-key). Set defaultSopsFile to secrets/home-manager/users/crs58/secrets.yaml.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/users/raquel/sops.nix</path>
        <kind>home-manager module fragment (NEW)</kind>
        <symbol>raquel sops secrets declarations</symbol>
        <lines>N/A (to be created)</lines>
        <reason>CREATE: Declare 4 sops secrets for raquel user (github-token, ssh-signing-key, bitwarden-email, atuin-key). Set defaultSopsFile to secrets/home-manager/users/raquel/secrets.yaml. NO AI secrets.</reason>
      </artifact>

      <!-- test-clan Configuration Files - To Create -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/.sops.yaml</path>
        <kind>sops configuration (NEW)</kind>
        <symbol>.sops.yaml multi-user encryption rules</symbol>
        <lines>N/A (to be created)</lines>
        <reason>CREATE: Multi-user .sops.yaml with age keys (admin, crs58-user, raquel-user) and creation_rules for secrets/home-manager/users/{user}/.*\.yaml$ paths. Extract public keys from sops/users/*/key.json. Reference infra .sops.yaml structure.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/secrets/home-manager/users/crs58/secrets.yaml</path>
        <kind>encrypted secrets file (NEW)</kind>
        <symbol>crs58 user secrets (7 secrets)</symbol>
        <lines>N/A (to be created)</lines>
        <reason>CREATE: Encrypted YAML with 7 secrets. Import from infra via sops decrypt (SECURITY PROTOCOL: manual transfer, dev agent provides commands, orchestrator executes). Encrypt with sops -e after populating.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/secrets/home-manager/users/raquel/secrets.yaml</path>
        <kind>encrypted secrets file (NEW)</kind>
        <symbol>raquel user secrets (4 secrets)</symbol>
        <lines>N/A (to be created)</lines>
        <reason>CREATE: Encrypted YAML with 4 secrets subset. Import same secrets as crs58 (github-token, ssh-signing-key, bitwarden-email, atuin-key). Encrypt with sops -e after populating.</reason>
      </artifact>
    </code>

    <dependencies>
      <nix>
        <package name="sops-nix" version="from flake inputs" source="github:Mic92/sops-nix">
          sops-nix home-manager module for declarative secrets management. Provides sops.secrets, sops.templates, sops.age.keyFile configuration. Required for home-manager sops integration.
        </package>
        <package name="age" version="from nixpkgs" source="nixpkgs">
          Age encryption tool for sops backend. Used for encrypting/decrypting secrets files. Already installed in test-clan.
        </package>
        <package name="sops" version="from nixpkgs" source="nixpkgs">
          Secrets OPerationS CLI tool for managing encrypted YAML/JSON files. Used for sops -e, sops -d, sops edit commands. Already installed in test-clan.
        </package>
        <package name="jq" version="from nixpkgs" source="nixpkgs">
          JSON processor for extracting age public keys from sops/users/*/key.json files. Command: jq -r '.[0].publickey' sops/users/crs58/key.json
        </package>
      </nix>
    </dependencies>
  </artifacts>

  <constraints>
    **Architectural Constraints:**

    1. **Two-Tier Secrets Architecture (Epic 1 Finding):**
       - System-level secrets (NixOS/darwin): clan vars (future, Epic 2+)
       - User-level secrets (home-manager): sops-nix (Story 1.10C scope)
       - Clan vars incompatible with home-manager (requires NixOS-specific _class parameter)
       - sops-nix proven in infra, validated across 8 clan reference repos

    2. **Age Key Reuse Pattern:**
       - Same age private key used by clan AND sops-nix (~/.config/sops/age/keys.txt)
       - Public keys: Extract from sops/users/*/key.json (clan) → Reference in .sops.yaml (sops-nix)
       - One keypair per user (simpler, consistent)
       - Admin recovery key: age1vy7wsnf8eg5229evq3ywup285jzk9cntsx5hhddjtwsjh0kf4c6s9fmalv

    3. **Pattern A Module Structure (from Story 1.10BA):**
       - ALL home-manager modules MUST use explicit flake.modules = { homeManager.aggregate = ... } pattern
       - DO NOT use dot notation (flake.modules.homeManager.aggregate = ...)
       - Dendritic import-tree requires explicit braces for module merging
       - Pattern A provides flake context (flake.inputs, flake.config) required for sops-nix

    4. **Module Access Patterns (from Architecture Section 11):**
       - sops-nix secrets: config.sops.secrets.<secret-name>.path (home-manager config)
       - Flake inputs: flake.inputs.self (via extraSpecialArgs)
       - Clan inventory: flake.config.clan.inventory.* (if needed)
       - DO NOT use flake.config.sops.* (sops is home-manager module, not flake-parts)
       - DO NOT use config.clan.core.vars.* (clan vars not for home-manager)

    5. **Multi-User Isolation:**
       - Separate secrets files per user (secrets/home-manager/users/{user}/secrets.yaml)
       - Separate sops modules per user (modules/home/users/{user}/sops.nix)
       - .sops.yaml creation_rules enforce encryption boundaries
       - crs58/cameron: 7 secrets (development + ai + shell)
       - raquel: 4 secrets (development + shell, NO AI)

    6. **Security Protocol (from Story Work Item):**
       - NEVER expose plaintext secrets in chat or tool output
       - Dev agent: Provide optimal sops decrypt commands for orchestrator
       - Orchestrator: Execute sops commands interactively, manually transfer secrets
       - Always encrypt secrets files with sops -e before committing
       - Verify encryption: file secrets.yaml should show JSON data, not plaintext

    7. **Build Requirements:**
       - nix build .#darwinConfigurations.blackphos.system MUST succeed
       - nix build .#homeConfigurations.aarch64-darwin.{crs58,raquel}.activationPackage MUST succeed
       - nix flake check MUST pass with no sops-related errors
       - All Pattern A modules MUST have flake context access

    8. **Secrets Inventory (from Epic 1 lines 947-962):**
       - github-token: Git operations, gh CLI (all users)
       - ssh-signing-key: Git/jujutsu SSH signing (all users)
       - glm-api-key: GLM alternative LLM backend (crs58/cameron only)
       - firecrawl-api-key: Firecrawl MCP server (crs58/cameron only)
       - huggingface-token: HuggingFace MCP server (crs58/cameron only)
       - bitwarden-email: Bitwarden configuration (all users)
       - atuin-key: Shell history encryption (all users)

    9. **Work Salvage (from Story Work Item):**
       - 66% salvageable: Module structure, conditional logic, atomic commits
       - 33% revert: Clan vars imports, generators, access pattern references
       - Change access pattern ONLY: config.clan.core.vars.* → config.sops.secrets.*

    10. **Documentation Requirements:**
        - Section 12 in test-clan-validated-architecture.md: Two-tier secrets architecture
        - Operational guide: sops-nix workflow (add, encrypt, rotate secrets)
        - Access pattern examples: Before/after, multi-user, code snippets
        - Age key extraction commands documented
  </constraints>

  <interfaces>
    **sops-nix Home-Manager Module Interface:**

    ```nix
    # Base sops configuration (modules/home/base/sops.nix)
    sops.age.keyFile = "${config.xdg.configHome}/sops/age/keys.txt";

    # User-specific secrets declarations (modules/home/users/crs58/sops.nix)
    sops.defaultSopsFile = flake.inputs.self + "/secrets/home-manager/users/crs58/secrets.yaml";
    sops.secrets.<secret-name> = {
      # Optional overrides:
      sopsFile = ...; # Override defaultSopsFile
      mode = "0400"; # File permissions
      owner = config.home.username; # Owner
      key = "yaml-key"; # YAML key if different from secret name
    };

    # Access secrets in modules
    config.sops.secrets.<secret-name>.path
    # Resolves to: ~/.config/sops-nix/secrets/<secret-name>

    # sops templates for dynamic file generation
    sops.templates.<template-name> = {
      mode = "0400";
      path = "/path/to/output";
      content = builtins.toJSON {
        key = config.sops.placeholder."secret-name";
      };
    };
    ```

    **Age Key Extraction Interface:**

    ```bash
    # Extract public key from clan user key.json
    jq -r '.[0].publickey' sops/users/crs58/key.json
    # Output: age1vn8fpkmkzkjttcuc3prq3jrp7t5fsrdqey74ydu5p88keqmcupvs8jtmv8

    # Use in .sops.yaml
    keys:
      - &crs58-user age1vn8fpkmkzkjttcuc3prq3jrp7t5fsrdqey74ydu5p88keqmcupvs8jtmv8
    ```

    **.sops.yaml Multi-User Encryption Interface:**

    ```yaml
    keys:
      - &admin age1vy7wsnf8eg5229evq3ywup285jzk9cntsx5hhddjtwsjh0kf4c6s9fmalv
      - &crs58-user age1vn8fpkmkzkjttcuc3prq3jrp7t5fsrdqey74ydu5p88keqmcupvs8jtmv8
      - &raquel-user age12w0rmmskrds6m334w7qrcmpms5lpe3llah6wf8ry5jtatvuxku2sarl8ut

    creation_rules:
      - path_regex: secrets/home-manager/users/crs58/.*\.yaml$
        key_groups:
          - age: [*admin, *crs58-user]
      - path_regex: secrets/home-manager/users/raquel/.*\.yaml$
        key_groups:
          - age: [*admin, *raquel-user]
    ```

    **Secret File Structure Interface:**

    ```yaml
    # secrets/home-manager/users/crs58/secrets.yaml (before encryption)
    github-token: ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    ssh-signing-key: <multi-line SSH private key content>
    glm-api-key: sk-proj-xxxxxxxxxxxxxxxxxxxx
    firecrawl-api-key: fc-xxxxxxxxxxxxxxxxxxxx
    huggingface-token: hf_xxxxxxxxxxxxxxxxxxxx
    bitwarden-email: cameron.ray.smith@gmail.com
    atuin-key: <base64-encoded-key>

    # After: sops -e -i secrets/home-manager/users/crs58/secrets.yaml
    # File becomes JSON encrypted data
    ```

    **Module Update Pattern Interface:**

    ```nix
    # BEFORE (clan vars - WRONG for home-manager)
    programs.git.signing.key = config.clan.core.vars.generators.ssh-signing-key.files.ed25519_priv.path;

    # AFTER (sops-nix - CORRECT for home-manager)
    programs.git.signing.key = config.sops.secrets.ssh-signing-key.path;

    # User-specific sops declaration
    sops.secrets.ssh-signing-key = {
      sopsFile = flake.inputs.self + "/secrets/home-manager/users/crs58/secrets.yaml";
      mode = "0400";
    };
    ```

    **Flake Input Integration:**

    ```nix
    # flake.nix inputs (ensure sops-nix available)
    inputs.sops-nix = {
      url = "github:Mic92/sops-nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    # Import in home-manager modules (via base module)
    imports = [ inputs.sops-nix.homeManagerModules.sops ];
    ```
  </interfaces>

  <tests>
    <standards>
      **Build Validation Standards:**
      All nix builds must succeed with sops-nix integration. Validate home-manager configurations (crs58, raquel) and darwin system configuration (blackphos). Secrets must be accessible via config.sops.secrets.*.path in modules. Pattern A modules must preserve flake context access.

      **Secrets Encryption Standards:**
      All secrets files MUST be encrypted with sops -e before committing. Verify encryption with file command (output: JSON data, not plaintext YAML). Test decryption with sops -d (requires correct age key). Multi-user isolation enforced via .sops.yaml creation_rules.

      **Access Pattern Standards:**
      Module access MUST use config.sops.secrets.<secret-name>.path (NOT config.clan.core.vars.*). Flake inputs MUST use flake.inputs.self for defaultSopsFile paths. Pattern A structure MUST be preserved (explicit flake.modules braces).
    </standards>

    <locations>
      - ~/projects/nix-workspace/test-clan/modules/checks/ (existing nix-unit tests, if applicable)
      - Manual validation commands in Dev Notes (nix build, sops -d, file commands)
      - Integration tests: Build all 3 configurations (blackphos, crs58, raquel)
    </locations>

    <ideas>
      **Test Idea 1 (AC16): Build Validation**
      - Map to: AC16 (Nix Build Validation)
      - Commands:
        - nix flake check
        - nix build .#darwinConfigurations.blackphos.system
        - nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage
        - nix build .#homeConfigurations.aarch64-darwin.raquel.activationPackage
      - Expected: All builds succeed, no sops evaluation errors

      **Test Idea 2 (AC9): Secrets Encryption**
      - Map to: AC9 (Verify Secrets Encryption)
      - Commands:
        - file secrets/home-manager/users/crs58/secrets.yaml (expect: JSON data)
        - sops -d secrets/home-manager/users/crs58/secrets.yaml (expect: decrypted YAML)
        - sops -d secrets/home-manager/users/raquel/secrets.yaml (expect: decrypted YAML)
      - Expected: Files encrypted, decryption works with correct age keys

      **Test Idea 3 (AC18): Multi-User Isolation**
      - Map to: AC18 (Multi-User Isolation Validation)
      - Validation:
        - crs58 secrets.yaml contains 7 keys (all secrets)
        - raquel secrets.yaml contains 4 keys (no AI secrets)
        - .sops.yaml creation_rules enforce encryption boundaries
        - raquel age key CANNOT decrypt crs58 AI secrets
      - Expected: Multi-user encryption working, isolation verified

      **Test Idea 4 (AC19): Pattern A Integration**
      - Map to: AC19 (sops-nix Works with Pattern A Modules)
      - Validation:
        - All updated modules use Pattern A structure (explicit flake.modules braces)
        - config.sops.secrets.* access works in all 6 modules
        - No conflicts between dendritic imports and sops access
        - Flake context (flake.inputs.self) accessible for defaultSopsFile
      - Expected: Pattern A + sops-nix integration working seamlessly

      **Test Idea 5 (AC20): Age Key Reuse**
      - Map to: AC20 (Age Key Integration)
      - Validation:
        - Extract public keys: jq -r '.[0].publickey' sops/users/*/key.json
        - Verify .sops.yaml keys match extracted public keys
        - Confirm key location: ~/.config/sops/age/keys.txt (same for clan AND sops-nix)
        - Test decryption uses same age private key
      - Expected: Age key reuse pattern validated, one keypair per user
    </ideas>
  </tests>
</story-context>
