<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.10C</storyId>
    <title>Migrate Secrets from sops-nix to Clan Vars</title>
    <status>drafted</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-10c-migrate-secrets-clan-vars.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to migrate 7 sops-nix encrypted secrets to clan vars generators following Pattern B for vars (generators in user modules) with unified vars.nix and conditional access</iWant>
    <soThat>test-clan uses clan-core's recommended secrets management pattern and enables scalable multi-machine secret deployment</soThat>
    <tasks>
### Task 1: Clan Vars Setup and Admin Configuration (AC: 1-3) - ✅ SKIP (Already Complete)
- 1.1: ~~Generate Clan Admin Keypair~~ - Already exists (4 keys verified)
- 1.2: ~~Add User to Clan Secrets~~ - crs58 sops user exists, cameron/raquel share identity
- 1.3: ~~Verify Vars Directory Structure~~ - vars/shared/, vars/per-machine/* functional

### Task 2: Define Unified Vars Module with Conditional Access (AC: 4-6)
- 2.1: Create crs58 vars.nix File (unified for all users)
- 2.2: Define 7 Generators with Conditional Access
- 2.3: Implement Conditional Logic (crs58/cameron: all 7, raquel: subset 4)
- 2.4: Add Security Notes for Manual Extraction (atuin-key)
- 2.5: Verify Generator Export

### Task 3: Update Module Access Patterns (AC: 7-12)
- 3.1: Update git.nix (all users)
- 3.2: Update jujutsu.nix (if configured)
- 3.3: Update mcp-servers.nix (crs58/cameron only, 2 API keys)
- 3.4: Update wrappers.nix (crs58/cameron only)
- 3.5: Update atuin.nix (all users)
- 3.6: Update/Create Bitwarden Module (all users)
- 3.7: Commit Access Pattern Updates

### Task 4: Generate and Validate Vars (AC: 13-16)
- 4.1: Extract Atuin Key Manually (AC13)
- 4.2: Generate Vars for All Users (AC14)
- 4.3: Build Validation (AC15)
- 4.4: Verify Secrets Accessible (AC16)
- 4.5: SSH Signing Path Validation

### Task 5: Integration and Multi-User Validation (AC: 17-19)
- 5.1: Pattern A + Clan Vars Integration
- 5.2: Multi-User Conditional Access
- 5.3: Import-Tree Discovery
- 5.4: Commit Integration Validation

### Task 6: Documentation (AC: 20-24)
- 6.1: Document SSH Signing Public Key
- 6.2: Create Secrets Migration Guide
- 6.3: Document Unified Vars Pattern
- 6.4: Create Operational Guide
- 6.5: Access Pattern Examples
- 6.6: Final Documentation Commit
</tasks>
  </story>

  <acceptanceCriteria>
### A. Clan Vars Setup and Admin Configuration - ✅ SKIP (Already Complete)
**AC1:** ✅ SKIP (Already Complete) - Clan admin keypair exists (4 keys in ~/.config/sops/age/keys.txt)
**AC2:** ✅ SKIP (Already Complete) - crs58 sops user configured, cameron/raquel share crs58 identity
**AC3:** ✅ SKIP (Already Complete) - Vars directory structure exists: `vars/shared/`, `vars/per-machine/*`

### B. Vars Generators Defined (Pattern B - in user modules)
**AC4:** Unified vars module with conditional access created at `modules/home/users/crs58/vars.nix` with 7 generators:
  - github-token (prompt-based, all users: crs58, cameron, raquel)
  - ssh-signing-key (SSH key generator, regenerable, all users)
  - glm-api-key (prompt-based, crs58/cameron only)
  - firecrawl-api-key (prompt-based, crs58/cameron only)
  - huggingface-token (prompt-based, crs58/cameron only)
  - bitwarden-email (prompt-based, all users)
  - atuin-key (manual extraction, all users)
Note: Conditional access implemented - crs58/cameron get all 7, raquel gets subset of 4

**AC5:** Conditional access implemented in unified vars.nix: crs58/cameron (7 secrets), raquel (4 secrets: github-token, ssh-signing-key, bitwarden-email, atuin-key)

**AC6:** Vars module integrated with dendritic pattern: `flake.modules.homeManager."users/crs58/vars"` exports

### C. Module Access Pattern Updates (sops-nix → clan vars)
**AC7:** Git module (modules/home/development/git.nix) updated for SSH signing + GitHub token (works for all users: crs58, cameron, raquel)

**AC8:** Jujutsu module (modules/home/development/jujutsu.nix) SSH signing updated if configured (works for all users)

**AC9:** MCP servers API keys updated (2 keys: firecrawl, huggingface via `config.clan.core.vars.generators.*.files.*.path`) in modules/home/ai/claude-code/mcp-servers.nix (crs58/cameron only)

**AC10:** Claude Code GLM wrapper (modules/home/ai/claude-code/wrappers.nix) updated (`config.clan.core.vars.generators.glm-api-key.files.key.path`) (crs58/cameron only)

**AC11:** Atuin shell history (modules/home/shell/atuin.nix) updated (`config.clan.core.vars.generators.atuin-key.files.key.path`) (all users)

**AC12:** Bitwarden config updated (`config.clan.core.vars.generators.bitwarden-email.files.email.path`) (all users)

### D. Vars Generation and Validation
**AC13:** Manual secret extraction (atuin-key via `atuin key --base64` from existing setup)

**AC14:** Build validation (corrected paths): All 3 builds succeed:
  - `nix build .#darwinConfigurations.blackphos.system`
  - `nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage`
  - `nix build .#homeConfigurations.aarch64-darwin.raquel.activationPackage`

**AC15:** Secrets accessible: `/run/secrets/vars/*` paths resolve in activation scripts

**AC16:** SSH signing validated in git/jujutsu configs

### E. Dendritic + Clan Vars Integration Validation
**AC17:** Pattern B vars work with Pattern A modules (no conflicts between dendritic imports and clan vars access)

**AC18:** Multi-user conditional access (shared vars.nix, username-based secret distribution: crs58/cameron 7 secrets, raquel 4 secrets)

**AC19:** Import-tree discovers vars module correctly (single vars.nix in users/crs58/, auto-discovery works)

### F. GitHub Signing Key Update Documentation
**AC20:** New SSH signing public key documented with GitHub upload instructions

### G. Documentation
**AC21:** Secrets migration guide (sops-nix → clan vars conversion)

**AC22:** Unified vars pattern documentation (single vars.nix with conditional access, shared sops identity, NOT separate per-user vars)

**AC23:** Operational guide (add secrets, regenerate vars, update GitHub keys, clan vars CLI)

**AC24:** Access pattern examples (before/after comparisons with code snippets)
</acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Epic Definition -->
      <doc>
        <path>docs/notes/development/epics/epic-1-architectural-validation-migration-pattern-rehearsal-phase-0.md</path>
        <title>Epic 1 - Story 1.10C Definition</title>
        <section>Lines 894-1039: Complete Story 1.10C scope, 7 secrets inventory, 24 acceptance criteria</section>
        <snippet>Story 1.10C migrates 7 sops-nix encrypted secrets to clan vars generators using unified vars.nix with conditional access. Secrets: github-token, ssh-signing-key, glm-api-key, firecrawl-api-key, huggingface-token, bitwarden-email, atuin-key (manual extraction). Pattern B for vars (generators in user modules). crs58/cameron get all 7 secrets, raquel gets subset of 4. Blocks Story 1.10D (feature enablement) and Story 1.12 (physical deployment).</snippet>
      </doc>

      <!-- Architecture Documentation -->
      <doc>
        <path>docs/notes/development/test-clan-validated-architecture.md</path>
        <title>Module System Architecture - Flake-Parts + Home-Manager Nesting</title>
        <section>Section 11 (lines 728-1086): Two-layer module system, access patterns, Pattern A structure</section>
        <snippet>Flake-parts layer (outer): config.flake.*, inputs.* | Home-manager layer (inner): config.*, pkgs.*, flake.* via extraSpecialArgs. Bridge: extraSpecialArgs.flake = config.flake. Clan vars access: config.clan.core.vars.generators.X.files.Y.path in home-manager modules. Pattern A provides flake context for clan vars integration.</snippet>
      </doc>

      <!-- Story 1.10BA Context -->
      <doc>
        <path>docs/notes/development/work-items/1-10BA-refactor-pattern-a.md</path>
        <title>Story 1.10BA - Pattern A Refactoring (Completed Baseline)</title>
        <section>Complete story file: Pattern A modules, aggregate organization, flake context access</section>
        <snippet>Story 1.10BA refactored 17 home-manager modules to Pattern A (explicit flake.modules). All builds passing (crs58, raquel, blackphos). Pattern A provides flake parameter for clan vars access. Aggregates: development/ (git.nix, jujutsu.nix), ai/ (mcp-servers.nix, wrappers.nix), shell/ (atuin.nix). Established clean foundation for Story 1.10C clan vars integration.</snippet>
      </doc>

      <!-- Clan Vars Documentation -->
      <doc>
        <path>~/projects/nix-workspace/clan-core/docs/site/guides/vars/vars-overview.md</path>
        <title>Clan Vars Overview - Official Documentation</title>
        <section>Complete guide: What vars solve, benefits, architecture, use cases</section>
        <snippet>Vars system is clan's declarative solution for generated files/secrets. Benefits: reproducible, declarative, secure, collaborative, automated. Generators declare prompts, scripts, dependencies, outputs. Storage backends: sops (default), password-store. Files: secret (encrypted, .path only) vs public (.value accessible). Access: config.clan.core.vars.generators.NAME.files.FILE.path</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/clan-core/docs/site/guides/vars/vars-concepts.md</path>
        <title>Clan Vars Concepts & Architecture</title>
        <section>Architecture, design principles, storage backends, lifecycle</section>
        <snippet>Design principles: declarative generation, separation of concerns (generation/storage/deployment/access), composability via dependencies, type safety (secret vs public files). Storage: sops backend (default), integrates with clan's encryption. Generation phases: pre-deployment, during deployment, regeneration. Access control via file permissions, deployed to /run/secrets/vars/</snippet>
      </doc>

      <!-- Sprint Status -->
      <doc>
        <path>docs/notes/development/sprint-status.yaml</path>
        <title>Sprint Status - Current State</title>
        <section>Epic 1 progress: Stories 1.1-1.10BA done, Story 1.10C ready-for-dev, Story 1.10D backlog</section>
        <snippet>Story 1.10BA: done (Pattern A refactoring complete, builds passing, features deferred to 1.10D). Story 1.10C: ready-for-dev (7 secrets migration to clan vars, unified vars.nix with conditional access, infrastructure exists from 1.1-1.10A). Story 1.10D: backlog (enable 11 features using clan vars + flake.inputs, depends on 1.10C). Story 1.12: backlog (physical deployment, needs 1.10C secrets).</snippet>
      </doc>
    </docs>

    <code>
      <!-- Test-Clan Flake Structure -->
      <code>
        <path>~/projects/nix-workspace/test-clan/flake.nix</path>
        <kind>flake</kind>
        <symbol>flake.nix</symbol>
        <lines>1-71</lines>
        <reason>Flake inputs (clan-core, home-manager, lazyvim), outputs structure (import-tree ./modules), no sops-nix input (uses clan vars instead)</reason>
      </code>

      <!-- Current User Modules (Pattern A) -->
      <code>
        <path>~/projects/nix-workspace/test-clan/modules/home/users/crs58/default.nix</path>
        <kind>home-manager-module</kind>
        <symbol>flake.modules.homeManager."users/crs58"</symbol>
        <lines>1-49</lines>
        <reason>Pattern A user module structure. Imports aggregates via configurations.nix. Contains TODO comments for Story 1.10C clan vars integration (lines 36-43). Unified vars.nix will be created in same directory with conditional access for all users (crs58, cameron, raquel).</reason>
      </code>

      <code>
        <path>~/projects/nix-workspace/test-clan/modules/home/users/raquel/default.nix</path>
        <kind>home-manager-module</kind>
        <symbol>flake.modules.homeManager."users/raquel"</symbol>
        <lines>1-49</lines>
        <reason>raquel user module (similar to crs58, subset of features: development + shell). Shares unified vars.nix from users/crs58/ with conditional access (gets 4 secrets: github-token, ssh-signing-key, bitwarden-email, atuin-key, NO AI keys)</reason>
      </code>

      <!-- Home-Manager Modules Requiring Updates -->
      <code>
        <path>~/projects/nix-workspace/test-clan/modules/home/development/git.nix</path>
        <kind>home-manager-module</kind>
        <symbol>flake.modules.homeManager.development (git component)</symbol>
        <lines>1-143</lines>
        <reason>Pattern A aggregate module with flake context. Contains TODO for clan vars SSH signing + GitHub token (lines 24-29). Target update (AC7): signing.key = config.clan.core.vars.generators.ssh-signing-key.files.ed25519_priv.path, github-token access. Works for all users (crs58, cameron, raquel). Shows allowed_signers pattern (line 62).</reason>
      </code>

      <code>
        <path>~/projects/nix-workspace/test-clan/modules/home/ai/claude-code/mcp-servers.nix</path>
        <kind>home-manager-module</kind>
        <symbol>flake.modules.homeManager.ai (mcp-servers component)</symbol>
        <lines>1-268</lines>
        <reason>Pattern A aggregate module with flake context. Contains TODO for Story 1.10C clan vars migration (lines 22-30). Currently DISABLED sops-nix blocks (lines 33-118). Target update (AC9): 2 API keys (firecrawl, huggingface, NOT context7) via config.clan.core.vars.generators.*.files.*.path. crs58/cameron only (raquel has no ai aggregate).</reason>
      </code>

      <code>
        <path>~/projects/nix-workspace/test-clan/modules/home/ai/claude-code/wrappers.nix</path>
        <kind>home-manager-module</kind>
        <symbol>flake.modules.homeManager.ai (wrappers component)</symbol>
        <lines>1-100+</lines>
        <reason>Pattern A aggregate module with flake context. Target update (AC10): GLM API key via config.clan.core.vars.generators.glm-api-key.files.key.path. crs58/cameron only (raquel has no ai aggregate).</reason>
      </code>

      <code>
        <path>~/projects/nix-workspace/test-clan/modules/home/shell/atuin.nix</path>
        <kind>home-manager-module</kind>
        <symbol>flake.modules.homeManager.shell (atuin component)</symbol>
        <lines>1-100+</lines>
        <reason>Pattern A aggregate module with flake context. Target update (AC11): atuin encryption key via config.clan.core.vars.generators.atuin-key.files.key.path. Works for all users (crs58, cameron, raquel). Manual extraction required: `atuin key --base64`.</reason>
      </code>

      <!-- Reference Implementation Examples -->
      <code>
        <path>~/projects/nix-workspace/qubasa-clan-infra/</path>
        <kind>reference-repository</kind>
        <symbol>qubasa-clan-infra (clan-core developer example)</symbol>
        <lines>N/A</lines>
        <reason>Complex vars generators patterns, dependency composition, advanced usage. Provides examples of generator structure, file declarations, prompt-based secrets, multi-file generators.</reason>
      </code>

      <code>
        <path>~/projects/nix-workspace/mic92-clan-dotfiles/sops/</path>
        <kind>reference-repository</kind>
        <symbol>mic92-clan-dotfiles (large-scale secrets)</symbol>
        <lines>N/A</lines>
        <reason>Legacy sops-nix pattern (128 secrets, 9 machines). Shows scale but uses raw sops-nix (not clan vars). Demonstrates secrets directory structure: sops/groups/, sops/machines/, sops/secrets/, sops/users/. Clan vars uses sops/vars/ instead.</reason>
      </code>
    </code>

    <dependencies>
      <!-- Nix/Nixpkgs Ecosystem -->
      <nix>
        <package name="nixpkgs" version="unstable"/>
        <package name="nix-darwin" version="latest"/>
        <package name="home-manager" version="latest"/>
        <package name="clan-core" version="git (clan.lol)"/>
        <package name="flake-parts" version="latest"/>
        <package name="import-tree" version="latest"/>
      </nix>

      <!-- Story Dependencies -->
      <story>
        <dependency name="Story 1.10BA" status="done" reason="Pattern A modules provide flake context for clan vars access"/>
      </story>

      <!-- External Tools -->
      <tools>
        <tool name="clan" description="Clan CLI for vars generate, secrets key generate, secrets users add"/>
        <tool name="sops" description="Underlying encryption tool (wrapped by clan vars)"/>
        <tool name="age" description="Encryption backend for clan vars"/>
        <tool name="ssh-keygen" description="SSH key generator (used by ssh-signing-key vars generator)"/>
      </tools>
    </dependencies>
  </artifacts>

  <constraints>
### Architectural Constraints

**1. Pattern B for Vars (NOT Pattern B Home-Manager):**
- Vars generators defined in user module directories: `modules/home/users/*/vars.nix`
- Pattern B home-manager (plain modules) DEPRECATED in Story 1.10B (architectural failures)
- Pattern B vars COMPATIBLE with Pattern A modules (different layers)
- Dendritic export pattern: `flake.modules.homeManager."users/*/vars" = { ... }`

**2. CRITICAL: Nested Module System Architecture (Two Separate Layers)**

**Understanding the Dendritic Pattern: A Nested Function**

Dendritic modules are FLAKE-PARTS modules (outer) that DEFINE home-manager modules (inner):

```nix
# File: modules/home/development/git.nix
# ┌─ OUTER: This is a FLAKE-PARTS module
{ config, inputs, ... }:  # ← Flake-parts module signature
{
  # Setting a flake-parts option
  flake.modules = {
    # ┌─ INNER: This VALUE is a HOME-MANAGER module
    homeManager.development =
      { config, pkgs, flake, ... }:  # ← DIFFERENT config!
      {
        programs.git = { ... };
      };
    # └─ END INNER
  };
}
# └─ END OUTER
```

**Two Different `config` Variables:**
- **Outer config:** Flake-parts module system state (`config.flake.*`, `inputs.*`)
- **Inner config:** Home-manager module system state (`config.programs.*`, `config.clan.core.vars.*`)
- **They are NOT the same object!**

**The Bridge: extraSpecialArgs**

How the layers connect (in modules/home/configurations.nix):
```nix
flake.homeConfigurations.crs58 =
  inputs.home-manager.lib.homeManagerConfiguration {
    extraSpecialArgs = {
      flake = config.flake;  # ← Bridge from outer to inner!
    };
    modules = [ config.flake.modules.homeManager.development ];
  };
```

**ACCESS PATTERNS REFERENCE TABLE (READ BEFORE IMPLEMENTING):**

| What You Want | In Home-Manager Module | Why |
|---------------|------------------------|-----|
| Flake input package | `flake.inputs.X.packages.${pkgs.system}.Y` | Flake inputs passed via extraSpecialArgs |
| Nixpkgs package | `pkgs.git` | Home-manager provides `pkgs` automatically |
| Clan inventory user | `flake.config.clan.inventory.services.users.users.cameron` | Clan-core is flake-parts module |
| **Clan vars secret** | `config.clan.core.vars.generators.X.files.Y.path` | **Clan vars in home-manager (THIS STORY)** |
| Sops-nix secret | `config.sops.secrets."user/key".path` | sops-nix is home-manager module (NOT in test-clan) |
| Home-manager option | `config.programs.git.userName` | Home-manager config only in home-manager modules |

**ANTI-PATTERNS - DO NOT USE THESE:**

```nix
# In home-manager module:

# ✗ WRONG - sops-nix is home-manager module, not flake-parts
flake.config.sops.secrets.*

# ✗ WRONG - programs is home-manager option, not flake-parts
flake.config.programs.*

# ✗ WRONG - pkgs doesn't exist in flake
flake.pkgs.*

# ✗ WRONG - inputs doesn't exist in home-manager config
config.inputs.*

# ✗ WRONG - trying to import dendritic modules in home-manager
imports = [ flake.modules.homeManager.shell ];  # Causes recursion
```

**test-clan Specific Reality: Clan Vars, NOT sops-nix**

CRITICAL FACT: test-clan does NOT have sops-nix configured. It uses clan vars.

Proof: `ls ~/projects/nix-workspace/test-clan/sops/` shows `vars/` (NOT `secrets/`)

**Why clan inventory works but sops doesn't:**
- Clan inventory (`flake.config.clan.inventory.*`): Clan-core IS a flake-parts module, so `config.flake.config.clan.*` exists
- Sops secrets (`config.sops.*`): sops-nix is a HOME-MANAGER module (if imported), exists in home-manager `config`, NOT in `flake.config`
- Clan vars (`config.clan.core.vars.*`): Clan-core provides vars in BOTH layers (flake-parts AND home-manager)

**Diagnostic Questions (Use These When Stuck):**

**Q1: Is it a flake input?**
- ✅ YES → Use `flake.inputs.*` (via extraSpecialArgs in home-manager)

**Q2: Is it from a FLAKE-PARTS module (clan-core, custom flake-parts modules)?**
- ✅ YES → Use `flake.config.*` (via extraSpecialArgs in home-manager)
- Example: `flake.config.clan.inventory.*`

**Q3: Is it from a HOME-MANAGER module (sops-nix, catppuccin-nix.homeManagerModules)?**
- ✅ YES → Use `config.*` (home-manager config)
- Example: `config.sops.secrets.*` (if sops-nix imported), `config.programs.*`

**Q4: Is it a nixpkgs package?**
- ✅ YES → Use `pkgs.*` (always available in home-manager)

**Summary: The Two-Layer Mental Model**

Always remember:
1. **Flake-parts layer (outer):** Where dendritic modules live
   - Access: `config.flake.*`, `inputs.*`
   - Purpose: Define what home-manager modules exist

2. **Home-manager layer (inner):** What dendritic modules return
   - Access: `config.*`, `pkgs.*`, `flake.*` (via extraSpecialArgs)
   - Purpose: Configure user environment

3. **The bridge:** `extraSpecialArgs.flake = config.flake`
   - Makes flake-parts data available in home-manager
   - Does NOT merge the two `config` objects

4. **Key insight:** `flake.config.*` only contains data from FLAKE-PARTS modules (like clan-core), NOT from home-manager modules (like sops-nix)

**When you write code, always know which layer you're in:**
- In a dendritic .nix file outer scope? → Flake-parts layer
- In the function returned by dendritic module? → Home-manager layer

[Source: docs/notes/development/test-clan-validated-architecture.md, Section 11, lines 728-1086]

**3. Clan Vars IS sops-nix (Declarative Wrapper):**
- Clan vars provides declarative interface to sops-nix encryption
- Storage backend: sops (default, uses age encryption)
- Files: secret (`.path` only, deployed to `/run/secrets/vars/`) vs public (`.value` accessible)
- CLI: `clan vars generate`, `clan secrets key generate`, `clan secrets users add`

**4. Multi-User Conditional Access:**
- Unified vars.nix in modules/home/users/crs58/ serves all users with conditional access
- crs58/cameron vars (7 secrets): github-token, ssh-signing-key, glm-api-key, firecrawl-api-key, huggingface-token, bitwarden-email, atuin-key
- raquel vars (4 secrets subset): github-token, ssh-signing-key, bitwarden-email, atuin-key (NO AI keys)
- Shared encryption (all use sops/users/crs58/ age key, single identity)
- Username-based conditional logic in vars.nix determines secret access

**5. Security Protocol:**
- CRITICAL: Manual secret transfer (dev agent provides commands, orchestrator executes interactively)
- Avoid exposing secret values in chat session
- Process: Decrypt from infra sops → Orchestrator copies → Import to test-clan clan vars
- Validation: Verify encryption before committing (file sops/vars/*/secret shows JSON encrypted)

**6. Build Validation Requirements:**
- darwinConfigurations.blackphos.system must build successfully
- homeConfigurations.aarch64-darwin.crs58.activationPackage must build
- homeConfigurations.aarch64-darwin.raquel.activationPackage must build
- No evaluation errors related to vars access
- Paths `/run/secrets/vars/*` must resolve in activation scripts

**7. No sops-nix in test-clan:**
- test-clan does NOT have sops-nix configured (uses clan vars instead)
- Proof: `ls ~/projects/nix-workspace/test-clan/sops/` shows vars/ (not secrets/)
- Access pattern: Use `config.clan.core.vars.*`, NOT `config.sops.secrets.*`

**8. Dendritic Import-Tree Discovery:**
- vars.nix files auto-discovered in user directories
- No manual wiring required for vars discovery
- Dendritic namespace exports: `flake.modules.homeManager."users/*/vars"`
- User modules import vars via configurations.nix aggregate imports
</constraints>

  <interfaces>
### Clan Vars API

**Generator Definition (in vars.nix):**
```nix
clan.core.vars.generators.GENERATOR_NAME = {
  prompts = {
    PROMPT_NAME = {
      description = "User-facing prompt message";
      type = "hidden" | "line" | "multiline";  # hidden for passwords
    };
  };
  files = {
    FILE_NAME = {
      secret = true | false;  # true: encrypted, .path only | false: .value accessible
    };
  };
  script = ''
    # Generation logic (bash script)
    # Inputs: $prompts/PROMPT_NAME, $dependencies/GENERATOR/FILE
    # Output: $out/FILE_NAME
  '';
  runtimeInputs = [ pkgs.package1 pkgs.package2 ];  # Dependencies for script
  dependencies = [ "other-generator" ];  # Generator dependencies
};
```

**File Access (in home-manager modules):**
```nix
# Secret file (encrypted)
config.clan.core.vars.generators.GENERATOR_NAME.files.FILE_NAME.path
# → /run/secrets/vars/GENERATOR_NAME/FILE_NAME

# Public file (not encrypted, .value accessible)
config.clan.core.vars.generators.GENERATOR_NAME.files.FILE_NAME.value
# → Nix store path with file content as string
```

**Built-in Generators:**
- `ssh-keygen`: Generates SSH keypairs (ed25519 by default)
- `password`: Prompts for password, stores encrypted
- `prompt`: Generic prompt-based generator

**Clan Vars CLI:**
```bash
# Setup
clan secrets key generate                      # Generate admin age keypair
clan secrets users add USERNAME --age-key KEY  # Add user to secrets

# Vars Generation
clan vars generate MACHINE                     # Generate all vars for machine
clan vars generate MACHINE --regenerate        # Regenerate all vars
clan vars generate MACHINE --generator NAME    # Generate specific var

# Vars Management
clan vars list MACHINE                         # List all vars
clan vars show MACHINE GENERATOR               # Show specific var details
```

### Module Access Patterns (Story 1.10C Updates)

**Git SSH Signing (AC7):**
```nix
# Before (sops-nix, DISABLED in test-clan):
programs.git.signing.key = config.sops.secrets."user/signing-key".path;

# After (clan vars):
programs.git.signing.key =
  config.clan.core.vars.generators.ssh-signing-key.files.ed25519_priv.path;
```

**MCP API Keys (AC9):**
```nix
# Before (sops-nix):
sops.templates.mcp-firecrawl.content = builtins.toJSON {
  mcpServers.firecrawl.env.FIRECRAWL_API_KEY =
    config.sops.placeholder."mcp-firecrawl-api-key";
};

# After (clan vars):
home.file.".mcp/firecrawl.json".text = builtins.toJSON {
  mcpServers.firecrawl.env.FIRECRAWL_API_KEY =
    builtins.readFile config.clan.core.vars.generators.mcp-api-keys.files.firecrawl.path;
};
```

**Allowed Signers (SSH Public Key):**
```nix
# User module (crs58/default.nix):
home.file."${config.xdg.configHome}/git/allowed_signers".text = ''
  ${config.programs.git.settings.user.email} namespaces="git" ${
    config.clan.core.vars.generators.ssh-signing-key.files.ed25519_pub.value
  }
'';
```
</interfaces>

  <tests>
    <standards>
Test harness established in Story 1.6 (nix-unit + validation + integration tests). Build validation is CRITICAL for this story. Use `nix build .#TARGET` commands to verify configurations build successfully. Manual validation of secret paths via `nix repl` (inspect config.clan.core.vars.*). Integration tests verify vars generators defined correctly (namespace exports, import-tree discovery). No regressions: All tests from Stories 1.1-1.10BA must continue passing.
    </standards>

    <locations>
- `modules/checks/`: Dendritic test modules (auto-discovered by import-tree)
- Story validation: Build commands for darwinConfigurations, homeConfigurations
- Integration: `nix eval .#flake.modules.homeManager --apply builtins.attrNames` (verify namespace exports)
- Vars validation: `clan vars list blackphos`, `clan vars show blackphos GENERATOR`
    </locations>

    <ideas>
**TC-Story-1.10C-01: Clan Vars Generators Defined**
- Test: `nix eval .#flake.modules.homeManager."users/crs58/vars" --apply builtins.attrNames`
- Expected: crs58 vars module exported to dendritic namespace
- Validates: AC4, AC6

**TC-Story-1.10C-02: Multi-User Conditional Access**
- Test: Verify unified vars.nix with conditional access for crs58/cameron and raquel
- Expected: crs58/cameron access 7 generators (github-token, ssh-signing-key, glm-api-key, firecrawl-api-key, huggingface-token, bitwarden-email, atuin-key), raquel accesses 4 generators (github-token, ssh-signing-key, bitwarden-email, atuin-key)
- Validates: AC5, AC18

**TC-Story-1.10C-03: Pattern A Modules Access Clan Vars**
- Test: `nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage` succeeds
- Expected: Build succeeds, git.nix references clan vars ssh-signing-key path
- Validates: AC7, AC14, AC17

**TC-Story-1.10C-04: darwinConfigurations Build**
- Test: `nix build .#darwinConfigurations.blackphos.system` succeeds
- Expected: Build succeeds with clan vars integration
- Validates: AC14

**TC-Story-1.10C-05: Secrets Accessible in Build**
- Test: Inspect activation scripts for `/run/secrets/vars/*` paths
- Expected: SSH signing key, API keys, Bitwarden email paths resolve
- Validates: AC15

**TC-Story-1.10C-06: Import-Tree Discovers Vars Modules**
- Test: `fd vars.nix modules/home/users/` finds crs58/vars.nix, raquel/vars.nix
- Expected: vars.nix files auto-discovered in user directories
- Validates: AC19

**TC-Story-1.10C-07: Vars Generation (Manual)**
- Test: `clan vars generate blackphos` (prompts for secrets)
- Expected: Prompts for GLM, MCP keys (3), Bitwarden email; auto-generates SSH key
- Validates: AC12

**TC-Story-1.10C-08: Encryption Validation**
- Test: `file sops/vars/crs58/ssh-signing-key/ed25519_priv/secret` shows JSON
- Expected: sops-encrypted JSON data (not plaintext)
- Validates: AC12, Security Protocol

**Integration with Existing Tests:**
- All Story 1.6 tests (TC-001 through TC-018) must continue passing
- No regressions in dendritic pattern, home-manager exports, configurations
- Build validation from Story 1.10BA (crs58, raquel, blackphos builds) with clan vars
    </ideas>
  </tests>
</story-context>
