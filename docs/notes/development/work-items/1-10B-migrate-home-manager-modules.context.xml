<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.10B</storyId>
    <title>Migrate Home-Manager Module Ecosystem from infra to test-clan</title>
    <status>backlog</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-10B-migrate-home-manager-modules.md</sourceStoryPath>
    <implementationRepository>~/projects/nix-workspace/test-clan/</implementationRepository>
    <managementRepository>~/projects/nix-workspace/infra/</managementRepository>
    <estimatedEffort>12-16 hours</estimatedEffort>
    <riskLevel>Medium</riskLevel>
    <dependencies>Story 1.10A (done)</dependencies>
    <blocks>Story 1.10C (secrets migration), Story 1.12 (physical deployment)</blocks>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to migrate the remaining 51 home-manager modules from infra to test-clan</iWant>
    <soThat>blackphos configuration is complete and ready for physical deployment validation</soThat>

    <context>
      <discoveryContext>
        DISCOVERED STORY - Configuration Completeness Gap identified via comprehensive blackphos audit (2025-11-14).

        Story 1.10 audit was incomplete:
        - Only compared top-level darwin configs (darwin/blackphos.nix)
        - Missed 51 home-manager modules (2,500+ lines) auto-wired via nixos-unified
        - Current test-clan coverage: ~15% (basic git/gh/zsh only from Story 1.8/1.10 baseline)
        - Missing critical functionality: Development environment (neovim, wezterm, editors), AI tooling (claude-code, 11 MCP servers), shell environment (atuin, yazi, zellij), utilities
      </discoveryContext>

      <deploymentRisk>
        Physical deployment to blackphos with current test-clan config would cause severe productivity regression:
        - No advanced editors (neovim/LazyVim, zed)
        - No AI-assisted development (claude-code ecosystem, MCP servers)
        - No enhanced shell environment (atuin history, yazi file manager, zellij multiplexer)
        - No essential dev tools (jujutsu VCS, enhanced git config with SSH signing)
      </deploymentRisk>

      <architecturalPatternDifference>
        infra uses nixos-unified auto-wiring (self.homeModules.default aggregates all 51 modules implicitly, 6+ levels of indirection, easy to miss in audits).
        test-clan uses dendritic explicit imports (each module exported to flake.modules.homeManager.* namespace, user modules import explicitly, transparent what's included).

        This architectural difference caused Story 1.10 audit failure - surface-level config comparison missed deep module composition.
      </architecturalPatternDifference>

      <strategicValue>
        - Completes blackphos migration (15% → 100% coverage with Priority 1-3 modules)
        - Validates dendritic pattern at scale (51 modules total, 17 Priority 1-3 focus)
        - Unblocks Story 1.12 physical deployment (complete config required)
        - Provides empirical data for Party Mode checkpoint (Story 1.11 type-safe architecture decision)
        - Establishes home-manager migration pattern for Epic 2-6 (4 more machines: cinnabar, rosegold, argentum, stibnite)
      </strategicValue>
    </context>

    <tasks>
      <task n="1" title="Audit infra home modules and document inventory (AC1-AC3)">
        <subtask>Read all Priority 1 module files from infra/modules/home/all/development/</subtask>
        <subtask>Read all Priority 2 module files from infra/modules/home/all/tools/claude-code/</subtask>
        <subtask>Read all Priority 3 module files from infra/modules/home/all/terminal/ and shell/</subtask>
        <subtask>Document sops-nix access patterns for Story 1.10C coordination</subtask>
        <subtask>Create migration inventory (module, priority, sops-nix refs, dependencies)</subtask>
      </task>
      <task n="2" title="Migrate Priority 1 modules (Critical Development Environment)">
        <subtask>Create modules/home/development/ directory in test-clan</subtask>
        <subtask>Migrate git.nix with TODO for sops-nix → clan vars (Story 1.10C)</subtask>
        <subtask>Migrate jujutsu.nix with signing key TODO</subtask>
        <subtask>Migrate neovim/, wezterm/, zed/ directories</subtask>
        <subtask>Enhance starship.nix (exclude starship-jj with rationale comment)</subtask>
        <subtask>Enhance zsh.nix from infra baseline</subtask>
        <subtask>Export all to flake.modules.homeManager."development/*" namespace</subtask>
        <subtask>Update crs58 user module with Priority 1 imports</subtask>
        <subtask>Build validation: nix build .#homeConfigurations.crs58.activationPackage</subtask>
      </task>
      <task n="3" title="Migrate Priority 2 modules (AI-Assisted Development)">
        <subtask>Create modules/home/tools/claude-code/ directory</subtask>
        <subtask>Migrate claude-code/default.nix, mcp-servers.nix, wrappers.nix, ccstatusline-settings.nix</subtask>
        <subtask>Add TODO comments for API key clan vars migration (11 MCP servers)</subtask>
        <subtask>Export all to flake.modules.homeManager."tools/claude-code/*" namespace</subtask>
        <subtask>Update crs58 user module with Priority 2 imports</subtask>
        <subtask>Build validation: nix build .#homeConfigurations.crs58.activationPackage</subtask>
      </task>
      <task n="4" title="Migrate Priority 3 modules (Shell & Terminal Environment)">
        <subtask>Create modules/home/tools/terminal/ directory (if needed)</subtask>
        <subtask>Migrate atuin.nix, yazi.nix, zellij.nix, tmux.nix, bash.nix, nushell/</subtask>
        <subtask>Export all to flake.modules.homeManager."tools/*" namespace</subtask>
        <subtask>Update crs58 user module with Priority 3 imports</subtask>
        <subtask>Build validation: nix build .#homeConfigurations.crs58.activationPackage</subtask>
      </task>
      <task n="5" title="Update raquel user module with appropriate Priority 1-3 imports">
        <subtask>Audit raquel's module needs (subset of crs58)</subtask>
        <subtask>Update modules/home/users/raquel/default.nix with explicit imports</subtask>
        <subtask>Build validation: nix build .#homeConfigurations.raquel.activationPackage</subtask>
        <subtask>Document raquel's module subset in Dev Notes</subtask>
      </task>
      <task n="6" title="Build validation and zero-regression testing (AC7-AC10)">
        <subtask>Build all configurations (homeConfigurations, darwinConfigurations)</subtask>
        <subtask>Generate package comparison (infra vs test-clan blackphos)</subtask>
        <subtask>Verify configuration coverage (Priority 1-3 modules present)</subtask>
        <subtask>Run test suite: nix flake check (all existing tests must pass)</subtask>
        <subtask>Validate <10% package delta target</subtask>
      </task>
      <task n="7" title="Documentation and learnings capture (AC11-AC12)">
        <subtask>Update work item completion notes</subtask>
        <subtask>Capture dendritic pattern learnings (scalability, trade-offs)</subtask>
        <subtask>Document for Party Mode checkpoint (Story 1.11 assessment)</subtask>
        <subtask>Update Dev Notes with exclusions and module organization decisions</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <section id="A" title="Priority 1-3 Module Migration (Critical Path)">
      <criterion id="AC1">
        All Priority 1 modules migrated to test-clan:
        - git.nix (Git with SSH signing, delta diff, lazygit, allowed_signers)
        - jujutsu.nix (Modern VCS with SSH signing, git colocate mode)
        - neovim/ (LazyVim editor framework)
        - wezterm/ (Terminal emulator with GPU acceleration)
        - zed/ (Zed editor configuration)
        - starship.nix (Enhanced prompt - basic already migrated, add enhancements)
        - zsh.nix (Enhanced shell - basic already migrated, add enhancements)
        Exclusion: starship-jj explicitly excluded (custom Rust package, long compile time, non-essential)
        Each module exported to flake.modules.homeManager."development/*" namespace
        User modules (crs58, raquel) import migrated modules explicitly
        Build validation: nix build .#homeConfigurations.crs58.activationPackage succeeds
      </criterion>
      <criterion id="AC2">
        All Priority 2 modules migrated:
        - claude-code/default.nix (Claude Code CLI configuration)
        - claude-code/mcp-servers.nix (11 MCP server configs: firecrawl, huggingface, chrome, cloudflare, duckdb, historian, mcp-prompt-server, nixos, playwright, terraform, gcloud, gcs)
        - claude-code-wrappers.nix (GLM alternative LLM backend)
        - claude-code/ccstatusline-settings.nix (Status line configuration)
        Each module exported to flake.modules.homeManager."tools/claude-code/*" namespace
      </criterion>
      <criterion id="AC3">
        All Priority 3 modules migrated:
        - atuin.nix (Shell history with sync)
        - yazi.nix (Terminal file manager)
        - zellij.nix (Terminal multiplexer)
        - tmux.nix (Alternative multiplexer)
        - bash.nix (Bash shell setup)
        - nushell/ (Modern structured shell)
        Each module exported to flake.modules.homeManager."tools/*" namespace
      </criterion>
    </section>

    <section id="B" title="Module Access Pattern Updates">
      <criterion id="AC4">
        Prepare for clan vars integration (coordinate with Story 1.10C):
        - Identify sops-nix references in migrated modules (git.nix line 19, jujutsu.nix, mcp-servers.nix lines 22-35, claude-code-wrappers.nix)
        - Document current sops-nix access patterns
        - Add TODO comments for Story 1.10C clan vars migration
        - Ensure modules build with current access patterns (no premature clan vars changes)
      </criterion>
    </section>

    <section id="C" title="Dendritic Pattern Compliance">
      <criterion id="AC5">
        Module organization follows dendritic philosophy:
        - All modules use explicit imports (config.flake.modules.homeManager.*)
        - No auto-aggregation patterns (infra's self.homeModules.default NOT replicated)
        - Module directory structure:
          modules/home/users/crs58/ - user-specific imports
          modules/home/users/raquel/ - user-specific imports
          modules/home/tools/ - reusable tool configs (created as needed)
          modules/home/development/ - dev environment configs (created as needed)
      </criterion>
      <criterion id="AC6">
        Namespace exports configured:
        - Each migrated module exported to dendritic namespace
        - Export paths follow convention: flake.modules.homeManager."category/module-name"
        - User modules import from namespace (no relative paths to tools/development modules)
      </criterion>
    </section>

    <section id="D" title="Build Validation">
      <criterion id="AC7">
        All configurations build successfully:
        - nix build .#homeConfigurations.crs58.activationPackage succeeds
        - nix build .#homeConfigurations.raquel.activationPackage succeeds
        - nix build .#darwinConfigurations.blackphos.system succeeds
        - Zero evaluation errors
      </criterion>
      <criterion id="AC8">
        Configuration coverage validated:
        - Coverage: ~15% → ~100% (all critical Priority 1-3 functionality migrated)
        - Verify Priority 1 modules present in build output
        - Verify Priority 2 modules present in build output
        - Verify Priority 3 modules present in build output
      </criterion>
    </section>

    <section id="E" title="Zero-Regression Validation">
      <criterion id="AC9">
        Package diff comparison:
        - Generate infra blackphos package list: nix-store -q --references result | sort > infra-packages.txt
        - Generate test-clan blackphos package list: nix-store -q --references result | sort > test-clan-packages.txt
        - Compare: diff infra-packages.txt test-clan-packages.txt
        - Target: <10% package delta (acceptable additions: clan vars infrastructure)
        - Document any regressions with justification
      </criterion>
      <criterion id="AC10">
        Functional validation checklist:
        - All Priority 1-3 functionality present in build
        - No missing packages from infra baseline
        - No broken module imports or evaluation errors
        - Build time acceptable (starship-jj exclusion reduces compile time)
      </criterion>
    </section>

    <section id="F" title="Documentation">
      <criterion id="AC11">
        Migration completion documented:
        - Priority 1-3 migration checklist documented in work item
        - Dendritic pattern notes captured (explicit imports, no auto-aggregation)
        - Module organization documented (users/, tools/, development/ structure)
        - starship-jj exclusion rationale documented
      </criterion>
      <criterion id="AC12">
        Learnings captured for Party Mode checkpoint:
        - Dendritic pattern scalability assessment (51 modules vs 2-3 in Story 1.8A)
        - Auto-aggregation vs explicit imports trade-offs
        - Migration effort vs maintenance cost analysis
        - Input for Story 1.11 decision (type-safe architecture feasibility)
      </criterion>
    </section>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Epic and Story Definitions -->
      <doc path="docs/notes/development/epics/epic-1-architectural-validation-migration-pattern-rehearsal-phase-0.md" title="Epic 1 Definition" section="Story 1.10B (lines 572-696)" snippet="Comprehensive story definition with investigation findings (2025-11-14). Documents 51 modules across 6 priority levels, architectural pattern differences (nixos-unified auto-wiring vs dendritic explicit imports), zero-regression requirement, strategic value for Epic 2-6 scaling." />
      <doc path="docs/notes/development/work-items/1-10B-migrate-home-manager-modules.md" title="Story 1.10B Work Item (Complete)" section="Full work item with 12 AC across 6 categories (A-F)" snippet="Complete story definition with investigation context, 7 tasks with 50+ subtasks, dev notes including architectural comparison (nixos-unified vs dendritic), testing standards, quick reference commands, learnings from Story 1.10A, external references, starship-jj exclusion rationale." />
      <doc path="docs/notes/development/work-items/1-10A-migrate-user-management-inventory.context.xml" title="Story 1.10A Context (QUALITY REFERENCE)" section="Complete context XML" snippet="Reference quality baseline (Party Mode rated 5/5 stars). Demonstrates comprehensive metadata, detailed acceptance criteria, extensive artifact references, framework dependencies, architectural constraints, exact interface signatures, specific test guidance. Use as template for Story 1.10B structure and completeness." />

      <!-- Architecture Documentation -->
      <doc path="docs/notes/development/PRD/index.md" title="Product Requirements Document" section="Complete PRD index" snippet="Project classification (Level 2 brownfield migration), success criteria (Phase 0-6 stability gates), functional requirements (FR-1 through FR-5), infrastructure-specific requirements (declarative infrastructure, module organization, multi-machine coordination, secrets management)." />
      <doc path="docs/notes/development/architecture/index.md" title="Architecture Document" section="Complete architecture index" snippet="Executive summary, architectural decisions (dendritic + clan integration, user management patterns, home-manager patterns), technology stack details, novel pattern designs, implementation patterns, deployment architecture, security architecture, ADRs (ADR-001 through ADR-006)." />
      <doc path="docs/notes/development/test-clan-validated-architecture.md" title="test-clan Validated Architecture Map" section="Complete architecture overview" snippet="Dendritic flake-parts pattern validation, clan integration patterns (inventory, services, vars), machine configuration patterns, test harness structure (nix-unit, runNixOSTest, runCommand), Stories 1.1-1.7 complete with 17 test cases passing." />
    </docs>

    <code>
      <!-- Source Modules (infra - Migration FROM) -->

      <!-- Priority 1: Critical Development Environment (7 modules) -->
      <artifact path="modules/home/all/development/git.nix" kind="home-manager-module" symbol="programs.git" lines="1-80" reason="Git with SSH signing (sops-nix line 19), delta diff, lazygit, allowed_signers. MIGRATE with TODO for Story 1.10C clan vars (config.sops.secrets signing-key → config.clan.core.vars.generators.ssh-signing-key)" />
      <artifact path="modules/home/all/development/jujutsu.nix" kind="home-manager-module" symbol="programs.jujutsu" lines="all" reason="Modern VCS with SSH signing, git colocate mode. MIGRATE with same sops-nix → clan vars TODO as git.nix" />
      <artifact path="modules/home/all/development/neovim/" kind="home-manager-module-directory" symbol="programs.neovim" lines="all" reason="LazyVim editor framework. MIGRATE entire directory preserving structure" />
      <artifact path="modules/home/all/development/wezterm/" kind="home-manager-module-directory" symbol="programs.wezterm" lines="all" reason="Terminal emulator with GPU acceleration. MIGRATE entire directory preserving structure" />
      <artifact path="modules/home/all/development/zed/" kind="home-manager-module-directory" symbol="programs.zed" lines="all" reason="Zed editor configuration. MIGRATE entire directory preserving structure" />
      <artifact path="modules/home/all/terminal/starship.nix" kind="home-manager-module" symbol="programs.starship" lines="all" reason="Enhanced shell prompt. ENHANCE existing test-clan baseline, EXCLUDE starship-jj (custom Rust package, long compile time, non-essential)" />
      <artifact path="modules/home/all/shell/zsh.nix" kind="home-manager-module" symbol="programs.zsh" lines="all" reason="Enhanced shell configuration. ENHANCE existing test-clan baseline with infra enhancements" />

      <!-- Priority 2: AI-Assisted Development (4 modules) -->
      <artifact path="modules/home/all/tools/claude-code/default.nix" kind="home-manager-module" symbol="programs.claude-code" lines="all" reason="Claude Code CLI configuration. MIGRATE to test-clan/modules/home/tools/claude-code/" />
      <artifact path="modules/home/all/tools/claude-code/mcp-servers.nix" kind="home-manager-module" symbol="sops.secrets mcp-*" lines="1-50" reason="11 MCP server configs (firecrawl, huggingface, chrome, cloudflare, duckdb, historian, mcp-prompt-server, nixos, playwright, terraform, gcloud, gcs). MIGRATE with TODO for Story 1.10C clan vars (sops.secrets mcp-* lines 22-35 → config.clan.core.vars.generators.mcp-api-keys)" />
      <artifact path="modules/home/all/tools/claude-code-wrappers.nix" kind="home-manager-module" symbol="GLM wrapper config" lines="all" reason="GLM alternative LLM backend. MIGRATE with TODO for GLM API key clan vars" />
      <artifact path="modules/home/all/tools/claude-code/ccstatusline-settings.nix" kind="home-manager-module" symbol="ccstatusline settings" lines="all" reason="Status line configuration. MIGRATE preserving structure" />

      <!-- Priority 3: Shell & Terminal Environment (6 modules) -->
      <artifact path="modules/home/all/terminal/atuin.nix" kind="home-manager-module" symbol="programs.atuin" lines="all" reason="Shell history with sync capabilities. MIGRATE to test-clan/modules/home/tools/" />
      <artifact path="modules/home/all/terminal/yazi.nix" kind="home-manager-module" symbol="programs.yazi" lines="all" reason="Terminal file manager. MIGRATE to test-clan/modules/home/tools/" />
      <artifact path="modules/home/all/terminal/zellij.nix" kind="home-manager-module" symbol="programs.zellij" lines="all" reason="Terminal multiplexer. MIGRATE to test-clan/modules/home/tools/" />
      <artifact path="modules/home/all/terminal/tmux.nix" kind="home-manager-module" symbol="programs.tmux" lines="all" reason="Alternative multiplexer. MIGRATE to test-clan/modules/home/tools/" />
      <artifact path="modules/home/all/shell/bash.nix" kind="home-manager-module" symbol="programs.bash" lines="all" reason="Bash shell setup. MIGRATE to test-clan/modules/home/users/crs58/ (user-specific shell)" />
      <artifact path="modules/home/all/shell/nushell/" kind="home-manager-module-directory" symbol="programs.nushell" lines="all" reason="Modern structured shell. MIGRATE directory to test-clan/modules/home/tools/" />

      <!-- Target Modules (test-clan - Migration TO) -->
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/users/crs58/default.nix" kind="home-manager-module" symbol="flake.modules.homeManager.users/crs58" lines="all" reason="Current baseline (~38 lines). ENHANCE with Priority 1-3 module imports using explicit namespace pattern (config.flake.modules.homeManager.development/*, tools/*)" />
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/users/raquel/default.nix" kind="home-manager-module" symbol="flake.modules.homeManager.users/raquel" lines="all" reason="Minimal user module. UPDATE with appropriate Priority 1-3 subset based on raquel's needs" />
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/development/" kind="directory" symbol="(to be created)" lines="N/A" reason="CREATE directory for Priority 1 development environment modules (git, jujutsu, neovim, wezterm, zed)" />
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/tools/" kind="directory" symbol="(to be created)" lines="N/A" reason="CREATE directory for Priority 2-3 tool modules (claude-code/, atuin, yazi, zellij, tmux, nushell)" />

      <!-- Reference Patterns -->
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/tools/starship.nix" kind="home-manager-module" symbol="programs.starship (existing)" lines="all" reason="Existing starship baseline from Story 1.8/1.10. ENHANCE with infra starship.nix improvements, EXCLUDE starship-jj with rationale comment" />
      <artifact path="~/projects/nix-workspace/test-clan/README.md" kind="repository-documentation" symbol="test-clan overview" lines="all" reason="Repository structure, architecture, development workflow, deployment patterns. Context for understanding where new modules fit and validation strategy." />
    </code>

    <dependencies>
      <nix>
        <package name="nixpkgs" version="unstable" reason="Core Nix packages for all 51 home-manager modules" />
        <package name="home-manager" version="unstable" reason="User environment management framework, basis for all migrated modules" />
        <package name="clan-core" version="git+https://git.clan.lol/clan/clan-core" reason="Clan vars system (Story 1.10C preparation), dendritic integration" />
        <package name="flake-parts" version="latest" reason="Dendritic pattern foundation, module organization, namespace exports" />
        <package name="import-tree" version="via dendritic-flake-parts" reason="Auto-discovery mechanism for modules in development/ and tools/ directories" />
        <package name="sops-nix" version="via clan-core" reason="Current secrets mechanism (will be migrated to clan vars in Story 1.10C)" />

        <!-- Priority 1 Module Dependencies -->
        <package name="gitFull" version="latest" reason="Git with SSH signing support (git.nix)" />
        <package name="jujutsu" version="latest" reason="Modern VCS (jujutsu.nix)" />
        <package name="neovim" version="latest" reason="LazyVim editor (neovim/)" />
        <package name="wezterm" version="latest" reason="Terminal emulator (wezterm/)" />
        <package name="zed-editor" version="latest" reason="Zed editor (zed/)" />
        <package name="starship" version="latest" reason="Shell prompt (starship.nix enhanced)" />
        <package name="zsh" version="latest" reason="Shell (zsh.nix enhanced)" />

        <!-- Priority 2 Module Dependencies -->
        <package name="claude-code" version="latest" reason="Claude Code CLI (claude-code/default.nix)" />
        <package name="mcp-servers" version="various" reason="11 MCP servers (mcp-servers.nix): firecrawl, huggingface, chrome, cloudflare, duckdb, historian, mcp-prompt-server, nixos, playwright, terraform, gcloud, gcs" />

        <!-- Priority 3 Module Dependencies -->
        <package name="atuin" version="latest" reason="Shell history (atuin.nix)" />
        <package name="yazi" version="latest" reason="File manager (yazi.nix)" />
        <package name="zellij" version="latest" reason="Multiplexer (zellij.nix)" />
        <package name="tmux" version="latest" reason="Alternative multiplexer (tmux.nix)" />
        <package name="bash" version="latest" reason="Bash shell (bash.nix)" />
        <package name="nushell" version="latest" reason="Modern shell (nushell/)" />
      </nix>

      <architecturalPatterns>
        <pattern name="Dendritic explicit imports" reason="Core pattern - replaces nixos-unified auto-aggregation. Each module exports to flake.modules.homeManager.* namespace, user modules import explicitly" />
        <pattern name="Pattern B (vars in user modules)" reason="Story 1.10C coordination - prepare sops-nix references for clan vars migration" />
        <pattern name="Module namespace exports" reason="flake.modules.homeManager.category/module-name convention for all migrated modules" />
        <pattern name="Import-tree auto-discovery" reason="Modules in development/ and tools/ directories automatically discovered, no manual flake.nix imports" />
        <pattern name="nixos-unified auto-wiring (reference)" reason="Migration FROM this pattern - understanding helps explain why Story 1.10 audit missed modules" />
      </architecturalPatterns>

      <tools>
        <tool name="nix build" reason="Build validation: .#homeConfigurations.{crs58,raquel}.activationPackage, .#darwinConfigurations.blackphos.system" />
        <tool name="nix flake check" reason="Test suite execution, zero-regression validation" />
        <tool name="nix-store" reason="Package diff comparison: nix-store -q --references result for infra vs test-clan" />
        <tool name="diff" reason="Package list comparison, target <10% delta" />
      </tools>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="DENDRITIC-PATTERN-COMPLIANCE" priority="CRITICAL">
      All migrated modules MUST follow dendritic pattern:
      - Each module explicitly exported to flake.modules.homeManager.* namespace
      - NO auto-aggregation patterns (infra's self.homeModules.default NOT replicated)
      - User modules import explicitly using config.flake.modules.homeManager.* references
      - Module organization: users/, tools/, development/ directory structure
      This is an architectural requirement - dendritic pattern is the validated test-clan pattern.
    </constraint>

    <constraint id="ZERO-REGRESSION" priority="CRITICAL">
      Configuration coverage must reach ~100% (up from ~15%) with Priority 1-3 modules:
      - Package diff <10% delta acceptable (additions: clan vars infrastructure)
      - All Priority 1-3 functionality present in build output
      - No missing packages from infra baseline (except documented exclusions like starship-jj)
      - All existing tests continue passing (nix flake check)
      Physical deployment to blackphos REQUIRES complete configuration to avoid severe productivity regression.
    </constraint>

    <constraint id="PATTERN-B-COORDINATION" priority="CRITICAL">
      Modules with sops-nix references MUST prepare for Story 1.10C clan vars migration:
      - Identify all sops-nix access patterns (git.nix line 19, jujutsu.nix, mcp-servers.nix lines 22-35, claude-code-wrappers.nix)
      - Add TODO comments for Story 1.10C migration
      - Ensure modules build with current sops-nix patterns (NO premature clan vars changes)
      - Document sops-nix → clan vars mapping for 5 affected modules
      Story 1.10B provides home modules, Story 1.10C updates access patterns - sequential dependency.
    </constraint>

    <constraint id="PRIORITY-BASED-MIGRATION" priority="HIGH">
      Migration MUST proceed sequentially by priority tier with build validation after each:
      - Priority 1 (7 modules) → build validation → continue
      - Priority 2 (4 modules) → build validation → continue
      - Priority 3 (6 modules) → build validation → complete
      This risk mitigation strategy enables early error detection and incremental validation.
    </constraint>

    <constraint id="MODULE-ORGANIZATION" priority="HIGH">
      Module directory structure MUST follow convention:
      - modules/home/users/{crs58,raquel}/ - user-specific imports and configs
      - modules/home/development/ - dev environment (git, jujutsu, neovim, wezterm, zed)
      - modules/home/tools/ - reusable tools (claude-code/, atuin, yazi, zellij, tmux, nushell, starship)
      This maintainability requirement enables clear organization at scale (51 modules total).
    </constraint>

    <constraint id="BUILD-VALIDATION-GATES" priority="MEDIUM">
      Build validation required after each priority tier:
      - nix build .#homeConfigurations.crs58.activationPackage (after each priority)
      - nix build .#homeConfigurations.raquel.activationPackage (after raquel updates)
      - nix build .#darwinConfigurations.blackphos.system (final validation)
      - nix flake check (all existing tests pass)
      Quality assurance gate - catch evaluation errors early.
    </constraint>

    <constraint id="STARSHIP-JJ-EXCLUSION" priority="MEDIUM">
      starship-jj MUST be explicitly excluded with documented rationale:
      - Custom Rust package requiring full Rust toolchain compilation
      - Long compile time (10-30 minutes depending on hardware)
      - Non-essential functionality (enhanced jujutsu integration for starship prompt)
      - Enhanced starship.nix provides 95% of value without starship-jj overhead
      Add explicit comment in migrated starship.nix documenting this performance optimization.
    </constraint>
  </constraints>

  <interfaces>
    <interface name="flake.modules.homeManager.development/git" kind="home-manager-module-export" signature="flake.modules.homeManager.&quot;development/git&quot; = { config, pkgs, lib, ... }: { programs.git = { enable = true; signing = { key = config.sops.secrets.signing-key.path; /* TODO Story 1.10C: migrate to config.clan.core.vars.generators.ssh-signing-key.files.ed25519_priv.path */ format = &quot;ssh&quot;; signByDefault = true; }; /* ... full git config */ }; };" path="modules/home/development/git.nix" reason="Git module export with sops-nix signing key (prepare for Story 1.10C clan vars migration)" />

    <interface name="flake.modules.homeManager.development/jujutsu" kind="home-manager-module-export" signature="flake.modules.homeManager.&quot;development/jujutsu&quot; = { config, pkgs, lib, ... }: { programs.jujutsu = { enable = true; signing = { key = config.sops.secrets.signing-key.path; /* TODO Story 1.10C: same as git.nix */ }; /* ... jujutsu config */ }; };" path="modules/home/development/jujutsu.nix" reason="Jujutsu module export with same signing key pattern as git" />

    <interface name="flake.modules.homeManager.development/neovim" kind="home-manager-module-export" signature="flake.modules.homeManager.&quot;development/neovim&quot; = ./modules/home/development/neovim/default.nix; /* LazyVim configuration directory */" path="modules/home/development/neovim/" reason="Neovim/LazyVim directory export" />

    <interface name="flake.modules.homeManager.tools/claude-code/mcp-servers" kind="home-manager-module-export" signature="flake.modules.homeManager.&quot;tools/claude-code/mcp-servers&quot; = { config, pkgs, lib, ... }: { sops.secrets = { &quot;mcp-firecrawl-api-key&quot; = { /* ... */ }; /* TODO Story 1.10C: migrate to config.clan.core.vars.generators.mcp-api-keys.files.firecrawl.path */ /* ... 10 more MCP secrets */ }; /* ... MCP server configs */ };" path="modules/home/tools/claude-code/mcp-servers.nix" reason="MCP servers module export with 11 API key sops-nix references (prepare for Story 1.10C clan vars)" />

    <interface name="crs58 user module imports" kind="user-module-import-pattern" signature="{ imports = with config.flake.modules.homeManager; [ &quot;development/git&quot; &quot;development/jujutsu&quot; &quot;development/neovim&quot; &quot;development/wezterm&quot; &quot;development/zed&quot; &quot;tools/starship&quot; &quot;tools/claude-code&quot; &quot;tools/claude-code/mcp-servers&quot; &quot;tools/atuin&quot; &quot;tools/yazi&quot; &quot;tools/zellij&quot; /* ... all Priority 1-3 modules */ ]; }" path="modules/home/users/crs58/default.nix" reason="User module explicit import pattern - dendritic namespace references for all Priority 1-3 modules" />

    <interface name="clan vars access pattern (Story 1.10C preparation)" kind="vars-access-interface" signature="# git.nix will use (after Story 1.10C): programs.git.signing.key = config.clan.core.vars.generators.ssh-signing-key.files.ed25519_priv.path; # mcp-servers.nix will use (after Story 1.10C): env.FIRECRAWL_API_KEY = config.clan.core.vars.generators.mcp-api-keys.files.firecrawl.path; /* ... 10 more MCP API keys */" path="Pattern B coordination for Story 1.10C" reason="Document sops-nix → clan vars migration path for 5 affected modules (git, jujutsu, mcp-servers, claude-code-wrappers, rbw if migrated)" />

    <interface name="Module organization structure" kind="directory-structure" signature="modules/home/ ├── users/ │ ├── crs58/ │ │ └── default.nix (imports all Priority 1-3 modules) │ └── raquel/ │ └── default.nix (imports subset based on needs) ├── development/ │ ├── git.nix │ ├── jujutsu.nix │ ├── neovim/ │ ├── wezterm/ │ └── zed/ └── tools/ ├── claude-code/ │ ├── default.nix │ ├── mcp-servers.nix │ └── ccstatusline-settings.nix ├── starship.nix ├── atuin.nix ├── yazi.nix ├── zellij.nix ├── tmux.nix └── nushell/" path="modules/home/" reason="Complete module organization showing all Priority 1-3 modules in users/, development/, and tools/ structure" />
  </interfaces>

  <tests>
    <standards>
      Test harness uses three frameworks: nix-unit for expression evaluation (fast, ~1s), runNixOSTest for VM integration (slow, ~2-5min, Linux-only), runCommand for validation/behavioral checks (fast, ~4s).
      Tests organized in modules/checks/ and auto-discovered by import-tree.
      Each test has passthru.meta.description and unique TC-XXX identifier.
      Zero regression mandate requires all existing tests continue passing.
      Story 1.10B focuses on build validation and package diff comparison rather than new test cases (functional validation deferred to Story 1.12 physical deployment).
    </standards>

    <locations>
      modules/checks/nix-unit.nix (expression evaluation tests)
      modules/checks/integration.nix (VM integration tests, Linux-only)
      modules/checks/validation.nix (property validation tests)
      modules/checks/performance.nix (CI performance tests, skeleton)
    </locations>

    <ideas>
      <test id="TC-025-P1" ac="AC1,AC7" description="Priority 1 build validation: After Priority 1 migration (git, jujutsu, neovim, wezterm, zed, starship enhanced, zsh enhanced), verify nix build .#homeConfigurations.crs58.activationPackage succeeds with zero eval errors. Verify all 7 Priority 1 modules present in build output." />

      <test id="TC-025-P2" ac="AC2,AC7" description="Priority 2 build validation: After Priority 2 migration (claude-code ecosystem), verify nix build .#homeConfigurations.crs58.activationPackage succeeds. Verify claude-code CLI + 11 MCP servers + GLM wrapper + ccstatusline all present in build output." />

      <test id="TC-025-P3" ac="AC3,AC7" description="Priority 3 build validation: After Priority 3 migration (shell/terminal environment), verify nix build .#homeConfigurations.crs58.activationPackage succeeds. Verify atuin, yazi, zellij, tmux, bash, nushell all present in build output." />

      <test id="TC-025-raquel" ac="AC7" description="Raquel configuration build: After raquel user module updated with appropriate Priority 1-3 subset, verify nix build .#homeConfigurations.raquel.activationPackage succeeds. Document raquel's module subset (likely subset of crs58 - may exclude claude-code, some dev tools)." />

      <test id="TC-025-blackphos" ac="AC7" description="Darwin configuration build: After all Priority 1-3 modules migrated and integrated, verify nix build .#darwinConfigurations.blackphos.system succeeds. This validates integrated home-manager modules within full darwin system build." />

      <test id="TC-025-coverage" ac="AC8" description="Configuration coverage validation: Verify coverage increased from ~15% (baseline: git, gh, zsh only) to ~100% (all Priority 1-3 functionality). Inspect build output to confirm all 17 Priority 1-3 modules present. Verify starship-jj absent (intentionally excluded per AC exclusion note)." />

      <test id="TC-025-regression" ac="AC9,AC10" description="Package diff zero-regression test: Generate infra blackphos package list (cd ~/projects/nix-workspace/infra && nix build .#darwinConfigurations.blackphos.system && nix-store -q --references result | sort > /tmp/infra-packages.txt). Generate test-clan result (cd ~/projects/nix-workspace/test-clan && nix build .#darwinConfigurations.blackphos.system && nix-store -q --references result | sort > /tmp/test-clan-packages.txt). Compare: diff /tmp/infra-packages.txt /tmp/test-clan-packages.txt. Validate <10% package delta. Acceptable additions: clan vars infrastructure. Acceptable removals: starship-jj (intentionally excluded), infra-specific packages. Document any unexpected differences." />

      <test id="TC-025-flake-check" ac="AC10" description="Test suite regression: Execute nix flake check to run all existing tests (14 tests from Story 1.9/1.10). Verify zero failures. All existing test cases (TC-001 through TC-024) must continue passing - this is a zero-regression refactoring story." />

      <test id="TC-025-functional" ac="AC10" description="Functional validation checklist (manual pre-deployment): Verify Priority 1 modules present (git, jujutsu, neovim, wezterm, zed, starship, zsh). Verify Priority 2 modules present (claude-code, 11 MCP servers, GLM wrapper, ccstatusline). Verify Priority 3 modules present (atuin, yazi, zellij, tmux, bash, nushell). Verify starship-jj absent (intentionally excluded). No broken module imports. No missing packages from infra baseline (except documented exclusions)." />
    </ideas>
  </tests>
</story-context>
