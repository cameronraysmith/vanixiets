<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.3</storyId>
    <title>Configure clan inventory and service instances for test VMs</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-3-configure-clan-inventory-and-service-instances-for-test-vm.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>define clan inventory with real VM machine definitions (Hetzner + GCP) and configure service instances (admin, zerotier, tor)</iWant>
    <soThat>I have infrastructure targets for terraform deployment and clan coordination</soThat>
    <tasks>
- Define machine inventory in modules/flake-parts/clan.nix
  - Add hetzner-vm to inventory.machines with tags ["nixos" "cloud" "hetzner"]
  - Add gcp-vm to inventory.machines with tags ["nixos" "cloud" "gcp"]
  - Set machineClass = "nixos" for both machines
  - Reference clan-infra inventory patterns from docs/notes/implementation/clan-infra-terranix-pattern.md

- Configure admin service instance
  - Identify current user's SSH public key (from ~/.ssh/id_ed25519.pub or similar)
  - Replace `__YOUR_PUBLIC_KEY__` placeholder with actual key
  - Verify admin service targets both machines via tags.all

- Configure zerotier service instance
  - Replace `__YOUR_CONTROLLER__` with "hetzner-vm"
  - Verify controller role assigned to hetzner-vm
  - Verify peer role targets both machines via tags.all (includes controller)
  - Reference zerotier pattern from clan-infra

- Configure tor service instance
  - Verify tor server role targets nixos machines via tags.nixos
  - Document tor as fallback connectivity method

- Validate inventory configuration
  - Run: `nix eval .#clan.inventory --json | jq .machines`
  - Verify both machines appear in output
  - Run: `nix eval .#clan.inventory --json | jq .instances`
  - Verify service instances configured correctly

- Create minimal NixOS configurations
  - Create modules/hosts/hetzner-vm/default.nix with minimal config
  - Create modules/hosts/gcp-vm/default.nix with minimal config
  - Both configs import base modules (nix-settings)
  - Set networking.hostName for each machine
  - Set system.stateVersion = "25.05" for both
  - Build both configs: `nix build .#nixosConfigurations.hetzner-vm.config.system.build.toplevel`
  - Build both configs: `nix build .#nixosConfigurations.gcp-vm.config.system.build.toplevel`

- Test flake evaluation
  - Run: `nix flake check --all-systems`
  - Fix any evaluation errors
  - Verify no regressions from Story 1.1

- Commit changes atomically
  - Create atomic commits for each logical change
  - Verify working tree clean: `git status`
  - Ready for Story 1.4 (Hetzner terraform configuration)
</tasks>
  </story>

  <acceptanceCriteria>
1. Machine definitions populated: hetzner-vm and gcp-vm with proper tags (AC: #1)
2. Admin service configured with real SSH public key (AC: #2)
3. Zerotier controller assigned to hetzner-vm, peer role to gcp-vm (AC: #3)
4. Tor service configured for fallback connectivity (AC: #4)
5. Inventory evaluates and shows both machines correctly (AC: #5)
6. Both nixosConfigurations build successfully (AC: #6)
7. Git working tree clean and ready for next story (AC: #7)
</acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/notes/development/epics.md</path>
        <title>Epic 1: Architectural Validation + Infrastructure Deployment</title>
        <section>Story 1.3: Configure clan inventory</section>
        <snippet>Define clan inventory with real VM machine definitions (Hetzner + GCP) and configure service instances (admin, zerotier, tor) so that I have infrastructure targets for terraform deployment and clan coordination. Story 1.3 is a required prerequisite for Story 1.4.</snippet>
      </artifact>
      <artifact>
        <path>docs/notes/implementation/clan-infra-terranix-pattern.md</path>
        <title>Clan-infra terranix pattern extraction</title>
        <section>Architecture overview and inventory patterns</section>
        <snippet>Complete guide for implementing terranix with flake-parts in test-clan based on clan-infra's proven patterns. Covers terranix flake module import, machine-specific terraform configs, state encryption via OpenTofu, and clan secrets integration for provider credentials.</snippet>
      </artifact>
      <artifact>
        <path>docs/notes/development/work-items/1-1-prepare-existing-test-clan-repository-for-validation.md</path>
        <title>Story 1.1: Prepare test-clan repository</title>
        <section>Completion Notes and File List</section>
        <snippet>Story 1.1 successfully migrated test-clan from vanilla clan pattern to flake-parts.lib.mkFlake structure following clan-infra's proven terranix + flake-parts pattern. Created modules/flake-parts/clan.nix with inventory placeholders, modules/base/nix-settings.nix for reuse, and modules/hosts/ structure ready for Story 1.3.</snippet>
      </artifact>
      <artifact>
        <path>docs/notes/development/decisions/2025-11-03-defer-dendritic-pattern.md</path>
        <title>Decision: Defer Story 1.2 - Infrastructure First</title>
        <section>Rationale and Implementation</section>
        <snippet>Infrastructure-first approach: Deploy infrastructure using clan-infra's proven terranix + flake-parts patterns. Story 1.3 (inventory) is required prerequisite for Story 1.4 (terraform). Dendritic pattern deferred as secondary optimization that can be refactored later.</snippet>
      </artifact>
      <artifact>
        <path>docs/notes/development/sprint-status.yaml</path>
        <title>Sprint Status Tracking</title>
        <section>Epic 1 development status</section>
        <snippet>Story 1.1: done, Story 1.2: deferred, Story 1.3: drafted (current), Story 1.4-1.12: drafted. Infrastructure-first flow: 1.1 → 1.3 → 1.4-1.8 (infrastructure) → 1.2 (dendritic if time).</snippet>
      </artifact>
    </docs>
    <code>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/flake-parts/clan.nix</path>
        <kind>flake-parts module</kind>
        <symbol>clan.inventory</symbol>
        <lines>14-66</lines>
        <reason>Primary file to modify - contains inventory.machines and inventory.instances placeholders. Import terranix.flakeModule at line 4. Placeholder values at lines 31, 44 need replacement.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/base/nix-settings.nix</path>
        <kind>base module</kind>
        <symbol>nix.settings</symbol>
        <lines>1-19</lines>
        <reason>Base configuration to import in new machine configs (hetzner-vm, gcp-vm). Provides experimental-features, trusted-users, and default stateVersion.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/flake.nix</path>
        <kind>flake</kind>
        <symbol>flake-parts.lib.mkFlake</symbol>
        <lines>1-51</lines>
        <reason>Main flake structure using flake-parts.lib.mkFlake. Imports clan-core.flakeModules.default and flake-parts modules. Systems configured for cross-platform support.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/flake-parts/nixpkgs.nix</path>
        <kind>flake-parts module</kind>
        <symbol>perSystem._module.args.pkgs</symbol>
        <lines>1-12</lines>
        <reason>Nixpkgs configuration with allowUnfree = true for all systems. Reference for understanding flake-parts perSystem patterns.</reason>
      </artifact>
    </code>
    <dependencies>
      <nix>
        <package name="nixpkgs" version="github:NixOS/nixpkgs/nixos-unstable">Core NixOS packages and modules system</package>
        <package name="flake-parts" version="github:hercules-ci/flake-parts">Flake modularization framework with perSystem and module composition</package>
        <package name="clan-core" version="git+https://git.clan.lol/clan/clan-core">Clan coordination system providing inventory, service instances, and multi-machine orchestration</package>
        <package name="terranix" version="github:terranix/terranix">Terraform/OpenTofu configuration generation via Nix with flakeModule integration</package>
        <package name="disko" version="github:nix-community/disko">Declarative disk partitioning for NixOS installations with LUKS support</package>
        <package name="srvos" version="github:nix-community/srvos">Server hardening and production-ready NixOS modules</package>
        <package name="import-tree" version="github:vic/import-tree">Automatic module discovery for dendritic pattern (declared but deferred)</package>
      </nix>
      <tooling>
        <tool name="nix">Nix package manager with flakes support (experimental-features enabled)</tool>
        <tool name="clan">Clan CLI for machine coordination, secrets management, and deployment</tool>
        <tool name="terraform/opentofu">Infrastructure provisioning via terranix-generated configs (Story 1.4+)</tool>
        <tool name="git">Version control with atomic commit workflow</tool>
      </tooling>
      <localSourceCode>
        <note>Reference implementations available in ~/projects/nix-workspace/ subtree for pattern analysis</note>
        <available>
          <repo path="~/projects/nix-workspace/clan-infra">Proven production clan + terranix + flake-parts patterns</repo>
          <repo path="~/projects/nix-workspace/test-clan">Target repository for Story 1.3 implementation</repo>
          <repo path="~/projects/nix-workspace/infra">Documentation and planning repository (current location)</repo>
        </available>
        <important>If agent needs to reference source code from dependencies (clan-core, terranix, disko, etc.) that is not available locally, PAUSE and notify user to download source to ~/projects/nix-workspace/ before proceeding</important>
      </localSourceCode>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Follow clan-infra's proven terranix + flake-parts patterns exactly (not dendritic pattern - deferred)</constraint>
    <constraint>Use tags-based service targeting: tags.all for all machines, tags.nixos for NixOS-specific, tags.cloud for cloud VMs</constraint>
    <constraint>Machine classes must be "nixos" for NixOS machines in inventory.machines definition</constraint>
    <constraint>Service instances use role-based configuration: roles.default, roles.controller, roles.peer, roles.server</constraint>
    <constraint>All new machine configs must import modules/base/nix-settings.nix for consistent base configuration</constraint>
    <constraint>Set system.stateVersion = "25.05" for both new machines (override base module default "24.11")</constraint>
    <constraint>Replace placeholder values: __YOUR_PUBLIC_KEY__ with actual SSH key, __YOUR_CONTROLLER__ with "hetzner-vm"</constraint>
    <constraint>Create atomic git commits after each logical change (one file edit = one commit)</constraint>
    <constraint>Zero-regression mandate does NOT apply to test-clan (experimental Phase 0 environment)</constraint>
    <constraint>Story 1.3 is required prerequisite for Story 1.4 - terraform configs will reference inventory machines</constraint>
    <constraint>Validate with nix commands: nix eval, nix build, nix flake check before committing</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>clan.inventory.machines</name>
      <kind>Nix attribute set</kind>
      <signature>machines.&lt;machine-name&gt; = { tags = [ "tag1" "tag2" ]; machineClass = "nixos"; }</signature>
      <path>~/projects/nix-workspace/test-clan/modules/flake-parts/clan.nix:14-17</path>
    </interface>
    <interface>
      <name>clan.inventory.instances</name>
      <kind>Nix attribute set</kind>
      <signature>instances.&lt;service-name&gt; = { roles.&lt;role&gt;.tags.&lt;tag&gt; = { }; roles.&lt;role&gt;.machines."&lt;machine&gt;" = { }; }</signature>
      <path>~/projects/nix-workspace/test-clan/modules/flake-parts/clan.nix:20-56</path>
    </interface>
    <interface>
      <name>nixosConfigurations</name>
      <kind>Flake output</kind>
      <signature>nixosConfigurations.&lt;machine-name&gt; automatically registered via clan.machines attribute</signature>
      <path>~/projects/nix-workspace/test-clan/modules/flake-parts/clan.nix:61-65</path>
    </interface>
    <interface>
      <name>Admin service allowedKeys</name>
      <kind>Clan service configuration</kind>
      <signature>roles.default.settings.allowedKeys."&lt;key-name&gt;" = "&lt;ssh-public-key&gt;"</signature>
      <path>~/projects/nix-workspace/test-clan/modules/flake-parts/clan.nix:27-32</path>
    </interface>
    <interface>
      <name>Zerotier controller/peer roles</name>
      <kind>Clan service configuration</kind>
      <signature>roles.controller.machines."&lt;machine&gt;" = { }; roles.peer.tags.all = { }</signature>
      <path>~/projects/nix-workspace/test-clan/modules/flake-parts/clan.nix:40-47</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Phase 0 testing uses manual validation commands, not automated test suites. Key validation approach: (1) nix eval commands to verify inventory structure, (2) nix build commands to validate nixosConfigurations compile, (3) nix flake check for comprehensive evaluation across all systems. No CI/CD required for experimental test-clan environment. Story 1.1 established baseline: nix flake check --all-systems must pass for all 4 systems (x86_64-linux, aarch64-linux, aarch64-darwin, x86_64-darwin). Validation findings documented in story files, not automated tests.</standards>
    <locations>No formal test directories - validation performed in-place via nix commands at repository root (~/projects/nix-workspace/test-clan/)</locations>
    <ideas>
      <test ac="1">Verify machine definitions: `nix eval .#clan.inventory --json | jq .machines` shows hetzner-vm and gcp-vm with correct tags ["nixos" "cloud" "hetzner"/"gcp"] and machineClass = "nixos"</test>
      <test ac="2">Verify admin service configured: `nix eval .#clan.inventory --json | jq '.instances.admin.roles.default.settings.allowedKeys'` shows real SSH key instead of __YOUR_PUBLIC_KEY__</test>
      <test ac="3">Verify zerotier configuration: `nix eval .#clan.inventory --json | jq '.instances.zerotier.roles'` shows controller assigned to hetzner-vm and peer targeting tags.all</test>
      <test ac="4">Verify tor service: `nix eval .#clan.inventory --json | jq '.instances.tor.roles.server.tags'` shows nixos tag targeting</test>
      <test ac="5">Validate inventory evaluation: `nix eval .#clan.inventory --json | jq .` succeeds without errors and shows complete structure</test>
      <test ac="6">Build both configs: `nix build .#nixosConfigurations.hetzner-vm.config.system.build.toplevel` and `nix build .#nixosConfigurations.gcp-vm.config.system.build.toplevel` both succeed</test>
      <test ac="7">Comprehensive check: `nix flake check --all-systems` passes for all 4 systems without regressions from Story 1.1</test>
      <test ac="7">Git status verification: `git status` shows clean working tree with no uncommitted changes</test>
    </ideas>
  </tests>
</story-context>
