<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>2</storyId>
    <title>Evaluate and refine dendritic flake-parts architecture in test-clan</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-05T18:12:44Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-2-implement-dendritic-flake-parts-pattern-in-test-clan.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a system administrator</asA>
    <iWant>to evaluate test-clan's current architecture against dendritic flake-parts patterns and refine if beneficial</iWant>
    <soThat>I can ensure the foundation is scalable and maintainable before expanding to GCP and production deployments</soThat>
    <tasks>
### Task 1: Conduct comprehensive architectural assessment (AC: #1)

- [ ] **1.1: Review test-clan current structure**
  - [ ] Read modules/flake-parts/clan.nix completely (inventory, terranix integration)
  - [ ] Examine base modules: nix-settings.nix, admins.nix, initrd-networking.nix
  - [ ] Analyze host modules: hetzner-ccx23/default.nix, hetzner-cx43/default.nix
  - [ ] Identify module dependencies and import patterns
  - [ ] Document current module discovery mechanism

- [ ] **1.2: Cross-reference clan-infra patterns**
  - [ ] Read ~/projects/nix-workspace/clan-infra/modules/flake-parts/ structure
  - [ ] Identify machine import patterns in clan-infra
  - [ ] Compare clan-infra specialArgs usage vs test-clan
  - [ ] Note differences: srvos imports, module organization, namespace exports

- [ ] **1.3: Explore dendritic exemplar repositories**
  - [ ] Review dendrix-dendritic-nix repository structure and patterns
  - [ ] Examine drupol-dendritic-infra for real-world usage
  - [ ] Identify core dendritic principles: import-tree, namespaces, composition
  - [ ] Document dendritic requirements that might conflict with clan/terraform

- [ ] **1.4: Evaluate module discovery scalability**
  - [ ] Analyze manual per-machine imports pattern
  - [ ] Project scalability to 10+ machines
  - [ ] Assess whether automatic discovery is needed
  - [ ] Consider clan's machine inventory impact

- [ ] **1.5: Evaluate module namespacing value**
  - [ ] Assess current module export pattern
  - [ ] Evaluate namespace export benefits
  - [ ] Compare relative imports vs config.flake.modules access
  - [ ] Determine value at small vs large scale

- [ ] **1.6: Evaluate specialArgs compatibility**
  - [ ] Analyze current specialArgs = { inherit inputs; } pattern
  - [ ] Research how clan-infra imports srvos without inputs in specialArgs
  - [ ] Determine dendritic specialArgs requirements
  - [ ] Assess compatibility and migration path

### Task 2: Execute decision framework and determine outcome (AC: #2)

- [ ] **2.1: Synthesize assessment findings**
- [ ] **2.2: Evaluate Outcome A: Already Compliant**
- [ ] **2.3: Evaluate Outcome B: Easy Refactoring**
- [ ] **2.4: Evaluate Outcome C: Complex Refactoring**
- [ ] **2.5: Document decision with rationale**

### Task 3: Perform module organization evaluation (AC: #3)

- [ ] **3.1: Assess base module reusability**
- [ ] **3.2: Assess host configuration consistency**
- [ ] **3.3: Assess infrastructure module scalability**
- [ ] **3.4: Project maintenance at 10+ machines**

### Task 4: Analyze specialArgs compatibility (AC: #4)

- [ ] **4.1: Review clan-infra specialArgs pattern**
- [ ] **4.2: Understand srvos import mechanism**
- [ ] **4.3: Evaluate dendritic specialArgs requirements**
- [ ] **4.4: Document compatibility assessment**

### Task 5: Implement refactoring if Outcome B (AC: #5)

- [ ] **5.1: Create git checkpoint before refactoring**
- [ ] **5.2: Execute identified refactoring tasks**
- [ ] **5.3: Validate nix flake check passes**
- [ ] **5.4: Validate host configurations build**
- [ ] **5.5: Validate terraform/terranix integration**
- [ ] **5.6: Validate operational VMs remain stable**
- [ ] **5.7: Commit refactoring with detailed message**

### Task 6: Create comprehensive documentation (AC: #6)

- [ ] **6.1: Create or update DENDRITIC-NOTES.md**
- [ ] **6.2: Document decision rationale**
- [ ] **6.3: Capture architectural learnings**
- [ ] **6.4: Update Story 1.2 Dev Agent Record**
</tasks>
  </story>

  <acceptanceCriteria>
### AC1: Comprehensive Architectural Assessment

Analyze test-clan structure against dendritic patterns across three dimensions:

1. **Module Discovery:** Does manual import pattern scale to 10+ machines? Is automatic discovery needed?
2. **Module Namespacing:** Are base modules exported and reusable?
3. **specialArgs Usage:** Is `{ inherit inputs; }` compatible with dendritic?

**Validation Method:**
- Cross-reference clan-infra patterns
- Review dendritic exemplar repositories
- Analyze test-clan modules/ structure
- Document findings

### AC2: Decision Framework Execution

Determine test-clan's dendritic compliance using decision tree:

**Outcome A: Already Dendritic-Compliant** - Document validation, no refactoring needed
**Outcome B: Easy Dendritic Refactoring (< 4 hours)** - Execute refactoring NOW
**Outcome C: Complex Dendritic Refactoring (> 4 hours)** - Document and defer

### AC3: Module Organization Evaluation

Evaluate current module structure for scalability and maintainability:
- Base module reusability assessment
- Host configuration consistency
- Infrastructure module scalability
- Projection to 10+ machines

### AC4: specialArgs Compatibility Assessment

Analyze whether `specialArgs = { inherit inputs; }` is compatible with dendritic patterns:
- Review clan-infra's specialArgs usage
- Understand srvos import mechanism
- Evaluate dendritic requirements
- Document compatibility

### AC5: Validation of Existing Infrastructure

If refactoring is applied (Outcome B), ensure operational stability:
- nix flake check passes
- Host configurations build successfully
- Terraform/terranix integration unchanged
- VMs remain operational

### AC6: Comprehensive Documentation

Document evaluation findings and architectural decisions in DENDRITIC-NOTES.md with:
- Assessment results and decision rationale
- Pattern comparison (test-clan vs clan-infra vs dendritic)
- Trade-offs analysis
- Scalability analysis
- Recommendations for Phase 1
</acceptanceCriteria>

  <artifacts>
    <docs>{{docs_artifacts}}</docs>
    <code>{{code_artifacts}}</code>
    <dependencies>{{dependencies_artifacts}}</dependencies>
  </artifacts>

  <constraints>{{constraints}}</constraints>
  <interfaces>{{interfaces}}</interfaces>
  <tests>
    <standards>{{test_standards}}</standards>
    <locations>{{test_locations}}</locations>
    <ideas>{{test_ideas}}</ideas>
  </tests>
</story-context>
