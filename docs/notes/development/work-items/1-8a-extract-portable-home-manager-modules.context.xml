<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>8A</storyId>
    <title>Extract Portable Home-Manager Modules for Cross-Platform User Config Sharing</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-12</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-8a-extract-portable-home-manager-modules.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to extract crs58 and raquel home-manager configurations from blackphos into portable, reusable modules</iWant>
    <soThat>user configs can be shared across platforms (darwin + NixOS) without duplication and support three integration modes (darwin integrated, NixOS integrated, standalone)</soThat>
    <tasks>
### Task 1: Create crs58 Home Module (30 minutes)
Extract crs58 home config from blackphos into portable module with dendritic export pattern.

### Task 2: Create raquel Home Module (30 minutes)
Extract raquel home config from blackphos into portable module with raquel-specific packages.

### Task 3: Create Standalone homeConfigurations (45 minutes)
Expose flake-level homeConfigurations for standalone usage via nh CLI.

### Task 4: Refactor blackphos to Import Shared Modules (1 hour)
Replace inline configs with namespace imports, validate zero regression with package diff.

### Task 5: Test Standalone Home Activation (30 minutes)
Validate standalone homeConfigurations work with nh home switch workflow.

### Task 6: Document Pattern for Story 1.9 (45 minutes)
Update architecture.md with portable home-manager pattern for cinnabar reuse.

### Task 7: Update Test Harness with Validation Tests (30 minutes)
Add test coverage for home module exports and configurations.

### Task 8: Create Story Completion Notes (30 minutes)
Document completion and unblock Story 1.9.
</tasks>
  </story>

  <acceptanceCriteria>
### AC1: crs58 Home Module Created and Exported to Dendritic Namespace
Module at `test-clan/modules/home/users/crs58/default.nix` exports to `flake.modules.homeManager."users/crs58"` with content from blackphos lines 128-148 (stateVersion, zsh, starship, git, packages).

### AC2: raquel Home Module Created and Exported to Dendritic Namespace
Module at `test-clan/modules/home/users/raquel/default.nix` exports to namespace with content from blackphos lines 151-182 (includes additional dev tools: just, ripgrep, fd, bat, eza).

### AC3: Standalone homeConfigurations Exposed in Flake
Flake-level module `test-clan/modules/home/configurations.nix` exposes `flake.homeConfigurations.{crs58,raquel}` using home-manager.lib.homeManagerConfiguration with username-only naming (no @hostname).

### AC4: blackphos Refactored to Import Shared Modules (Zero Regression)
blackphos home-manager.users.{crs58,raquel} refactored to import from namespace. Package diff validates zero functional regression.

### AC5: Standalone Home Activation Validated
Both users' standalone activation works via `nh home switch . -c {username}` creating correct symlinks and profiles.

### AC6: Pattern Documented for Story 1.9 Reuse (cinnabar NixOS)
Architecture.md documents "Portable Home-Manager Modules with Dendritic Integration" pattern with three integration modes and cinnabar example code.

### AC7: Test Harness Updated (Validation Coverage)
Validation tests added to `test-clan/modules/checks/validation.nix` verifying module exports and homeConfigurations exist.
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/notes/development/work-items/1-8a-extract-portable-home-manager-modules.md</path>
        <title>Story 1.8A Implementation</title>
        <section>Complete Story Definition</section>
        <snippet>Story restores modular home-manager pattern from infra adapted to dendritic + clan. Blocks Story 1.9 (cinnabar needs crs58 config). 8 implementation tasks with zero-regression validation strategy.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/architecture.md</path>
        <title>Architecture - Dendritic + Clan Integration</title>
        <section>Executive Summary</section>
        <snippet>Validated dendritic flake-parts + clan-core pattern with 65-line flake.nix using pure import-tree auto-discovery. Modules export to flake.modules.{nixos,darwin,homeManager}.* namespace.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/architecture.md</path>
        <title>Architecture - Decision Summary</title>
        <section>Home-Manager Integration</section>
        <snippet>Darwin module integration via darwinModules.home-manager with useGlobalPkgs=true. Multi-user pattern uses standard NixOS users.users (no clan-specific user management).</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-8-migrate-blackphos-from-infra-to-test-clan.md</path>
        <title>Story 1.8 Completion</title>
        <section>Architectural Gap Identified</section>
        <snippet>Lines 841-861: Inline configs identified as anti-pattern for multi-machine reuse. Story 1.8A course correction restores modular pattern for cross-platform sharing.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/machines/darwin/blackphos/default.nix</path>
        <kind>machine-config</kind>
        <symbol>flake.modules.darwin."machines/darwin/blackphos"</symbol>
        <lines>127-183</lines>
        <reason>SOURCE MATERIAL - Inline home configs to be extracted. Lines 128-148 (crs58), Lines 151-182 (raquel). Shows home-manager.users.{username} pattern with useGlobalPkgs=true.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/machines/darwin/blackphos/default.nix</path>
        <kind>machine-config</kind>
        <symbol>flakeModules capture pattern</symbol>
        <lines>8-9</lines>
        <reason>DENDRITIC PATTERN - Shows outer config capture: `flakeModules = config.flake.modules.darwin;` for namespace self-composition. Required for importing from namespace within machine modules.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/machines/darwin/blackphos/default.nix</path>
        <kind>machine-config</kind>
        <symbol>users.users definitions</symbol>
        <lines>84-111</lines>
        <reason>Shows standard NixOS user definitions (no clan-specific user management). Users defined per machine with UID, home, shell, SSH keys. Pattern: users.users.{username} + users.knownUsers (darwin).</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/system/nix-settings.nix</path>
        <kind>system-module</kind>
        <symbol>flake.modules.nixos.base</symbol>
        <lines>1-23</lines>
        <reason>DENDRITIC EXPORT PATTERN REFERENCE - Shows how to export modules to namespace: `flake.modules.{platform}.{path} = { ... }: { };` Target pattern for Story 1.8A: `flake.modules.homeManager."users/{username}"`</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/darwin/base.nix</path>
        <kind>system-module</kind>
        <symbol>flake.modules.darwin.base</symbol>
        <lines>1-31</lines>
        <reason>Darwin base module showing dendritic export to flake.modules.darwin.base. Proves darwin platform namespace exists and works. Home modules will use parallel homeManager namespace.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/clan/machines.nix</path>
        <kind>clan-config</kind>
        <symbol>clan.machines</symbol>
        <lines>1-24</lines>
        <reason>Shows clan machine registration pattern using namespace imports: `imports = [ config.flake.modules.{platform}."machines/{platform}/{name}" ];` Pattern to follow for machine configs.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/flake.nix</path>
        <kind>flake</kind>
        <symbol>import-tree auto-discovery</symbol>
        <lines>65</lines>
        <reason>CRITICAL - Shows auto-discovery mechanism: `flake-parts.lib.mkFlake { inherit inputs; } (inputs.import-tree ./modules)` All .nix files in modules/ discovered automatically. Home modules will be auto-discovered.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/flake.nix</path>
        <kind>flake</kind>
        <symbol>inputs configuration</symbol>
        <lines>20-38</lines>
        <reason>Shows flake inputs including home-manager, nix-darwin, clan-core with follows rules. Home-manager input available for homeManagerConfiguration API.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/infra/modules/home/default.nix</path>
        <kind>home-module</kind>
        <symbol>homeModules.default pattern</symbol>
        <lines>1-35</lines>
        <reason>REFERENCE PATTERN FROM INFRA - Shows proven modular home structure with imports (catppuccin, lazyvim, sops, local modules). Pattern to adapt to dendritic namespace (simpler initially).</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/infra/configurations/home/raquel@blackphos.nix</path>
        <kind>home-config</kind>
        <symbol>raquel@blackphos standalone config</symbol>
        <lines>1-47</lines>
        <reason>REFERENCE PATTERN - Shows imports from self.homeModules.{default,darwin-only,standalone} with lib.mkForce overrides for user-specific settings. Pattern proves modular home configs work.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/infra/modules/home/darwin-only.nix</path>
        <kind>home-module</kind>
        <symbol>darwin-only module pattern</symbol>
        <lines>1-20</lines>
        <reason>Shows platform-specific home module pattern. For Story 1.8A: keep configs platform-agnostic initially (no darwin-only split yet). Future expansion pattern documented.</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/checks/validation.nix</path>
        <kind>test-module</kind>
        <symbol>validation checks pattern</symbol>
        <lines>15-37</lines>
        <reason>TEST PATTERN - Shows validation test structure using pkgs.runCommand with assertions. Pattern to follow for AC7 home module validation tests. Example: naming-conventions check.</reason>
      </artifact>
    </code>
    <dependencies>
      <nix>
        <package>home-manager</package>
        <version>25.05 (follows nixpkgs unstable)</version>
        <usage>Three integration modes: darwinModules.home-manager (Mode 1), nixosModules.home-manager (Mode 2), lib.homeManagerConfiguration (Mode 3 standalone)</usage>
      </nix>
      <nix>
        <package>nix-darwin</package>
        <version>Latest (follows nixpkgs)</version>
        <usage>Darwin system module framework, provides darwinConfigurations and darwin module system</usage>
      </nix>
      <nix>
        <package>clan-core</package>
        <version>main branch (git+https://git.clan.lol/clan/clan-core)</version>
        <usage>Multi-machine coordination via clan.machines, clan inventory, vars generation. No clan-specific user management used.</usage>
      </nix>
      <nix>
        <package>flake-parts</package>
        <version>7.1.1</version>
        <usage>Module system foundation, provides config.flake.* namespace for dendritic pattern self-composition</usage>
      </nix>
      <nix>
        <package>import-tree</package>
        <version>Latest (github:vic/import-tree)</version>
        <usage>Auto-discovery mechanism for dendritic pattern. All .nix files in modules/ discovered automatically, zero manual imports</usage>
      </nix>
      <cli>
        <tool>nh</tool>
        <version>Latest</version>
        <usage>Deployment CLI for three workflows: `nh darwin switch . -H blackphos` (Mode 1), `nh os switch . -H cinnabar` (Mode 2), `nh home switch . -c crs58` (Mode 3 standalone)</usage>
      </cli>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architectural">
      <name>Dendritic Namespace Export Pattern</name>
      <description>All modules MUST export to flake.modules.{platform}.{path} namespace. Home modules export to flake.modules.homeManager."users/{username}". Auto-discovered by import-tree. Zero manual flake.nix imports allowed.</description>
      <source>Test-clan Stories 1.1-1.7 validated pattern, architecture.md Decision Summary</source>
    </constraint>
    <constraint type="architectural">
      <name>Clan-Core Compatibility</name>
      <description>NO clan-specific user management. Users defined via standard NixOS users.users in machine modules. Home-manager integration via standard darwin/nixos modules. Clan inventory separate from user definitions.</description>
      <source>Architecture.md Multi-User Pattern, production clan examples (clan-infra, mic92)</source>
    </constraint>
    <constraint type="naming">
      <name>Username-Only Naming Convention</name>
      <description>Home modules and homeConfigurations MUST use username-only (e.g., "crs58", not "crs58@blackphos") for cross-platform portability. Same user module works on multiple machines.</description>
      <source>Story 1.8A AC3, infra pattern adaptation for dendritic + clan</source>
    </constraint>
    <constraint type="regression">
      <name>Zero-Regression Validation Required</name>
      <description>Package diff before/after refactoring MUST show zero functional regressions. Use: nix-store -qR $(nix build .#darwinConfigurations.blackphos.system --no-link --print-out-paths) | sort. Compare pre/post lists.</description>
      <source>Story 1.8A AC4, Task 4, infra migration best practice</source>
    </constraint>
    <constraint type="implementation">
      <name>Three Home-Manager Integration Modes</name>
      <description>Same user module MUST work in three modes: (1) Darwin integrated via darwinModules.home-manager, (2) NixOS integrated via nixosModules.home-manager (Story 1.9), (3) Standalone via lib.homeManagerConfiguration. Keep modules platform-agnostic.</description>
      <source>Story 1.8A Technical Notes, home-manager documentation</source>
    </constraint>
    <constraint type="implementation">
      <name>Auto-Discovery Requirement</name>
      <description>All .nix files in modules/ MUST be auto-discovered by import-tree. No manual imports in flake.nix. Module structure: modules/home/users/{username}/default.nix exports to namespace automatically.</description>
      <source>Test-clan flake.nix line 65, dendritic pattern core principle</source>
    </constraint>
    <constraint type="implementation">
      <name>Outer Config Capture for Namespace Access</name>
      <description>Machine modules importing from namespace MUST capture outer config: `flakeModulesHome = config.flake.modules.homeManager;` before module definition. Required for self-composition in dendritic pattern.</description>
      <source>Blackphos default.nix lines 8-9, dendritic self-composition pattern</source>
    </constraint>
    <constraint type="testing">
      <name>Test Coverage Mandatory</name>
      <description>AC7 requires validation tests in modules/checks/validation.nix verifying: (1) module exports exist in namespace, (2) homeConfigurations exposed in flake, (3) modules are functions (proper structure). Use pkgs.runCommand with assertions.</description>
      <source>Story 1.8A AC7, Task 7, test-clan test harness pattern</source>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>flake.modules.homeManager."users/{username}"</name>
      <kind>Dendritic namespace export</kind>
      <signature>{ config, pkgs, lib, ... }: { home.* = ...; programs.* = ...; }</signature>
      <description>Home-manager module exported to dendritic namespace. Function accepting standard NixOS module arguments, returning home-manager configuration attrset.</description>
      <location>Target: modules/home/users/{username}/default.nix</location>
    </interface>
    <interface>
      <name>flake.homeConfigurations.{username}</name>
      <kind>Standalone home-manager configuration</kind>
      <signature>inputs.home-manager.lib.homeManagerConfiguration { pkgs = ...; modules = [ ... ]; }</signature>
      <description>Standalone homeConfiguration for nh home switch workflow. Imports user module from namespace. Supports multiple architectures via pkgs parameter.</description>
      <location>Target: modules/home/configurations.nix</location>
    </interface>
    <interface>
      <name>home-manager.users.{username}.imports</name>
      <kind>Machine-level home integration</kind>
      <signature>imports = [ config.flake.modules.homeManager."users/{username}" ];</signature>
      <description>Machine module imports user config from namespace. Works in both darwin (darwinModules.home-manager) and NixOS (nixosModules.home-manager) integration modes.</description>
      <location>Usage: modules/machines/darwin/blackphos/default.nix (after Task 4 refactoring)</location>
    </interface>
    <interface>
      <name>users.users.{username}</name>
      <kind>Standard NixOS user definition</kind>
      <signature>users.users.{username} = { uid = ...; home = ...; shell = ...; openssh.authorizedKeys.keys = [ ... ]; };</signature>
      <description>Standard NixOS/darwin user account definition. Not clan-specific. Each machine defines its users. Home-manager configs imported separately via imports.</description>
      <location>Example: blackphos default.nix lines 84-111</location>
    </interface>
    <interface>
      <name>nh CLI workflows</name>
      <kind>Deployment tool</kind>
      <signature>nh {darwin|os|home} switch . -H {hostname} | -c {username}</signature>
      <description>Three deployment modes: darwin switch (Mode 1 integrated), os switch (Mode 2 NixOS), home switch (Mode 3 standalone). Story 1.8A validates darwin + standalone modes.</description>
      <location>CLI tool, documented in test-clan README.md and Story 1.8A Technical Notes</location>
    </interface>
  </interfaces>

  <tests>
    <standards>Test-clan uses hybrid test harness with auto-discovery in modules/checks/: (1) nix-unit for fast expression tests, (2) pkgs.runCommand validation checks for structural assertions, (3) runNixOSTest for VM integration tests. All tests run via `nix flake check`. Story 1.8A adds validation checks (AC7) verifying home module exports and homeConfigurations exist with proper structure (function types, derivation types).</standards>
    <locations>
      <location>modules/checks/validation.nix - Structural validation tests</location>
      <location>modules/checks/nix-unit.nix - Fast expression evaluation tests</location>
      <location>modules/checks/integration.nix - VM integration tests (Linux only)</location>
    </locations>
    <ideas>
      <test ac="AC1">
        <name>validate-crs58-module-export</name>
        <description>Assert flake.modules.homeManager."users/crs58" exists and is a function (proper module structure)</description>
      </test>
      <test ac="AC2">
        <name>validate-raquel-module-export</name>
        <description>Assert flake.modules.homeManager."users/raquel" exists and is a function</description>
      </test>
      <test ac="AC3">
        <name>validate-homeconfigurations-exposed</name>
        <description>Assert flake.homeConfigurations.crs58 and flake.homeConfigurations.raquel exist (username-only naming)</description>
      </test>
      <test ac="AC3">
        <name>validate-homeconfigurations-buildable</name>
        <description>Assert homeConfigurations are derivations (have activationPackage attribute, buildable)</description>
      </test>
      <test ac="AC4">
        <name>validate-blackphos-builds</name>
        <description>Build test: `nix build .#darwinConfigurations.blackphos.system` succeeds after refactoring</description>
      </test>
      <test ac="AC4">
        <name>validate-zero-regression</name>
        <description>Manual validation: Compare pre/post package lists from nix-store -qR, verify all packages preserved</description>
      </test>
      <test ac="AC5">
        <name>validate-standalone-activation</name>
        <description>Manual test: `nh home switch . -c crs58` succeeds, creates ~/.config/home-manager symlinks, activates profile</description>
      </test>
    </ideas>
  </tests>
</story-context>
