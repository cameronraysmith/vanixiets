<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>9</storyId>
    <title>Rename Hetzner VMs to cinnabar/electrum and establish zerotier network</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-9-rename-vms-cinnabar-electrum-establish-zerotier.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to rename the test Hetzner VMs to their intended production names (cinnabar and electrum) and establish a zerotier network between them</iWant>
    <soThat>the test-clan infrastructure mirrors the production topology that will be deployed in Epic 2+ and heterogeneous networking is validated</soThat>
    <tasks>
### Task 1: Identify and catalog all files requiring rename updates (30 minutes)
- Search test-clan for old machine names
- Create checklist of files to update
- Document current zerotier network configuration from Story 1.5
- Verify no operational VMs at risk

### Task 2: Rename machine module directories (15 minutes)
- Rename directories: hetzner-vm → cinnabar, test-vm → electrum
- Update module default.nix files with new hostnames
- Verify no broken imports after directory rename

### Task 3: Update clan inventory with new machine names (30 minutes)
- Edit modules/flake-parts/clan.nix with production names
- Update tags: cinnabar (controller), electrum (peer)
- Update service instances to reference new names
- Validate inventory and build configurations

### Task 4: Update terranix configuration for new machine names (30 minutes)
- Update terraform resource names
- Regenerate terraform configuration
- Review generated terraform.tf.json for consistency

### Task 5: Regenerate clan vars for renamed machines (20 minutes)
- Check if vars need regeneration
- Generate vars for cinnabar and electrum
- Verify secrets properly named and accessible

### Task 6: Update all test files to reference new machine names (45 minutes)
- Update regression tests (RT-1, RT-2, RT-3)
- Update invariant tests (IT-1, IT-2)
- Update integration tests (VT-1)
- Run full test suite

### Task 7: Validate zerotier network between cinnabar and electrum (45 minutes)
- Verify zerotier controller status on cinnabar
- Verify zerotier peer status on electrum
- Test bidirectional connectivity via zerotier IPs
- Document zerotier network ID and IPs

### Task 8: Update documentation with production topology (30 minutes)
- Update README.md with production names
- Update architecture docs
- Add zerotier network documentation
- Document cinnabar/electrum roles

### Task 9: Commit changes with atomic commits per category (30 minutes)
- Commit machine module rename
- Commit inventory updates
- Commit test updates
- Commit terranix updates
- Commit documentation
</tasks>
  </story>

  <acceptanceCriteria>
### AC1: VMs renamed in test-clan configuration
- hetzner-vm → cinnabar (primary VPS, zerotier controller)
- test-vm → electrum (secondary test VM, zerotier peer)
- All module paths updated to reflect new names
- No references to old names remain

### AC2: Clan inventory updated with new machine names
- cinnabar: tags = ["nixos" "cloud" "hetzner" "controller"], role = zerotier controller
- electrum: tags = ["nixos" "cloud" "hetzner" "peer"], role = zerotier peer
- Service instances updated to target new names
- Inventory validates successfully

### AC3: Zerotier network established and documented
- Cinnabar configured as zerotier controller (from Story 1.5)
- Electrum configured as zerotier peer
- Both machines join the same zerotier network
- Network ID documented

### AC4: Network connectivity validated between cinnabar and electrum
- Bidirectional ping via zerotier IPs successful
- SSH via zerotier IPs working
- Network latency acceptable (< 100ms)
- Zerotier status shows online on both machines

### AC5: Configuration rebuilds successful with new names
- cinnabar builds successfully
- electrum builds successfully
- No errors or warnings about missing references
- Clan vars regenerated if needed

### AC6: Test harness updated to reference new machine names
- All test files updated with new names
- Regression tests passing (RT-1, RT-2, RT-3)
- Invariant tests passing (IT-1, IT-2)
- Integration tests updated (VT-1)

### AC7: Documentation updated to reflect production topology
- README.md updated
- Architecture docs reference production topology
- Zerotier network ID documented
- Troubleshooting guides updated
</acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Epic 1 Overview -->
      <doc>
        <path>docs/notes/development/epics/epic-1-architectural-validation-migration-pattern-rehearsal-phase-0.md</path>
        <title>Epic 1: Architectural Validation + Migration Pattern Rehearsal</title>
        <section>Story 1.9 Description</section>
        <snippet>Configuration refactoring to rename test VMs (hetzner-vm → cinnabar, test-vm → electrum) and establish zerotier network between them. Aligns test-clan infrastructure with production topology naming for Epic 2+ migration.</snippet>
      </doc>

      <!-- test-clan Architecture -->
      <doc>
        <path>docs/notes/development/test-clan-validated-architecture.md</path>
        <title>test-clan Validated Architecture Map</title>
        <section>Repository Structure</section>
        <snippet>Dendritic flake-parts with clan-core orchestration. Machines auto-discovered via import-tree pattern. Test harness validates architectural constraints (17 test cases). Module structure: modules/machines/nixos/{machine-name}/, modules/clan/{inventory,machines}.nix, modules/checks/*.nix for tests.</snippet>
      </doc>

      <!-- test-clan README -->
      <doc>
        <path>~/projects/nix-workspace/test-clan/README.md</path>
        <title>test-clan Repository README</title>
        <section>Development Workflow</section>
        <snippet>Fast validation (~5s): just test-quick. Full test suite: just test. VM integration tests: just test-integration. Build all machines: just build-all. Deployment via nh CLI for darwin, clan machines update for nixos.</snippet>
      </doc>

      <!-- Story 1.5 Context (Zerotier Foundation) -->
      <doc>
        <path>docs/notes/development/work-items/1-5-deploy-hetzner-vm-and-validate-stack.md</path>
        <title>Story 1.5: Deploy Hetzner VM and validate stack</title>
        <section>AC9: Zerotier Controller Operational</section>
        <snippet>Zerotier controller deployed on hetzner-vm (now to be renamed cinnabar). Network created during Story 1.5. Controller running, network ID exists for Story 1.9 documentation.</snippet>
      </doc>

      <!-- Story 1.6 Context (Test Harness) -->
      <doc>
        <path>docs/notes/development/work-items/1-6-implement-comprehensive-test-harness-for-test-clan.md</path>
        <title>Story 1.6: Implement comprehensive test harness</title>
        <section>Test Categories</section>
        <snippet>18 tests total: 12 nix-unit (regression, invariant, feature), 4 validation (behavioral), 2 integration (VM boot). Tests in modules/checks/ with categories: regression (RT-*), invariant (IT-*), feature (FT-*), integration (VT-*). All tests must pass after rename.</snippet>
      </doc>

      <!-- Story 1.7 Context (Zero-Regression Pattern) -->
      <doc>
        <path>docs/notes/development/work-items/1-7-execute-dendritic-refactoring-in-test-clan-using-test-harness.md</path>
        <title>Story 1.7: Execute dendritic refactoring with test harness</title>
        <section>Zero-Regression Validation Strategy</section>
        <snippet>Proven pattern: Capture pre-change state, perform refactoring, validate post-change equivalence. Test harness validates structural and functional preservation. Story 1.9 uses same approach for rename operation.</snippet>
      </doc>

      <!-- Story 1.8A Context (Portable Home Modules) -->
      <doc>
        <path>docs/notes/development/work-items/1-8a-extract-portable-home-manager-modules.md</path>
        <title>Story 1.8A: Extract portable home-manager modules</title>
        <section>Implementation Outcome</section>
        <snippet>User modules extracted to modules/home/users/{crs58,raquel}/. Exported to dendritic namespace. Three integration modes: darwin integrated, NixOS integrated, standalone. crs58 module ready for future cinnabar NixOS integration (not this story).</snippet>
      </doc>

      <!-- External Reference: Clan Inventory Patterns -->
      <doc>
        <path>~/projects/nix-workspace/clan-infra/</path>
        <title>clan-infra - Primary Clan Reference (flake-parts, not dendritic)</title>
        <section>Clan Inventory Structure</section>
        <snippet>Production clan usage with inventory patterns, service targeting, machine definitions. Reference for clan.inventory.machines structure, service instance configurations, role-based targeting. Shows proven patterns for multi-machine coordination.</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/qubasa-clan-infra/</path>
        <title>qubasa-clan-infra - Clan Core Developer Personal Usage</title>
        <section>Clan Patterns</section>
        <snippet>Clan core developer (Johannes Kirschbauer) personal infrastructure. Reference for advanced clan patterns, service configurations, inventory organization. May show edge cases and best practices from clan-core maintainer perspective.</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/mic92-clan-dotfiles/</path>
        <title>mic92-clan-dotfiles - Clan Core Developer Personal Usage</title>
        <section>Clan Patterns</section>
        <snippet>Clan core developer (Jörg Thalheim) personal configuration. Reference for clan service patterns, machine coordination, zerotier network setup. Shows production usage patterns from clan-core maintainer.</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/pinpox-clan-nixos/</path>
        <title>pinpox-clan-nixos - Clan Core Developer Personal Usage</title>
        <section>Clan Patterns</section>
        <snippet>Clan core developer personal configuration. Reference for clan inventory patterns, service instances, machine fleet management. May show naming conventions and organizational patterns.</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/nixpkgs.molybdenum.software-dendritic-clan/</path>
        <title>molybdenum.software - Dendritic + Clan Combination</title>
        <section>Dendritic + Clan Integration</section>
        <snippet>Demonstrates dendritic flake-parts + clan-core integration (minimal example). Shows how clan inventory works with dendritic module discovery. Useful for understanding integration points between the two patterns.</snippet>
      </doc>

      <!-- External Reference: Dendritic Patterns -->
      <doc>
        <path>~/projects/nix-workspace/dendrix-dendritic-nix/</path>
        <title>dendrix-dendritic-nix - Reference Dendritic Implementation</title>
        <section>Module Organization and Namespace Exports</section>
        <snippet>Reference dendritic flake-parts implementation. Shows module self-organization via flake.modules.* namespaces, import-tree auto-discovery, machine module patterns. Reference for directory structure and module export patterns.</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/gaetanlepage-dendritic-nix-config/</path>
        <title>gaetanlepage-dendritic-nix-config - Reference Dendritic Implementation</title>
        <section>Module Organization and Naming Conventions</section>
        <snippet>High-quality dendritic implementation. Shows module organization patterns, namespace exports, machine configuration structure. Reference for naming conventions (kebab-case), directory organization, module boundaries.</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/drupol-dendritic-infra/</path>
        <title>drupol-dendritic-infra - Reference Dendritic Implementation</title>
        <section>Infrastructure Patterns</section>
        <snippet>Dendritic pattern for infrastructure management. Shows module organization for infrastructure code, namespace patterns, auto-discovery usage. May provide patterns for machine module organization.</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/mightyiam-dendritic-infra/</path>
        <title>mightyiam-dendritic-infra - Reference Dendritic Implementation</title>
        <section>Module Patterns</section>
        <snippet>Dendritic infrastructure patterns. Reference for module organization, namespace exports, import-tree integration. Shows real-world usage patterns.</snippet>
      </doc>

      <!-- External Reference: Testing Patterns -->
      <doc>
        <path>~/projects/nix-workspace/nix-unit-flake-parts/</path>
        <title>nix-unit-flake-parts - Testing Integration</title>
        <section>Test Organization</section>
        <snippet>Nix-unit integration with flake-parts. Shows test organization patterns, test case structure, integration with flake checks. Reference for test harness patterns (already implemented in test-clan, but useful for validation).</snippet>
      </doc>
    </docs>

    <code>
      <!-- Clan Inventory (will need updates) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/machines.nix</path>
        <kind>config</kind>
        <symbol>clan.inventory.machines</symbol>
        <lines>1-48</lines>
        <reason>Central machine inventory definition. Currently has hetzner-ccx23, hetzner-cx43, gcp-vm, test-darwin, blackphos. Story 1.9 needs to identify which names are hetzner-vm and test-vm equivalents for rename to cinnabar/electrum.</reason>
      </artifact>

      <!-- Clan Machine Registration (will need updates) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/clan/machines.nix</path>
        <kind>config</kind>
        <symbol>clan.machines</symbol>
        <lines>1-24</lines>
        <reason>Machine registration mapping clan.machines to flake.modules imports. References dendritic module paths. Must update machine keys and import paths after directory rename.</reason>
      </artifact>

      <!-- Test Harness: nix-unit tests -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/checks/nix-unit.nix</path>
        <kind>test</kind>
        <symbol>nix-unit.tests</symbol>
        <lines>1-100</lines>
        <reason>Expression evaluation tests. TC-003 (inventory structure test) hardcodes machine name list, must update to cinnabar/electrum. Other tests reference self.nixosConfigurations keys.</reason>
      </artifact>

      <!-- Machine Modules (will be renamed) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/machines/nixos/hetzner-ccx23/</path>
        <kind>directory</kind>
        <symbol>hetzner-ccx23 machine config</symbol>
        <lines>N/A</lines>
        <reason>Likely candidate for rename to cinnabar (primary VPS). Contains default.nix with machine configuration, networking.hostName, disko config.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/machines/nixos/hetzner-cx43/</path>
        <kind>directory</kind>
        <symbol>hetzner-cx43 machine config</symbol>
        <lines>N/A</lines>
        <reason>Likely candidate for rename to electrum (secondary test VM). Contains default.nix with machine configuration.</reason>
      </artifact>

      <!-- Terranix Configuration (will need updates) -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/terranix/hetzner.nix</path>
        <kind>infrastructure</kind>
        <symbol>flake.modules.terranix.hetzner</symbol>
        <lines>N/A</lines>
        <reason>Terraform resource generation for Hetzner VMs. Uses machines = { hetzner-ccx23 = {...}, hetzner-cx43 = {...} } pattern with toggle mechanism. Must update machine keys to cinnabar/electrum.</reason>
      </artifact>

      <!-- Zerotier Service Configuration -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/services/zerotier.nix</path>
        <kind>service</kind>
        <symbol>clan.inventory.instances.zerotier</symbol>
        <lines>N/A</lines>
        <reason>Zerotier service instance configuration. Currently targets machines by old names. Must update roles.controller.machines and roles.peer references to new names.</reason>
      </artifact>

      <!-- Test Integration Tests -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/checks/integration.nix</path>
        <kind>test</kind>
        <symbol>VM boot tests</symbol>
        <lines>N/A</lines>
        <reason>VM integration tests (VT-1: vm-boot-all-machines). References nixosConfigurations keys. Must update to cinnabar/electrum after rename.</reason>
      </artifact>

      <!-- Test Validation Tests -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/checks/validation.nix</path>
        <kind>test</kind>
        <symbol>Behavioral validation tests</symbol>
        <lines>N/A</lines>
        <reason>Property validation tests (TC-006, TC-007, TC-012, TC-017). May reference machine names in validation logic or naming convention checks.</reason>
      </artifact>
    </code>

    <dependencies>
      <nix>
        <package>nixpkgs (unstable)</package>
        <package>flake-parts</package>
        <package>clan-core</package>
        <package>import-tree (dendritic pattern)</package>
        <package>terranix</package>
        <package>disko</package>
        <package>srvos</package>
        <package>nix-unit (testing)</package>
        <package>treefmt-nix (formatting)</package>
      </nix>

      <tools>
        <tool>just (task runner)</tool>
        <tool>nh (nix helper CLI)</tool>
        <tool>clan CLI (machine deployment)</tool>
        <tool>opentofu (terraform)</tool>
        <tool>zerotier-cli (network validation)</tool>
        <tool>ripgrep (search for old names)</tool>
        <tool>fd (file discovery)</tool>
      </tools>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Dendritic flake-parts pattern: All module imports via config.flake.modules.* namespace. No direct file path imports in machine configs. Module paths must match directory structure.</constraint>
    <constraint type="architecture">Clan inventory pattern: Machine definitions must have matching entries in both clan.machines (registration) and clan.inventory.machines (metadata). Service instances target machines by name or tags.</constraint>
    <constraint type="configuration">Configuration-only changes: Story 1.9 does NOT deploy new infrastructure or users. No crs58 user deployment to cinnabar (deferred to future work). Focus: rename VMs + zerotier network validation.</constraint>
    <constraint type="testing">Zero-regression requirement: All 18 tests must pass after rename. Test harness validates structural equivalence. Machine closures may have different paths (name embedded) but same functionality.</constraint>
    <constraint type="naming">Production topology alignment: cinnabar = primary VPS, permanent, zerotier controller. electrum = secondary test VM, may be ephemeral, zerotier peer. Names chosen for production infra (Epic 2+).</constraint>
    <constraint type="operational">Protect operational VMs: Story 1.7 notes mention operational IPs (162.55.175.87, 49.13.140.183). Avoid accidental deployment during testing. Use enabled=false in terranix toggle.</constraint>
    <constraint type="git">Atomic commits per category: Separate commits for machine rename, inventory updates, test updates, terranix updates, documentation. Follow conventional commit format.</constraint>
    <constraint type="zerotier">Zerotier network from Story 1.5: Controller already operational on hetzner-vm. Network ID exists. Story 1.9 validates network still works after rename and adds electrum peer.</constraint>
    <constraint type="reference-examples">When uncertain about patterns during implementation, consult external reference projects: clan-infra, qubasa-clan-infra, mic92-clan-dotfiles, pinpox-clan-nixos (clan patterns); dendrix-dendritic-nix, gaetanlepage-dendritic-nix-config, drupol-dendritic-infra, mightyiam-dendritic-infra (dendritic patterns); molybdenum.software (dendritic+clan integration); nix-unit-flake-parts (testing patterns). All available in ~/projects/nix-workspace/.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>clan machines registration</name>
      <kind>nix module system</kind>
      <signature>clan.machines.&lt;machine-name&gt; = { imports = [ config.flake.modules.&lt;platform&gt;."machines/&lt;platform&gt;/&lt;machine-name&gt;" ]; };</signature>
      <path>~/projects/nix-workspace/test-clan/modules/clan/machines.nix</path>
      <notes>Machine keys must match dendritic module paths. After directory rename, both keys and import paths must update.</notes>
    </interface>

    <interface>
      <name>clan inventory machines</name>
      <kind>nix module system</kind>
      <signature>clan.inventory.machines.&lt;machine-name&gt; = { tags = ["..."]; machineClass = "nixos"|"darwin"; description = "..."; };</signature>
      <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/machines.nix</path>
      <notes>Provides metadata and tags for service targeting. Machine keys must match clan.machines keys.</notes>
    </interface>

    <interface>
      <name>clan service instances</name>
      <kind>nix module system</kind>
      <signature>clan.inventory.instances.&lt;service&gt; = { module = {...}; roles.&lt;role&gt;.machines.&lt;name&gt; = {}; roles.&lt;role&gt;.tags.&lt;tag&gt; = {}; };</signature>
      <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/services/*.nix</path>
      <notes>Zerotier service: roles.controller.machines references controller machine by name. roles.peer.tags targets peers via inventory tags.</notes>
    </interface>

    <interface>
      <name>dendritic module exports</name>
      <kind>flake-parts pattern</kind>
      <signature>flake.modules.&lt;namespace&gt;.&lt;path&gt; = { ... }: { ... };</signature>
      <path>modules/**/default.nix in test-clan</path>
      <notes>Machine modules export to flake.modules.nixos."machines/nixos/&lt;name&gt;". Path component must match directory name. After rename, module export paths update automatically via dendritic discovery.</notes>
    </interface>

    <interface>
      <name>terranix machine definitions</name>
      <kind>terraform generation</kind>
      <signature>machines = { &lt;name&gt; = { enabled = bool; serverType = "..."; location = "..."; image = "..."; }; };</signature>
      <path>~/projects/nix-workspace/test-clan/modules/terranix/hetzner.nix</path>
      <notes>Machine keys in terranix must match clan.machines keys. Resources generated dynamically via lib.mapAttrs over enabledMachines.</notes>
    </interface>

    <interface>
      <name>test case assertions</name>
      <kind>nix-unit testing</kind>
      <signature>testName = { expr = ...; expected = ...; };</signature>
      <path>~/projects/nix-workspace/test-clan/modules/checks/nix-unit.nix</path>
      <notes>TC-003 hardcodes machine name list. Must update expected = [...] to include cinnabar/electrum after rename. Other tests reference self.nixosConfigurations keys.</notes>
    </interface>
  </interfaces>

  <tests>
    <standards>
Test harness uses three frameworks: nix-unit for expression evaluation, runNixOSTest for VM integration (Linux-only), runCommand for behavioral validation.
Test categories: Regression (RT-*) validates no functionality loss, Invariant (IT-*) validates structural constraints, Feature (FT-*) validates architectural patterns, Integration (VT-*) validates VM boot and deployment.
Test execution: just test-quick (~5s) for fast tests, just test (~11s) for full suite on current system, just test-integration (~2-5min) for VM tests.
Zero-regression requirement: All tests must pass after refactoring. Test harness proven in Story 1.7 for dendritic refactoring with zero regressions.
    </standards>

    <locations>
~/projects/nix-workspace/test-clan/modules/checks/nix-unit.nix (11 test cases)
~/projects/nix-workspace/test-clan/modules/checks/integration.nix (2 VM boot tests, Linux-only)
~/projects/nix-workspace/test-clan/modules/checks/validation.nix (4 behavioral tests)
~/projects/nix-workspace/test-clan/justfile (test runners: test-quick, test, test-integration)
    </locations>

    <ideas>
      <idea ac="AC1" test="RT-3 (Machine builds)">After directory rename and hostname updates, verify both cinnabar and electrum configurations build successfully. Compare closures to pre-rename state (ignoring path differences from name embedding).</idea>
      <idea ac="AC2" test="IT-1 (Inventory structure)">Update TC-003 test expected machine list to include cinnabar and electrum instead of old names. Verify inventory.machines has correct machine keys.</idea>
      <idea ac="AC2" test="IT-2 (Service targeting)">Verify zerotier service instance correctly targets cinnabar as controller and electrum (or tag-based targeting) as peer after inventory updates.</idea>
      <idea ac="AC3,AC4" test="Manual validation (not automated)">SSH to operational VMs and run zerotier-cli info, zerotier-cli listnetworks, zerotier-cli listpeers. Test bidirectional ping via zerotier IPs. Document network ID.</idea>
      <idea ac="AC5" test="RT-3 + nix build">Run nix build .#nixosConfigurations.{cinnabar,electrum}.config.system.build.toplevel. Verify no errors about missing references or broken imports after rename.</idea>
      <idea ac="AC6" test="All test categories">Update all test files with new machine names. Run full test suite: just test. Verify all 18 tests passing (regression, invariant, feature, integration).</idea>
      <idea ac="AC7" test="Manual review">Grep README.md and docs/ for old machine names. Verify all documentation references cinnabar/electrum consistently. Check architecture docs reflect production topology.</idea>
    </ideas>
  </tests>
</story-context>
