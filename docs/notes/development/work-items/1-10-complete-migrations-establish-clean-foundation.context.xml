<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.10</storyId>
    <title>Complete Migrations and Establish Clean Foundation</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-10-complete-migrations-establish-clean-foundation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a system administrator</asA>
    <iWant>to complete the blackphos migration from infra, apply shared configuration to cinnabar, and refactor test-clan to exemplar dendritic patterns</iWant>
    <soThat>I have complete, clean configurations ready for deployment and a solid foundation for type-safe home-manager architecture</soThat>
    <tasks>
### Task 1: Audit blackphos Migration and Identify Gaps (1-2 hours)
Objective: Create comprehensive comparison between infra blackphos and test-clan blackphos to identify all remaining configuration to migrate.
- Subtask 1.1: Compare infra blackphos packages vs test-clan blackphos packages
- Subtask 1.2: Compare infra blackphos services vs test-clan blackphos services
- Subtask 1.3: Compare infra blackphos system settings vs test-clan blackphos settings
- Subtask 1.4: Review infra blackphos-nixos replica configuration

### Task 2: Migrate Remaining blackphos Configuration to test-clan (2-3 hours)
Objective: Migrate all identified remaining configuration from infra blackphos to test-clan blackphos following dendritic patterns.
- Subtask 2.1: Migrate packages
- Subtask 2.2: Migrate services
- Subtask 2.3: Migrate system settings
- Subtask 2.3a: Capture pre-migration baseline for zero-regression validation
- Subtask 2.4: Validate zero regression

### Task 3: Deploy cameron User to cinnabar (2-3 hours) **CRITICAL**
Objective: Add cameron user to cinnabar with home-manager integration, enabling SSH login and validating cross-platform user module reuse.
- Subtask 3.1: Add cameron user to cinnabar nixos configuration
- Subtask 3.2: Integrate portable home-manager module (nixos integrated mode)
- Subtask 3.3: Build and deploy cinnabar configuration
- Subtask 3.4: Validate SSH login as cameron

### Task 4: Audit and Refine Dendritic Patterns (2-3 hours)
Objective: Audit test-clan for dendritic pattern compliance and refine patterns to match gaetanlepage exemplar standards.
- Subtask 4.1: Audit file length compliance
- Subtask 4.2: Audit pattern compliance
- Subtask 4.3: Refine module organization
- Subtask 4.4: Update architecture documentation

### Task 5: Validate Clan-Core Integration (1 hour)
Objective: Verify clan-core integration remains functional after migrations and dendritic pattern refinements.
- Subtask 5.1: Validate clan inventory structure
- Subtask 5.2: Validate clan machines build
- Subtask 5.3: Validate zerotier network operational

### Task 6: Run Comprehensive Test Suite (1 hour)
Objective: Validate zero regression via comprehensive test suite and verify all architectural invariants maintained.
- Subtask 6.1: Run full test suite
- Subtask 6.2: Validate pattern compliance
- Subtask 6.3: Validate integration tests

### Task 7: Document Migration Patterns and Dendritic Guidelines (1 hour)
Objective: Create comprehensive documentation for migration patterns and dendritic pattern guidelines for Epic 2-6 reuse.
- Subtask 7.1: Document migration patterns
- Subtask 7.2: Document dendritic pattern guidelines
- Subtask 7.3: Update story completion notes
</tasks>
  </story>

  <acceptanceCriteria>
### A. Complete blackphos Migration and Apply Shared Config to cinnabar
**AC1: blackphos Migration Audit Complete** - Audit infra vs test-clan, identify ALL remaining config, document findings, create migration checklist
**AC2: All Remaining Configuration Migrated** - All config migrated following dendritic patterns, package list comparison validates zero regression
**AC3: Shared vs Platform-Specific Identified** - Shared (user identity, SSH, nix, caches) vs darwin (homebrew, GUI) vs nixos (boot, systemd) documented
**AC4: cinnabar User Configuration Deployed** - cameron user added, SSH keys configured, home-manager integrated (nixos-integrated mode), SSH login validated
**AC5: Migration Pattern Documented** - Shared/platform-specific guidelines, migration checklist, cross-platform user pattern documented

### B. Apply Dendritic Pattern Refinements
**AC6: File Length Compliance** - Files >200 lines audited, modularized if justified, exceptions documented
**AC7: Pattern Compliance Enforced** - ALL modules/ files are flake-parts modules, `_` prefix ONLY for non-module data files
**AC8: Module Organization Refined** - Clear separation (base/host/user), consistent namespaces, gaetanlepage patterns referenced
**AC9: All Configurations Build** - darwinConfigurations, nixosConfigurations, homeConfigurations all build successfully

### C. Clan-Core Integration Validation
**AC10: Clan-Core Compatibility Maintained** - inventory structure, services.*, vars.*, secrets.*, zerotier config unchanged
**AC11: Zerotier Network Operational** - Cinnabar controller, electrum peer operational, clan inventory evaluates

### D. Test Coverage
**AC12: Migration Validation Tests Pass** - blackphos package diff zero regression, cinnabar SSH login works, home-manager builds both platforms
**AC13: Pattern Compliance Tests Pass** - All 14 tests from Story 1.9 continue passing, file length compliance, namespace consistency
**AC14: Integration Tests Pass** - All configurations build, clan inventory evaluates, full test suite passes

### E. Documentation
**AC15: Migration Documentation Complete** - Shared/platform-specific pattern, blackphos migration checklist, cinnabar user config guide
**AC16: Dendritic Pattern Guidelines Documented** - File organization standards, module composition patterns, namespace hygiene rules
</acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Migration Source Documentation -->
      <doc>
        <path>docs/notes/architecture/dendritic-organization-patterns.md</path>
        <title>Dendritic Organization Patterns Investigation</title>
        <section>Investigation Findings</section>
        <snippet>Investigation of dendritic flake-parts pattern organization revealed test-clan's current structure is appropriate with minimal restructuring needed. gaetanlepage exemplar demonstrates clear separation of base modules, host-specific modules, and hardware modules.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/home-manager-type-safe-architecture.md</path>
        <title>Home-Manager Type-Safe Architecture Reference</title>
        <section>Architecture Reference</section>
        <snippet>Documents type-safe home-manager architecture pattern using homeHosts options with validation. Three integration modes: darwin integrated, NixOS integrated, standalone homeConfigurations.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-8a-extract-portable-home-manager-modules.md</path>
        <title>Story 1.8A - Portable Home Modules Pattern</title>
        <section>Pattern and Migration Validation</section>
        <snippet>Extracted crs58/raquel into portable modules (modules/home/users/{crs58,raquel}/). Package diff validated zero regression (270 packages preserved exactly). Pattern ready for cinnabar NixOS integration.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-9-rename-vms-cinnabar-electrum-establish-zerotier.md</path>
        <title>Story 1.9 - Zerotier Network Baseline</title>
        <section>Current State and Zerotier Context</section>
        <snippet>VMs renamed cinnabar/electrum, zerotier network operational (db4344343b14b903). 14/14 tests passing baseline. Cinnabar controller + electrum peer, bidirectional connectivity 1-12ms latency.</snippet>
      </doc>
      <doc>
        <path>CLAUDE.md</path>
        <title>Project Context - Machine Fleet and Username Conventions</title>
        <section>Machines and Users</section>
        <snippet>User crs58 is global admin. Preferred username cameron on new machines (operates as alias for crs58 in home-manager). Machine fleet includes stibnite, blackphos, argentum, rosegold (darwin) and cinnabar, ephemeral-* (nixos).</snippet>
      </doc>

      <!-- Architecture and Epic Context -->
      <doc>
        <path>docs/notes/development/PRD/index.md</path>
        <title>PRD Index - Product Requirements</title>
        <section>Product Scope and Requirements</section>
        <snippet>Progressive rollout infrastructure migration with 6 phases. Phase 0 (test-clan validation) establishes patterns for production refactoring.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/architecture/index.md</path>
        <title>Architecture Index - Technical Decisions</title>
        <section>Architectural Decisions and Technology Stack</section>
        <snippet>Dendritic flake-parts + clan-core architecture with terraform/terranix infrastructure provisioning. Zerotier mesh networking for machine coordination.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/epics/epic-1-architectural-validation-migration-pattern-rehearsal-phase-0.md</path>
        <title>Epic 1 - Architectural Validation Context</title>
        <section>Epic Overview and Success Criteria</section>
        <snippet>Epic 1 validates complete stack (dendritic + clan + terraform + infrastructure) on real VMs and darwin machines. Stories 1.1-1.9 complete, Story 1.10 completes migrations and establishes clean foundation for Story 1.11 type-safe architecture.</snippet>
      </doc>

      <!-- External Reference Repositories -->
      <doc>
        <path>~/projects/nix-workspace/gaetanlepage-dendritic-nix-config/README.md</path>
        <title>gaetanlepage Dendritic Exemplar</title>
        <section>Dendritic Pattern Reference</section>
        <snippet>Exemplar dendritic flake-parts pattern. File organization: modules/flake/hosts.nix for generation, modules/hosts/<hostname>/ for host-specific, clear separation of concerns.</snippet>
      </doc>
      <doc>
        <path>~/projects/nix-workspace/test-clan/README.md</path>
        <title>test-clan Repository Context</title>
        <section>Current State and Story 1.9 Baseline</section>
        <snippet>Validation repository for Epic 1. Story 1.9 complete: zerotier network operational, 14/14 tests passing. Ready for Story 1.10 migrations and refinements.</snippet>
      </doc>
    </docs>
    <code>
      <!-- infra Repository - Migration Source -->
      <code>
        <path>~/projects/nix-workspace/infra/configurations/darwin/blackphos.nix</path>
        <kind>darwin configuration</kind>
        <symbol>blackphos darwin configuration</symbol>
        <lines>entire file</lines>
        <reason>PRIMARY SOURCE for remaining blackphos configuration to migrate. Compare against test-clan blackphos to identify gaps.</reason>
      </code>
      <code>
        <path>~/projects/nix-workspace/infra/configurations/nixos/blackphos-nixos.nix</path>
        <kind>nixos configuration</kind>
        <symbol>blackphos-nixos shared pattern</symbol>
        <lines>entire file</lines>
        <reason>Shows SHARED configuration pattern between blackphos (darwin) and blackphos-nixos. Reveals what cinnabar should share with blackphos (user identity, SSH, nix settings, caches) vs exclude (platform-specific).</reason>
      </code>
      <code>
        <path>~/projects/nix-workspace/infra/modules/darwin/all/homebrew.nix</path>
        <kind>darwin module</kind>
        <symbol>homebrew configuration</symbol>
        <lines>entire file</lines>
        <reason>Platform-specific darwin module (homebrew). Should NOT be shared with cinnabar. Helps understand darwin vs nixos boundaries.</reason>
      </code>

      <!-- test-clan Repository - Migration Target -->
      <code>
        <path>~/projects/nix-workspace/test-clan/modules/machines/darwin/blackphos/default.nix</path>
        <kind>darwin machine module</kind>
        <symbol>blackphos machine configuration</symbol>
        <lines>entire file</lines>
        <reason>MIGRATION TARGET for blackphos. Current state shows what's already migrated. Compare against infra to identify remaining config.</reason>
      </code>
      <code>
        <path>~/projects/nix-workspace/test-clan/modules/machines/nixos/cinnabar/default.nix</path>
        <kind>nixos machine module</kind>
        <symbol>cinnabar machine configuration</symbol>
        <lines>entire file</lines>
        <reason>TARGET for cameron user deployment. Currently only has srvos defaults + zerotier. Add cameron user here with nixos-integrated home-manager.</reason>
      </code>
      <code>
        <path>~/projects/nix-workspace/test-clan/modules/home/users/crs58/default.nix</path>
        <kind>home-manager user module</kind>
        <symbol>crs58 user module</symbol>
        <lines>entire file</lines>
        <reason>PORTABLE MODULE ready for cinnabar integration. Extracted in Story 1.8A, cross-platform compatible. Import as flake.modules.homeManager."users/crs58".</reason>
      </code>
      <code>
        <path>~/projects/nix-workspace/test-clan/modules/home/users/raquel/default.nix</path>
        <kind>home-manager user module</kind>
        <symbol>raquel user module</symbol>
        <lines>entire file</lines>
        <reason>Cross-platform user module example. Shows portable home-manager pattern working across darwin + nixos.</reason>
      </code>
      <code>
        <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/machines.nix</path>
        <kind>clan inventory</kind>
        <symbol>clan machine definitions</symbol>
        <lines>entire file</lines>
        <reason>Clan-core integration point. Defines cinnabar, electrum, blackphos machines. MUST preserve structure during migrations.</reason>
      </code>
      <code>
        <path>~/projects/nix-workspace/test-clan/modules/checks/</path>
        <kind>test harness</kind>
        <symbol>test suite modules</symbol>
        <lines>directory</lines>
        <reason>Test harness (14/14 tests from Story 1.9). MUST continue passing after all migrations and refinements. Zero-regression validation.</reason>
      </code>

      <!-- gaetanlepage Exemplar -->
      <code>
        <path>~/projects/nix-workspace/gaetanlepage-dendritic-nix-config/modules/flake/hosts.nix</path>
        <kind>flake module</kind>
        <symbol>nixosConfigurations/homeConfigurations generator</symbol>
        <lines>entire file</lines>
        <reason>Exemplar dendritic pattern for configuration generation. Reference for organization patterns and module composition.</reason>
      </code>
      <code>
        <path>~/projects/nix-workspace/gaetanlepage-dendritic-nix-config/modules/hosts/</path>
        <kind>host modules directory</kind>
        <symbol>host-specific modules</symbol>
        <lines>directory</lines>
        <reason>Exemplar host-specific module organization. Shows clear separation of base modules, host-specific modules, hardware modules.</reason>
      </code>
    </code>
    <dependencies>
      <!-- Nix Ecosystem -->
      <nix>
        <package>nixpkgs</package>
        <version>unstable</version>
        <purpose>Core package collection</purpose>
      </nix>
      <nix>
        <package>flake-parts</package>
        <version>latest</version>
        <purpose>Modular flake framework</purpose>
      </nix>
      <nix>
        <package>clan-core</package>
        <version>main branch</version>
        <purpose>Machine coordination and secrets management</purpose>
      </nix>
      <nix>
        <package>home-manager</package>
        <version>unstable</version>
        <purpose>User configuration management (darwin + nixos integrated modes)</purpose>
      </nix>
      <nix>
        <package>nix-darwin</package>
        <version>latest</version>
        <purpose>Darwin system configuration (blackphos)</purpose>
      </nix>

      <!-- Infrastructure -->
      <infrastructure>
        <tool>terranix</tool>
        <purpose>Terraform configuration generation</purpose>
      </infrastructure>
      <infrastructure>
        <tool>disko</tool>
        <purpose>Declarative disk partitioning (nixos VMs)</purpose>
      </infrastructure>
      <infrastructure>
        <tool>srvos</tool>
        <purpose>Server hardening defaults (cinnabar, electrum)</purpose>
      </infrastructure>

      <!-- Testing -->
      <testing>
        <tool>nix-unit</tool>
        <purpose>Nix unit testing framework (14 tests baseline)</purpose>
      </testing>
    </dependencies>
  </artifacts>

  <constraints>
    <!-- Migration Constraints -->
    <constraint type="migration-accuracy">
      <rule>NEVER guess what to migrate - compare infra vs test-clan explicitly</rule>
      <rule>ALWAYS verify package lists, service configs, system settings against infra source</rule>
      <rule>Reference priority order: (1) infra blackphos config (2) infra blackphos-nixos config (3) test-clan blackphos config (4) gaetanlepage patterns (5) Story 1.8A modules</rule>
      <rationale>Cross-repository migration requires explicit comparison to avoid missing configuration</rationale>
    </constraint>

    <constraint type="zero-regression">
      <rule>Package diff comparison before/after migration (Story 1.8A pattern)</rule>
      <rule>Test harness execution after every major change (14/14 tests must pass)</rule>
      <rule>Build validation for all configurations after changes</rule>
      <rule>SSH login validation for cameron user on cinnabar</rule>
      <rationale>Configuration refactoring and migration must preserve all functionality</rationale>
    </constraint>

    <constraint type="dendritic-pattern-compliance">
      <rule>File length target: &lt;200 lines per file (modularize if justified, document exceptions)</rule>
      <rule>Use `_` prefix ONLY for non-module data files (JSON, YAML, shell scripts)</rule>
      <rule>NEVER use `_` prefix as shortcut for long flake-parts modules</rule>
      <rule>Namespace consistency: flake.modules.{darwin|nixos|homeManager}.*</rule>
      <rule>Clear separation: base modules, host-specific modules, user modules</rule>
      <rationale>Dendritic pattern standards ensure maintainability and consistency</rationale>
    </constraint>

    <constraint type="clan-core-compatibility">
      <rule>MUST preserve: clan.inventory structure (machine definitions, service instances)</rule>
      <rule>MUST preserve: clan-core.services.* (service instance registration)</rule>
      <rule>MUST preserve: clan-core.vars.* and clan-core.secrets.* access patterns</rule>
      <rule>MUST preserve: Zerotier network configuration interface (network db4344343b14b903)</rule>
      <rule>Validate: nix eval .#clan.inventory --json | jq .machines</rule>
      <rationale>Clan-core integration must remain functional throughout migrations</rationale>
    </constraint>

    <constraint type="shared-vs-platform-specific">
      <rule>Shared configuration: User identity (cameron/crs58), SSH keys, nix settings, caches, development tooling</rule>
      <rule>Platform-specific darwin: Homebrew, GUI apps, macOS system defaults, touchID</rule>
      <rule>Platform-specific nixos: Boot/disk config, systemd services, server-specific tools</rule>
      <rule>cinnabar shares user config with blackphos but excludes platform-specific settings</rule>
      <rationale>Investigation finding: "replica" means SHARED config, not identical (infra blackphos ↔ blackphos-nixos pattern)</rationale>
    </constraint>

    <constraint type="username-convention">
      <rule>cinnabar system username: cameron (preferred for new machines per CLAUDE.md)</rule>
      <rule>Home directory: /home/cameron</rule>
      <rule>Home-manager module: Still references users/crs58 (user-level identity config)</rule>
      <rule>Pattern: system username can differ from home-manager user module (cameron system user imports crs58 identity config)</rule>
      <rationale>CLAUDE.md states "Preferred username cameron on new machines (operates as alias for crs58 in home-manager)"</rationale>
    </constraint>

    <constraint type="home-manager-integration-mode">
      <rule>Use nixos-integrated mode for cinnabar (one of three modes from Story 1.8A)</rule>
      <rule>Configuration: home-manager.users.cameron imports config.flake.modules.homeManager."users/crs58"</rule>
      <rule>NOT standalone homeConfiguration (that's for `nh home switch` workflow)</rule>
      <rule>Home-manager activated with system switch, not separately</rule>
      <rationale>nixos-integrated mode appropriate for server with single primary user</rationale>
    </constraint>

    <constraint type="red-flags">
      <warning>Migrating config without explicit infra comparison (guessing)</warning>
      <warning>Skipping package diff validation ("it should be the same")</warning>
      <warning>Assuming shared config without checking blackphos-nixos pattern</warning>
      <warning>Not validating cameron user login after deployment</warning>
      <warning>Breaking zerotier network during user configuration</warning>
      <rationale>Common mistakes that indicate guessing instead of verifying</rationale>
    </constraint>
  </constraints>

  <interfaces>
    <!-- Clan Inventory API -->
    <interface>
      <name>clan.inventory</name>
      <kind>Nix attrset</kind>
      <signature>
        {
          machines = {
            cinnabar = { tags = ["nixos" "cloud" "hetzner" "controller"]; machineClass = "nixos"; };
            electrum = { tags = ["nixos" "cloud" "hetzner" "peer"]; machineClass = "nixos"; };
            blackphos = { tags = ["darwin" "workstation" "backup"]; machineClass = "darwin"; };
          };
          services = {
            emergency-access = { roles.default.tags = [ "all" ]; };
            sshd-clan = { roles.server.tags = [ "all" ]; roles.client.tags = [ "all" ]; };
            zerotier-local = {
              roles.controller.machines = [ "cinnabar" ];
              roles.peer.machines = [ "electrum" "blackphos" ];
            };
            users-root = { roles.default.tags = [ "all" ]; };
          };
        }
      </signature>
      <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/machines.nix</path>
    </interface>

    <!-- Home-Manager Module Namespace -->
    <interface>
      <name>flake.modules.homeManager</name>
      <kind>Flake-parts module namespace</kind>
      <signature>
        {
          "users/crs58" = { ... }; # Portable crs58 home module
          "users/raquel" = { ... }; # Portable raquel home module
        }
      </signature>
      <path>~/projects/nix-workspace/test-clan/modules/home/users/{crs58,raquel}/default.nix</path>
    </interface>

    <!-- Dendritic Flake Namespaces -->
    <interface>
      <name>flake.modules.{darwin|nixos|homeManager}</name>
      <kind>Flake-parts module namespaces</kind>
      <signature>
        flake.modules.darwin.* - Darwin-specific modules
        flake.modules.nixos.* - NixOS-specific modules
        flake.modules.homeManager.* - Home-manager user modules
      </signature>
      <path>modules/ directory (auto-discovered by import-tree)</path>
    </interface>

    <!-- Zerotier Network -->
    <interface>
      <name>Zerotier Network db4344343b14b903</name>
      <kind>Mesh VPN Network</kind>
      <signature>
        Controller: cinnabar (fddb:4344:343b:14b9:399:93db:4344:343b)
        Peers: electrum (fddb:4344:343b:14b9:399:93d1:7e6d:27cc), blackphos (TBD)
        Network ID: db4344343b14b903
      </signature>
      <path>Established in Story 1.9, operational baseline for Story 1.10</path>
    </interface>

    <!-- Build Outputs -->
    <interface>
      <name>darwinConfigurations.blackphos</name>
      <kind>Nix-darwin configuration</kind>
      <signature>nix build .#darwinConfigurations.blackphos.system</signature>
      <path>~/projects/nix-workspace/test-clan/</path>
    </interface>
    <interface>
      <name>nixosConfigurations.{cinnabar,electrum}</name>
      <kind>NixOS configurations</kind>
      <signature>nix build .#nixosConfigurations.{cinnabar,electrum}.config.system.build.toplevel</signature>
      <path>~/projects/nix-workspace/test-clan/</path>
    </interface>
    <interface>
      <name>homeConfigurations.{crs58,raquel}</name>
      <kind>Home-manager standalone configurations</kind>
      <signature>nix build .#homeConfigurations.{crs58,raquel}.activationPackage</signature>
      <path>~/projects/nix-workspace/test-clan/</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Test harness implemented in Story 1.6 using nix-unit framework with hybrid organization in modules/checks/ directory.
Test categories: (1) Regression tests - validate structural equivalence and zero regressions, (2) Invariant tests - validate architectural invariants preserved, (3) Feature tests - validate new capabilities work correctly, (4) Integration tests - validate end-to-end functionality.
Story 1.9 established baseline: 14/14 tests passing. Story 1.10 MUST maintain this baseline throughout migrations and refinements.
Zero-regression requirement: All functionality must be preserved during migration. Package diff comparison critical (Story 1.8A pattern validated 270 packages preserved exactly).
Test execution: `nix flake check` runs full suite. Individual test categories: TC-001 through TC-019 defined in modules/checks/*.nix.
    </standards>
    <locations>
      <location>~/projects/nix-workspace/test-clan/modules/checks/</location>
      <location>~/projects/nix-workspace/test-clan/modules/checks/flake.nix</location>
      <location>~/projects/nix-workspace/test-clan/modules/checks/validation.nix</location>
      <location>Test execution via: nix flake check or just test</location>
    </locations>
    <ideas>
      <!-- Migration Validation Tests -->
      <test id="MV-1" ac="AC2">
        <description>blackphos package diff validation</description>
        <approach>
          1. Capture pre-migration package list: nix-store -qR $(nix build .#darwinConfigurations.blackphos.system --no-link --print-out-paths) | sort
          2. Perform migrations (Task 2)
          3. Capture post-migration package list with same command
          4. Compare: diff pre-migration.txt post-migration.txt
          5. Expected: Zero delta OR only expected additions from migration (document any changes)
        </approach>
      </test>
      <test id="MV-2" ac="AC4">
        <description>cinnabar cameron user login validation</description>
        <approach>
          1. Deploy cinnabar with cameron user configuration
          2. SSH test: ssh cameron@&lt;cinnabar-ip&gt;
          3. Verify: shell is zsh, home directory exists (/home/cameron)
          4. Verify: ~/.config/ directory populated by home-manager
          5. Verify: git config accessible, starship prompt active
          6. Verify: sudo access works (admin privileges)
        </approach>
      </test>
      <test id="MV-3" ac="AC12">
        <description>Home-manager builds for both platforms</description>
        <approach>
          1. Build darwin blackphos: nix build .#darwinConfigurations.blackphos.system
          2. Build nixos cinnabar: nix build .#nixosConfigurations.cinnabar.config.system.build.toplevel
          3. Verify: both include home-manager activation
          4. Verify: user packages available on both platforms
        </approach>
      </test>

      <!-- Pattern Compliance Tests -->
      <test id="PC-1" ac="AC6">
        <description>File length compliance validation</description>
        <approach>
          1. Search: fd '\.nix$' modules/ | xargs wc -l | sort -n | tail -20
          2. Review each file &gt;200 lines
          3. Verify: modularized if justified OR exception documented with rationale
          4. Expected: All files ≤200 lines OR documented exceptions
        </approach>
      </test>
      <test id="PC-2" ac="AC7">
        <description>Underscore prefix pattern compliance</description>
        <approach>
          1. Search: fd '^_' modules/
          2. Verify: ONLY non-module data files (JSON, YAML, shell scripts)
          3. Expected: No flake-parts modules with `_` prefix
          4. If violations found: rename to proper module names
        </approach>
      </test>
      <test id="PC-3" ac="AC13">
        <description>Story 1.9 baseline regression prevention</description>
        <approach>
          1. Run: nix flake check
          2. Verify: All 14 tests from Story 1.9 continue passing
          3. Tests: TC-001 through TC-019 (regression, invariant, feature, integration)
          4. Expected: 14/14 passing throughout Story 1.10 execution
        </approach>
      </test>

      <!-- Integration Tests -->
      <test id="IT-1" ac="AC9">
        <description>All configurations build successfully</description>
        <approach>
          1. Darwin: nix build .#darwinConfigurations.blackphos.system
          2. NixOS: nix build .#nixosConfigurations.{cinnabar,electrum}.config.system.build.toplevel
          3. Home: nix build .#homeConfigurations.{crs58,raquel}.activationPackage
          4. Expected: All builds succeed without errors
        </approach>
      </test>
      <test id="IT-2" ac="AC10,AC11">
        <description>Clan-core integration validation</description>
        <approach>
          1. Inventory: nix eval .#clan.inventory --json | jq .machines
          2. Verify: cinnabar, electrum, blackphos machines defined
          3. Verify: service instances (emergency-access, sshd-clan, zerotier-local, users-root) unchanged
          4. Clan machines: nix build .#clan.machines.{cinnabar,electrum,blackphos}.config.system.build.toplevel
          5. Expected: All builds succeed, inventory structure preserved
        </approach>
      </test>
      <test id="IT-3" ac="AC11">
        <description>Zerotier network operational validation</description>
        <approach>
          1. Cinnabar controller: ssh root@&lt;cinnabar-ip&gt; "zerotier-cli info"
          2. Electrum peer: ssh root@&lt;electrum-ip&gt; "zerotier-cli info"
          3. Network connectivity: bidirectional ping cinnabar ↔ electrum
          4. Expected: Network ID db4344343b14b903 operational, latency &lt;50ms
        </approach>
      </test>

      <!-- Architectural Validation -->
      <test id="AV-1" ac="AC3,AC5">
        <description>Shared vs platform-specific configuration validation</description>
        <approach>
          1. Review: infra blackphos-nixos.nix (shared pattern reference)
          2. Identify: Shared config (user identity, SSH, nix, caches) in both blackphos + cinnabar
          3. Identify: Darwin-specific (homebrew, GUI) ONLY in blackphos
          4. Identify: NixOS-specific (boot, systemd) ONLY in cinnabar
          5. Document: Shared vs platform-specific boundaries in completion notes
        </approach>
      </test>
    </ideas>
  </tests>
</story-context>
