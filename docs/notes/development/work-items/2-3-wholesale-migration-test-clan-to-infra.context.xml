<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>3</storyId>
    <title>Execute wholesale migration from test-clan to infra</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/2-3-wholesale-migration-test-clan-to-infra.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a system administrator</asA>
    <iWant>to execute the wholesale migration from test-clan to infra using the "rip the band-aid" strategy</iWant>
    <soThat>infra repository uses the validated dendritic+clan architecture while preserving all infra-specific components</soThat>

    <context>
      <migrationPhilosophy>
        Epic 1 was discovery/validation in test-clan.
        Epic 2 is application of proven patterns to infra.
        Use modular "replace" approach, not individual file reading.
        Trust git branch/diff/history as safety net.
        Fast and pragmatic &gt; slow and careful.
      </migrationPhilosophy>

      <foundations>
        <story21>Story 2.1 created comprehensive preservation checklist (887 lines, 9.8/10 quality) with PRESERVE/REPLACE/CREATE/IGNORE/MERGE/VERIFY patterns.</story21>
        <story22>Story 2.2 created clan-01 branch and verified clean state.</story22>
        <epicScope>This is the LINCHPIN story of Epic 2 - the "rip the band-aid" wholesale migration where we copy ALL validated nix configurations from test-clan → infra while preserving infra-specific components (GitHub Actions, TypeScript monorepo, Cloudflare deployment).</epicScope>
      </foundations>
    </context>

    <tasks>
      <task id="1" title="Pre-Migration Preparation" effort="15min">
        <subtasks>
          <item>Verify clan-01 branch clean (git status)</item>
          <item>Tag pre-migration state: git tag pre-story-2.3-migration</item>
          <item>Read Story 2.1 checklist (PRESERVE/REPLACE/MERGE patterns)</item>
          <item>Document test-clan commit hash</item>
        </subtasks>
        <references>
          <file>docs/notes/development/work-items/story-2-1-preservation-checklist.md</file>
        </references>
      </task>

      <task id="2" title="rsync Dry-Run Validation" effort="20min">
        <subtasks>
          <item>Construct rsync command with 33+ exclusion patterns from Story 2.1</item>
          <item>Execute dry-run: rsync -avun --delete [exclusions]</item>
          <item>Verify preservation patterns NOT affected (.github/, packages/, docs/notes/, scripts/)</item>
          <item>Verify replace/delete patterns correct (flake.nix, lib/, modules/, machines/ copied; configurations/, overlays/, tests/ deleted)</item>
        </subtasks>
        <commands>
          <file path="docs/notes/development/work-items/2-3-wholesale-migration-test-clan-to-infra.md" lines="406-442">rsync exclusion patterns</file>
        </commands>
      </task>

      <task id="3" title="Execute rsync Copy" effort="10min">
        <subtasks>
          <item>Remove -n flag from rsync command</item>
          <item>Execute actual copy: rsync -avu --delete [exclusions]</item>
          <item>Verify exit code 0 (success)</item>
        </subtasks>
      </task>

      <task id="4" title="Verify File Structure" effort="15min">
        <subtasks>
          <item>Check new directories exist (machines/, sops/, vars/, pkgs/, terraform/, inventory.json)</item>
          <item>Check legacy deleted (configurations/, overlays/, tests/, config.nix)</item>
          <item>Count modules: find lib/ modules/ -name "*.nix" | wc -l (expect ~148)</item>
        </subtasks>
      </task>

      <task id="5" title="Manual Merge - justfile" effort="30min">
        <subtasks>
          <item>Back up current justfile</item>
          <item>Base on test-clan justfile (149 lines)</item>
          <item>Add infra target groups (docs: 13 targets, containers: 8, secrets: 13, sops: 9, CI/CD: 20+)</item>
          <item>Resolve conflicts (check, show, update targets)</item>
          <item>Test: just --summary (expect ~68+ targets)</item>
        </subtasks>
        <finalSize>~600-800 lines (149 base + 450-650 infra-specific)</finalSize>
      </task>

      <task id="6" title="Manual Merge - .gitignore" effort="10min">
        <subtasks>
          <item>Back up current .gitignore</item>
          <item>Base on infra .gitignore (37 lines, TypeScript patterns)</item>
          <item>Add terraform patterns from test-clan (6 lines)</item>
          <item>Deduplicate overlapping patterns</item>
        </subtasks>
        <finalSize>~45 lines</finalSize>
      </task>

      <task id="7" title="Manual Merge - .sops.yaml" effort="20min">
        <subtasks>
          <item>Back up current .sops.yaml</item>
          <item>Base on infra .sops.yaml (98 lines, three-tier structure)</item>
          <item>Preserve all infra age keys (8 keys)</item>
          <item>Optionally add home-manager pattern from test-clan if needed</item>
          <item>Test: sops -d secrets/shared.yaml (verify decryption works)</item>
        </subtasks>
        <finalSize>~110 lines (if home-manager added) or 98 lines (if not)</finalSize>
      </task>

      <task id="8" title="Stage and Commit Changes" effort="15min">
        <subtasks>
          <item>Stage all changes: git add -A</item>
          <item>Verify preservation patterns NOT staged (empty diff)</item>
          <item>Commit with detailed message (use template from dev notes)</item>
        </subtasks>
        <commitTemplate>
          <file path="docs/notes/development/work-items/2-3-wholesale-migration-test-clan-to-infra.md" lines="320-374">Complete commit message template</file>
        </commitTemplate>
      </task>

      <task id="9" title="Post-Migration Verification" effort="45min">
        <subtasks>
          <item>Run all 7 AC verification commands</item>
          <item>Document failures (categorize: CRITICAL vs ACCEPTABLE)</item>
          <item>If critical failures, revert: git reset --hard pre-story-2.3-migration</item>
          <item>If acceptable failures, document and proceed</item>
        </subtasks>
      </task>

      <task id="10" title="Update CLAUDE.md" effort="10min">
        <subtasks>
          <item>Update "Current Architecture" section (remove nixos-unified, add clan+dendritic)</item>
          <item>Update "Migration Status" section (mark Story 2.3 complete)</item>
          <item>Document secrets/sops coexistence (two-tier architecture note)</item>
          <item>Commit: git add CLAUDE.md &amp;&amp; git commit -m "docs(claude): update architecture to dendritic+clan"</item>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1" title="All PRESERVE components unchanged (Zero-Regression)" effort="5min" critical="true">
      <verification>
        <command>git diff main..clan-01 -- .github/</command>
        <expected>No output (empty diff)</expected>
        <criticalFailure>ANY output means preservation violated - ABORT story</criticalFailure>
      </verification>
      <verification>
        <command>git diff main..clan-01 -- packages/ package.json biome.json bun.lock</command>
        <expected>No output</expected>
      </verification>
      <verification>
        <command>git diff main..clan-01 -- docs/notes/</command>
        <expected>No output</expected>
      </verification>
      <verification>
        <command>git diff main..clan-01 -- scripts/</command>
        <expected>No output</expected>
      </verification>
      <verification>
        <command>git diff main..clan-01 -- CLAUDE.md README.md Makefile .gitleaksignore</command>
        <expected>No output (or intentional README updates only)</expected>
      </verification>
    </ac>

    <ac id="2" title="All REPLACE components copied from test-clan" effort="10min" critical="true">
      <verification>
        <command>ls -la machines/ sops/ vars/ pkgs/ terraform/ inventory.json</command>
        <expected>All directories and inventory.json exist</expected>
      </verification>
      <verification>
        <command>git diff main..clan-01 -- flake.nix | head -20</command>
        <expected>Large diff showing nixos-unified → clan+dendritic change</expected>
      </verification>
      <verification>
        <command>find lib/ modules/ -name "*.nix" | wc -l</command>
        <expected>~148 files (1 in lib/, 147 in modules/)</expected>
      </verification>
      <verification>
        <command>ls configurations/ overlays/ tests/ config.nix 2>&amp;1 | grep "No such file"</command>
        <expected>All show "No such file or directory"</expected>
      </verification>
    </ac>

    <ac id="3" title="All MERGE files manually merged" effort="verified-from-tasks-5-7" critical="true">
      <verification>
        <command>just help | grep -E '(test|darwin|os|home)'</command>
        <expected>test-clan targets present</expected>
      </verification>
      <verification>
        <command>just help | grep -E '(docs|ci)'</command>
        <expected>infra targets present</expected>
      </verification>
      <verification>
        <command>just --summary</command>
        <expected>Lists all targets (~68+), no syntax errors</expected>
      </verification>
      <verification>
        <command>grep -E 'terraform' .gitignore</command>
        <expected>terraform patterns from test-clan</expected>
      </verification>
      <verification>
        <command>grep -E '(admin|dev|ci|admin-user|raquel-user|stibnite|blackphos)' .sops.yaml</command>
        <expected>All age keys from infra</expected>
      </verification>
      <verification>
        <command>sops -d secrets/shared.yaml | head -5</command>
        <expected>Decryption succeeds</expected>
      </verification>
    </ac>

    <ac id="4" title="GitHub Actions workflows functional" effort="15min" critical="false">
      <verification>
        <command>gh workflow list</command>
        <expected>7 workflows listed (ci.yaml, deploy-docs.yaml, package-release.yaml, package-test.yaml, pr-check.yaml, pr-merge.yaml, test-composite-actions.yaml)</expected>
      </verification>
      <verification>
        <command>gh workflow run ci.yaml --ref clan-01 &amp;&amp; gh run watch</command>
        <expected>Workflow runs (may fail on nix checks - acceptable)</expected>
        <acceptableFailure>CI run fails on nix flake check (dendritic integration issues)</acceptableFailure>
        <criticalFailure>Cannot trigger workflow (workflow file corrupted)</criticalFailure>
      </verification>
    </ac>

    <ac id="5" title="TypeScript documentation builds successfully" effort="20min" critical="true">
      <verification>
        <command>git clean -fdx packages/docs/node_modules packages/docs/dist</command>
      </verification>
      <verification>
        <command>nix develop -c just install</command>
        <expected>npm install succeeds</expected>
      </verification>
      <verification>
        <command>nix develop -c just docs-build</command>
        <expected>Build completes, creates dist/ directory</expected>
        <criticalFailure>Build fails completely - infra TypeScript monorepo is broken</criticalFailure>
      </verification>
      <verification>
        <command>ls -lh packages/docs/dist/</command>
        <expected>dist/ contains index.html, _astro/, etc.</expected>
      </verification>
      <verification>
        <command>nix develop -c just docs-linkcheck</command>
        <expected>Most links valid (some may fail - acceptable)</expected>
        <acceptableFailure>Some external links fail</acceptableFailure>
      </verification>
    </ac>

    <ac id="6" title="Nix flake checks pass (New Architecture)" effort="30min" critical="false">
      <verification>
        <command>nix flake check</command>
        <expected>May show some failures (acceptable), but no syntax errors</expected>
        <acceptableFailure>Some checks fail (dendritic integration issues)</acceptableFailure>
        <criticalFailure>Syntax errors, flake won't parse</criticalFailure>
      </verification>
      <verification>
        <command>nix flake show --legacy</command>
        <expected>Shows darwinConfigurations, nixosConfigurations, homeConfigurations</expected>
      </verification>
      <verification>
        <command>nix build .#darwinConfigurations.blackphos.system --dry-run</command>
        <expected>Evaluation succeeds (no actual build)</expected>
        <acceptableFailure>Some attributes don't evaluate (document in dev notes)</acceptableFailure>
      </verification>
    </ac>

    <ac id="7" title="Secrets structure coexistence verified" effort="10min" critical="partial">
      <verification>
        <command>ls -la secrets/ sops/</command>
        <expected>Both directories exist</expected>
      </verification>
      <verification>
        <command>ls -la secrets/users/ secrets/hosts/ secrets/services/</command>
        <expected>All subdirs exist, no changes to secrets/</expected>
        <command>git diff main..clan-01 -- secrets/</command>
        <expected>No output (no changes)</expected>
      </verification>
      <verification>
        <command>ls -la sops/machines/ sops/secrets/ sops/users/</command>
        <expected>All subdirs exist (from test-clan)</expected>
      </verification>
      <verification>
        <command>sops -d secrets/shared.yaml | head -5</command>
        <expected>Decryption succeeds</expected>
      </verification>
      <verification>
        <command>sops -d sops/secrets/shared.yaml 2>&amp;1 | head -5 || echo "No sops/secrets/shared.yaml (expected)"</command>
        <expected>Either decrypts or file doesn't exist (both acceptable)</expected>
      </verification>
      <critical>secrets/ must be unchanged, sops/ must exist</critical>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/notes/development/work-items/story-2-1-preservation-checklist.md</path>
        <title>Story 2.1: Infra-Specific Components Preservation Checklist</title>
        <section>Complete Document (887 lines)</section>
        <snippet>Comprehensive preservation checklist identifying all infra-specific components that MUST NOT be overwritten during Epic 2 migration. Includes PRESERVE/REPLACE/CREATE/IGNORE/MERGE/VERIFY patterns for Story 2.3 execution.</snippet>
      </artifact>

      <artifact>
        <path>docs/notes/development/epics/epic-2-infrastructure-architecture-migration.md</path>
        <title>Epic 2: Infrastructure Architecture Migration</title>
        <section>Epic Goal and Migration Strategy</section>
        <snippet>"Rip the Band-Aid" strategy - comprehensive migration from nixos-unified to dendritic+clan architecture. Fast and pragmatic approach trusting git branch/diff/history as safety net.</snippet>
      </artifact>

      <artifact>
        <path>docs/notes/development/architecture/novel-pattern-designs.md</path>
        <title>Novel Pattern Designs</title>
        <section>Epic 1 Validated Patterns</section>
        <snippet>Four key patterns validated in Epic 1: (1) Two-tier secrets architecture (clan vars + sops-nix), (2) Five-layer overlay architecture, (3) Home-Manager Pattern A (dendritic aggregates), (4) Auto-merge base modules via import-tree.</snippet>
      </artifact>

      <artifact>
        <path>docs/notes/development/architecture/implementation-patterns.md</path>
        <title>Implementation Patterns</title>
        <section>Dendritic Pattern Implementation</section>
        <snippet>Single-line flake.nix pattern using import-tree for auto-discovery. Module size heuristic: &gt;7 lines = extract to separate module. Deep attribute merging for nested attrsets, list concatenation for overlays/imports.</snippet>
      </artifact>

      <artifact>
        <path>docs/notes/development/architecture/index.md</path>
        <title>Architecture Documentation Index</title>
        <section>Table of Contents</section>
        <snippet>18 architecture documents covering: executive summary, project structure, novel patterns, implementation patterns, data architecture, API contracts, security, performance, deployment, development environment, ADRs.</snippet>
      </artifact>

      <artifact>
        <path>docs/notes/development/epic-1-retro-2025-11-20.md</path>
        <title>Epic 1 Retrospective</title>
        <section>"Rip the Band-Aid" Migration Strategy (lines 403-421)</section>
        <snippet>Migration philosophy: Create clan-01 branch, replace nix configs wholesale from test-clan. Don't read/mutate every file individually. Fast and pragmatic &gt; slow and careful. Epic 1 was discovery/validation, Epic 2 is application of proven patterns.</snippet>
      </artifact>

      <artifact>
        <path>docs/notes/development/work-items/2-3-wholesale-migration-test-clan-to-infra.md</path>
        <title>Story 2.3 Work Item File</title>
        <section>Complete Story (549 lines)</section>
        <snippet>Complete story definition with 7 ACs, 10 tasks, 4 blockers, rsync exclusion patterns (lines 402-442), commit message template (lines 320-374), estimated effort 3-4 hours.</snippet>
      </artifact>
    </docs>

    <code>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/</path>
        <kind>source-repository</kind>
        <symbol>Complete test-clan repository</symbol>
        <reason>Source of all validated nix configurations to be copied to infra</reason>
        <structure>
          <directory name="flake.nix">Clan+dendritic entry point</directory>
          <directory name="inventory.json">Clan inventory</directory>
          <directory name="lib/">DRY configuration (1 file: caches.nix)</directory>
          <directory name="modules/">Dendritic modules (~147 .nix files in 10 subdirs)</directory>
          <directory name="machines/">Clan machine definitions (cinnabar, electrum)</directory>
          <directory name="sops/">Clan sops structure (3 subdirs)</directory>
          <directory name="vars/">Clan vars (2 subdirs)</directory>
          <directory name="pkgs/">Package definitions (by-name pattern)</directory>
          <directory name="terraform/">Infrastructure as code</directory>
          <directory name="justfile">Build automation (149 lines)</directory>
          <directory name=".gitignore">Git ignore patterns (18 lines)</directory>
          <directory name=".sops.yaml">Sops configuration (23 lines)</directory>
        </structure>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/infra/</path>
        <kind>target-repository</kind>
        <symbol>Current infra repository (working directory)</symbol>
        <reason>Target of wholesale migration, contains infra-specific components to preserve</reason>
        <preservationDirs>
          <directory name=".github/">CI/CD workflows (7 workflows, 2 composite actions)</directory>
          <directory name="packages/">TypeScript monorepo (docs website)</directory>
          <directory name="docs/notes/">Project documentation</directory>
          <directory name="scripts/">Utility scripts (CI, sops, validation)</directory>
          <directory name=".bmad/">.claude/, .cache/, .gemini/, bmad-bak/ (tool directories)</directory>
          <file name="CLAUDE.md">Project-specific AI instructions</file>
          <file name="README.md">Repository documentation</file>
          <file name="Makefile">Build automation</file>
          <file name="biome.json">JavaScript/TypeScript linter config</file>
          <file name=".gitleaksignore">Secret detection ignore patterns</file>
        </preservationDirs>
        <legacyDirs>
          <directory name="configurations/">nixos-unified (will be DELETED)</directory>
          <directory name="overlays/">nixos-unified (will be DELETED)</directory>
          <directory name="tests/">nixos-unified (will be DELETED)</directory>
          <file name="config.nix">Legacy configuration (will be DELETED)</file>
        </legacyDirs>
      </artifact>

      <artifact>
        <path>justfile</path>
        <kind>build-automation</kind>
        <symbol>Build and deployment automation</symbol>
        <lines>1496</lines>
        <reason>MERGE required - combine test-clan targets (149 lines) with infra-specific targets (docs, containers, secrets, CI/CD)</reason>
        <mergeStrategy>
          Base on test-clan justfile structure (clean sections).
          Add infra-specific target groups: docs (13), containers (8), secrets (13), sops (9), CI/CD (20+).
          Resolve conflicts: check, show, update targets.
          Final size: ~600-800 lines.
        </mergeStrategy>
      </artifact>

      <artifact>
        <path>.gitignore</path>
        <kind>git-configuration</kind>
        <symbol>Git ignore patterns</symbol>
        <lines>37</lines>
        <reason>MERGE required - combine infra TypeScript patterns with test-clan terraform patterns</reason>
        <mergeStrategy>
          Base on infra .gitignore (TypeScript/build artifact patterns).
          Add terraform patterns from test-clan (6 lines).
          Deduplicate overlapping patterns.
          Final size: ~45 lines.
        </mergeStrategy>
      </artifact>

      <artifact>
        <path>.sops.yaml</path>
        <kind>secrets-configuration</kind>
        <symbol>Sops age key and creation rules configuration</symbol>
        <lines>98</lines>
        <reason>MERGE required - preserve infra age keys, optionally add test-clan home-manager patterns</reason>
        <mergeStrategy>
          Base on infra .sops.yaml (8 age keys, 10+ creation rules).
          Preserve all existing infra keys and rules.
          Optionally add test-clan home-manager patterns if needed.
          Final size: ~110 lines (if home-manager added) or 98 lines (if not).
        </mergeStrategy>
      </artifact>
    </code>

    <dependencies>
      <tool name="rsync" version="system" purpose="File synchronization for wholesale copy">
        <usage>rsync -avu --delete [33+ exclusion patterns] ~/projects/nix-workspace/test-clan/ ~/projects/nix-workspace/infra/</usage>
      </tool>

      <tool name="git" version="system" purpose="Version control and branch management">
        <usage>Branch creation, diff verification, commit staging, tagging</usage>
      </tool>

      <tool name="just" version="system" purpose="Build automation and task execution">
        <usage>just install, just docs-build, just --summary (merged justfile verification)</usage>
      </tool>

      <tool name="sops" version="system" purpose="Secrets management and decryption">
        <usage>sops -d secrets/shared.yaml (verify secrets decryption post-merge)</usage>
      </tool>

      <tool name="nix" version="system" purpose="Configuration evaluation and building">
        <usage>nix flake check, nix flake show, nix build .#darwinConfigurations.*.system --dry-run</usage>
      </tool>

      <tool name="gh" version="system" purpose="GitHub CLI for workflow management">
        <usage>gh workflow list, gh workflow run ci.yaml --ref clan-01, gh run watch</usage>
      </tool>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="preservation" priority="CRITICAL">
      MUST preserve all components identified in Story 2.1 checklist (887 lines).
      Zero changes allowed to: .github/, packages/, docs/notes/, scripts/, CLAUDE.md, README.md, Makefile, biome.json, .gitleaksignore.
    </constraint>

    <constraint type="migration-philosophy" priority="HIGH">
      Migration philosophy: "Fast and pragmatic &gt; slow and careful"
      Use modular "replace" approach, not individual file reading.
      Trust git branch/diff/history as safety net.
      Epic 1 was discovery/validation, Epic 2 is application of proven patterns.
    </constraint>

    <constraint type="blocker-handling" priority="HIGH">
      Four identified blockers require specific handling:
      Blocker #1: README.md conflict (MEDIUM) - Add --exclude='README.md' to rsync
      Blocker #2: CLAUDE.md conflict (MEDIUM) - Already excluded, verify in dry-run
      Blocker #3: secrets/sops coexistence (CRITICAL) - Allow parallel structures, verify both exist post-migration
      Blocker #4: flake.nix input differences (HIGH) - Document lost inputs in commit message, test failures acceptable
    </constraint>

    <constraint type="zero-regression" priority="CRITICAL">
      All preserved components must function identically before and after migration.
      AC1 (preservation verification) is CRITICAL - ANY changes to preserved components = ABORT story.
      AC5 (TypeScript build) is CRITICAL - Build must succeed, infra-specific functionality must work.
    </constraint>

    <constraint type="merge-correctness" priority="HIGH">
      Three files require manual merge: justfile, .gitignore, .sops.yaml.
      Each merge must preserve both test-clan patterns AND infra-specific functionality.
      Syntax validation required for each merged file before commit.
    </constraint>

    <constraint type="architectural-alignment" priority="MEDIUM">
      Post-migration, infra must use validated Epic 1 patterns:
      - Dendritic flake-parts with import-tree auto-discovery
      - Clan-core inventory and service instances
      - Two-tier secrets architecture (clan vars + sops-nix)
      - Five-layer overlay architecture
      - Home-Manager Pattern A (dendritic aggregates with explicit braces)
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>rsync file synchronization</name>
      <kind>command-line-tool</kind>
      <signature>rsync [OPTIONS] SOURCE DESTINATION</signature>
      <path>Story 2.3 work item, lines 406-442 (exclusion patterns)</path>
      <usage>
        Dry-run: rsync -avun --delete [33+ --exclude flags] ~/projects/nix-workspace/test-clan/ ~/projects/nix-workspace/infra/ &gt; /tmp/rsync-dry-run.log 2&gt;&amp;1
        Actual: rsync -avu --delete [33+ --exclude flags] ~/projects/nix-workspace/test-clan/ ~/projects/nix-workspace/infra/
        Flags: -a (archive), -v (verbose), -u (update), -n (dry-run), --delete (remove extraneous files)
      </usage>
    </interface>

    <interface>
      <name>Git branch and diff operations</name>
      <kind>version-control</kind>
      <signature>git [subcommand] [options]</signature>
      <path>Story 2.3 work item, Tasks 1, 8, 9</path>
      <usage>
        Branch verification: git rev-parse --abbrev-ref HEAD (expect: clan-01)
        Status check: git status (expect: nothing to commit, working tree clean)
        Tagging: git tag pre-story-2.3-migration
        Preservation verification: git diff main..clan-01 -- [paths] (expect: no output for preserved components)
        Staging: git add -A
        Staging verification: git diff --cached --stat, git diff --cached -- [paths]
        Commit: git commit -m "[message]"
      </usage>
    </interface>

    <interface>
      <name>Justfile task execution</name>
      <kind>build-automation</kind>
      <signature>just [target] [args]</signature>
      <path>Story 2.3 work item, AC3, AC5</path>
      <usage>
        List targets: just --summary (expect: ~68+ targets after merge)
        Help: just help | grep -E '(test|darwin|os|home|docs|ci)'
        Install dependencies: just install (TypeScript npm packages)
        Build documentation: just docs-build (Astro static site generation)
        Link check: just docs-linkcheck (validate internal/external links)
      </usage>
    </interface>

    <interface>
      <name>Sops secrets management</name>
      <kind>secrets-tool</kind>
      <signature>sops [options] [file]</signature>
      <path>Story 2.3 work item, AC3, AC7</path>
      <usage>
        Decrypt: sops -d secrets/shared.yaml | head -5 (verify decryption works)
        Test sops/ structure: sops -d sops/secrets/shared.yaml 2&gt;&amp;1 || echo "No file (expected)"
        Age key location: ~/.config/sops/age/keys.txt
        Multi-user encryption: .sops.yaml defines creation rules per user path regex
      </usage>
    </interface>

    <interface>
      <name>Nix flake evaluation and building</name>
      <kind>nix-tool</kind>
      <signature>nix [subcommand] [options]</signature>
      <path>Story 2.3 work item, AC6</path>
      <usage>
        Flake check: nix flake check (comprehensive validation, may show some failures - acceptable)
        Show outputs: nix flake show --legacy (expect: darwinConfigurations, nixosConfigurations, homeConfigurations)
        Dry-run build: nix build .#darwinConfigurations.blackphos.system --dry-run (evaluation test, no actual build)
        Development shell: nix develop -c [command] (run command in dev environment)
      </usage>
    </interface>

    <interface>
      <name>GitHub CLI workflow management</name>
      <kind>github-tool</kind>
      <signature>gh [resource] [subcommand] [options]</signature>
      <path>Story 2.3 work item, AC4</path>
      <usage>
        List workflows: gh workflow list (expect: 7 workflows - ci.yaml, deploy-docs.yaml, package-release.yaml, package-test.yaml, pr-check.yaml, pr-merge.yaml, test-composite-actions.yaml)
        Trigger workflow: gh workflow run ci.yaml --ref clan-01
        Watch run: gh run watch (monitor workflow execution)
      </usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Zero-regression testing is the primary validation strategy for Story 2.3. All preserved components (identified in Story 2.1 checklist) must function identically pre- and post-migration. Testing occurs at multiple levels: (1) Preservation verification via git diff (no changes to preserved paths), (2) Functional validation via tool execution (GitHub Actions, TypeScript build, nix evaluation), (3) Structural validation via file existence checks, (4) Secrets validation via sops decryption. Tests are categorized as CRITICAL (block story completion if fail) vs ACCEPTABLE (document and proceed). No unit tests required - validation is integration-level via AC verification commands.
    </standards>

    <locations>
      Story 2.3 work item file contains all verification commands: docs/notes/development/work-items/2-3-wholesale-migration-test-clan-to-infra.md
      AC verification commands: lines 36-143 (7 ACs with specific bash commands and expected outputs)
      Task execution guidance: lines 147-315 (10 tasks with verification checkpoints)
      Post-migration smoke test: lines 693-722 (automated verification script concept)
    </locations>

    <ideas>
      <testIdea ac="AC1" priority="CRITICAL">
        Test: Preservation verification for .github/ directory
        Command: git diff main..clan-01 -- .github/
        Expected: No output (empty diff)
        Rationale: Zero changes to GitHub Actions workflows ensures CI/CD pipeline intact
      </testIdea>

      <testIdea ac="AC1" priority="CRITICAL">
        Test: Preservation verification for TypeScript monorepo
        Command: git diff main..clan-01 -- packages/ package.json biome.json bun.lock
        Expected: No output
        Rationale: Ensures documentation website infrastructure unchanged
      </testIdea>

      <testIdea ac="AC1" priority="CRITICAL">
        Test: Preservation verification for project documentation
        Command: git diff main..clan-01 -- docs/notes/
        Expected: No output
        Rationale: Preserves all Epic 1-2 documentation and planning artifacts
      </testIdea>

      <testIdea ac="AC2" priority="CRITICAL">
        Test: Verify new dendritic+clan directories created
        Command: ls -la machines/ sops/ vars/ pkgs/ terraform/ inventory.json
        Expected: All exist with content from test-clan
        Rationale: Confirms wholesale copy succeeded for NEW directories
      </testIdea>

      <testIdea ac="AC2" priority="CRITICAL">
        Test: Verify legacy nixos-unified directories deleted
        Command: ls configurations/ overlays/ tests/ config.nix 2&gt;&amp;1 | grep "No such file"
        Expected: All show "No such file or directory"
        Rationale: Confirms clean removal of replaced architecture
      </testIdea>

      <testIdea ac="AC2" priority="HIGH">
        Test: Count nix modules in migrated structure
        Command: find lib/ modules/ -name "*.nix" | wc -l
        Expected: ~148 files (1 in lib/, 147 in modules/)
        Rationale: Validates dendritic module structure copied completely
      </testIdea>

      <testIdea ac="AC3" priority="HIGH">
        Test: Justfile merge verification - test-clan targets
        Command: just help | grep -E '(test|darwin|os|home)'
        Expected: test-clan targets present (test, darwin-switch, os-switch, home-switch)
        Rationale: Confirms test-clan build/deployment targets merged
      </testIdea>

      <testIdea ac="AC3" priority="HIGH">
        Test: Justfile merge verification - infra targets
        Command: just help | grep -E '(docs|ci)'
        Expected: infra-specific targets present (docs-build, ci-run-watch, etc.)
        Rationale: Confirms infra-specific functionality preserved
      </testIdea>

      <testIdea ac="AC3" priority="CRITICAL">
        Test: Justfile syntax validation
        Command: just --summary
        Expected: Lists all targets (~68+), no syntax errors
        Rationale: Ensures merged justfile is syntactically correct
      </testIdea>

      <testIdea ac="AC3" priority="HIGH">
        Test: .gitignore merge verification - terraform patterns
        Command: grep -E 'terraform' .gitignore
        Expected: terraform patterns from test-clan present
        Rationale: Confirms test-clan patterns added
      </testIdea>

      <testIdea ac="AC3" priority="HIGH">
        Test: .sops.yaml merge verification - age keys
        Command: grep -E '(admin|dev|ci|admin-user|raquel-user|stibnite|blackphos)' .sops.yaml
        Expected: All infra age keys present
        Rationale: Confirms infra secrets keys preserved
      </testIdea>

      <testIdea ac="AC3" priority="CRITICAL">
        Test: Sops decryption functional
        Command: sops -d secrets/shared.yaml | head -5
        Expected: Decryption succeeds, shows first 5 lines
        Rationale: Validates .sops.yaml merge didn't break secrets decryption
      </testIdea>

      <testIdea ac="AC4" priority="MEDIUM">
        Test: GitHub Actions workflows list
        Command: gh workflow list
        Expected: 7 workflows listed (all workflow files intact)
        Rationale: Confirms GitHub Actions infrastructure preserved
      </testIdea>

      <testIdea ac="AC4" priority="MEDIUM">
        Test: GitHub Actions workflow trigger
        Command: gh workflow run ci.yaml --ref clan-01 &amp;&amp; gh run watch
        Expected: Workflow runs (may fail on nix checks - acceptable)
        Rationale: Functional validation that workflows can be triggered
        Note: Acceptable failure - CI run fails on nix flake check due to dendritic integration issues
      </testIdea>

      <testIdea ac="AC5" priority="CRITICAL">
        Test: TypeScript documentation build
        Command: nix develop -c just install &amp;&amp; nix develop -c just docs-build
        Expected: Build completes successfully, dist/ directory created
        Rationale: Critical validation that infra TypeScript monorepo still works
      </testIdea>

      <testIdea ac="AC5" priority="HIGH">
        Test: Documentation build output verification
        Command: ls -lh packages/docs/dist/
        Expected: dist/ contains index.html, _astro/, etc.
        Rationale: Confirms build output structure correct
      </testIdea>

      <testIdea ac="AC6" priority="MEDIUM">
        Test: Nix flake syntax validation
        Command: nix flake check
        Expected: May show some failures (acceptable), but no syntax errors
        Rationale: Validates flake.nix and modules/ structure syntactically correct
        Note: Acceptable failure - some checks fail due to dendritic integration issues
      </testIdea>

      <testIdea ac="AC6" priority="HIGH">
        Test: Nix flake outputs verification
        Command: nix flake show --legacy
        Expected: Shows darwinConfigurations, nixosConfigurations, homeConfigurations
        Rationale: Confirms dendritic pattern correctly exposes configurations
      </testIdea>

      <testIdea ac="AC6" priority="MEDIUM">
        Test: Configuration evaluation (dry-run build)
        Command: nix build .#darwinConfigurations.blackphos.system --dry-run
        Expected: Evaluation succeeds (no actual build)
        Rationale: Tests that configurations can be evaluated without errors
        Note: Acceptable failure - some attributes don't evaluate, document in dev notes
      </testIdea>

      <testIdea ac="AC7" priority="HIGH">
        Test: secrets/sops directory coexistence
        Command: ls -la secrets/ sops/
        Expected: Both directories exist
        Rationale: Confirms two-tier secrets architecture coexistence (infra legacy + clan target)
      </testIdea>

      <testIdea ac="AC7" priority="CRITICAL">
        Test: Infra secrets/ directory unchanged
        Command: git diff main..clan-01 -- secrets/
        Expected: No output (no changes)
        Rationale: Critical - infra existing secrets must be preserved
      </testIdea>

      <testIdea ac="AC7" priority="HIGH">
        Test: Clan sops/ directory structure created
        Command: ls -la sops/machines/ sops/secrets/ sops/users/
        Expected: All subdirs exist (from test-clan)
        Rationale: Confirms clan secrets structure copied
      </testIdea>

      <testIdea ac="AC7" priority="HIGH">
        Test: Infra secrets decryption works
        Command: sops -d secrets/shared.yaml | head -5
        Expected: Decryption succeeds
        Rationale: Validates infra existing secrets still functional
      </testIdea>
    </ideas>
  </tests>
</story-context>
