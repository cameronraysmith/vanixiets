<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.12</storyId>
    <title>Deploy blackphos and Integrate into Zerotier Network</title>
    <status>backlog</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-12-deploy-blackphos-zerotier-integration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to deploy the fully-migrated blackphos configuration to physical hardware and integrate into the test-clan zerotier network</iWant>
    <soThat>I validate heterogeneous networking (nixos ↔ nix-darwin), prove multi-platform coordination works, and complete Epic 1 architectural validation with real hardware evidence</soThat>
    <tasks>
      <taskGroup id="1" name="Pre-Deployment Preparation and Validation" estimatedHours="0.5">
        <task id="1.1">Verify Configuration Builds: nix build .#darwinConfigurations.blackphos.system</task>
        <task id="1.2">Verify Home-Manager Builds (crs58 + raquel): 122 + 105 derivations expected</task>
        <task id="1.3">Run Test Suite: nix flake check</task>
        <task id="1.4">Review Configuration for Darwin-Specific Issues</task>
        <task id="1.5">Document Pre-Deployment State</task>
      </taskGroup>

      <taskGroup id="2" name="Physical Deployment to Blackphos Hardware" estimatedHours="1-1.5">
        <task id="2.1">Execute Deployment: darwin-rebuild switch --flake .#blackphos</task>
        <task id="2.2">Post-Deployment System Validation (hostname, platform, services)</task>
        <task id="2.3">Service Validation (launchd, homebrew casks)</task>
        <task id="2.4">Zero-Regression Validation (crs58): LazyVim, git signing, Claude Code, tmux, atuin</task>
        <task id="2.5">Zero-Regression Validation (raquel): LazyVim, git, shell, tmux</task>
        <task id="2.6">Secrets Validation (/run/secrets/ permissions, multi-user)</task>
        <task id="2.7">Performance Validation (responsiveness, launch times, memory)</task>
        <task id="2.8">Document Deployment Results</task>
      </taskGroup>

      <taskGroup id="3" name="Zerotier Darwin Integration" estimatedHours="2-3">
        <task id="3.1">Research Zerotier Darwin Options (A: Homebrew, B: Custom Launchd, C: Manual)</task>
        <task id="3.2">Implement Chosen Approach (Recommended: Option A for Story 1.12)</task>
        <task id="3.3">Verify Zerotier Service Running</task>
        <task id="3.4">Join Zerotier Network (db4344343b14b903)</task>
        <task id="3.5">Verify Network Membership and Peer List</task>
        <task id="3.6">Authorize Peer on Controller (if needed)</task>
        <task id="3.7">Get Blackphos Zerotier IP (feth0 interface on darwin)</task>
        <task id="3.8">Document Zerotier Integration Approach</task>
      </taskGroup>

      <taskGroup id="4" name="Network and Integration Validation" estimatedHours="1.5-2">
        <task id="4.1">Get Zerotier IPs (cinnabar, electrum, blackphos)</task>
        <task id="4.2">Test Bidirectional Connectivity (blackphos → nixos VMs)</task>
        <task id="4.3">Test Bidirectional Connectivity (nixos VMs → blackphos)</task>
        <task id="4.4">Measure Network Latency (20-packet averages)</task>
        <task id="4.5">Test Network Stability (5-minute ping test)</task>
        <task id="4.6">SSH from blackphos to cinnabar/electrum (cameron, testuser)</task>
        <task id="4.7">SSH from nixos VMs to blackphos (crs58, raquel)</task>
        <task id="4.8">Verify Clan-Managed SSH Keys</task>
        <task id="4.9">Verify /run/secrets/ Directory and Permissions (darwin)</task>
        <task id="4.10">Check Secrets Accessibility to User Processes</task>
        <task id="4.11">Verify sops.templates Functional on Darwin</task>
        <task id="4.12">Test Secret Rotation (age key management)</task>
        <task id="4.13">Verify Multi-User Encryption (crs58 + raquel isolation)</task>
        <task id="4.14">Create Integration Findings Documentation (5 sections)</task>
      </taskGroup>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="A" name="Blackphos Deployment to Physical Hardware">
      <requirement>Configuration deployed to actual blackphos laptop hardware</requirement>
      <requirement>darwin-rebuild switch --flake .#blackphos succeeds without errors</requirement>
      <requirement>All crs58 daily workflows functional (LazyVim, git signing, Claude Code, tmux, atuin, MCP servers)</requirement>
      <requirement>All raquel daily workflows functional (LazyVim, shell, development tools, tmux)</requirement>
      <requirement>Zero regressions from pre-deployment state (122 crs58 packages, 105 raquel packages)</requirement>
      <requirement>Performance acceptable (no slowdowns, no freezes)</requirement>
      <requirement>sops-nix secrets decrypted and accessible at /run/secrets/</requirement>
      <validation>All homebrew casks installed and functional (8 casks + 1 masApp)</validation>
      <validation>TouchID sudo authentication works</validation>
      <validation>SSH keys loaded correctly for both users</validation>
    </criterion>

    <criterion id="B" name="Zerotier Peer Configuration (INVESTIGATION REQUIRED)">
      <requirement>Zerotier service running on blackphos (darwin platform)</requirement>
      <requirement>Blackphos joined network db4344343b14b903 as peer</requirement>
      <requirement>Blackphos visible in cinnabar controller peer list</requirement>
      <investigation>Research and implement ONE approach: Option A (Homebrew cask - RECOMMENDED), Option B (Custom launchd service), or Option C (Manual installation - NOT RECOMMENDED)</investigation>
      <documentation>Approach chosen with rationale</documentation>
      <documentation>Configuration code added to blackphos config</documentation>
      <documentation>Manual steps required (if any)</documentation>
      <documentation>Platform-specific challenges encountered and resolutions</documentation>
      <documentation>Potential improvements for Epic 3-6 darwin migrations (blackphos prod, rosegold, argentum)</documentation>
      <platformNote>nix-darwin has NO native zerotier module (verified repository search)</platformNote>
      <platformNote>Darwin uses feth0 interface (not zt0 like nixos)</platformNote>
    </criterion>

    <criterion id="C" name="Heterogeneous Network Validation">
      <requirement>3-machine zerotier network operational (cinnabar + electrum + blackphos)</requirement>
      <requirement>Blackphos can ping both nixos VMs via zerotier IPs (5 packets, 0% loss)</requirement>
      <requirement>Both nixos VMs can ping blackphos via zerotier IP (5 packets, 0% loss)</requirement>
      <requirement>Network latency &lt;50ms typical (acceptable for coordination)</requirement>
      <requirement>0% packet loss over 5-minute stability test</requirement>
      <validation>Interface names documented (zt0 on nixos, feth0 on darwin)</validation>
      <validation>Heterogeneous networking proven (nixos ↔ nix-darwin connectivity works)</validation>
    </criterion>

    <criterion id="D" name="Cross-Platform SSH Validation">
      <requirement>SSH from blackphos to cinnabar/electrum works (cameron@cinnabar, testuser@electrum)</requirement>
      <requirement>SSH from cinnabar/electrum to blackphos works (crs58@blackphos, raquel@blackphos)</requirement>
      <requirement>Certificate-based authentication functional across platforms</requirement>
      <requirement>Clan-managed SSH keys operational (sops-nix on darwin)</requirement>
      <requirement>No password prompts (key-based authentication only)</requirement>
      <validation>Both crs58 and raquel SSH access validated from remote hosts</validation>
      <validation>6 user combinations tested successfully</validation>
    </criterion>

    <criterion id="E" name="Clan Vars/Secrets Validation on Darwin">
      <requirement>/run/secrets/ populated with proper permissions (darwin-compatible)</requirement>
      <requirement>SSH host keys functional (sshd starts successfully)</requirement>
      <requirement>User secrets accessible to crs58 and raquel</requirement>
      <requirement>No permission issues on darwin platform</requirement>
      <requirement>sops.templates work correctly (allowed_signers, gh hosts.yml)</requirement>
      <requirement>Multi-user encryption verified (crs58 + raquel separate namespaces)</requirement>
      <requirement>Age key management functional (~/.config/sops/age/keys.txt)</requirement>
      <validation>Secret permissions: 0400 (read-only by owner)</validation>
      <validation>Secret ownership: user-specific (UID 550 for crs58, UID 551 for raquel)</validation>
      <validation>Secrets rotation possible (sops edit works)</validation>
    </criterion>

    <criterion id="F" name="Integration Findings Documentation">
      <section name="Physical Deployment Process">
        <content>Pre-deployment checklist, deployment commands, timing, post-deployment validation, manual steps (if any)</content>
      </section>
      <section name="Zerotier Darwin Integration">
        <content>Approach chosen with rationale, configuration code, manual steps, verification commands, platform-specific challenges, interface naming (feth0 vs zt0), recommendations for Epic 3-6, custom module development assessment</content>
      </section>
      <section name="Platform-Specific Challenges">
        <content>Secrets management (location, permissions, sops-nix compatibility), Homebrew integration (conflicts, activation, cleanup), System activation (darwin-rebuild vs nixos-rebuild differences), Performance (build times, activation duration, memory usage)</content>
      </section>
      <section name="Heterogeneous Networking Results">
        <content>Network topology with IPs, connectivity matrix (all 6 paths tested), SSH connectivity matrix (5 user combinations), network stability results (latency, packet loss), platform differences observed, reliability assessment (production-ready?)</content>
      </section>
      <section name="Epic 2-6 Migration Value">
        <content>Patterns validated (deployment, validation, networking), time savings estimate (across Epic 3-6 darwin migrations), reusable artifacts (code, checklists, documentation), gotchas documented with workarounds, recommended improvements for future migrations</content>
      </section>
      <requirement>All 5 documentation sections complete</requirement>
      <requirement>Documentation quality sufficient for Epic 3-6 teams to replicate</requirement>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/notes/development/epics/epic-1-architectural-validation-migration-pattern-rehearsal-phase-0.md</path>
        <title>Epic 1 - Architectural Validation + Migration Pattern Rehearsal (Phase 0)</title>
        <section>Story 1.12 Section (lines 2146-2220)</section>
        <snippet>Story 1.12 provides first physical hardware deployment validation. Acceptance criteria cover deployment (AC A), zerotier darwin integration investigation (AC B), heterogeneous networking (AC C), cross-platform SSH (AC D), clan vars/secrets on darwin (AC E), and integration findings documentation (AC F). Estimated effort: 4-6 hours. Risk: Medium (physical hardware, zerotier darwin uncertainty). Strategic value: Proves nixos ↔ nix-darwin coordination works with complete configurations.</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/test-clan-validated-architecture.md</path>
        <title>test-clan Validated Architecture</title>
        <section>Section 11: Module System Architecture - Flake-Parts + Home-Manager Nesting</section>
        <snippet>Critical architecture explanation: Two separate, nested module systems (flake-parts outer, home-manager inner). Dendritic modules are flake-parts modules that RETURN home-manager modules. Access patterns: flake.inputs.* for flake inputs, flake.config.* for flake-parts modules (clan-core), config.* for home-manager modules (sops-nix), pkgs.* for nixpkgs packages. The bridge: extraSpecialArgs.flake = config.flake.</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/test-clan-validated-architecture.md</path>
        <title>test-clan Validated Architecture</title>
        <section>Section 12: Two-Tier Secrets Architecture - System vs User Secrets</section>
        <snippet>Story 1.10C validated two-tier secrets: Tier 1 (system-level, clan vars, NixOS/nix-darwin) for machine configuration, Tier 2 (user-level, sops-nix, home-manager) for user secrets (SSH keys, API tokens, git signing). Clan vars module incompatible with home-manager context. sops-nix used for user secrets with age key reuse pattern. Multi-user encryption achieved via separate age keys per user.</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/work-items/1-8-migrate-blackphos-from-infra-to-test-clan.md</path>
        <title>Story 1.8: Migrate blackphos from infra to test-clan</title>
        <section>Blackphos Configuration Migration</section>
        <snippet>Created blackphos darwin configuration in test-clan. Users: crs58 (admin UID 550), raquel (primary UID 551). Homebrew: 8 casks (codelayer-nightly, dbeaver-community, docker, gpg-suite, inkscape, keycastr, meld, postgres) + 1 masApp. TouchID sudo enabled. Home-manager aggregates: development + ai + shell for crs58, development + shell for raquel.</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/work-items/1-8a-extract-portable-home-manager-modules.md</path>
        <title>Story 1.8A: Extract portable home-manager modules</title>
        <section>Portable User Modules (crs58, raquel)</section>
        <snippet>Extracted crs58 and raquel into portable modules (modules/home/users/). Dendritic namespace exports: flake.modules.homeManager."users/crs58", flake.modules.homeManager."users/raquel". Pattern: Platform-agnostic user configuration with pkgs.stdenv.isDarwin conditionals where needed. Multi-machine reuse validated (cinnabar, electrum use cameron, blackphos uses crs58 + raquel).</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/work-items/1-10ba-refactor-pattern-a.md</path>
        <title>Story 1.10BA: Refactor Pattern B → Pattern A</title>
        <section>Pattern A Migration (17 modules)</section>
        <snippet>Converted 16 modules to Pattern A (explicit flake.modules = {...} structure). Blackphos refactored: Imports from dendritic namespace (46 lines removed, zero regression). Pattern A enables import-tree auto-discovery and explicit namespace exports. All functionality preserved (270 packages baseline). Build validation: darwinConfigurations.blackphos.system ✅ builds successfully.</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/work-items/1-10c-establish-sops-nix-secrets-home-manager.md</path>
        <title>Story 1.10C: Establish sops-nix secrets for home-manager</title>
        <section>sops-nix Integration (Multi-User Encryption)</section>
        <snippet>sops-nix home-manager integration validated. Secret categories: SSH signing keys (ed25519 format), MCP API keys (anthropic, openai), git allowed_signers templates. Multi-user encryption: crs58 age key (~/.config/sops/age/keys.txt), raquel age key (separate namespace). Direct path access pattern: config.sops.secrets."crs58/git-signing-key".path. sops.templates pattern for multi-line secrets (allowed_signers). Runtime cat and activation scripts for complex templating.</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/work-items/1-9-rename-vms-cinnabar-electrum-establish-zerotier.md</path>
        <title>Story 1.9: Rename VMs, establish zerotier network</title>
        <section>Zerotier Network Established (cinnabar + electrum)</section>
        <snippet>Zerotier network db4344343b14b903 operational. Cinnabar: zerotier controller (nixos VPS), zt0 interface. Electrum: zerotier peer (nixos VPS), zt0 interface. Bidirectional connectivity validated (1-12ms latency). Story 1.12 adds blackphos as third peer (first darwin peer) for heterogeneous networking validation (nixos ↔ nix-darwin).</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/work-items/1-10d-validate-custom-package-overlays.md</path>
        <title>Story 1.10D: Validate custom package overlays with pkgs-by-name pattern</title>
        <section>Custom Package Pattern Baseline</section>
        <snippet>Empirical validation baseline for Story 1.12 (9.5/10 clarity). pkgs-by-name pattern validated for custom packages (claude-code, ccstatusline). Overlay architecture: 5 layers (package overrides, module overlays, custom packages, upstream overlays, unstable channel). Pattern A modules import packages via flake.overlays.default. Build reproducibility verified.</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/work-items/1-10db-execute-overlay-architecture-migration.md</path>
        <title>Story 1.10DB: Execute overlay architecture migration</title>
        <section>5-Layer Overlay Architecture</section>
        <snippet>Overlay architecture migration complete (5 layers functional). Layer 1: Package-level overrides (git, tmux, neovim). Layer 2: Module-level overlays (nix-ai-tools, catppuccin-nix). Layer 3: Custom packages (claude-code, ccstatusline, glm-wrapper via pkgs-by-name). Layer 4: Upstream overlays (nix-ai-tools.overlays.default). Layer 5: Unstable channel (nixpkgs-unstable). Blackphos uses flake.overlays.default (all 5 layers). Zero regressions validated.</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/work-items/1-10e-enable-remaining-features.md</path>
        <title>Story 1.10E: Enable remaining features</title>
        <section>Feature Enablement (ccstatusline, claude-code, catppuccin)</section>
        <snippet>Features enabled post-overlay migration: ccstatusline (Claude Code status line), claude-code (nix-ai-tools), catppuccin themes (tmux, LazyVim). Pattern: Custom packages via overlays, feature modules via dendritic aggregates. All 7 feature enablement patterns validated (pkgs-by-name, overlays, home-manager modules, activation scripts, templates, runtime scripts, environment setup). Blackphos configuration now complete (173 lines, production-ready).</snippet>
      </doc>

      <doc>
        <path>~/projects/nix-workspace/test-clan/README.md</path>
        <title>test-clan Repository README</title>
        <section>Validation Repository Overview</section>
        <snippet>test-clan proves dendritic flake-parts + clan-core integration with real infrastructure (Hetzner VMs via terranix). Machines: cinnabar (nixos VPS, zerotier controller), electrum (nixos VPS, zerotier peer), blackphos (darwin laptop, to be deployed in Story 1.12). Story 1.12 validates heterogeneous networking (nixos ↔ nix-darwin) and completes Epic 1 architectural validation.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/machines/darwin/blackphos/default.nix</path>
        <kind>darwin-configuration</kind>
        <symbol>darwinConfigurations.blackphos</symbol>
        <lines>173</lines>
        <reason>Current blackphos configuration (production-ready after Stories 1.8 → 1.8A → 1.10BA → 1.10C → 1.10DB → 1.10E). Users: crs58 (UID 550, admin), raquel (UID 551, primary). Homebrew: 8 casks + 1 masApp. TouchID sudo enabled. Home-manager: Pattern A aggregates (development, ai, shell for crs58; development, shell for raquel). Overlays: flake.overlays.default (all 5 layers). Build status: ✅ BUILDS SUCCESSFULLY. Deployment target: Story 1.12 AC A (physical hardware).</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/services/zerotier.nix</path>
        <kind>clan-inventory-service</kind>
        <symbol>zerotier service instance</symbol>
        <lines>~30</lines>
        <reason>Clan inventory service instance for zerotier networking. Controller role: cinnabar. Peer role: all machines (roles.peer.tags."all"). Network ID: db4344343b14b903. Pattern: NixOS-specific (uses systemd services). Story 1.12 AC B investigates darwin zerotier integration (no nix-darwin module exists). Note: Blackphos zerotier config will differ from this nixos pattern.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/clan/inventory/machines.nix</path>
        <kind>clan-inventory</kind>
        <symbol>machines inventory</symbol>
        <lines>~50</lines>
        <reason>Clan inventory machines definition. Current machines: cinnabar (nixos VPS), electrum (nixos VPS). Story 1.12 AC F requires documenting blackphos metadata (may add entry here or document external management). Machines define tags, roles, platform-specific options.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/users/crs58/default.nix</path>
        <kind>home-manager-module</kind>
        <symbol>flake.modules.homeManager."users/crs58"</symbol>
        <lines>~120</lines>
        <reason>Portable crs58 user module (Story 1.8A extraction). Dendritic namespace export. Platform-agnostic configuration with darwin conditionals. Features: git config, SSH keys, LazyVim, development tools, AI tooling (Claude Code, MCP servers). sops-nix secrets integration (SSH signing, API keys). Multi-machine reuse: blackphos (darwin), cinnabar (nixos as cameron alias). Pattern A structure validated in Story 1.10BA.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/users/raquel/default.nix</path>
        <kind>home-manager-module</kind>
        <symbol>flake.modules.homeManager."users/raquel"</symbol>
        <lines>~80</lines>
        <reason>Portable raquel user module (Story 1.8A extraction). Dendritic namespace export. Features: git config, LazyVim, shell environment (zsh, starship), tmux with catppuccin theme, development tools. sops-nix secrets integration (separate age key from crs58). Deployment target: Story 1.12 AC A zero-regression validation (raquel daily workflows must remain functional).</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home-manager/base-sops.nix</path>
        <kind>home-manager-module</kind>
        <symbol>base sops-nix configuration</symbol>
        <lines>~40</lines>
        <reason>Base sops-nix configuration for home-manager (Story 1.10C pattern). Multi-user encryption setup: age keys (~/.config/sops/age/keys.txt), secret paths (secrets/crs58/default.yaml, secrets/raquel/default.yaml). Direct path access pattern: config.sops.secrets."user/key".path. sops.templates for multi-line secrets (allowed_signers, gh hosts.yml). Deployment target: Story 1.12 AC E darwin secrets validation (/run/secrets/ permissions, multi-user isolation).</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/flake.nix</path>
        <kind>flake-configuration</kind>
        <symbol>flake inputs and outputs</symbol>
        <lines>~100</lines>
        <reason>Root flake configuration. Inputs: nixpkgs, home-manager, nix-darwin, clan-core, nix-ai-tools, catppuccin-nix, import-tree, sops-nix. Outputs: import-tree integration for dendritic modules. Build targets: darwinConfigurations.blackphos, homeConfigurations (crs58, raquel), nixosConfigurations (cinnabar, electrum). Deployment command: darwin-rebuild switch --flake ~/projects/nix-workspace/test-clan#blackphos (Story 1.12 AC A).</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/nix-darwin/modules/services/</path>
        <kind>nix-darwin-services-directory</kind>
        <symbol>nix-darwin service modules</symbol>
        <lines>N/A</lines>
        <reason>nix-darwin service modules directory. Verified: NO zerotier module exists (repository search negative). Story 1.12 AC B requires zerotier darwin integration investigation. Options: homebrew cask (zerotier-one), custom launchd service, manual installation. Reference for custom launchd patterns if Option B chosen.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/clan-core/pkgs/clan-cli/clan_cli/machines/install.py</path>
        <kind>python-module</kind>
        <symbol>clan machine installation</symbol>
        <lines>~300</lines>
        <reason>Clan machine installation CLI logic. darwin deployment command reference: darwin-rebuild switch --flake. Platform detection: nix-darwin vs nixos. Story 1.12 AC A deployment pattern may reference clan CLI or use direct darwin-rebuild. Clan CLI supports darwin platform (macOS validation confirmed in clan-core codebase).</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/clan-core/nixosModules/clanCore/vars.nix</path>
        <kind>nix-module</kind>
        <symbol>clan vars module</symbol>
        <lines>~200</lines>
        <reason>Clan vars module (system-level secrets, NixOS/nix-darwin). Story 1.12 AC E validates clan vars on darwin (if used for machine secrets). Story 1.10C two-tier architecture uses sops-nix for user secrets (home-manager), clan vars for system secrets. macOS support confirmed (clan vars compatible with nix-darwin activation).</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/checks/validation.nix</path>
        <kind>test-harness</kind>
        <symbol>test suite</symbol>
        <lines>~400</lines>
        <reason>Test suite for test-clan validation. Test coverage: TC-018 (home-module-exports verification), TC-019 (home-configurations-exposed verification). Story 1.12 AC A pre-deployment validation: nix flake check. Expected result: all tests pass before physical deployment.</reason>
      </artifact>
    </code>

    <dependencies>
      <nix>
        <package name="nixpkgs" version="unstable" source="github:NixOS/nixpkgs/nixos-unstable" />
        <package name="home-manager" version="master" source="github:nix-community/home-manager" />
        <package name="nix-darwin" version="master" source="github:LnL7/nix-darwin" />
        <package name="clan-core" version="main" source="git+https://git.clan.lol/clan/clan-core" />
        <package name="sops-nix" version="master" source="github:Mic92/sops-nix" />
        <package name="nix-ai-tools" version="main" source="github:cameronraysmith/nix-ai-tools" />
        <package name="catppuccin-nix" version="main" source="github:catppuccin/nix" />
        <package name="import-tree" version="main" source="github:numtide/import-tree" />
      </nix>

      <homebrew>
        <cask name="codelayer-nightly" reason="Blackphos existing cask, must remain functional post-deployment" />
        <cask name="dbeaver-community" reason="Blackphos existing cask, must remain functional post-deployment" />
        <cask name="docker" reason="Blackphos existing cask, must remain functional post-deployment" />
        <cask name="gpg-suite" reason="Blackphos existing cask, must remain functional post-deployment" />
        <cask name="inkscape" reason="Blackphos existing cask, must remain functional post-deployment" />
        <cask name="keycastr" reason="Blackphos existing cask, must remain functional post-deployment" />
        <cask name="meld" reason="Blackphos existing cask, must remain functional post-deployment" />
        <cask name="postgres" reason="Blackphos existing cask, must remain functional post-deployment" />
        <cask name="zerotier-one" reason="Story 1.12 AC B Option A (RECOMMENDED) - zerotier darwin integration via homebrew" />
      </homebrew>

      <system>
        <package name="zerotier-one" platform="nixpkgs" reason="Story 1.12 AC B Option B (custom launchd) - zerotier binary from nixpkgs" />
      </system>
    </dependencies>
  </artifacts>

  <constraints>
    <architectural>
      <constraint>Use Pattern A for all home-manager modules (explicit flake.modules = {...} structure)</constraint>
      <constraint>Two-tier secrets architecture: clan vars for system secrets, sops-nix for user secrets</constraint>
      <constraint>Multi-user encryption: separate age keys per user (~/.config/sops/age/keys.txt)</constraint>
      <constraint>Dendritic namespace exports required for portable modules</constraint>
      <constraint>Platform conditionals via pkgs.stdenv.isDarwin where darwin-specific behavior needed</constraint>
      <constraint>Overlay architecture: Use flake.overlays.default (5 layers: overrides, module overlays, custom packages, upstream overlays, unstable)</constraint>
    </architectural>

    <platform>
      <constraint platform="darwin">darwin-rebuild switch --flake deployment (not nixos-rebuild)</constraint>
      <constraint platform="darwin">Launchd service management (not systemd)</constraint>
      <constraint platform="darwin">Homebrew integration required for GUI applications (8 existing casks + zerotier-one for AC B)</constraint>
      <constraint platform="darwin">Darwin secrets location: /run/secrets/ (not /var/run/secrets/)</constraint>
      <constraint platform="darwin">Darwin UID assignments: crs58 (550), raquel (551)</constraint>
      <constraint platform="darwin">Darwin zerotier interface: feth0 (not zt0 like nixos)</constraint>
      <constraint platform="darwin">TouchID sudo authentication preserved post-deployment</constraint>
    </platform>

    <zerotier>
      <constraint>Network ID: db4344343b14b903 (cinnabar controller)</constraint>
      <constraint>Blackphos joins as peer (not controller)</constraint>
      <constraint>Zerotier darwin integration: NO nix-darwin module exists (verified)</constraint>
      <constraint>Option A (RECOMMENDED): Homebrew cask zerotier-one with manual join</constraint>
      <constraint>Option B (alternative): Custom launchd service with pkgs.zerotierone binary</constraint>
      <constraint>Option C (NOT RECOMMENDED): Manual installation defeats nix benefits</constraint>
      <constraint>Zerotier service must start on boot (launchd RunAtLoad or homebrew service)</constraint>
    </zerotier>

    <deployment>
      <constraint>Zero-regression requirement: ALL pre-deployment functionality must be preserved</constraint>
      <constraint>crs58 workflows: LazyVim, git signing, Claude Code, tmux, atuin, MCP servers (6 checks)</constraint>
      <constraint>raquel workflows: LazyVim, git config, shell (zsh, starship), tmux, development tools (5 checks)</constraint>
      <constraint>Package count preservation: 122 crs58 packages, 105 raquel packages</constraint>
      <constraint>Performance: No slowdowns, no freezes, acceptable application launch times</constraint>
      <constraint>Secrets validation: /run/secrets/ permissions (0400), ownership (user-specific UIDs)</constraint>
      <constraint>Build validation BEFORE deployment: nix build, nix flake check, test suite</constraint>
    </deployment>

    <testing>
      <constraint>Pre-deployment: nix build .#darwinConfigurations.blackphos.system</constraint>
      <constraint>Pre-deployment: nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage</constraint>
      <constraint>Pre-deployment: nix build .#homeConfigurations.aarch64-darwin.raquel.activationPackage</constraint>
      <constraint>Pre-deployment: nix flake check (all tests pass)</constraint>
      <constraint>Post-deployment: Zero-regression validation checklist (14 items)</constraint>
      <constraint>Heterogeneous network: Bidirectional connectivity tests (blackphos ↔ cinnabar, blackphos ↔ electrum)</constraint>
      <constraint>SSH validation: 6 user combinations (crs58@blackphos, raquel@blackphos from cinnabar/electrum, cameron@cinnabar, testuser@electrum from blackphos)</constraint>
      <constraint>Network stability: 5-minute ping test, 0% packet loss, latency &lt;50ms</constraint>
    </testing>
  </constraints>

  <interfaces>
    <darwinRebuild>
      <name>darwin-rebuild switch</name>
      <kind>CLI command</kind>
      <signature>darwin-rebuild switch --flake &lt;flake-path&gt;#&lt;configuration&gt;</signature>
      <example>darwin-rebuild switch --flake ~/projects/nix-workspace/test-clan#blackphos</example>
      <notes>Story 1.12 AC A deployment command. Activation script runs launchd services, homebrew activation, user home-manager. Expected output: activation success, services started, no errors.</notes>
    </darwinRebuild>

    <zerotierCLI>
      <name>zerotier-cli</name>
      <kind>CLI command</kind>
      <operations>
        <join>sudo zerotier-cli join &lt;network-id&gt;</join>
        <listnetworks>sudo zerotier-cli listnetworks</listnetworks>
        <peers>sudo zerotier-cli peers</peers>
      </operations>
      <example>sudo zerotier-cli join db4344343b14b903</example>
      <notes>Story 1.12 AC B manual join command (Option A homebrew cask). Expected output: 200 join OK. Verification: sudo zerotier-cli listnetworks (should show db4344343b14b903).</notes>
    </zerotierCLI>

    <sops>
      <name>sops</name>
      <kind>CLI command</kind>
      <operations>
        <edit>sops &lt;secret-file&gt;</edit>
        <decrypt>sops -d &lt;secret-file&gt;</decrypt>
      </operations>
      <example>sops secrets/crs58/default.yaml</example>
      <notes>Story 1.12 AC E secrets validation. Age key required (~/.config/sops/age/keys.txt). Multi-user isolation: crs58 can decrypt crs58 secrets, raquel can decrypt raquel secrets. Expected behavior: File decrypts successfully in editor, shows secrets in YAML format.</notes>
    </sops>

    <homeManagerConfig>
      <name>config.sops.secrets</name>
      <kind>Nix attribute set</kind>
      <signature>config.sops.secrets."&lt;path&gt;".path</signature>
      <example>config.sops.secrets."crs58/git-signing-key".path</example>
      <notes>Direct path access pattern (Story 1.10C). Decrypted secret location: /run/secrets/crs58/git-signing-key (darwin). Permissions: 0400 (read-only owner). Ownership: crs58 UID (550). Multi-user: raquel secrets at /run/secrets/raquel/ (UID 551).</notes>
    </homeManagerConfig>

    <sopsTem plates>
      <name>config.sops.templates</name>
      <kind>Nix attribute set</kind>
      <signature>config.sops.templates."&lt;name&gt;".content</signature>
      <example>config.sops.templates."git-allowed-signers".content (multi-line template with SSH public keys)</example>
      <notes>sops.templates pattern for complex secrets (Story 1.10C). Output location: ~/.ssh/allowed_signers, ~/.config/gh/hosts.yml. Story 1.12 AC E validates templates functional on darwin.</notes>
    </sopsTemplates>

    <zerotierNetwork>
      <name>Zerotier Network db4344343b14b903</name>
      <kind>Virtual network</kind>
      <topology>
        <controller>cinnabar (nixos VPS, zt0 interface)</controller>
        <peer>electrum (nixos VPS, zt0 interface)</peer>
        <peer>blackphos (darwin laptop, feth0 interface) - Story 1.12 adds</peer>
      </topology>
      <connectivity>Bidirectional (all nodes can ping each other)</connectivity>
      <latency>1-12ms (cinnabar ↔ electrum validated in Story 1.9), &lt;50ms expected for blackphos</latency>
      <notes>Story 1.12 AC C validates heterogeneous networking (nixos ↔ nix-darwin). Interface naming difference: zt0 (nixos) vs feth0 (darwin). Network ID hardcoded in zerotier join command.</notes>
    </zerotierNetwork>

    <clanInventory>
      <name>flake.config.clan.inventory</name>
      <kind>Clan metadata</kind>
      <access>In home-manager modules: flake.config.clan.inventory.* (via extraSpecialArgs)</access>
      <example>flake.config.clan.inventory.services.users.users.cameron.name</example>
      <notes>Clan-core is flake-parts module, so inventory accessible via flake.config in home-manager. Service instances: zerotier (nixos-specific). Machine tags and roles. Story 1.12 may document blackphos in inventory or externally.</notes>
    </clanInventory>
  </interfaces>
  <tests>
    <standards>
      test-clan uses nix flake check for validation. Test harness location: modules/checks/validation.nix (17 test cases). Test categories: base module validation (TC-001 through TC-005), dendritic namespace exports (TC-006 through TC-010), configuration builds (TC-011 through TC-015), home-manager integration (TC-018, TC-019), clan inventory validation (TC-016, TC-017). Story 1.12 pre-deployment validation: nix build .#darwinConfigurations.blackphos.system (build verification), nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage (122 derivations expected), nix build .#homeConfigurations.aarch64-darwin.raquel.activationPackage (105 derivations expected), nix flake check (all tests pass). Post-deployment testing: Zero-regression validation (crs58: LazyVim, git signing, Claude Code, tmux, atuin, MCP servers; raquel: LazyVim, git config, shell, tmux, development tools), network connectivity tests (ping tests blackphos ↔ cinnabar, blackphos ↔ electrum, 5-minute stability test), SSH validation (6 user combinations), secrets validation (/run/secrets/ permissions, multi-user encryption, sops.templates). Test execution timing: Pre-deployment (15 min build + validation), deployment (30 min activation + observation), post-deployment (1-1.5h zero-regression + network + SSH + secrets validation).
    </standards>

    <locations>
      <location>~/projects/nix-workspace/test-clan/modules/checks/validation.nix (test harness, 17 test cases)</location>
      <location>~/projects/nix-workspace/test-clan/flake.nix (nix flake check entry point)</location>
      <location>Story 1.12 work item zero-regression checklist (14 items, AC A validation)</location>
      <location>Story 1.12 work item network validation commands (AC C, bidirectional connectivity tests)</location>
      <location>Story 1.12 work item SSH validation commands (AC D, 6 user combinations)</location>
      <location>Story 1.12 work item secrets validation commands (AC E, permissions and multi-user encryption)</location>
    </locations>

    <ideas>
      <testIdea acceptanceCriteria="A" priority="critical">
        Pre-deployment build validation: nix build .#darwinConfigurations.blackphos.system, nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage (122 derivations), nix build .#homeConfigurations.aarch64-darwin.raquel.activationPackage (105 derivations). Expected: All builds succeed without errors. Ensures configuration is valid before physical deployment.
      </testIdea>

      <testIdea acceptanceCriteria="A" priority="critical">
        Deployment execution: darwin-rebuild switch --flake ~/projects/nix-workspace/test-clan#blackphos. Expected: Activation succeeds, launchd services start, homebrew casks install, no errors. Observe activation script output, deployment duration. Ensures physical deployment completes successfully.
      </testIdea>

      <testIdea acceptanceCriteria="A" priority="critical">
        Zero-regression validation (crs58): LazyVim opens and loads plugins, git signing works (commit with -S flag), Claude Code launches with ccstatusline, tmux starts with catppuccin theme, atuin history syncs, MCP servers accessible (API keys loaded). Expected: All 6 checks pass, 122 packages present. Ensures crs58 daily workflows remain functional.
      </testIdea>

      <testIdea acceptanceCriteria="A" priority="critical">
        Zero-regression validation (raquel): LazyVim opens successfully, git configuration correct, shell environment functional (zsh, starship), tmux starts with catppuccin theme, development tools accessible. Expected: All 5 checks pass, 105 packages present. Ensures raquel daily workflows remain functional.
      </testIdea>

      <testIdea acceptanceCriteria="B" priority="high">
        Zerotier service verification: sudo launchctl list | grep zerotier (Option A homebrew) OR launchctl list | grep zerotier (Option B custom module). Expected: Service running. Manual join: sudo zerotier-cli join db4344343b14b903. Expected: 200 join OK. Verification: sudo zerotier-cli listnetworks. Expected: db4344343b14b903 listed. Ensures zerotier integration successful on darwin.
      </testIdea>

      <testIdea acceptanceCriteria="B" priority="medium">
        Zerotier interface verification: ifconfig feth0. Expected: inet 10.147.x.x (zerotier IP assigned). Platform note: darwin uses feth0 (not zt0 like nixos). Store IP for connectivity tests. Ensures zerotier network interface operational.
      </testIdea>

      <testIdea acceptanceCriteria="C" priority="high">
        Bidirectional connectivity (blackphos → nixos): ping -c 5 <cinnabar-zt-ip>, ping -c 5 <electrum-zt-ip>. Expected: 5 packets transmitted, 5 received, 0% packet loss, latency <50ms. Ensures blackphos can reach nixos VMs via zerotier.
      </testIdea>

      <testIdea acceptanceCriteria="C" priority="high">
        Bidirectional connectivity (nixos → blackphos): On cinnabar/electrum: ping -c 5 <blackphos-zt-ip>. Expected: 5 packets transmitted, 5 received, 0% packet loss, latency <50ms. Ensures nixos VMs can reach blackphos via zerotier.
      </testIdea>

      <testIdea acceptanceCriteria="C" priority="medium">
        Network stability test: ping -c 300 <cinnabar-zt-ip> (5-minute test). Expected: 0% packet loss, stable latency over duration. Ensures zerotier network reliable for production coordination.
      </testIdea>

      <testIdea acceptanceCriteria="D" priority="high">
        SSH validation (blackphos → nixos): ssh cameron@<cinnabar-zt-ip>, ssh testuser@<electrum-zt-ip>. Expected: Login succeeds, certificate-based authentication, no password prompts. Verify whoami and pwd. Ensures SSH works from darwin to nixos.
      </testIdea>

      <testIdea acceptanceCriteria="D" priority="high">
        SSH validation (nixos → blackphos): On cinnabar/electrum: ssh crs58@<blackphos-zt-ip>, ssh raquel@<blackphos-zt-ip>. Expected: Login succeeds, certificate-based authentication. Verify uname -s (Darwin), whoami, pwd. Ensures SSH works from nixos to darwin with both users.
      </testIdea>

      <testIdea acceptanceCriteria="E" priority="high">
        Secrets directory validation: ls -la /run/secrets/, ls -la /run/secrets/crs58/, ls -la /run/secrets/raquel/. Expected: Directories exist, proper permissions. Secrets present: git-signing-key, ssh-private-key, github-api-token, anthropic-api-key, openai-api-key (crs58), git-signing-key, ssh-private-key (raquel). Ensures sops-nix secrets decrypted on darwin.
      </testIdea>

      <testIdea acceptanceCriteria="E" priority="high">
        Secrets permissions validation: stat -f "%Sp %u:%g" /run/secrets/crs58/git-signing-key, stat -f "%Sp %u:%g" /run/secrets/raquel/git-signing-key. Expected: 0400 (read-only owner), owned by correct UID (550 crs58, 551 raquel). Ensures secrets permissions correct on darwin.
      </testIdea>

      <testIdea acceptanceCriteria="E" priority="medium">
        sops.templates validation: cat ~/.ssh/allowed_signers, cat ~/.config/gh/hosts.yml. Expected: Multi-line template with SSH public keys (allowed_signers), GitHub token present (gh hosts.yml). Ensures sops.templates functional on darwin.
      </testIdea>

      <testIdea acceptanceCriteria="E" priority="medium">
        Multi-user encryption validation: As crs58: sops secrets/crs58/default.yaml (should succeed), sops secrets/raquel/default.yaml (should fail, not authorized). As raquel: sops secrets/raquel/default.yaml (should succeed). Ensures age key isolation between users.
      </testIdea>

      <testIdea acceptanceCriteria="F" priority="medium">
        Integration findings documentation: Populate AC F 5 sections (Physical Deployment Process, Zerotier Darwin Integration, Platform-Specific Challenges, Heterogeneous Networking Results, Epic 2-6 Migration Value) with actual deployment results, timing, challenges encountered, resolutions, connectivity matrices, time savings estimates. Ensures Epic 3-6 teams can replicate deployment pattern.
      </testIdea>
    </ideas>
  </tests>
</story-context>
