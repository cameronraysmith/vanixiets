<story-context id="2-4-home-manager-secrets-migration" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>4</storyId>
    <title>Home-manager secrets migration</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/2-4-home-manager-secrets-migration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>migrate home-manager secrets to the two-tier sops-nix architecture</iWant>
    <soThat>user secrets are properly encrypted with infra age keys and independently managed per user</soThat>
    <tasks>
      <task id="1" title="Pre-Migration Validation" ac="1">
        <subtask>Verify Story 2.3 completion state</subtask>
        <subtask>Confirm clan-01 branch has dendritic+clan structure</subtask>
        <subtask>Verify secrets/home-manager/users/ directory exists</subtask>
        <subtask>Verify sops/users/ structure (crs58, raquel, cameron)</subtask>
        <subtask>Document current state (file sizes, modification dates, encryption key metadata)</subtask>
        <subtask>Create safety backup: cp -r secrets/home-manager secrets/home-manager.backup-pre-2.4</subtask>
      </task>
      <task id="2" title="Age Key Correspondence Validation" ac="3">
        <subtask>Extract public keys from sops/users/ via jq</subtask>
        <subtask>Extract anchors from .sops.yaml</subtask>
        <subtask>Compare and document correspondence in Dev Notes table</subtask>
        <subtask>If mismatch detected: STOP and investigate root cause</subtask>
      </task>
      <task id="3" title="Re-encrypt Home-Manager Secrets" ac="2">
        <subtask>Re-encrypt crs58 secrets: sops -i secrets/home-manager/users/crs58/secrets.yaml</subtask>
        <subtask>Re-encrypt raquel secrets: sops -i secrets/home-manager/users/raquel/secrets.yaml</subtask>
        <subtask>Verify git diff shows encryption metadata change</subtask>
        <subtask>Verify plaintext content unchanged</subtask>
      </task>
      <task id="4" title="Darwin Platform Testing" ac="4">
        <subtask>Verify ~/.config/sops/age/keys.txt exists on stibnite with correct permissions (600)</subtask>
        <subtask>Test decryption on stibnite: sops -d secrets/home-manager/users/crs58/secrets.yaml</subtask>
        <subtask>Test decryption on blackphos (if accessible): sops -d secrets/home-manager/users/raquel/secrets.yaml</subtask>
        <subtask>Test home-manager builds: nix build .#homeConfigurations.crs58.activationPackage</subtask>
        <subtask>Test home-manager builds: nix build .#homeConfigurations.raquel.activationPackage</subtask>
      </task>
      <task id="5" title="NixOS Platform Testing" ac="5">
        <subtask>SSH to cinnabar: ssh root@cinnabar</subtask>
        <subtask>Test sops decryption with cameron user's age key</subtask>
        <subtask>Verify sops-nix module integration: nix eval .#nixosConfigurations.cinnabar.config.sops.secrets --json</subtask>
      </task>
      <task id="6" title="Documentation" ac="6">
        <subtask>Create docs/guides/home-manager-secrets-migration.md</subtask>
        <subtask>Write Overview section (two-tier architecture, Tier 1 vs Tier 2)</subtask>
        <subtask>Write User Setup Process section (SSH key from Bitwarden, ssh-to-age derivation)</subtask>
        <subtask>Write .sops.yaml Configuration section (adding user anchor, creation_rule)</subtask>
        <subtask>Write secrets.yaml Creation section (sops command for new file)</subtask>
        <subtask>Write Validation Workflow section (three-context correspondence check)</subtask>
        <subtask>Write Troubleshooting section (common errors, key mismatch debugging)</subtask>
        <subtask>Write Example Workflow section (step-by-step for new user)</subtask>
      </task>
      <task id="7" title="Final Validation and Commit" ac="1-7">
        <subtask>Run all AC verification commands (AC1-AC7)</subtask>
        <subtask>Stage changes: git add secrets/home-manager/ docs/guides/home-manager-secrets-migration.md</subtask>
        <subtask>Commit with conventional commit format</subtask>
        <subtask>Update sprint-status.yaml: story-2-4: drafted -> review</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" title="Two-Tier Architecture Structure Validated">
      Verify the required directory structure exists and matches the test-clan pattern.
      Verification: ls -la sops/users/*/key.json (3 files: crs58, raquel, cameron)
      Verification: ls -la secrets/home-manager/users/*/ (2 users: crs58, raquel)
    </criterion>
    <criterion id="AC2" title="Home-Manager Secrets Re-encrypted with Infra Age Keys">
      Re-encrypt both user secret files using the infra age keys defined in .sops.yaml.
      Verification: sops -i secrets/home-manager/users/crs58/secrets.yaml
      Verification: sops -i secrets/home-manager/users/raquel/secrets.yaml
      Verification: git diff secrets/home-manager/users/ shows age key metadata updated
    </criterion>
    <criterion id="AC3" title="Age Key Correspondence Validated Across Three Contexts">
      All three contexts must have corresponding age public keys for each user.
      Context 1: sops/users/{user}/key.json - clan user public key storage
      Context 2: .sops.yaml anchors - sops-nix encryption rules
      Context 3: ~/.config/sops/age/keys.txt - workstation private key derives to matching public
    </criterion>
    <criterion id="AC4" title="Secrets Decryption Tested on Darwin Platforms">
      Test that secrets can be decrypted on darwin workstations (stibnite, blackphos) with infra age keys.
      Verification: sops -d secrets/home-manager/users/crs58/secrets.yaml succeeds on stibnite
      Verification: sops -d secrets/home-manager/users/raquel/secrets.yaml succeeds on blackphos
      Verification: nix build .#homeConfigurations.{crs58,raquel}.activationPackage succeeds
    </criterion>
    <criterion id="AC5" title="Secrets Decryption Tested on NixOS Platforms">
      Test that secrets can be decrypted on nixos VPS (cinnabar) with infra age keys.
      Verification: SSH to cinnabar and run sops -d secrets/home-manager/users/crs58/secrets.yaml
      Verification: nix eval .#nixosConfigurations.cinnabar.config.sops.secrets --json
    </criterion>
    <criterion id="AC6" title="Secret Migration Process Documented for Future Users">
      Create documentation sufficient for onboarding christophersmith (Story 2.11) and janettesmith (Story 2.12).
      Deliverable: docs/guides/home-manager-secrets-migration.md
      Required sections: Overview, User setup, .sops.yaml config, secrets.yaml creation, Validation, Troubleshooting, Example workflow
      Reference: test-clan age-key-management.md (882 lines)
      Expected size: 300-500 lines
    </criterion>
    <criterion id="AC7" title="All Existing Secrets Preserved and Accessible">
      Zero data loss during re-encryption. All existing secrets remain accessible.
      crs58 secrets (7+1): github-token, ssh-signing-key, ssh-public-key, glm-api-key, firecrawl-api-key, huggingface-token, bitwarden-email, atuin-key
      raquel secrets (4+1): github-token, ssh-signing-key, ssh-public-key, bitwarden-email, atuin-key
      Verification: sops -d count matches expected secrets per user
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture/secrets-and-vars-architecture.md</path>
        <title>Secrets and Vars Architecture</title>
        <section>Overview, Age Key Types, Three-Context Correspondence</section>
        <snippet>Two-tier secrets architecture: Tier 1 (clan vars system-level) + Tier 2 (sops-nix user-level). Age keys must correspond across three contexts for sops-nix to work correctly.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/epics/epic-2-infrastructure-architecture-migration.md</path>
        <title>Epic 2: Infrastructure Architecture Migration</title>
        <section>Story 2.4 definition</section>
        <snippet>Copy sops-nix two-tier architecture from test-clan to infra. Validate age key reuse pattern. Test secrets decryption on darwin and nixos platforms.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/2-3-wholesale-migration-test-clan-to-infra.md</path>
        <title>Story 2.3: Wholesale Migration</title>
        <section>Dev Agent Record, Secrets Structure</section>
        <snippet>Story 2.3 established secrets/home-manager/users/{crs58,raquel}/ directories. Secrets copied from test-clan with TEST-CLAN age key encryption. Re-encryption required in Story 2.4.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/work-items/1-10c-establish-sops-nix-secrets-home-manager.md</path>
        <title>Story 1.10C: Establish sops-nix Secrets for Home-Manager</title>
        <section>Two-Tier Architecture, sops-nix patterns</section>
        <snippet>Validated sops-nix for home-manager in test-clan. Age key reuse pattern: Same keypair for clan secrets AND sops-nix. Module access patterns for git, jujutsu, mcp-servers, wrappers, atuin, rbw.</snippet>
      </doc>
      <doc>
        <path>~/projects/nix-workspace/test-clan/docs/guides/age-key-management.md</path>
        <title>Age Key Management and sops-nix Operations (External)</title>
        <section>SSH-to-Age Derivation, Three-Context Validation, Bitwarden Workflow</section>
        <snippet>ONE SSH keypair derives ONE age keypair used in three contexts. Bitwarden as source of truth. Validation workflow for context correspondence. Reference for AC6 documentation.</snippet>
      </doc>
      <doc>
        <path>.sops.yaml</path>
        <title>SOPS Configuration</title>
        <section>Age key anchors, creation_rules</section>
        <snippet>Age keys: admin-user (crs58/cameron), raquel-user, dev, ci, admin. Home-manager rules at lines 50-64: secrets/home-manager/users/crs58/*.yaml encrypted for admin + dev + admin-user.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/sprint-status.yaml</path>
        <title>Sprint Status Tracking</title>
        <section>Story 2.4 status</section>
        <snippet>story-2-4: drafted. Predecessor story-2-3: done. Epic 2 Phase 1 final story.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>sops/users/crs58/key.json</path>
        <kind>clan-user-key</kind>
        <symbol>publickey</symbol>
        <lines>1-6</lines>
        <reason>crs58 age public key: age1vn8fpkmkzkjttcuc3prq3jrp7t5fsrdqey74ydu5p88keqmcupvs8jtmv8. Context 1 for three-context validation.</reason>
      </artifact>
      <artifact>
        <path>sops/users/raquel/key.json</path>
        <kind>clan-user-key</kind>
        <symbol>publickey</symbol>
        <lines>1-6</lines>
        <reason>raquel age public key: age12w0rmmskrds6m334w7qrcmpms5lpe3llah6wf8ry5jtatvuxku2sarl8ut. Context 1 for three-context validation.</reason>
      </artifact>
      <artifact>
        <path>sops/users/cameron/key.json</path>
        <kind>clan-user-key</kind>
        <symbol>publickey</symbol>
        <lines>1-6</lines>
        <reason>cameron age public key (same as crs58): age1vn8fpkmkzkjttcuc3prq3jrp7t5fsrdqey74ydu5p88keqmcupvs8jtmv8. Alias validation.</reason>
      </artifact>
      <artifact>
        <path>secrets/home-manager/users/crs58/secrets.yaml</path>
        <kind>sops-encrypted-secrets</kind>
        <symbol>user-secrets</symbol>
        <lines>full-file</lines>
        <reason>crs58 secrets file to re-encrypt. 8 secrets: github-token, ssh-signing-key, ssh-public-key, glm-api-key, firecrawl-api-key, huggingface-token, bitwarden-email, atuin-key.</reason>
      </artifact>
      <artifact>
        <path>secrets/home-manager/users/raquel/secrets.yaml</path>
        <kind>sops-encrypted-secrets</kind>
        <symbol>user-secrets</symbol>
        <lines>full-file</lines>
        <reason>raquel secrets file to re-encrypt. 5 secrets: github-token, ssh-signing-key, ssh-public-key, bitwarden-email, atuin-key.</reason>
      </artifact>
      <artifact>
        <path>.sops.yaml</path>
        <kind>sops-config</kind>
        <symbol>creation_rules</symbol>
        <lines>50-64</lines>
        <reason>Home-manager creation_rules defining which age keys encrypt each user's secrets. Context 2 for three-context validation.</reason>
      </artifact>
      <artifact>
        <path>modules/home/base/sops.nix</path>
        <kind>nix-module</kind>
        <symbol>homeManager.base-sops</symbol>
        <lines>1-26</lines>
        <reason>Base sops-nix home-manager module. Imports sops-nix module, configures keyFile to ~/.config/sops/age/keys.txt. Foundation for user-specific secrets.</reason>
      </artifact>
      <artifact>
        <path>modules/home/users/crs58/default.nix</path>
        <kind>nix-module</kind>
        <symbol>homeManager.users/crs58</symbol>
        <lines>20-46</lines>
        <reason>crs58 user module with sops configuration. Declares 8 secrets, sops.templates for allowed_signers. Pattern to verify post-re-encryption.</reason>
      </artifact>
      <artifact>
        <path>modules/home/users/raquel/default.nix</path>
        <kind>nix-module</kind>
        <symbol>homeManager.users/raquel</symbol>
        <lines>20-43</lines>
        <reason>raquel user module with sops configuration. Declares 5 secrets (no AI keys). Pattern to verify post-re-encryption.</reason>
      </artifact>
      <artifact>
        <path>modules/checks/validation.nix</path>
        <kind>nix-check</kind>
        <symbol>home-module-exports, home-configurations-exposed</symbol>
        <lines>15-125</lines>
        <reason>Validation checks for home-manager module exports. TC-018, TC-019 verify homeManager namespace and configurations exposed.</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="nix-flake">
        <package name="sops-nix" url="github:Mic92/sops-nix">sops-nix home-manager module for secrets</package>
        <package name="clan-core" url="github:cameronraysmith/clan-core/dev">Clan orchestration, user management, vars</package>
        <package name="home-manager" url="github:nix-community/home-manager">Home-manager for user configurations</package>
        <package name="nix-darwin" url="github:nix-darwin/nix-darwin">Darwin (macOS) system configuration</package>
        <package name="import-tree" url="github:vic/import-tree">Dendritic auto-discovery for flake-parts</package>
      </ecosystem>
      <ecosystem name="cli-tools">
        <package name="sops">SOPS CLI for encryption/decryption operations</package>
        <package name="age">Age encryption tool</package>
        <package name="ssh-to-age">Derive age keys from SSH keys</package>
        <package name="jq">JSON processing for key extraction</package>
        <package name="bw">Bitwarden CLI for SSH key retrieval</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture" priority="critical">
      Two-tier secrets architecture must be preserved: Tier 1 (clan vars for system-level) stays OUT OF SCOPE, Tier 2 (sops-nix for user-level) is Story 2.4 scope.
    </constraint>
    <constraint source="story-scope" priority="critical">
      Only secrets/home-manager/users/ and sops/users/ are in scope. Do NOT touch vars/ directory (clan vars), sops/machines/ (machine keys, Stories 2.9-2.10), or secrets/users/ (legacy service accounts, Epic 6 cleanup).
    </constraint>
    <constraint source="age-key-correspondence" priority="critical">
      Age public keys MUST match across all three contexts: sops/users/*/key.json, .sops.yaml anchors, and derived from workstation private keys. Mismatch blocks all sops operations.
    </constraint>
    <constraint source="data-integrity" priority="critical">
      Zero data loss during re-encryption. Secret count must match: crs58 (8 secrets), raquel (5 secrets). Verify before and after re-encryption.
    </constraint>
    <constraint source="security-protocol" priority="high">
      Avoid populating secret values in chat. Use sops CLI commands executed interactively. Private keys never committed to repository.
    </constraint>
    <constraint source="bitwarden-source" priority="high">
      Bitwarden vault is source of truth for SSH keys. Age keys are ephemeral derivations. If keys mismatch, re-derive from Bitwarden.
    </constraint>
    <constraint source="pattern-a" priority="medium">
      All modules use Pattern A (dendritic flake-parts with flake context access). sops.nix modules access flake.inputs.self for secret paths.
    </constraint>
    <constraint source="atomic-commits" priority="medium">
      Use conventional commit format. Separate commits for re-encryption and documentation.
    </constraint>
  </constraints>

  <interfaces>
    <interface name="sops-nix home-manager" kind="nix-module">
      <signature>sops.age.keyFile = "${config.xdg.configHome}/sops/age/keys.txt"</signature>
      <path>modules/home/base/sops.nix</path>
    </interface>
    <interface name="sops secrets declaration" kind="nix-option">
      <signature>sops.secrets.&lt;name&gt; = { mode = "0400"; }</signature>
      <path>modules/home/users/*/default.nix</path>
    </interface>
    <interface name="sops defaultSopsFile" kind="nix-option">
      <signature>sops.defaultSopsFile = flake.inputs.self + "/secrets/home-manager/users/&lt;user&gt;/secrets.yaml"</signature>
      <path>modules/home/users/*/default.nix</path>
    </interface>
    <interface name="sops templates" kind="nix-option">
      <signature>sops.templates."allowed_signers" = { content = "... ${config.sops.placeholder.ssh-public-key}"; }</signature>
      <path>modules/home/users/*/default.nix</path>
    </interface>
    <interface name="sops -i re-encryption" kind="cli-command">
      <signature>sops -i &lt;encrypted-file.yaml&gt;</signature>
      <note>In-place re-encryption using .sops.yaml rules. Updates encryption metadata without changing plaintext.</note>
    </interface>
    <interface name="sops -d decryption test" kind="cli-command">
      <signature>sops -d &lt;encrypted-file.yaml&gt;</signature>
      <note>Decrypt to stdout for verification. Requires matching private key in ~/.config/sops/age/keys.txt</note>
    </interface>
    <interface name="age-keygen -y" kind="cli-command">
      <signature>age-keygen -y &lt; ~/.config/sops/age/keys.txt</signature>
      <note>Derive public key from private key. Used for Context 3 validation.</note>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing uses nix-unit for unit tests and nix flake checks for validation. Checks are defined in modules/checks/ with auto-discovery via import-tree. Test execution via `just check` or `nix flake check`. Home-manager builds are validated via `nix build .#homeConfigurations.{system}.{user}.activationPackage`.
    </standards>
    <locations>
      <location>modules/checks/validation.nix</location>
      <location>modules/checks/nix-unit.nix</location>
      <location>modules/checks/integration.nix</location>
      <location>nix flake check (all checks)</location>
      <location>just check (convenience wrapper)</location>
    </locations>
    <ideas>
      <idea ac="1">Verify directory structure: ls -la sops/users/*/key.json returns 3 files, ls -la secrets/home-manager/users/*/ returns 2 directories</idea>
      <idea ac="2">Verify git diff shows age key metadata change in secrets/home-manager/users/*/secrets.yaml after sops -i</idea>
      <idea ac="3">Extract age public keys from all three contexts and compare: jq -r '.[0].publickey' vs grep .sops.yaml vs age-keygen -y</idea>
      <idea ac="4">Execute sops -d on both user secrets files on stibnite to verify darwin decryption works</idea>
      <idea ac="4">Build homeConfigurations activation packages: nix build .#homeConfigurations.{system}.crs58.activationPackage</idea>
      <idea ac="5">SSH to cinnabar and verify sops -d works with cameron user's age key</idea>
      <idea ac="6">Verify documentation exists with required sections: wc -l docs/guides/home-manager-secrets-migration.md (expect 300-500 lines)</idea>
      <idea ac="7">Count secrets in decrypted output: sops -d ... | grep -c "^[a-z]" matches expected (8 for crs58, 5 for raquel)</idea>
      <idea ac="7">Verify home-manager activation builds complete without sops-related errors</idea>
    </ideas>
  </tests>
</story-context>
