<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.10D</storyId>
    <title>Validate Custom Package Overlays with pkgs-by-name Pattern</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-10d-validate-custom-package-overlays.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to validate that infra's custom package overlays work with dendritic flake-parts + clan architecture using the pkgs-by-name pattern</iWant>
    <soThat>Epic 2-6 migration can proceed confidently knowing all 4 infra custom packages will migrate successfully</soThat>
    <tasks>
      - Task 1: Infrastructure Setup (AC A-B) - 20 minutes estimated
        - 1.1: Add pkgs-by-name-for-flake-parts flake input to flake.nix
        - 1.2: Import flake module in modules/nixpkgs.nix
        - 1.3: Configure pkgsDirectory in perSystem
        - 1.4: Create pkgs/by-name/cc/ccstatusline/ directory structure
        - 1.5: Verify flake module loads (nix flake check)
      - Task 2: ccstatusline Package Implementation (AC C) - 10 minutes estimated
        - 2.1: Copy infra ccstatusline.nix → test-clan package.nix
        - 2.2: Verify callPackage signature (no modifications)
        - 2.3: Confirm npm tarball pattern
      - Task 3: Build and Quality Validation (AC D-E) - 30 minutes estimated
        - 3.1: Build ccstatusline package
        - 3.2: Verify auto-discovery
        - 3.3: Inspect package contents
        - 3.4: Validate build quality
      - Task 4: Integration and Dendritic Compatibility (AC F-G) - 45 minutes estimated
        - 4.1: Test module consumption
        - 4.2: Build home-manager activation package
        - 4.3: Verify ccstatusline in activation closure
        - 4.4: Validate dendritic compatibility (6-item checklist)
      - Task 5: Documentation (AC H-I) - 1 hour 15 minutes estimated
        - 5.1: Document infra migration path (4 packages table)
        - 5.2: Create Section 13.1 in test-clan-validated-architecture.md
        - 5.3: Write pattern overview
        - 5.4: Write ccstatusline complete example
        - 5.5: Write infra migration guide
    </tasks>
  </story>

  <acceptanceCriteria>
### A. Add pkgs-by-name-for-flake-parts Infrastructure

**Target:** Integrate pkgs-by-name-for-flake-parts flake module into test-clan

**Implementation:**

1. Add flake input to flake.nix:
   ```nix
   inputs.pkgs-by-name-for-flake-parts.url = "github:drupol/pkgs-by-name-for-flake-parts";
   ```

2. Import flake module in modules/nixpkgs.nix:
   ```nix
   imports = [ inputs.pkgs-by-name-for-flake-parts.flakeModule ];
   ```

3. Configure pkgsDirectory in perSystem:
   ```nix
   perSystem = { ... }: {
     pkgsDirectory = ../../pkgs/by-name;
   };
   ```

4. Verify flake module loads without errors:
   ```bash
   nix flake check
   ```

**Pass Criteria:**
- Flake input added correctly
- Module import successful
- pkgsDirectory configured
- `nix flake check` passes with no evaluation errors

**Estimated effort:** 15 min

---

### B. Create pkgs/by-name Directory Structure

**Target:** Establish nixpkgs RFC 140 compliant directory structure

**Implementation:**

1. Create directory following nixpkgs convention:
   ```bash
   mkdir -p pkgs/by-name/cc/ccstatusline
   ```

2. Verify structure follows RFC 140:
   - Pattern: `pkgs/by-name/&lt;first-2-chars&gt;/&lt;package-name&gt;/package.nix`
   - Example: `pkgs/by-name/cc/ccstatusline/package.nix`
   - First 2 chars: "cc" (from "ccstatusline")

3. Verify directory accessible from flake root:
   ```bash
   ls -la pkgs/by-name/cc/ccstatusline/
   ```

4. Confirm matches drupol-dendritic-infra pattern:
   - Reference: `~/projects/nix-workspace/drupol-dendritic-infra/pkgs/by-name/`
   - Verify same directory naming convention

**Pass Criteria:**
- Directory `pkgs/by-name/cc/ccstatusline/` exists
- Structure matches RFC 140 specification
- Accessible from flake root (relative path `../../pkgs/by-name` works from modules/)
- Pattern matches drupol reference implementation

**Estimated effort:** 5 min

---

### C. Implement ccstatusline Package

**Target:** Copy production-ready ccstatusline derivation from infra to test-clan

**Implementation:**

1. Copy production-ready derivation from infra:
   ```bash
   cp ~/projects/nix-workspace/infra/overlays/packages/ccstatusline.nix \
      ~/projects/nix-workspace/test-clan/pkgs/by-name/cc/ccstatusline/package.nix
   ```

2. Verify package.nix uses standard callPackage signature:
   ```nix
   { lib, buildNpmPackage, fetchzip, jq, nix-update-script }:
   buildNpmPackage (finalAttrs: {
     pname = "ccstatusline";
     version = "2.0.21";
     # ... rest of derivation
   })
   ```

3. Confirm no modifications needed:
   - Derivation is production-validated in infra
   - Uses standard nixpkgs builder (buildNpmPackage)
   - No custom overlay arguments required

4. Verify package follows npm tarball pattern:
   - Pre-built dist/ directory in source tarball
   - No compilation phase needed (dontNpmBuild = true)
   - installPhase copies dist/ to output

**Pass Criteria:**
- File `pkgs/by-name/cc/ccstatusline/package.nix` exists
- Uses standard callPackage signature (no custom arguments)
- Derivation matches infra production version (85 lines, npm tarball pattern)
- No syntax errors (will be validated in AC D build step)

**Estimated effort:** 10 min (copy + verify)

---

### D. Validate Package Auto-Discovery

**Target:** Verify pkgs-by-name-for-flake-parts auto-discovers and exports ccstatusline

**Implementation:**

1. Build ccstatusline package:
   ```bash
   nix build .#packages.aarch64-darwin.ccstatusline
   # OR short form:
   nix build .#ccstatusline
   ```

2. Verify package exports to correct output paths:
   - Full path: `packages.&lt;system&gt;.ccstatusline`
   - Short form: `ccstatusline` (flake output shorthand)
   - Check available with: `nix flake show | grep ccstatusline`

3. Verify package accessible via pkgs namespace:
   ```bash
   nix eval .#packages.aarch64-darwin.ccstatusline.meta.description
   # Expected output: "Highly customizable status line formatter for Claude Code CLI"
   ```

4. Confirm auto-discovery worked:
   - No manual package list in modules/nixpkgs.nix
   - Package discovered purely by directory structure
   - Matches drupol pattern (zero boilerplate)

**Pass Criteria:**
- `nix build .#ccstatusline` succeeds
- Package exports to `packages.&lt;system&gt;.ccstatusline`
- Package metadata accessible via `nix eval`
- No manual package registration needed (auto-discovery confirmed)

**Estimated effort:** 15 min

---

### E. Validate Package Build Quality

**Target:** Verify ccstatusline package build produces correct output structure

**Implementation:**

1. Inspect package contents:
   ```bash
   ls -la result/bin/
   ls -la result/lib/node_modules/ccstatusline/
   ```

2. Verify executable exists and is executable:
   ```bash
   file result/bin/ccstatusline
   # Expected: "...shell script..."
   test -x result/bin/ccstatusline &amp;&amp; echo "✓ Executable"
   ```

3. Check runtime dependencies:
   ```bash
   nix-store -q --references result/
   # Expected: nodejs runtime + ccstatusline package
   ```

4. Verify package metadata complete:
   ```bash
   nix eval .#packages.aarch64-darwin.ccstatusline.meta --json | jq '.description, .homepage, .license, .mainProgram'
   ```
   - Description: "Highly customizable status line formatter for Claude Code CLI"
   - Homepage: GitHub URL
   - License: Valid SPDX identifier
   - mainProgram: "ccstatusline"

**Pass Criteria:**
- Executable `result/bin/ccstatusline` exists and is executable
- Package includes nodejs runtime dependency
- Package metadata fields populated correctly
- File permissions correct (executable bit set)

**Estimated effort:** 15 min

---

### F. Test Module Consumption

**Target:** Verify ccstatusline accessible from dendritic modules via pkgs.ccstatusline

**Implementation:**

1. Update claude-code module to consume ccstatusline:
   ```nix
   # modules/home/ai/claude-code/default.nix
   { pkgs, ... }:
   {
     programs.claude-code.settings.statusLine = {
       type = "command";
       command = "${pkgs.ccstatusline}/bin/ccstatusline";
       padding = 0;
     };
   }
   ```

2. Verify pkgs.ccstatusline resolves without errors:
   - No infinite recursion
   - No missing package errors
   - No evaluation failures

3. Build home-manager configuration:
   ```bash
   nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage
   ```

4. Verify ccstatusline in activation closure:
   ```bash
   nix-store -q --references result/ | grep ccstatusline
   # Should output: /nix/store/...-ccstatusline-2.0.21
   ```

**Pass Criteria:**
- Module references `pkgs.ccstatusline` successfully
- home-manager build completes without errors
- ccstatusline package present in activation closure
- Package accessible from dendritic module context (no specialArgs needed)

**Estimated effort:** 30 min

---

### G. Validate Dendritic Compatibility

**Target:** Confirm pkgs-by-name pattern integrates correctly with dendritic architecture

**Compatibility Checklist:**

1. ✅ **Package definition is NOT a flake-parts module:**
   - File: `pkgs/by-name/cc/ccstatusline/package.nix`
   - Content: Standard Nix derivation (callPackage signature)
   - Verification: No `flake-parts` imports, no `perSystem` usage

2. ✅ **Package EXPORT via flake module:**
   - File: `modules/nixpkgs.nix`
   - Content: Import pkgs-by-name-for-flake-parts, configure pkgsDirectory
   - Verification: Package appears in `nix flake show` outputs

3. ✅ **Package CONSUMPTION in dendritic module:**
   - File: `modules/home/ai/claude-code/default.nix`
   - Content: References `pkgs.ccstatusline`
   - Verification: Module builds successfully with package reference

4. ✅ **NO specialArgs pass-thru needed:**
   - pkgs available in all dendritic modules automatically
   - No custom `extraSpecialArgs` configuration required
   - Verification: Standard module signature `{ pkgs, ... }:` works

5. ✅ **import-tree auto-discovery compatibility:**
   - pkgs-by-name doesn't conflict with module auto-discovery
   - Both use separate namespace (packages vs modules)
   - Verification: `nix flake check` passes with both systems active

6. ✅ **Pattern matches drupol-dendritic-infra architecture:**
   - Directory structure identical to drupol reference
   - Integration pattern identical (flake input + module import + perSystem config)
   - Verification: Side-by-side comparison with `~/projects/nix-workspace/drupol-dendritic-infra/`

**Pass Criteria:**
- All 6 compatibility checks pass
- No architectural conflicts detected
- Pattern matches proven dendritic reference implementation
- Zero workarounds or hacks needed

**Estimated effort:** 15 min

---

### H. Validate infra Migration Readiness

**Target:** Document migration path for all 4 infra packages

**infra Package Inventory:**

| Package | Current Location | Target Location | Estimated Effort |
|---------|------------------|-----------------|------------------|
| ccstatusline | `overlays/packages/ccstatusline.nix` | `pkgs/by-name/cc/ccstatusline/package.nix` | ✅ Validated (this story) |
| atuin-format | `overlays/packages/atuin-format/` | `pkgs/by-name/at/atuin-format/package.nix` | 30 min (directory package → single file) |
| markdown-tree-parser | `overlays/packages/markdown-tree-parser.nix` | `pkgs/by-name/ma/markdown-tree-parser/package.nix` | 15 min (file move) |
| starship-jj | `overlays/packages/starship-jj.nix` | `pkgs/by-name/st/starship-jj/package.nix` | 15 min (file move) |

**Total Migration Effort:** 2.5-3 hours (includes flake input setup, testing, documentation)

**Migration Verification:**

1. Verify all packages use standard callPackage signatures:
   - ccstatusline: ✅ `{ lib, buildNpmPackage, fetchzip, jq, nix-update-script }`
   - atuin-format: Review `overlays/packages/atuin-format/default.nix` for signature
   - markdown-tree-parser: Review for standard rustPlatform signature
   - starship-jj: Review for standard rustPlatform signature

2. Confirm lib.packagesFromDirectoryRecursive pattern compatibility:
   - infra current: `lib.packagesFromDirectoryRecursive { ... }`
   - pkgs-by-name-for-flake-parts: Uses SAME function under hood
   - Assessment: ✅ COMPATIBLE (no code changes needed)

3. Verify no custom overlayArgs needed:
   - All packages use standard nixpkgs builders
   - No infra-specific overlay arguments
   - Assessment: ✅ SAFE (standard callPackage only)

4. Migration risk assessment:
   - Risk level: LOW
   - Reasoning: Directory restructuring only, same underlying function, proven pattern
   - Mitigation: Story 1.10D validates pattern before Epic 2-6 migration

**Pass Criteria:**
- All 4 packages documented with migration paths
- Effort estimates provided per package
- callPackage signature compatibility verified
- Migration risk assessed as LOW
- Epic 2-6 migration confidence established

**Estimated effort:** 30 min (documentation + verification)

---

### I. Documentation - Section 13.1 (Custom Package Overlays)

**Target:** Create comprehensive tutorial in test-clan-validated-architecture.md

**Documentation Structure:**

```markdown
## 13.1 Custom Package Overlays with pkgs-by-name Pattern

### Pattern Overview

**Architecture:** pkgs-by-name-for-flake-parts (drupol pattern)

**Directory Structure:**
pkgs/by-name/&lt;first-2-chars&gt;/&lt;package-name&gt;/package.nix

**Integration Steps:**
1. Add flake input: inputs.pkgs-by-name-for-flake-parts.url = "github:drupol/pkgs-by-name-for-flake-parts"
2. Import module: modules/nixpkgs.nix adds flake module import
3. Configure perSystem: Set pkgsDirectory = ../../pkgs/by-name
4. Create packages: Standard Nix derivations with callPackage signature
5. Auto-discovery: Packages export to packages.&lt;system&gt;.&lt;name&gt; and pkgs.&lt;name&gt;

**Pattern Benefits:**
- Uses lib.packagesFromDirectoryRecursive (same as infra)
- Follows nixpkgs RFC 140 convention
- Zero boilerplate (no manual package lists)
- Dendritic compatible (proven in drupol, gaetanlepage repos)

### Complete Example: ccstatusline Package

**1. Package Derivation (pkgs/by-name/cc/ccstatusline/package.nix):**
[Include full 85-line derivation from infra]

**2. Build Commands:**
```bash
# Build package
nix build .#ccstatusline

# Inspect contents
ls -la result/bin/
nix-store -q --references result/

# Verify metadata
nix eval .#packages.aarch64-darwin.ccstatusline.meta.description
```

**3. Module Consumption:**
```nix
# modules/home/ai/claude-code/default.nix
{ pkgs, ... }:
{
  programs.claude-code.settings.statusLine = {
    type = "command";
    command = "${pkgs.ccstatusline}/bin/ccstatusline";
  };
}
```

**4. Integration Validation:**
```bash
# Build home-manager config
nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage

# Verify package in closure
nix-store -q --references result/ | grep ccstatusline
```

### infra Migration Guide

**Current State (infra):**
- Location: overlays/packages/
- Auto-discovery: lib.packagesFromDirectoryRecursive
- Packages: 4 production packages

**Migration Path:**
[Include table from AC H with all 4 packages]

**Migration Steps:**
1. Add pkgs-by-name-for-flake-parts flake input to infra
2. Create pkgs/by-name/ directory structure
3. Move package files to RFC 140 paths (no code changes)
4. Update modules/nixpkgs.nix to import flake module
5. Configure pkgsDirectory in perSystem
6. Test builds and module consumption
7. Remove old overlays/ configuration

**Estimated Total Effort:** 2.5-3 hours

**Risk Assessment:** LOW (directory restructuring only, proven pattern)

### References

- **drupol-dendritic-infra:** ~/projects/nix-workspace/drupol-dendritic-infra/ (PRIMARY pattern reference, 9 packages)
- **gaetanlepage:** ~/projects/nix-workspace/gaetanlepage-dendritic-nix-config/ (compatibility proof)
- **pkgs-by-name-for-flake-parts:** https://github.com/drupol/pkgs-by-name-for-flake-parts
- **nixpkgs RFC 140:** https://github.com/NixOS/rfcs/pull/140
- **Dendritic Overlay Pattern Review:** [Link to research document]
```

**Pass Criteria:**
- Section 13.1 exists in test-clan-validated-architecture.md
- Contains pattern overview (architecture, integration steps, benefits)
- Includes complete ccstatusline example (derivation + build + consumption)
- Documents infra migration guide (table + steps + effort + risk)
- References drupol (PRIMARY), gaetanlepage (compatibility), external links

**Estimated effort:** 45 min
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Epic Context -->
      <doc>
        <path>docs/notes/development/epics/epic-1-architectural-validation-migration-pattern-rehearsal-phase-0.md</path>
        <title>Epic 1 - Story 1.10D Definition</title>
        <section>Story 1.10D: Validate Custom Package Overlays (lines 1127-1362)</section>
        <snippet>Complete story definition with pkgs-by-name pattern, drupol reference, infra compatibility assessment, 9 ACs, strategic value. Epic reordering decision (2025-11-16) establishes infrastructure-before-features dependency flow.</snippet>
      </doc>

      <!-- Architecture Documentation -->
      <doc>
        <path>docs/notes/development/test-clan-validated-architecture.md</path>
        <title>test-clan Validated Architecture - Section 11</title>
        <section>Module System Architecture - Flake-Parts + Home-Manager Nesting (lines 728-1086)</section>
        <snippet>Nested module systems (flake-parts outer, home-manager inner), access patterns, Pattern A structure, common anti-patterns. Foundation for understanding dendritic + pkgs-by-name integration.</snippet>
      </doc>

      <!-- Previous Stories Context -->
      <doc>
        <path>docs/notes/development/work-items/1-10ba-refactor-pattern-a.md</path>
        <title>Story 1.10BA - Pattern A Foundation</title>
        <section>Complete Story (done)</section>
        <snippet>Refactored 16 modules to Pattern A (explicit flake.modules pattern), validates dendritic auto-discovery, provides flake context access. Precedent for Story 1.10D package integration.</snippet>
      </doc>

      <doc>
        <path>docs/notes/development/work-items/1-10c-establish-sops-nix-secrets-home-manager.md</path>
        <title>Story 1.10C - sops-nix Secrets Infrastructure</title>
        <section>Complete Story (done, 24/24 ACs satisfied)</section>
        <snippet>Validates sops-nix works with dendritic, establishes quality standards (4 quality gates, comprehensive docs), proves Pattern A + external modules compatible. Story 1.10D follows same validation rigor.</snippet>
      </doc>

      <!-- Dendritic Overlay Pattern Review -->
      <doc>
        <path>N/A (Subagent Task Report, 2025-11-16)</path>
        <title>Dendritic Overlay Pattern Review</title>
        <section>Complete Analysis (8 repositories examined)</section>
        <snippet>Comprehensive review identifying pkgs-by-name-for-flake-parts as optimal pattern. Key findings: SAME lib.packagesFromDirectoryRecursive as infra, nixpkgs RFC 140 convention, zero boilerplate, proven in drupol (9 packages). infra compatibility: SAFE TO MIGRATE (directory restructuring only, 2.5-3h effort).</snippet>
      </doc>
    </docs>

    <code>
      <!-- drupol-dendritic-infra: PRIMARY Reference -->
      <artifact>
        <path>~/projects/nix-workspace/drupol-dendritic-infra/flake.nix</path>
        <kind>flake configuration (drupol PRIMARY reference)</kind>
        <symbol>pkgs-by-name-for-flake-parts flake input</symbol>
        <lines>Search for: inputs.pkgs-by-name-for-flake-parts</lines>
        <reason>PRIMARY reference for flake input syntax. drupol has 9 packages using pkgs-by-name pattern in production. Exact flake input URL and configuration to replicate in test-clan.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/drupol-dendritic-infra/modules/nixpkgs.nix</path>
        <kind>flake-parts module (drupol PRIMARY reference)</kind>
        <symbol>pkgs-by-name-for-flake-parts integration</symbol>
        <lines>Search for: pkgsDirectory, imports.*pkgs-by-name</lines>
        <reason>PRIMARY reference for flake module import and perSystem configuration. Shows pkgsDirectory option setup, module import pattern. Copy this integration pattern to test-clan modules/nixpkgs.nix.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/drupol-dendritic-infra/pkgs/by-name/</path>
        <kind>package directory structure (drupol PRIMARY reference)</kind>
        <symbol>nixpkgs RFC 140 convention</symbol>
        <lines>Explore: directory structure, package.nix files</lines>
        <reason>PRIMARY reference for pkgs/by-name/ directory organization. Shows first-2-chars subdirectory pattern (e.g., XY/package-name/package.nix). Model for test-clan cc/ccstatusline/ structure.</reason>
      </artifact>

      <!-- gaetanlepage: Compatibility Proof -->
      <artifact>
        <path>~/projects/nix-workspace/gaetanlepage-dendritic-nix-config/</path>
        <kind>comprehensive dendritic repository (compatibility proof)</kind>
        <symbol>dendritic without custom packages</symbol>
        <lines>Explore: modules/ structure, no pkgs/</lines>
        <reason>Proves dendritic pattern is orthogonal to overlay pattern (no custom packages, no conflicts). Validates pkgs-by-name can coexist with comprehensive dendritic usage. Architectural confidence reference.</reason>
      </artifact>

      <!-- infra: Migration Source -->
      <artifact>
        <path>~/projects/nix-workspace/infra/overlays/packages/ccstatusline.nix</path>
        <kind>npm package derivation (infra migration source)</kind>
        <symbol>ccstatusline production derivation</symbol>
        <lines>1-85 (complete file)</lines>
        <reason>COPY SOURCE for Story 1.10D. Production-validated npm tarball package (85 lines). Copy directly to test-clan pkgs/by-name/cc/ccstatusline/package.nix with ZERO modifications. Validates infra derivation works in dendritic context.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/infra/overlays/packages/</path>
        <kind>infra overlay directory (migration analysis)</kind>
        <symbol>4 production packages</symbol>
        <lines>Explore: atuin-format/, markdown-tree-parser.nix, starship-jj.nix</lines>
        <reason>Migration source for Epic 2-6. All 4 packages use lib.packagesFromDirectoryRecursive (SAME as pkgs-by-name-for-flake-parts). Document migration path in AC H (directory restructuring effort, risk assessment).</reason>
      </artifact>

      <!-- test-clan: Target Repository -->
      <artifact>
        <path>~/projects/nix-workspace/test-clan/flake.nix</path>
        <kind>flake configuration (test-clan target)</kind>
        <symbol>inputs section</symbol>
        <lines>Search for: inputs section</lines>
        <reason>TARGET for AC A. Add pkgs-by-name-for-flake-parts flake input here. Use drupol flake.nix as reference for exact syntax.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/nixpkgs.nix</path>
        <kind>flake-parts module (test-clan target)</kind>
        <symbol>nixpkgs module exports</symbol>
        <lines>Read entire file</lines>
        <reason>TARGET for AC A. Import pkgs-by-name-for-flake-parts flake module, configure pkgsDirectory in perSystem. Use drupol modules/nixpkgs.nix as reference pattern.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/home/ai/claude-code/default.nix</path>
        <kind>home-manager module (test-clan consumption test)</kind>
        <symbol>claude-code settings</symbol>
        <lines>Search for: ccstatusline-settings.nix, statusLine configuration</lines>
        <reason>TARGET for AC F. Currently has ccstatusline-settings.nix (175 lines) waiting for package. Update to consume pkgs.ccstatusline after package created. Validates module consumption pattern.</reason>
      </artifact>

      <artifact>
        <path>~/projects/nix-workspace/test-clan/pkgs/by-name/cc/ccstatusline/package.nix</path>
        <kind>package derivation (NEW, to be created)</kind>
        <symbol>ccstatusline package</symbol>
        <lines>N/A (create from infra overlays/packages/ccstatusline.nix)</lines>
        <reason>CREATE for AC C. Copy infra ccstatusline.nix (85 lines) to this path. Directory structure follows nixpkgs RFC 140 (cc = first 2 chars of ccstatusline). Zero modifications needed.</reason>
      </artifact>
    </code>

    <dependencies>
      <nix>
        <package name="pkgs-by-name-for-flake-parts" version="from flake inputs" source="github:drupol/pkgs-by-name-for-flake-parts">
          Flake-parts module providing auto-discovery of packages in pkgs/by-name/ directory following nixpkgs RFC 140 convention. Uses lib.packagesFromDirectoryRecursive under the hood (SAME as infra). Zero boilerplate: just set pkgsDirectory option.
        </package>
        <package name="nodejs" version="from nixpkgs" source="nixpkgs">
          Node.js runtime required for ccstatusline npm package. Dependency of buildNpmPackage. Already available in test-clan nixpkgs.
        </package>
        <package name="jq" version="from nixpkgs" source="nixpkgs">
          JSON processor for metadata inspection (AC E validation). Used to eval package metadata.
        </package>
      </nix>
    </dependencies>
  </artifacts>

  <constraints>
**Architectural Constraints:**

1. **Three-Layer Pattern Architecture (CRITICAL):**
   - Layer 1 (Definition): pkgs/by-name/ package derivations (callPackage signature, standard nix derivations)
   - Layer 2 (Export): modules/nixpkgs.nix flake-parts module (pkgs-by-name-for-flake-parts integration, perSystem exports)
   - Layer 3 (Consumption): Dendritic modules access via pkgs.ccstatusline (home-manager modules, system configs)
   - CRITICAL: Layers are orthogonal, zero overlap (prevents "where does my code go?" confusion)
   - DO NOT mix layer concerns (e.g., don't put flake-parts module config in package derivation)

2. **pkgs-by-name-for-flake-parts Pattern (drupol PRIMARY):**
   - Uses lib.packagesFromDirectoryRecursive under the hood (SAME function infra uses)
   - Directory structure: pkgs/by-name/&lt;first-2-chars&gt;/&lt;package-name&gt;/package.nix (nixpkgs RFC 140)
   - Auto-discovery: No manual package lists, no overlay boilerplate
   - Configuration: Single pkgsDirectory option in perSystem
   - Reference: drupol-dendritic-infra (9 packages, proven production)
   - DO NOT create manual overlays, DO NOT list packages explicitly

3. **infra Migration Architecture:**
   - Current: overlays/packages/ with lib.packagesFromDirectoryRecursive
   - Target: pkgs/by-name/ with pkgs-by-name-for-flake-parts
   - Change: Directory restructuring ONLY (SAME underlying function)
   - Packages: ccstatusline (npm), atuin-format (rust), markdown-tree-parser (rust), starship-jj (rust)
   - Effort: 2.5-3h total for all 4 packages (directory moves + flake input + module config)
   - Risk: LOW (proven pattern, compatible function)

4. **ccstatusline Test Case:**
   - Production-ready derivation: infra overlays/packages/ccstatusline.nix (85 lines)
   - Copy with ZERO modifications (derivation is production-validated)
   - npm tarball pattern: Pre-built dist/ directory, no compilation step
   - Settings pre-configured: test-clan ccstatusline-settings.nix (175 lines, waiting for package)
   - Validates full workflow: build → export → consumption → activation

5. **Dendritic Compatibility:**
   - Pattern A modules (Story 1.10BA) provide foundation for package consumption
   - Import-tree auto-discovery works with pkgs-by-name (orthogonal patterns per gaetanlepage)
   - Package definition is NOT a flake-parts module (just derivation)
   - Package EXPORT via flake module (modules/nixpkgs.nix)
   - Package CONSUMPTION in dendritic modules (claude-code/default.nix via pkgs.*)
   - NO specialArgs pass-thru needed (pkgs available in all modules via perSystem)

6. **Build Requirements:**
   - nix build .#ccstatusline MUST succeed (AC D)
   - nix build .#packages.aarch64-darwin.ccstatusline MUST succeed (AC D, full path)
   - nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage MUST succeed (AC F)
   - nix-store -q --references result/ MUST include ccstatusline (AC F, activation closure)
   - nix flake check MUST pass with no evaluation errors (AC A, Gate 1)

7. **Documentation Requirements (AC I):**
   - Section 13.1 in test-clan-validated-architecture.md (create new section)
   - Structure: Pattern overview + ccstatusline complete example + infra migration guide
   - Depth: Comprehensive tutorial (NOT brief reference)
   - Audience: Future Epic 2-6 developers executing package migration
   - Integration: Standalone section, link to Dendritic Overlay Pattern Review for research

8. **Epic 1 Validation Mission:**
   - This is VALIDATION story, NOT feature delivery
   - Each AC validates a pattern element for Epic 2-6 readiness
   - Success = Epic 2-6 confidence (proven pattern works with dendritic + clan)
   - Documentation = Epic 2-6 migration template (reusable for 4 packages)
   - Completes Epic 1 architectural coverage: 90% → 95%

9. **Quality Gate Standards (4 gates):**
   - Gate 1: Infrastructure Setup (AC A-B) - nix flake check passes
   - Gate 2: Build Validation (AC C-D-E) - nix build .#ccstatusline succeeds, executable exists
   - Gate 3: Integration Validation (AC F-G) - home-manager activation includes package, dendritic compatible
   - Gate 4: Documentation Review (AC H-I) - Section 13.1 complete, infra migration documented

10. **Story Dependencies:**
    - Story 1.10C (done): sops-nix infrastructure validates Pattern A + external modules work
    - Dendritic Overlay Pattern Review (2025-11-16): Provides architectural guidance and drupol identification
    - Blocks Story 1.10E (backlog): ccstatusline feature enablement requires package from this story
    - Blocks Epic 1 checkpoint (backlog): Overlay validation critical for Epic 2-6 GO decision
  </constraints>

  <interfaces>
**pkgs-by-name-for-flake-parts Flake Integration:**

```nix
# flake.nix (AC A)
inputs.pkgs-by-name-for-flake-parts.url = "github:drupol/pkgs-by-name-for-flake-parts";

# modules/nixpkgs.nix (AC A)
{ inputs, ... }:
{
  imports = [ inputs.pkgs-by-name-for-flake-parts.flakeModule ];

  perSystem = { ... }: {
    pkgsDirectory = ../../pkgs/by-name;
  };
}
```

**Package Derivation Interface (AC C):**

```nix
# pkgs/by-name/cc/ccstatusline/package.nix
# Standard callPackage signature (NO flake-parts specific params)
{ lib, buildNpmPackage, fetchzip, jq, nix-update-script }:

buildNpmPackage (finalAttrs: {
  pname = "ccstatusline";
  version = "2.0.21";

  src = fetchzip {
    url = "https://registry.npmjs.org/ccstatusline/-/ccstatusline-${finalAttrs.version}.tgz";
    hash = "sha256-sy9ZLN7Q8m8Gx2VkmtnSSg1CkAL8o6fRjnHuOLr+Y0Q=";
  };

  # npm tarball pattern: pre-built dist/, no npmBuild
  dontNpmBuild = true;

  meta = {
    description = "Highly customizable status line formatter for Claude Code CLI";
    homepage = "https://github.com/sirmalloc/ccstatusline";
    license = lib.licenses.mit;
    mainProgram = "ccstatusline";
  };
})
```

**Package Auto-Discovery Interface (AC D):**

```bash
# Build commands (both forms work)
nix build .#ccstatusline                                  # Short form
nix build .#packages.aarch64-darwin.ccstatusline          # Full path

# Eval package metadata
nix eval .#packages.aarch64-darwin.ccstatusline.meta.description
# Expected: "Highly customizable status line formatter for Claude Code CLI"

# Package exports automatically to:
# - packages.&lt;system&gt;.ccstatusline (flat output, AC D requirement)
```

**Module Consumption Interface (AC F):**

```nix
# modules/home/ai/claude-code/default.nix (Pattern A module)
{ pkgs, ... }:
{
  programs.claude-code.settings.statusLine = {
    type = "command";
    command = "${pkgs.ccstatusline}/bin/ccstatusline";  # Access via pkgs.*
    padding = 0;
  };
}

# Build home-manager activation (AC F validation)
nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage

# Verify in closure (AC F validation)
nix-store -q --references result/ | grep ccstatusline
# Expected: /nix/store/...-ccstatusline-2.0.21
```

**Dendritic Compatibility Checklist (AC G):**

1. Package definition is NOT a flake-parts module (just derivation) ✓
2. Package EXPORT via flake module (modules/nixpkgs.nix) ✓
3. Package CONSUMPTION in dendritic module (claude-code/default.nix) ✓
4. NO specialArgs pass-thru needed (pkgs available in all modules) ✓
5. Import-tree auto-discovery doesn't conflict with pkgs-by-name ✓
6. Pattern matches drupol-dendritic-infra architecture ✓

**infra Migration Path (AC H):**

| Package              | Source Path                                | Target Path                                      | Effort | Notes                                  |
|----------------------|--------------------------------------------|--------------------------------------------------|--------|----------------------------------------|
| ccstatusline         | overlays/packages/ccstatusline.nix         | pkgs/by-name/cc/ccstatusline/package.nix         | 15 min | ✅ Validated in Story 1.10D             |
| atuin-format         | overlays/packages/atuin-format/            | pkgs/by-name/at/atuin-format/package.nix         | 30 min | Rust package, directory already exists |
| markdown-tree-parser | overlays/packages/markdown-tree-parser.nix | pkgs/by-name/ma/markdown-tree-parser/package.nix | 30 min | Rust package, single file              |
| starship-jj          | overlays/packages/starship-jj.nix          | pkgs/by-name/st/starship-jj/package.nix          | 30 min | Rust package, single file              |

Total effort: 2.5-3 hours (directory restructuring only, no code changes)
Risk: LOW (SAME underlying function, proven pattern)
  </interfaces>

  <tests>
    <standards>
**Build Validation Standards (Quality Gate 2):**
Package build must succeed with executable output. Validate nix build .#ccstatusline produces result/bin/ccstatusline with correct permissions (executable). Verify runtime dependencies include nodejs and ccstatusline package. Package metadata must be complete (description, homepage, license, mainProgram).

**Integration Validation Standards (Quality Gate 3):**
Home-manager activation must include ccstatusline package in closure. Validate nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage succeeds. Verify nix-store -q --references result/ includes ccstatusline derivation. Module consumption via pkgs.ccstatusline must resolve correctly.

**Dendritic Compatibility Standards (AC G):**
Package pattern must match drupol-dendritic-infra architecture. Verify three-layer separation (definition, export, consumption). Confirm import-tree auto-discovery coexists with pkgs-by-name. Validate no specialArgs pass-thru required.

**Documentation Standards (Quality Gate 4):**
Section 13.1 must be comprehensive tutorial (NOT brief reference). Include pattern overview, ccstatusline complete example (derivation + build + integration), infra migration guide (4 packages table with effort estimates). Audience: Epic 2-6 developers.
    </standards>

    <locations>
      - ~/projects/nix-workspace/test-clan/ (target repository for all implementations)
      - Manual validation commands in work item Dev Notes (AC D-E-F validation)
      - Build commands: nix build .#ccstatusline, nix build .#homeConfigurations...
      - Documentation: docs/notes/development/test-clan-validated-architecture.md Section 13.1
    </locations>

    <ideas>
**Test Idea 1 (AC D): Package Auto-Discovery**
- Map to: AC D (Validate Package Auto-Discovery)
- Commands:
  - nix build .#ccstatusline (short form)
  - nix build .#packages.aarch64-darwin.ccstatusline (full path)
  - nix eval .#packages.aarch64-darwin.ccstatusline.meta.description
- Expected: Both builds succeed, metadata resolves correctly, auto-discovery working

**Test Idea 2 (AC E): Package Build Quality**
- Map to: AC E (Validate Package Build Quality)
- Commands:
  - ls -la result/bin/
  - file result/bin/ccstatusline
  - test -x result/bin/ccstatusline &amp;&amp; echo "✓ Executable"
  - nix-store -q --references result/
- Expected: Executable exists with correct permissions, runtime deps include nodejs + ccstatusline

**Test Idea 3 (AC F): Module Consumption**
- Map to: AC F (Test Module Consumption)
- Commands:
  - nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage
  - nix-store -q --references result/ | grep ccstatusline
- Expected: Build succeeds, ccstatusline in activation closure, pkgs.ccstatusline resolves

**Test Idea 4 (AC G): Dendritic Compatibility**
- Map to: AC G (Validate Dendritic Compatibility)
- Validation:
  - Package definition is NOT flake-parts module (check package.nix structure)
  - Package exported via modules/nixpkgs.nix (check flake module import)
  - Package consumed via pkgs.* in claude-code/default.nix
  - NO specialArgs pass-thru needed (pkgs available in all dendritic modules)
  - Import-tree discovers modules correctly (no conflicts)
  - Pattern matches drupol architecture (compare structures)
- Expected: All 6 compatibility checks pass

**Test Idea 5 (AC H): infra Migration Readiness**
- Map to: AC H (Validate infra Migration Readiness)
- Validation:
  - Document 4 packages (ccstatusline, atuin-format, markdown-tree-parser, starship-jj)
  - Verify all use standard callPackage signatures (check infra derivations)
  - Confirm lib.packagesFromDirectoryRecursive pattern matches pkgs-by-name (SAME function)
  - Create migration table (source path → target path, effort per package)
- Expected: Migration path documented, effort validated (2.5-3h total), assessment: SAFE TO MIGRATE
    </ideas>
  </tests>
</story-context>
