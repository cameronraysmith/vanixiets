<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.10BA</storyId>
    <title>Refactor Home-Manager Modules from Pattern B to Pattern A (Drupol Multi-Aggregate)</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-10BA-refactor-pattern-a.md</sourceStoryPath>
    <implementationRepository>~/projects/nix-workspace/test-clan/</implementationRepository>
    <managementRepository>~/projects/nix-workspace/infra/</managementRepository>
    <criticalCorrection>true</criticalCorrection>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to refactor the 17 migrated home-manager modules from Pattern B (underscore directories, plain modules) to Pattern A (drupol multi-aggregate dendritic)</iWant>
    <soThat>full functionality is restored (flake inputs, sops-nix compatibility, custom packages) and Story 1.10C can proceed with working modules</soThat>
    <tasks>
      <task n="1" title="Validation Experiment - Prove Pattern A Works (AC: 1-2)">
        <subtask>Convert git.nix to Pattern A</subtask>
        <subtask>Test import-tree auto-discovery</subtask>
        <subtask>Update crs58 user module for validation</subtask>
        <subtask>Build validation: homeConfigurations.aarch64-darwin.crs58</subtask>
        <subtask>Decision gate: SUCCESS → proceed | FAILURE → analyze and adjust</subtask>
      </task>
      <task n="2" title="Organize Aggregate Namespace Structure (AC: 3-5)">
        <subtask>Create aggregate directory structure (development, ai, shell)</subtask>
        <subtask>Document aggregate organization rationale</subtask>
        <subtask>Verify import-tree discovery</subtask>
      </task>
      <task n="3" title="Refactor Priority 1 Modules (development aggregate) (AC: 6)">
        <subtask>Refactor git.nix (if not done in Task 1)</subtask>
        <subtask>Refactor jujutsu.nix</subtask>
        <subtask>Refactor neovim modules</subtask>
        <subtask>Refactor wezterm, zed, starship, zsh</subtask>
        <subtask>Clean up _development/ directory</subtask>
      </task>
      <task n="4" title="Refactor Priority 2 Modules (ai aggregate) (AC: 7)">
        <subtask>Refactor claude-code modules (default, mcp-servers, wrappers, ccstatusline-settings)</subtask>
        <subtask>Note disabled features for Task 7 restoration</subtask>
        <subtask>Clean up _tools/claude-code/ directory</subtask>
      </task>
      <task n="5" title="Refactor Priority 3 Modules (shell aggregate) (AC: 8)">
        <subtask>Refactor shell modules (atuin, yazi, zellij, tmux, bash, nushell)</subtask>
        <subtask>Note catppuccin-nix tmux integration for restoration</subtask>
        <subtask>Clean up _tools/ directory</subtask>
      </task>
      <task n="6" title="Update User Modules for Aggregate Imports (AC: 9-10)">
        <subtask>Update crs58 user module (remove 17 relative imports, add 3 aggregate imports)</subtask>
        <subtask>Update raquel user module (remove 7 relative imports, add 2 aggregate imports)</subtask>
        <subtask>Build validation for both users</subtask>
      </task>
      <task n="7" title="Restore Disabled Features (AC: 11-16)">
        <subtask>Restore SSH signing (git.nix, jujutsu.nix with flake.config)</subtask>
        <subtask>Restore MCP API keys (mcp-servers.nix, 3 servers re-enabled)</subtask>
        <subtask>Restore GLM wrapper (wrappers.nix)</subtask>
        <subtask>Restore nix-ai-tools package (if flake input configured)</subtask>
        <subtask>Investigate and restore ccstatusline (if available)</subtask>
        <subtask>Restore catppuccin-nix tmux theme (if flake input configured)</subtask>
      </task>
      <task n="8" title="Build Validation and Regression Testing (AC: 17-21)">
        <subtask>homeConfigurations validation (crs58 + raquel)</subtask>
        <subtask>darwinConfigurations validation (blackphos - CRITICAL FIX)</subtask>
        <subtask>Package diff analysis (Pattern B vs Pattern A)</subtask>
        <subtask>Test suite validation (all existing tests)</subtask>
        <subtask>Feature validation checklist</subtask>
      </task>
      <task n="9" title="Documentation (AC: 22-24)">
        <subtask>Update story dev notes (transformation, rationale, references)</subtask>
        <subtask>Update architecture documentation (Pattern A standard)</subtask>
        <subtask>Document Story 1.10B lessons learned</subtask>
        <subtask>Final commit and summary</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" category="A-Validation-Experiment">
      Single Module Pattern A Conversion:
      - Convert ONE module (git.nix) to Pattern A as proof-of-concept
      - Create development aggregate namespace: flake.modules.homeManager.development
      - Wrap git.nix in dendritic export: flake.modules.homeManager.development = { config, pkgs, lib, flake, ... }: { programs.git = { ... }; }
      - Move modules/home/_development/git.nix → modules/home/development/git.nix (remove underscore)
      - Verify import-tree auto-discovers new location (no underscore prevention)
    </criterion>
    <criterion id="AC2" category="A-Validation-Experiment">
      Validation Experiment Integration:
      - Import in crs58 user module: imports = [ config.flake.modules.homeManager.development ];
      - Build validation: nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage succeeds
      - Verify flake context accessible in git.nix module (can access flake.inputs, flake.config)
      - If successful: Proceed with full refactoring (AC B-H)
      - If fails: Analyze root cause (infinite recursion, evaluation errors), adjust approach
      - Estimated Time: 1 hour (de-risks full refactoring)
    </criterion>
    <criterion id="AC3" category="B-Aggregate-Namespace-Organization">
      Define Three-Aggregate Structure:
      - homeManager.development (7 modules: git, jujutsu, neovim, wezterm, zed, starship, zsh)
      - homeManager.ai (4 modules: claude-code, mcp-servers, wrappers, ccstatusline-settings)
      - homeManager.shell (6 modules: atuin, yazi, zellij, tmux, bash, nushell)
      - Document aggregate organization rationale in story dev notes
    </criterion>
    <criterion id="AC6" category="C-Refactor-Existing-Modules">
      Priority 1 Modules (7 modules → development aggregate):
      - Wrap each module in dendritic export wrapper
      - Before: { config, pkgs, lib, ... }: { programs.git = { ... }; }
      - After: { flake.modules.homeManager.development = { config, pkgs, lib, flake, ... }: { programs.git = { ... }; }; }
      - Refactor all 7 modules: git.nix, jujutsu.nix, neovim/, wezterm/, zed/, starship.nix, zsh.nix
      - Preserve module content (move inside wrapper, no functional changes yet)
      - Verify individual builds after each module refactoring
    </criterion>
    <criterion id="AC7" category="C-Refactor-Existing-Modules">
      Priority 2 Modules (4 modules → ai aggregate):
      - Wrap in flake.modules.homeManager.ai = { config, pkgs, lib, flake, ... }: { ... }
      - Refactor all 4 modules: claude-code/default.nix, mcp-servers.nix, wrappers.nix, ccstatusline-settings.nix
      - Move: _tools/claude-code/*.nix → ai/claude-code/*.nix
      - Note disabled features for restoration in AC E
    </criterion>
    <criterion id="AC9" category="D-Update-User-Modules">
      crs58 User Module Refactoring:
      - Change from relative imports to aggregate imports
      - Before (Pattern B): 17 relative paths like ../../_development/git.nix
      - After (Pattern A): imports = with config.flake.modules.homeManager; [ development ai shell ];
      - Remove all relative import statements
      - Verify build succeeds with aggregate imports
      - Verify all 17 modules integrated for crs58
    </criterion>
    <criterion id="AC11" category="E-Restore-Disabled-Features">
      SSH Signing (git.nix, jujutsu.nix):
      - Re-enable sops-nix blocks (flake context now available via flake parameter)
      - Use flake.config for user lookup pattern
      - git.nix: Restore sops.secrets configuration for signing key
      - jujutsu.nix: Restore sops.secrets configuration for signing key
      - Prepare for Story 1.10C clan vars migration (working sops-nix → working clan vars)
      - Verify signing key paths accessible in module
    </criterion>
    <criterion id="AC17" category="F-Build-Validation">
      homeConfigurations Validation:
      - nix build .#homeConfigurations.aarch64-darwin.crs58.activationPackage SUCCEEDS
      - nix build .#homeConfigurations.aarch64-darwin.raquel.activationPackage SUCCEEDS
      - Verify all 17 modules integrated for crs58
      - Verify 13 module subset for raquel (development + shell, no ai)
      - Record build artifacts for package diff comparison
    </criterion>
    <criterion id="AC18" category="F-Build-Validation">
      darwinConfigurations Validation (CRITICAL FIX):
      - nix build .#darwinConfigurations.blackphos.system SUCCEEDS
      - Lazyvim integration functional (flake.inputs.lazyvim accessible)
      - Previous Pattern B failure: "option 'programs.lazyvim' does not exist" RESOLVED
      - Verify full darwin system builds successfully
      - Verify no evaluation errors or warnings
    </criterion>
    <criterion id="AC20" category="G-Zero-Regression-Validation">
      Package Diff Analysis:
      - Compare Pattern B vs Pattern A package lists
      - homeConfigurations.crs58: all Pattern B packages present + restored features
      - homeConfigurations.raquel: all Pattern B packages present
      - No functionality lost from Pattern B
      - All 11 disabled features restored (or documented if blocked by external factors)
      - Record package count differences (expected: +5 to +11 packages from restored features)
    </criterion>
    <criterion id="AC22" category="H-Documentation">
      Refactoring Documentation in Story:
      - Pattern B → Pattern A transformation documented in work item dev notes
      - Why Pattern B failed (11 limitations from Story 1.10B dev notes)
      - How Pattern A solves issues (flake context access, aggregate namespaces)
      - Aggregate organization rationale (development, ai, shell following drupol pattern)
      - Reference implementations documented (gaetanlepage, drupol patterns)
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Story Definitions and Evidence -->
      <doc path="docs/notes/development/work-items/1-10BA-refactor-pattern-a.md" title="Story 1.10BA Work Item (Complete)" section="All 8 acceptance criteria categories (AC A-H), 9 tasks with subtasks" snippet="CRITICAL ARCHITECTURAL CORRECTION based on Story 1.10B empirical evidence. Refactors 17 modules from Pattern B (underscore dirs, plain modules) to Pattern A (drupol multi-aggregate). Restores 11 disabled features, fixes darwinConfigurations build failure. Validation experiment de-risks 8-10h refactoring effort. Quality baseline from Story 1.10A (445 lines, 23 artifacts, 7 interfaces, 9 test ideas)." />
      <doc path="docs/notes/development/work-items/1-10B-migrate-home-manager-modules.md" title="Story 1.10B Dev Notes (EMPIRICAL EVIDENCE)" section="Session 2 lines 767-1031: Pattern B Limitations" snippet="CRITICAL ARCHITECTURAL LIMITATIONS DISCOVERED: 11 features DISABLED (SSH signing, MCP API keys, GLM wrapper, tmux theme, custom packages), darwinConfigurations.blackphos.system FAILS TO BUILD (lazyvim error). No flake context access (plain modules signature missing flake parameter). sops-nix completely incompatible. Flake input integration impossible. All TODOs documented lines 806-903." />
      <doc path="docs/notes/development/epics/epic-1-architectural-validation-migration-pattern-rehearsal-phase-0.md" title="Epic 1 Story 1.10BA Definition" section="Lines 701-903: Complete story definition with 8 AC categories" snippet="Story 1.10BA: Refactor Pattern B → Pattern A based on Party Mode investigation findings (9/9 unanimous). Both references (gaetanlepage, drupol) use Pattern A (all-dendritic, aggregate namespaces). ZERO references use Pattern B (underscore workaround). Validation experiment (Murat's 1-hour test) de-risks full refactoring. Strategic value: Restores 11 features, fixes builds, aligns with industry standard, unblocks Story 1.10C." />
      <doc path="docs/notes/development/work-items/1-10A-migrate-user-management-inventory.context.xml" title="Story 1.10A Context XML (QUALITY BASELINE)" section="Complete 445-line context XML approved 5/5 by Party Mode" snippet="Quality standard for Story 1.10BA: 23 artifact references, 7 exact interface signatures, 9 test ideas, all 8 required sections (metadata, structure, ACs, artifacts, dependencies, constraints, interfaces, test guidance). Predicted 5/5 stars. Developer had COMPLETE technical context with zero ambiguity." />

      <!-- Architecture and Pattern Documentation -->
      <doc path="docs/notes/development/test-clan-validated-architecture.md" title="test-clan Validated Architecture Map" section="Dendritic flake-parts + clan integration patterns" snippet="Comprehensive test-clan architecture: dendritic flake-parts pattern, clan integration (metadata, machines, inventory, services), terranix infrastructure, machine configuration patterns, test harness (18 tests passing). Stories 1.1-1.7 complete. Foundation for Pattern A migration." />
      <doc path="docs/notes/development/migration-patterns.md" title="Migration Patterns Documentation (Story 1.10 created)" section="Pattern evolution: nixos-unified → dendritic + clan" snippet="Documents migration from nixos-unified to dendritic + clan patterns. Configuration reuse (modules/shared/), user management evolution, home-manager module organization. Created during Story 1.10. Needs update for Pattern A vs Pattern B comparison." />
      <doc path="docs/notes/development/dendritic-patterns.md" title="Dendritic Patterns Reference (Story 1.10 created)" section="Flake-parts dendritic architecture patterns" snippet="651-line comprehensive reference for dendritic flake-parts patterns. Module auto-discovery, namespace exports, configuration composition. Created during Story 1.10. Foundation for understanding Pattern A architecture." />
    </docs>

    <code>
      <!-- Current State (Pattern B - Migration FROM) -->
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/_development/git.nix" kind="home-manager-module" symbol="plain module with SSH signing disabled" lines="all" reason="PATTERN B EXAMPLE: Plain home-manager module signature { config, pkgs, lib, ... } WITHOUT flake parameter. Lines 16-18: TODO Story 1.10C for sops-nix signing key (DISABLED). This is the current broken state. Pattern A will add flake parameter and restore line 21 signing.key config." />
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/_tools/claude-code/mcp-servers.nix" kind="home-manager-module" symbol="MCP servers with 3 disabled secrets" lines="all" reason="PATTERN B EXAMPLE: Shows disabled sops-nix blocks. TODO Story 1.10C lines mark 3 MCP servers with API keys (firecrawl, huggingface, context7) DISABLED. 8 MCP servers without secrets work via home.file. Pattern A will re-enable sops-nix blocks using flake.config user lookup." />
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/_tools/claude-code/wrappers.nix" kind="home-manager-module" symbol="GLM wrapper completely disabled" lines="all" reason="PATTERN B EXAMPLE: Entire GLM wrapper DISABLED (sops.secrets + home.packages writeShellApplication). TODO Story 1.10C marks disabled blocks. xdg.configFile sharing still enabled. Pattern A will restore full wrapper using flake.config for API key path." />
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/_tools/tmux.nix" kind="home-manager-module" symbol="catppuccin theme removed" lines="all" reason="PATTERN B EXAMPLE: TODO Story 1.10C (lines 5-8) documents removed 36-line catppuccin.tmux block. Original block removed in commit 6b7f33f. catppuccin-nix home-manager module requires flake input, unreachable in plain modules. Pattern A will restore via flake.inputs access." />
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/users/crs58/default.nix" kind="home-manager-module" symbol="flake.modules.homeManager.users/crs58" lines="all" reason="PATTERN B USER MODULE: 17 relative imports (lines 18-37) like ../../_development/git.nix. Dendritic export at user level (line 6). Pattern A will remove relative imports, replace with 3 aggregate imports: [ development ai shell ]. Demonstrates current working user module structure that needs refactoring." />
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/users/raquel/default.nix" kind="home-manager-module" symbol="flake.modules.homeManager.users/raquel" lines="all" reason="PATTERN B USER MODULE: 7 relative imports for productivity subset. Pattern A will replace with 2 aggregate imports: [ development shell ] (no ai). Shows selective composition pattern that aggregate namespaces enable." />

      <!-- Pattern A Reference Implementations (Migration TO) -->
      <artifact path="~/projects/nix-workspace/gaetanlepage-dendritic-nix-config/modules/home/core/programs/git.nix" kind="home-manager-module" symbol="flake.modules.homeManager.core (monolithic aggregate)" lines="all" reason="PATTERN A REFERENCE (gaetanlepage): Single core aggregate containing all modules. Line 2: flake.modules.homeManager.core export. Shows monolithic approach (one big aggregate). Story 1.10BA follows drupol multi-aggregate instead, but this validates Pattern A works at scale." />
      <artifact path="~/projects/nix-workspace/drupol-dendritic-infra/modules/shell/starship.nix" kind="home-manager-module" symbol="flake.modules.homeManager.shell (multi-aggregate)" lines="all" reason="PATTERN A REFERENCE (drupol): Multi-aggregate pattern. Line 3: flake.modules.homeManager.shell export. Shows component module exports to aggregate namespace. Multiple files merge into single namespace (shell also contains bash, zsh, etc in other files). THIS IS OUR TARGET PATTERN - multi-aggregate like drupol, not monolithic like gaetanlepage." />
      <artifact path="~/projects/nix-workspace/drupol-dendritic-infra/modules/hosts/x280/default.nix" kind="nixos-machine-config" symbol="aggregate imports in host configuration" lines="97-128" reason="PATTERN A REFERENCE (drupol): Lines 121-125 show aggregate imports. home-manager.users.user imports from config.flake.modules.homeManager: [ base desktop user ]. Demonstrates selective composition pattern. User module imports 3 aggregates, host decides which apply. Story 1.10BA will use identical pattern: crs58 imports [ development ai shell ], raquel imports [ development shell ]." />

      <!-- Test Infrastructure -->
      <artifact path="~/projects/nix-workspace/test-clan/modules/checks/validation.nix" kind="test-harness" symbol="perSystem.checks validation tests" lines="all" reason="Test harness for adding TC-025 through TC-031. Shows runCommand pattern, passthru.meta.description, validation logic examples. Story 1.10A added TC-020 and TC-024. Story 1.10BA will add 7 new test cases for aggregate namespace validation." />

      <!-- Build Evidence -->
      <artifact path="~/projects/nix-workspace/test-clan/modules/machines/darwin/blackphos/default.nix" kind="darwin-machine-config" symbol="darwinConfigurations.blackphos" lines="all" reason="Machine configuration that FAILS TO BUILD in Pattern B. Build error: 'programs.lazyvim' does not exist. Requires lazyvim home-manager module from flake input, unreachable in plain modules. Pattern A will provide flake.inputs access to fix this critical build failure." />
    </code>

    <dependencies>
      <nix>
        <package name="clan-core" version="git+https://git.clan.lol/clan/clan-core" reason="Vars system for secrets (Story 1.10C dependency), inventory framework, sops-nix integration. Pattern A enables clan vars access via flake.config." />
        <package name="home-manager" version="unstable" reason="User environment management. Pattern A modules use home-manager with flake parameter (extended signature)." />
        <package name="flake-parts" version="latest" reason="Dendritic pattern foundation. Pattern A uses flake.modules.homeManager namespace exports." />
        <package name="sops-nix" version="via clan-core" reason="Secrets encryption. Pattern A restores sops-nix functionality that Pattern B broke (flake.config user lookup)." />
        <package name="nix-ai-tools" version="flake input (optional)" reason="Custom claude-code package. Pattern A can access via flake.inputs if configured. AC14 restoration depends on availability." />
        <package name="catppuccin-nix" version="flake input (optional)" reason="Tmux theme module. Pattern A can access via flake.inputs if configured. AC16 restoration depends on availability." />
      </nix>
      <tools>
        <tool name="nix build" reason="Build validation commands for homeConfigurations and darwinConfigurations. Critical for AC17-AC18 validation." />
        <tool name="nix flake check" reason="Test suite execution (24 existing tests + 7 new tests for Pattern A validation)." />
        <tool name="nix eval" reason="Namespace inspection during validation experiment: nix eval .#flake.modules.homeManager.development --apply builtins.attrNames" />
      </tools>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="VALIDATION-FIRST" priority="critical">
      Validation experiment (AC1-AC2, Task 1) MUST be completed and successful before proceeding with full refactoring (Tasks 2-9). Convert ONE module (git.nix) to Pattern A, verify build succeeds, confirm flake context accessible. This 1-hour experiment de-risks the 8-10h full refactoring investment. If experiment fails, analyze root cause (infinite recursion, evaluation errors) and adjust approach before continuing.
    </constraint>
    <constraint id="ZERO-REGRESSION" priority="critical">
      All Pattern B functionality MUST be preserved. homeConfigurations.aarch64-darwin.crs58 and raquel MUST continue building successfully with identical package sets (plus restored features). darwinConfigurations.blackphos.system MUST build (currently FAILS in Pattern B). No existing tests can break. Package diff analysis (AC20) validates zero regression.
    </constraint>
    <constraint id="INCREMENTAL-VALIDATION" priority="high">
      Build after EACH module refactoring (not just at end). Catch errors early. If a module breaks build, fix immediately before proceeding to next module. This prevents accumulating multiple broken modules and difficult-to-debug compound errors.
    </constraint>
    <constraint id="DENDRITIC-AGGREGATE-PATTERN" priority="high">
      Follow drupol multi-aggregate pattern (NOT gaetanlepage monolithic). All modules MUST export to aggregate namespaces: homeManager.development, homeManager.ai, homeManager.shell. Multiple files merge into same aggregate (e.g., git.nix and jujutsu.nix both export to homeManager.development). User modules import aggregates, not individual modules.
    </constraint>
    <constraint id="REFERENCE-ALIGNMENT" priority="medium">
      Pattern A implementation MUST align with reference implementations (gaetanlepage + drupol). Both references use dendritic exports at component level, aggregate namespaces, flake parameter in module signature. Zero references use underscore workaround (Pattern B). Party Mode investigation (9/9 unanimous) validated this as industry standard.
    </constraint>
    <constraint id="FEATURE-RESTORATION" priority="high">
      All 11 disabled features from Story 1.10B MUST be restored or documented if blocked. SSH signing (git, jujutsu), MCP API keys (3 servers), GLM wrapper, catppuccin tmux theme, nix-ai-tools package, ccstatusline. If external dependency missing (flake input not configured), document limitation clearly and defer to future work.
    </constraint>
  </constraints>

  <interfaces>
    <interface name="Pattern B module signature (CURRENT - TO BE REPLACED)" kind="home-manager-module" signature="{ config, pkgs, lib, ... }: { programs.git = { enable = true; signing.key = /* BROKEN - no flake context */; }; }" path="modules/home/_development/git.nix" reason="Current broken signature WITHOUT flake parameter. Cannot access flake.inputs or flake.config. This is what Pattern A fixes." />
    <interface name="Pattern A module signature (TARGET - AFTER REFACTORING)" kind="home-manager-module" signature="{ flake.modules.homeManager.development = { config, pkgs, lib, flake, ... }: { programs.git = { enable = true; package = flake.inputs.nix-ai-tools.packages.\${pkgs.stdenv.hostPlatform.system}.git; signing.key = config.sops.secrets.&quot;\${flake.config.\${config.home.username}.sopsIdentifier}/signing-key&quot;.path; }; }; }" path="modules/home/development/git.nix" reason="Target signature WITH flake parameter. Can access flake.inputs for custom packages, flake.config for user lookup (sops-nix pattern). This restores all disabled functionality." />
    <interface name="Pattern B user imports (CURRENT - TO BE REPLACED)" kind="home-manager-module" signature="imports = [ ../../_development/git.nix ../../_development/jujutsu.nix /* ... 17 relative paths ... */ ];" path="modules/home/users/crs58/default.nix" reason="Current relative import pattern. 17 fragile relative paths. Needs manual maintenance. Pattern A replaces with 3 aggregate imports." />
    <interface name="Pattern A user imports (TARGET - AFTER REFACTORING)" kind="home-manager-module" signature="imports = with config.flake.modules.homeManager; [ development # 7 modules ai # 4 modules shell # 6 modules ];" path="modules/home/users/crs58/default.nix" reason="Target aggregate import pattern. 3 clean namespace imports. Auto-updated when modules added to aggregates. Selective composition (raquel omits ai aggregate)." />
    <interface name="Restored sops-nix SSH signing pattern" kind="code-snippet" signature="signing.key = config.sops.secrets.&quot;\${flake.config.\${config.home.username}.sopsIdentifier}/signing-key&quot;.path;" path="modules/home/development/git.nix, jujutsu.nix" reason="Pattern A restores sops-nix user lookup. flake.config provides user lookup by username (flake.config.cameron or flake.config.crs58). User object has sopsIdentifier for secrets path construction. AC11 restoration target." />
    <interface name="Restored sops-nix MCP API keys pattern" kind="code-snippet" signature="sops.secrets.&quot;mcp-firecrawl-api-key&quot; = { sopsFile = flake.inputs.self + &quot;/secrets/users/\${flake.config.\${config.home.username}.sopsIdentifier}/mcp-api-keys.yaml&quot;; }; sops.templates.&quot;mcp-firecrawl-config&quot; = { content = builtins.toJSON { args = { apiKey = config.sops.placeholder.&quot;mcp-firecrawl-api-key&quot;; }; }; };" path="modules/home/ai/claude-code/mcp-servers.nix" reason="Pattern A restores MCP server secrets. 3 servers with API keys (firecrawl, huggingface, context7) re-enabled. flake.inputs.self provides repo root, flake.config provides user lookup. AC12 restoration target." />
    <interface name="Restored catppuccin-nix tmux theme pattern" kind="code-snippet" signature="catppuccin.tmux = { enable = true; flavor = &quot;mocha&quot;; customisation.window = { statusStyle = &quot;rounded&quot;; textFormat = &quot;#W&quot;; }; customisation.statusModule = { applicationFormat = &quot;#W&quot;; kubernetes = { icon = &quot;\uf0e7&quot;; accent = &quot;blue&quot;; }; }; };" path="modules/home/shell/tmux.nix" reason="Pattern A restores catppuccin theme (36 lines removed in commit 6b7f33f). Requires catppuccin-nix flake input providing home-manager module. flake.inputs access enables catppuccin.tmux option. AC16 restoration target." />
  </interfaces>

  <tests>
    <standards>
      Test harness uses three frameworks: nix-unit for expression evaluation (fast ~1s), runNixOSTest for VM integration (slow ~2-5min, Linux-only), runCommand for validation checks (fast ~4s). Tests in modules/checks/ auto-discovered by import-tree. Each test has passthru.meta.description and unique TC-XXX identifier. Zero regression mandate: all 24 existing tests (TC-001 through TC-024 from Stories 1.1-1.10A) MUST continue passing. Story 1.10BA adds TC-025 through TC-031 for Pattern A validation.
    </standards>
    <locations>
      modules/checks/nix-unit.nix (expression evaluation tests)
      modules/checks/integration.nix (VM integration tests, Linux-only)
      modules/checks/validation.nix (property validation tests - ADD TC-025 through TC-031 here)
      modules/checks/performance.nix (CI performance tests, skeleton)
    </locations>
    <ideas>
      <test id="TC-025" ac="AC3,AC5" description="Aggregate namespace exports test: Verify homeManager.development, homeManager.ai, homeManager.shell exist in flake.modules namespace. Use runCommand with nix eval to check attribute names. Validate 3 aggregates exported correctly." />
      <test id="TC-026" ac="AC5,AC6" description="Module merging test: Verify 7 modules merged into development aggregate. Check that git.nix + jujutsu.nix + neovim/ + wezterm/ + zed/ + starship.nix + zsh.nix all contribute to single homeManager.development namespace. Use nix eval to inspect merged options (programs.git, programs.jujutsu, programs.neovim all present)." />
      <test id="TC-027" ac="AC2,AC6" description="Flake context access test: Verify modules can access flake.inputs and flake.config. Read git.nix module, confirm flake parameter in signature. Test that flake.inputs.self and flake.config.cameron are accessible (evaluate without errors). Validates Pattern A core benefit." />
      <test id="TC-028" ac="AC9,AC10" description="User aggregate imports test: Verify crs58 imports 3 aggregates, raquel imports 2. Check modules/home/users/crs58/default.nix has imports = with config.flake.modules.homeManager; [ development ai shell ]. Check raquel has [ development shell ]. Validate selective composition pattern." />
      <test id="TC-029" ac="AC18" description="darwinConfigurations build success test: nix build .#darwinConfigurations.blackphos.system MUST succeed. This was FAILING in Pattern B with lazyvim error. Use runCommand to execute build, verify exit code 0. Critical validation that Pattern A fixes build failure." />
      <test id="TC-030" ac="AC11,AC12" description="sops-nix integration test: Verify secrets accessible with flake.config pattern. Check git.nix has signing.key using flake.config user lookup. Check mcp-servers.nix has sops.secrets blocks with flake.inputs.self paths. Validate restored sops-nix functionality." />
      <test id="TC-031" ac="AC19,AC20" description="Restored features validation test: Verify 11 disabled features status. Check SSH signing configs present (git, jujutsu), MCP servers with API keys (3 servers), GLM wrapper, catppuccin tmux theme, nix-ai-tools package. Document any features deferred due to missing flake inputs. Package count comparison (Pattern B baseline vs Pattern A, expect +5 to +11 packages)." />
    </ideas>
  </tests>

  <strategicContext>
    <empiricalEvidence>
      Story 1.10B (Session 2, 2025-11-14, commits 92bb19b..d4ef3a2) provided empirical proof that Pattern B is an architectural dead end:
      - 11 features DISABLED due to lack of flake context (SSH signing, 3 MCP API keys, GLM wrapper, ccstatusline, nix-ai-tools package, catppuccin tmux theme)
      - darwinConfigurations.blackphos.system FAILS TO BUILD (error: "option 'programs.lazyvim' does not exist")
      - Plain modules signature { config, pkgs, lib, ... } fundamentally cannot access flake.inputs or flake.config
      - sops-nix completely incompatible (requires flake.config user lookup)
      - Functional status: ~85% (core functionality present, secrets/themes/packages disabled)

      This is NOT theoretical refactoring - we have 18 commits and comprehensive dev notes (lines 767-1031) documenting every failure. Pattern B was implemented, tested, and proven broken.
    </empiricalEvidence>

    <partyModeInvestigation>
      Party Mode team (9 agents, 2025-11-14) investigated two reference implementations:
      1. gaetanlepage-dendritic-nix-config: Single core aggregate, all modules dendritic exports
      2. drupol-dendritic-infra: Multi-aggregate (base, shell, desktop), all modules dendritic exports

      Key Finding: BOTH references use Pattern A (all-dendritic, aggregate namespaces). ZERO references use Pattern B (underscore workaround).
      Team Unanimous (9/9): Refactor to Pattern A immediately. Pattern B underscore workaround prevents import-tree discovery but blocks flake context - fundamental architectural limitation.
    </partyModeInvestigation>

    <validationExperimentRationale>
      Validation experiment (AC1-AC2, Task 1, 1 hour) de-risks 8-10h full refactoring investment:
      - Convert ONE module (git.nix) to Pattern A
      - Prove dendritic export + flake context works in test-clan
      - Build validation: homeConfigurations.aarch64-darwin.crs58 succeeds
      - If fails: Analyze root cause (infinite recursion? evaluation errors?) before committing to full refactoring

      This is Murat's approach: small experiment validates theory before large implementation. If Pattern A fails in test-clan, better to discover with 1 hour invested, not 8 hours.
    </validationExperimentRationale>

    <strategicValue>
      Story 1.10BA provides critical value beyond just "refactoring":
      1. Unblocks Story 1.10C: Secrets migration needs modules with flake context for clan vars access
      2. Fixes critical build failure: darwinConfigurations.blackphos.system currently FAILS, blocking Story 1.12 physical deployment
      3. Restores 11 features: Full functionality (SSH signing, MCP API keys, GLM wrapper, themes, custom packages)
      4. Aligns with industry standard: Both gaetanlepage and drupol use Pattern A (validated by Party Mode)
      5. Validates Party Mode review: Unanimous 9/9 recommendation proven correct by empirical evidence
      6. Establishes Epic 2-6 pattern: 4 more machines (cinnabar, rosegold, argentum, stibnite) will use Pattern A (not broken Pattern B)
      7. Demonstrates evidence-based decision-making: Pattern B tried, failed, corrected based on data (not speculation)

      This is architectural correction based on empirical evidence, not premature optimization.
    </strategicValue>
  </strategicContext>
</story-context>
