<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.10A</storyId>
    <title>Migrate User Management to Clan Inventory Pattern</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-10A-migrate-user-management-inventory.md</sourceStoryPath>
    <implementationRepository>~/projects/nix-workspace/test-clan/</implementationRepository>
    <managementRepository>~/projects/nix-workspace/infra/</managementRepository>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to refactor cinnabar user configuration from direct NixOS to clan inventory users service with vars-based password management</iWant>
    <soThat>I validate the clan-core recommended pattern before Epic 2-6 scaling and establish the fleet-wide user management architecture</soThat>
    <tasks>
      <task n="1" title="Create Inventory User Instance">
        <subtask>Create modules/clan/inventory/services/users.nix</subtask>
        <subtask>Define user-cameron inventory instance</subtask>
        <subtask>Configure module reference (clan-core users service)</subtask>
        <subtask>Set role targeting (all machines)</subtask>
        <subtask>Configure user settings (groups, share, prompt)</subtask>
        <subtask>Reference user overlay via extraModules</subtask>
        <subtask>Create modules/clan/inventory/services/users/cameron.nix</subtask>
        <subtask>Configure shell preference (zsh)</subtask>
        <subtask>Set up home-manager integration</subtask>
        <subtask>Verify build succeeds</subtask>
      </task>
      <task n="2" title="Remove Direct NixOS Configuration">
        <subtask>Edit modules/machines/nixos/cinnabar/default.nix</subtask>
        <subtask>Remove users.users.cameron block (lines 109-145)</subtask>
        <subtask>Remove home-manager.users.cameron configuration</subtask>
        <subtask>Verify no duplicate user definitions</subtask>
        <subtask>Verify build succeeds after removal</subtask>
      </task>
      <task n="3" title="Generate and Validate Vars">
        <subtask>Generate vars: clan vars generate cinnabar</subtask>
        <subtask>Verify vars directory structure created</subtask>
        <subtask>Verify SOPS encryption applied</subtask>
        <subtask>Inspect encrypted secrets (JSON format validation)</subtask>
        <subtask>Deploy to cinnabar: clan machines update cinnabar</subtask>
        <subtask>SSH to cinnabar and verify /run/secrets/vars/ populated</subtask>
      </task>
      <task n="4" title="Functional Validation">
        <subtask>Test SSH login: ssh cameron@cinnabar</subtask>
        <subtask>Verify shell and sudo access</subtask>
        <subtask>Verify home-manager activated</subtask>
        <subtask>Verify no service conflicts</subtask>
      </task>
      <task n="5" title="Test Harness Updates">
        <subtask>Run existing test suite: nix flake check</subtask>
        <subtask>Verify all 14 existing tests passing</subtask>
        <subtask>Add TC-024 vars validation tests to modules/checks/validation.nix</subtask>
        <subtask>Run updated test suite</subtask>
      </task>
      <task n="6" title="Documentation">
        <subtask>Create docs/notes/architecture/user-management.md</subtask>
        <subtask>Create docs/guides/adding-users.md</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" category="A-Inventory-User-Instances">
      User Inventory Instance Created:
      - Create modules/clan/inventory/services/users.nix in test-clan repository
      - Define user-cameron inventory instance
      - Module specification: { name = "users"; input = "clan-core"; }
      - Role targeting: roles.default.tags.all = { }; (deploys to all machines)
      - Settings configured: user = "cameron", groups = ["wheel" "networkmanager"], share = true, prompt = false
      - extraModules: Reference user overlay file
    </criterion>
    <criterion id="AC2" category="A-Inventory-User-Instances">
      User Overlay Created:
      - Create modules/clan/inventory/services/users/cameron.nix in test-clan repository
      - Shell preference: users.users.cameron.shell = pkgs.zsh
      - Home-manager integration via extraModules pattern
      - Platform-specific configuration not handled by users service
    </criterion>
    <criterion id="AC3" category="B-Direct-NixOS-Configuration-Removal">
      Remove Direct User Configuration:
      - Remove users.users.cameron from modules/machines/nixos/cinnabar/default.nix
      - Remove home-manager.users.cameron from machine config (now in overlay)
      - Verify no duplicate user definitions remain
      - Verify build succeeds after removal
    </criterion>
    <criterion id="AC4" category="C-Vars-System-Validation">
      Vars Generation and Encryption:
      - Generate vars: clan vars generate cinnabar (or automatic during deployment)
      - User password vars created in vars/shared/user-password-cameron/
      - SOPS encryption validated
      - Verify vars are properly encrypted (not plaintext)
    </criterion>
    <criterion id="AC5" category="C-Vars-System-Validation">
      Deployment Validation:
      - Deploy to cinnabar: clan machines update cinnabar succeeds
      - Verify /run/secrets/vars/user-password-cameron/user-password-hash exists on cinnabar
      - Verify vars properly populated in runtime secrets
    </criterion>
    <criterion id="AC6" category="D-Functional-Validation">
      User Login and Access:
      - SSH login works: ssh cameron@cinnabar
      - Home-manager activated: ssh cameron@cinnabar "echo $SHELL" shows zsh
      - Sudo access works: cameron in wheel group, passwordless sudo configured
      - User identity preserved: git config, SSH keys, development environment intact
    </criterion>
    <criterion id="AC7" category="D-Functional-Validation">
      Home-Manager Integration:
      - Verify crs58 home module correctly applied to cameron user
      - Verify shell configuration active (zsh + oh-my-zsh)
      - Verify development tools available
      - Verify no home-manager service conflicts or errors
    </criterion>
    <criterion id="AC8" category="E-Test-Coverage">
      Regression Testing:
      - All 14 existing regression tests from Story 1.9/1.10 continue passing
      - No build regressions introduced
      - No deployment regressions introduced
    </criterion>
    <criterion id="AC9" category="E-Test-Coverage">
      New Vars Validation Tests (TC-024):
      - Vars list test: clan vars list cinnabar | grep user-password-cameron
      - SOPS encryption test: Verify secret files are encrypted JSON
      - Deployment test: Verify /run/secrets populated correctly
      - Home-manager integration test: Verify shell, configs activated
      - Add tests to test harness in modules/checks/validation.nix
    </criterion>
    <criterion id="AC10" category="F-Documentation">
      Architecture Decision Documentation:
      - Create or update docs/notes/architecture/user-management.md in test-clan
      - Document inventory users service pattern (how it works)
      - Document vars system for password management (automatic generation, encryption)
      - Include party-mode investigation findings summary
      - Explain rationale for inventory adoption (scalability for Epic 2-6)
    </criterion>
    <criterion id="AC11" category="F-Documentation">
      Operational Guide:
      - Create docs/guides/adding-users.md in test-clan
      - How to add new user to inventory (define instance, create overlay)
      - How to generate vars for new machines
      - How to deploy user configuration
      - Examples for Epic 2-6 (argentum, rosegold, stibnite)
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Epic and Story Definitions -->
      <doc path="docs/notes/development/epics/epic-1-architectural-validation-migration-pattern-rehearsal-phase-0.md" title="Epic 1 Definition" section="Story 1.10A (lines 432-560)" snippet="Comprehensive story definition including architectural investigation findings from party-mode review. Documents clan-core inventory users service pattern, proven developer patterns (pinpox 8x3, mic92 9/128), dendritic + inventory compatibility validation, vars vs sops-nix productivity comparison (5-10x improvement), strategic rationale for refactoring with 1 machine vs 5 machines." />
      <doc path="docs/notes/development/work-items/1-10A-migrate-user-management-inventory.md" title="Story 1.10A Work Item (Complete)" section="Full work item with 11 AC across 6 categories" snippet="Complete story definition with party-mode investigation findings, 6 tasks with subtasks, dev notes including implementation context, architectural context, testing standards, quick reference commands, learnings from Story 1.10, external references, and project structure notes." />
      <doc path="docs/notes/development/work-items/1-10-complete-migrations-establish-clean-foundation.md" title="Story 1.10 Completion Notes (BASELINE)" section="Task 3: Deploy cameron User to cinnabar (lines 200-250)" snippet="Story 1.10 established cameron user via direct NixOS configuration (users.users.cameron). Build successful, home-manager integrated using crs58 module with username override pattern. VPS deployment pending. This is the working baseline Story 1.10A will migrate FROM." />

      <!-- Architecture Documentation -->
      <doc path="docs/notes/development/test-clan-validated-architecture.md" title="test-clan Validated Architecture Map" section="Complete architecture overview" snippet="Comprehensive test-clan architecture documentation including dendritic flake-parts pattern, clan integration (metadata, machines, inventory, services), terranix infrastructure configuration, machine configuration patterns, test harness structure. Stories 1.1-1.7 complete with 17 test cases passing." />
      <doc path="docs/notes/development/architecture/architecture-decision-records-adrs.md" title="Architecture Decision Records" section="ADR-001 through ADR-006" snippet="Key decisions: Adopt dendritic + clan-core (ADR-001), ZFS unencrypted (ADR-002), progressive migration with stability gates (ADR-003), multi-user via standard NixOS patterns - no clan magic (ADR-005 - critical for this story)." />
    </docs>

    <code>
      <!-- Current State (Story 1.10 Baseline - Migration FROM) -->
      <artifact path="~/projects/nix-workspace/test-clan/modules/machines/nixos/cinnabar/default.nix" kind="nixos-machine-config" symbol="users.users.cameron" lines="109-145" reason="Current direct NixOS user configuration - THIS IS WHAT WE'RE MIGRATING FROM. Contains user definition, SSH keys, home-manager integration that will be removed and replaced with inventory instance." />
      <artifact path="~/projects/nix-workspace/test-clan/modules/home/users/crs58/default.nix" kind="home-manager-module" symbol="flake.modules.homeManager.users/crs58" lines="all" reason="Portable home module that will be integrated via inventory instance extraModules. Already username-configurable via mkDefault (Story 1.10 pattern). This module will be REUSED, not modified." />

      <!-- Existing Inventory Patterns (Templates for New Instance) -->
      <artifact path="~/projects/nix-workspace/test-clan/modules/clan/inventory/services/zerotier.nix" kind="inventory-service-instance" symbol="clan.inventory.instances.zerotier" lines="all" reason="TEMPLATE: Existing inventory instance pattern. Shows module reference (name + input), role targeting (machines + tags), settings structure. User instance will follow identical pattern." />
      <artifact path="~/projects/nix-workspace/test-clan/modules/clan/inventory/services/emergency-access.nix" kind="inventory-service-instance" symbol="clan.inventory.instances.emergency-access" lines="all" reason="TEMPLATE: Shows role targeting with tags.all (fleet-wide deployment). Demonstrates settings structure for service configuration. User instance will use identical tags.all targeting." />

      <!-- Clan-Core Official Implementation (THE AUTHORITATIVE PATTERN) -->
      <artifact path="~/projects/nix-workspace/clan-core/clanServices/users/default.nix" kind="clan-service-definition" symbol="clan-core users service" lines="all" reason="OFFICIAL clan-core users service implementation - THE authoritative pattern. Defines roles.default interface (user, prompt, groups, share options), perInstance nixosModule (creates users.users with hashedPasswordFile from vars), vars generator (xkcdpass + mkpasswd), perMachine settings (users.mutableUsers = false)." />

      <!-- Developer Examples (Proven Patterns at Scale) -->
      <artifact path="~/projects/nix-workspace/pinpox-clan-nixos/inventory.nix" kind="inventory-example" symbol="user-root, user-pinpox, user-lislon" lines="71-89" reason="PROVEN PATTERN: 8 machines × 3 users via inventory. Shows user-root and user-pinpox instances with module.name, roles.default.tags.all, settings (user, share), extraModules for overlays. Validates inventory pattern at scale." />

      <!-- Test Infrastructure -->
      <artifact path="~/projects/nix-workspace/test-clan/modules/checks/validation.nix" kind="test-harness" symbol="perSystem.checks" lines="all" reason="Test harness module - need to understand structure to add TC-024 vars validation tests. Shows runCommand pattern, passthru.meta.description, validation logic examples (TC-017 naming-conventions, TC-012 terraform-validate, TC-007 secrets-generation)." />

      <!-- Repository Context -->
      <artifact path="~/projects/nix-workspace/test-clan/README.md" kind="repository-documentation" symbol="test-clan overview" lines="all" reason="Repository purpose, structure, architecture, development workflow, deployment patterns, terraform workflow, testing organization. Context for understanding where new files fit and how to validate changes." />
    </code>

    <dependencies>
      <nix>
        <package name="clan-core" version="git+https://git.clan.lol/clan/clan-core" reason="Provides users service implementation, vars system, inventory framework, sops-nix integration" />
        <package name="nixpkgs" version="unstable" reason="Core NixOS packages, mkpasswd, xkcdpass for password generation" />
        <package name="home-manager" version="unstable" reason="User environment management, integrated via extraModules in inventory instance" />
        <package name="flake-parts" version="latest" reason="Dendritic pattern foundation, module organization" />
        <package name="sops-nix" version="via clan-core" reason="Secrets encryption (used by vars system), SOPS-based secret management" />
      </nix>
      <tools>
        <tool name="clan CLI" reason="Vars generation (clan vars generate), deployment (clan machines update), secrets management (clan secrets get)" />
        <tool name="nix build" reason="Build validation (nix build .#nixosConfigurations.cinnabar.config.system.build.toplevel)" />
        <tool name="nix flake check" reason="Test suite execution (14 existing tests + TC-024 new tests)" />
        <tool name="ssh" reason="Functional validation (ssh cameron@cinnabar), home-manager verification" />
      </tools>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="ZERO-REGRESSION" priority="critical">
      All 14 existing tests from Story 1.9/1.10 MUST continue passing. This is a refactoring story - all existing functionality (SSH login, home-manager, sudo access, user identity) must be preserved exactly. Build outputs should be functionally equivalent before and after migration.
    </constraint>
    <constraint id="DENDRITIC-COMPLIANCE" priority="high">
      All new modules MUST follow dendritic flake-parts patterns: modules export to flake.modules namespace, auto-discovered by import-tree, no manual imports in flake.nix. User inventory instance goes in modules/clan/inventory/services/users.nix, user overlay in modules/clan/inventory/services/users/cameron.nix.
    </constraint>
    <constraint id="INVENTORY-TARGETING" priority="high">
      User instance MUST use roles.default.tags.all targeting for fleet-wide deployment. This validates the inventory pattern for Epic 2-6 scaling (6 machines × 4+ users). Per-machine targeting would defeat the scalability purpose of this story.
    </constraint>
    <constraint id="VARS-SYSTEM-USAGE" priority="high">
      Password management MUST use clan vars system (automatic generation via xkcdpass, SOPS encryption, share = true for cross-machine consistency). Do NOT use manual sops-nix definitions. Vars system is the clan-core recommended pattern and provides 5-10x productivity improvement for Epic 2-6.
    </constraint>
    <constraint id="HOME-MANAGER-PATTERN" priority="medium">
      Home-manager integration MUST use extraModules pattern in inventory instance to reference user overlay. Overlay imports portable crs58 module with username override. This maintains separation of concerns: inventory defines user, overlay defines environment.
    </constraint>
    <constraint id="NO-DUPLICATE-DEFINITIONS" priority="high">
      After inventory instance created, ALL direct NixOS user config MUST be removed from modules/machines/nixos/cinnabar/default.nix. Duplicate user definitions will cause build failures. Verify no users.users.cameron or home-manager.users.cameron remains in machine config.
    </constraint>
  </constraints>

  <interfaces>
    <interface name="clan.inventory.instances.user-cameron" kind="inventory-instance" signature="clan.inventory.instances.user-cameron = { module = { name = &quot;users&quot;; input = &quot;clan-core&quot;; }; roles.default.tags.all = { }; roles.default.settings = { user = &quot;cameron&quot;; groups = [&quot;wheel&quot; &quot;networkmanager&quot;]; share = true; prompt = false; }; roles.default.extraModules = [ ./users/cameron.nix ]; };" path="modules/clan/inventory/services/users.nix" reason="Primary interface for this story - creates user-cameron inventory instance using clan-core users service" />
    <interface name="users.users.cameron overlay" kind="nixos-module" signature="{ config, pkgs, lib, ... }: { users.users.cameron.shell = pkgs.zsh; home-manager.users.cameron = { imports = [ flakeModulesHome.&quot;users/crs58&quot; ]; home.username = &quot;cameron&quot;; home.homeDirectory = &quot;/home/cameron&quot;; }; }" path="modules/clan/inventory/services/users/cameron.nix" reason="User overlay providing shell preference and home-manager integration via extraModules pattern" />
    <interface name="clan.core.vars.generators.user-password-cameron" kind="vars-generator" signature="Automatic generator created by users service: generates user-password and user-password-hash files, uses xkcdpass for generation, mkpasswd for hashing, SOPS encryption, share setting controls cross-machine consistency" path="Implicit (defined in clan-core users service)" reason="Vars generator for cameron password - automatically created by users service, accessed via clan vars commands" />
    <interface name="flake.modules.homeManager.users/crs58" kind="home-manager-module" signature="Existing portable home module with mkDefault username/homeDirectory, provides git config, zsh, starship, development packages. Already established in Story 1.8A/1.10." path="modules/home/users/crs58/default.nix" reason="Portable home module reused via extraModules - no modifications needed, already username-configurable" />
  </interfaces>

  <tests>
    <standards>
      Test harness uses three frameworks: nix-unit for expression evaluation (fast, ~1s), runNixOSTest for VM integration (slow, ~2-5min, Linux-only), runCommand for validation/behavioral checks (fast, ~4s). Tests are organized in modules/checks/ and auto-discovered by import-tree. Each test has passthru.meta.description and unique TC-XXX identifier. Zero regression mandate requires all existing tests continue passing. New tests should follow existing patterns and be added to appropriate test module.
    </standards>
    <locations>
      modules/checks/nix-unit.nix (expression evaluation tests)
      modules/checks/integration.nix (VM integration tests, Linux-only)
      modules/checks/validation.nix (property validation tests)
      modules/checks/performance.nix (CI performance tests, skeleton)
    </locations>
    <ideas>
      <test id="TC-024-1" ac="AC4,AC5" description="Vars list test: Validate user-password-cameron appears in vars list output for cinnabar machine. Use runCommand with clan CLI to execute 'clan vars list cinnabar', grep for user-password-cameron, verify successful match." />
      <test id="TC-024-2" ac="AC4" description="SOPS encryption test: Validate vars files are encrypted JSON format. Read vars/shared/user-password-cameron/user-password/secret file, verify JSON structure (sops metadata), confirm not plaintext password." />
      <test id="TC-024-3" ac="AC5,AC6" description="Deployment test (post-deployment): Verify /run/secrets/vars/user-password-cameron/user-password-hash exists on cinnabar after deployment. SSH to cinnabar, check file exists, verify permissions 0400, confirm content is hashed password." />
      <test id="TC-024-4" ac="AC7" description="Home-manager integration test (post-deployment): Verify shell and configs active. SSH to cinnabar as cameron, echo $SHELL (expect zsh), check git config user.name, verify starship prompt, test development packages available (git, gh)." />
      <test id="TC-025" ac="AC8" description="Regression test suite: Execute all 14 existing tests (TC-001 through TC-021) via nix flake check. Verify zero failures. Document any test updates required for inventory pattern compatibility." />
    </ideas>
  </tests>
</story-context>
