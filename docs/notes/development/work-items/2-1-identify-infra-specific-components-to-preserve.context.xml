<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>Identify infra-specific components to preserve</title>
    <status>drafted</status>
    <generatedAt>2025-11-22</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/2-1-identify-infra-specific-components-to-preserve.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to identify and document all infra-specific components that must be preserved during migration</iWant>
    <soThat>the "rip the band-aid" config replacement doesn't destroy unique infra infrastructure (GitHub Actions CI/CD, TypeScript documentation website at docs.cameronraysmith.com, Cloudflare deployment automation)</soThat>
    <tasks>
### Task 1: Scan and Document GitHub Actions Workflows (AC1)

**Objective:** Identify all CI/CD workflows in `.github/workflows/` and document their purposes.

**Subtasks:**

- [ ] **1.1: List all workflow files**
  - Read `.github/workflows/` directory contents
  - Count total workflows (expected: 7 based on ls output)
  - Note file names and sizes
  - **AC Reference:** AC1

- [ ] **1.2: Document each workflow's purpose**
  - Read ci.yaml header/description (main CI pipeline)
  - Read deploy-docs.yaml header/description (Cloudflare Pages deployment)
  - Read package-release.yaml header/description (package release automation)
  - Read package-test.yaml header/description (package testing)
  - Read pr-check.yaml header/description (PR validation)
  - Read pr-merge.yaml header/description (PR merge automation)
  - Read test-composite-actions.yaml header/description (composite action testing)
  - **AC Reference:** AC1

- [ ] **1.3: Document workflow triggers and dependencies**
  - Identify triggers for each workflow (on: push, pull_request, workflow_dispatch, schedule)
  - Identify secrets used (CLOUDFLARE_API_TOKEN, NPM_TOKEN, etc.)
  - Identify external service dependencies (Cloudflare, npm registry)
  - **AC Reference:** AC1

- [ ] **1.4: Assign PRESERVE migration action**
  - Document `.github/workflows/` as MUST PRESERVE
  - Note: test-clan does NOT have GitHub Actions workflows
  - Directive: Story 2.3 MUST NOT overwrite .github/workflows/
  - **AC Reference:** AC1

**Deliverable:** GitHub Actions workflows section of preservation checklist (AC1 complete)

---

### Task 2: Document TypeScript Monorepo Structure (AC2)

**Objective:** Identify TypeScript monorepo components and document for preservation.

**Subtasks:**

- [ ] **2.1: Locate root package.json**
  - Read `/package.json` contents
  - Document package name, version, scripts
  - Identify build scripts (build, dev, test commands)
  - **AC Reference:** AC2

- [ ] **2.2: Identify monorepo workspace configuration**
  - Check if package.json uses workspaces (npm/yarn/pnpm workspaces)
  - Identify workspace packages (if monorepo structure)
  - Document workspace dependencies
  - **AC Reference:** AC2

- [ ] **2.3: Document TypeScript source directories**
  - Identify source code locations (docs/, packages/, src/ candidates)
  - Check for TypeScript config (tsconfig.json locations)
  - Document Astro/Starlight integration (if docs website)
  - Note: test-clan does NOT have TypeScript monorepo
  - **AC Reference:** AC2

- [ ] **2.4: Assign PRESERVE migration action**
  - Document package.json as MUST PRESERVE
  - Document source directories as MUST PRESERVE
  - Directive: Story 2.3 MUST NOT overwrite TypeScript monorepo files
  - Note: node_modules/ can be regenerated (not critical to preserve)
  - **AC Reference:** AC2

**Deliverable:** TypeScript monorepo section of preservation checklist (AC2 complete)

---

### Task 3: Document Cloudflare Deployment Configuration (AC3)

**Objective:** Identify Cloudflare deployment setup and document for preservation.

**Subtasks:**

- [ ] **3.1: Search for Cloudflare configuration files**
  - Search for wrangler.toml (Cloudflare Workers config)
  - Search for Cloudflare Pages configuration (may be in GitHub Actions, not separate file)
  - Check deploy-docs.yaml workflow for Cloudflare integration
  - **AC Reference:** AC3

- [ ] **3.2: Document deployment target and mechanism**
  - Identify deployment target (docs.cameronraysmith.com)
  - Document deployment mechanism (Cloudflare Pages via GitHub Actions)
  - Document build command and output directory (from deploy-docs.yaml)
  - **AC Reference:** AC3

- [ ] **3.3: Document GitHub Actions integration**
  - Read deploy-docs.yaml workflow details
  - Identify Cloudflare API token usage (secrets)
  - Document deployment triggers (push to main, manual, etc.)
  - **AC Reference:** AC3

- [ ] **3.4: Assign PRESERVE migration action**
  - Document Cloudflare config files as MUST PRESERVE (if wrangler.toml exists)
  - Note: Deploy-docs.yaml already preserved via AC1 (GitHub Actions workflows)
  - Directive: Story 2.3 MUST NOT overwrite Cloudflare deployment configuration
  - Note: test-clan does NOT have Cloudflare deployment
  - **AC Reference:** AC3

**Deliverable:** Cloudflare deployment section of preservation checklist (AC3 complete)

---

### Task 4: Identify Additional Infra-Unique Components (AC4)

**Objective:** Scan for any other infra-specific infrastructure beyond GitHub Actions, TypeScript, Cloudflare.

**Subtasks:**

- [ ] **4.1: Scan for custom scripts and tooling**
  - Check for `scripts/` directory (if exists)
  - Identify any custom automation scripts
  - Document purpose of each script
  - Assign migration action (PRESERVE if infra-specific)
  - **AC Reference:** AC4

- [ ] **4.2: Verify development documentation**
  - Confirm `docs/notes/development/` exists (known to exist from sprint-status.yaml)
  - Document contents: PRD, Architecture, Epics, Sprint status, Work items
  - Migration action: **PRESERVE** (critical project documentation)
  - Directive: Story 2.3 MUST NOT overwrite docs/notes/
  - **AC Reference:** AC4

- [ ] **4.3: Check for editor/IDE configurations**
  - Check for `.vscode/` directory (VS Code settings)
  - Check for `.editorconfig` file (editor configuration)
  - Document purpose (developer experience, code formatting)
  - Assign migration action (PRESERVE if infra-specific, REPLACE if generic)
  - **AC Reference:** AC4

- [ ] **4.4: Identify any other unique files/directories**
  - Compare infra root directory to test-clan root directory conceptually
  - Identify files present in infra but NOT in test-clan
  - Exclude nix files (those will be replaced)
  - Document purpose of each unique component
  - Assign migration action per component
  - **AC Reference:** AC4

**Deliverable:** Additional infra components section of preservation checklist (AC4 complete)

---

### Task 5: Create Comprehensive Preservation Checklist (AC5)

**Objective:** Compile all findings from Tasks 1-4 into comprehensive preservation checklist document.

**Subtasks:**

- [ ] **5.1: Create checklist document structure**
  - Create file: `docs/notes/development/work-items/story-2-1-preservation-checklist.md`
  - Add header: Story 2.1 deliverable, generated date, purpose
  - Create sections: Critical Infrastructure, Safe to Replace, Migration Strategy Summary
  - **AC Reference:** AC5

- [ ] **5.2: Populate Critical Infrastructure section**
  - Add GitHub Actions workflows (Task 1 deliverable)
  - Add TypeScript monorepo components (Task 2 deliverable)
  - Add Cloudflare deployment config (Task 3 deliverable)
  - Add development documentation (Task 4 deliverable)
  - Add any additional infra components (Task 4 deliverable)
  - **AC Reference:** AC5

- [ ] **5.3: Populate Safe to Replace section**
  - List all nix configuration files (flake.nix, modules/, hosts/, etc.)
  - List build artifacts (node_modules/, result/, .direnv/)
  - Note: These will be replaced with test-clan configs in Story 2.3
  - **AC Reference:** AC5

- [ ] **5.4: Write Migration Strategy Summary**
  - Document Story 2.3 execution plan (create clan-01 branch, copy configs, skip PRESERVE items)
  - Document zero-regression requirement (all PRESERVE components functional)
  - Provide clear directives for Story 2.3 migration
  - **AC Reference:** AC5

- [ ] **5.5: Review checklist completeness**
  - Verify all AC1-AC4 components included
  - Verify PRESERVE vs REPLACE actions clear
  - Verify Story 2.3+ guidance actionable
  - **AC Reference:** AC5

**Deliverable:** Complete preservation checklist document (AC5 complete)

---

### Task 6: Create File Exclusion List (AC6)

**Objective:** Map specific files/directories to PRESERVE (exclude from test-clan overwrite).

**Subtasks:**

- [ ] **6.1: Create exclusion list for directories**
  - List `.github/workflows/` (AC1)
  - List `docs/notes/development/` (AC4)
  - List TypeScript source directories (AC2)
  - List any additional directories from AC4
  - **AC Reference:** AC6

- [ ] **6.2: Create exclusion list for files**
  - List `/package.json` (AC2)
  - List Cloudflare config files if exist (AC3)
  - List `/README.md` if infra-specific (AC4)
  - List any additional files from AC4
  - **AC Reference:** AC6

- [ ] **6.3: Create safe-to-overwrite list**
  - List all nix files safe to replace (flake.nix, modules/, hosts/, etc.)
  - Clarify: These WILL be overwritten with test-clan configs
  - **AC Reference:** AC6

- [ ] **6.4: Document verification commands**
  - Create git diff commands to verify exclusions honored post-migration
  - Example: `git diff main..clan-01 -- .github/workflows/` (should show no changes)
  - Provide verification commands for each PRESERVE component
  - **AC Reference:** AC6

- [ ] **6.5: Integrate exclusion list into preservation checklist**
  - Add exclusion list section to preservation checklist document (from Task 5)
  - Include verification commands
  - Ensure Story 2.3 has clear actionable guidance
  - **AC Reference:** AC6

**Deliverable:** File exclusion list integrated into preservation checklist (AC6 complete)

---

### Task 7: Finalize and Save Preservation Checklist (AC7)

**Objective:** Finalize preservation checklist, validate completeness, prepare for Story 2.3 consumption.

**Subtasks:**

- [ ] **7.1: Review checklist against all ACs**
  - Verify AC1 satisfied (GitHub Actions workflows documented)
  - Verify AC2 satisfied (TypeScript monorepo documented)
  - Verify AC3 satisfied (Cloudflare config documented)
  - Verify AC4 satisfied (Additional infra components documented)
  - Verify AC5 satisfied (Comprehensive checklist created)
  - Verify AC6 satisfied (File exclusion list created)
  - **AC Reference:** AC7

- [ ] **7.2: Validate checklist completeness**
  - Confirm all critical infra components included
  - Confirm PRESERVE vs REPLACE directives clear
  - Confirm Story 2.3 execution guidance actionable
  - Confirm zero-regression requirement documented
  - **AC Reference:** AC7

- [ ] **7.3: Save final preservation checklist**
  - File path: `docs/notes/development/work-items/story-2-1-preservation-checklist.md`
  - Ensure markdown formatting correct
  - Ensure all sections complete (Critical Infrastructure, Safe to Replace, Migration Strategy, Exclusion List, Verification)
  - **AC Reference:** AC7

- [ ] **7.4: Update Story 2.1 completion notes**
  - Document checklist created and validated
  - Document all ACs 1-7 satisfied
  - Note: Checklist ready for Story 2.3 consumption
  - **AC Reference:** AC7

**Deliverable:** Final preservation checklist approved and ready for Story 2.3 (AC7 complete)
    </tasks>
  </story>

  <acceptanceCriteria>
### AC1: GitHub Actions Workflows Documented

**Requirement:** Scan `.github/workflows/` and document all CI/CD workflows with descriptions.

**Workflow Documentation Required:**
- Workflow file name (e.g., `ci.yaml`, `deploy-docs.yaml`)
- Workflow purpose (what it does - testing, deployment, release automation)
- Workflow triggers (when it runs - push, PR, manual, schedule)
- Critical dependencies (secrets, environments, external services)
- Migration action: PRESERVE (must NOT be overwritten by test-clan migration)

**Evidence Required:**
- Complete list of all workflows in `.github/workflows/`
- Description of each workflow's role in infra CI/CD
- Identification of workflows critical to infra operation
- Clear PRESERVE directive for migration (Story 2.3+)

**Validation:**
- All 7 workflows documented (ci.yaml, deploy-docs.yaml, package-release.yaml, package-test.yaml, pr-check.yaml, pr-merge.yaml, test-composite-actions.yaml)
- Purpose and triggers explained for each workflow
- PRESERVE action documented for entire `.github/workflows/` directory

---

### AC2: TypeScript Monorepo Structure Documented

**Requirement:** Document TypeScript monorepo structure including package locations, build scripts, and dependencies.

**Monorepo Documentation Required:**
- Root `package.json` location and purpose
- Monorepo workspace configuration (if using workspaces)
- Build scripts and commands (e.g., `npm run build`, `npm run dev`)
- Key dependencies (TypeScript, Astro, Starlight, build tools)
- Source code locations (e.g., `docs/`, `packages/`, `src/`)
- Migration action: PRESERVE (TypeScript code must NOT be overwritten)

**Evidence Required:**
- `package.json` file path and contents summary
- Workspace structure (if monorepo uses npm/yarn/pnpm workspaces)
- Build/dev script identification
- Source code directory identification
- Clear PRESERVE directive for TypeScript monorepo files

**Validation:**
- Root `package.json` documented with build scripts
- TypeScript source directories identified
- Node modules and build artifacts noted (can be regenerated, not critical)
- PRESERVE action documented for package.json and source directories

---

### AC3: Cloudflare Deployment Configuration Documented

**Requirement:** Document Cloudflare deployment configuration including wrangler.toml location and deployment targets.

**Cloudflare Documentation Required:**
- `wrangler.toml` file path (if exists)
- Cloudflare Pages configuration (if using Pages instead of Workers)
- Deployment target (e.g., docs.cameronraysmith.com)
- Build command and output directory
- Cloudflare integration with GitHub Actions (deploy-docs.yaml workflow)
- Migration action: PRESERVE (Cloudflare config must NOT be overwritten)

**Evidence Required:**
- Cloudflare configuration file location (wrangler.toml or Pages config)
- Deployment target documentation (docs.cameronraysmith.com)
- Build/deploy automation integration (GitHub Actions workflow)
- Clear PRESERVE directive for Cloudflare deployment files

**Validation:**
- Cloudflare deployment mechanism documented
- Integration with GitHub Actions identified (deploy-docs.yaml)
- Deployment target confirmed (docs.cameronraysmith.com)
- PRESERVE action documented for Cloudflare configuration

---

### AC4: Infra-Unique Infrastructure Identified

**Requirement:** Identify any other infra-unique infrastructure beyond GitHub Actions, TypeScript, and Cloudflare.

**Additional Infrastructure to Identify:**
- Custom scripts or tooling (e.g., `scripts/` directory)
- Documentation specific to infra (e.g., `docs/notes/` - preserve development docs)
- Configuration files unique to infra (e.g., `.vscode/`, `.editorconfig`)
- Any other files NOT present in test-clan that serve infra-specific purposes

**Evidence Required:**
- Inventory of additional infra-specific files/directories
- Purpose of each identified component
- Migration action per component (PRESERVE, ADAPT, or REPLACE)

**Validation:**
- Comprehensive scan completed (no critical infra components missed)
- Each additional component documented with purpose
- Migration actions assigned (PRESERVE/ADAPT/REPLACE)

---

### AC5: Preservation Checklist Created

**Requirement:** Create preservation checklist mapping component → file paths → migration action.

**Checklist Format:**

```markdown
# Infra-Specific Component Preservation Checklist

Generated: 2025-11-21 (Story 2.1)
Purpose: Document infra components to PRESERVE during Epic 2 migration (test-clan → infra)

## Critical Infrastructure (MUST PRESERVE)

### 1. GitHub Actions CI/CD Workflows
- **Directory:** `.github/workflows/`
- **Files:** [List all workflows from AC1]
- **Purpose:** CI/CD automation for package releases, testing, deployments
- **Migration Action:** **PRESERVE** - Do NOT overwrite with test-clan files
- **Story 2.3+ Directive:** Skip `.github/workflows/` when copying from test-clan

### 2. TypeScript Documentation Monorepo
- **Root package.json:** `/package.json`
- **Source directories:** [List from AC2]
- **Purpose:** docs.cameronraysmith.com documentation website source
- **Migration Action:** **PRESERVE** - Do NOT overwrite TypeScript code
- **Story 2.3+ Directive:** Skip package.json and source dirs when copying

### 3. Cloudflare Deployment Configuration
- **Configuration:** [From AC3]
- **Target:** docs.cameronraysmith.com
- **Integration:** deploy-docs.yaml workflow
- **Migration Action:** **PRESERVE** - Do NOT overwrite Cloudflare config
- **Story 2.3+ Directive:** Skip Cloudflare config files when copying

### 4. Additional Components
- [From AC4]

## Files/Directories Safe to Replace

### 1. Nix Configurations (REPLACE from test-clan)
- `flake.nix` - Replace with test-clan dendritic+clan pattern
- `modules/` - Replace with test-clan dendritic structure
- `hosts/` - Replace with test-clan machine configs
- `home-manager/` - Replace with test-clan Pattern A home configs
- `overlays/` - Replace with test-clan five-layer overlay architecture
- `secrets/` - Replace with test-clan sops-nix two-tier secrets

### 2. Build Artifacts (Regenerate)
- `node_modules/` - Regenerate via npm install
- `result/` - Nix build artifacts (regenerate)
- `.direnv/` - direnv cache (regenerate)

## Migration Strategy Summary

**Story 2.3 Execution Plan:**
1. Create `clan-01` branch in infra
2. Copy test-clan nix configs → infra (flake.nix, modules/, hosts/, home-manager/, overlays/, secrets/)
3. **SKIP copying** any files/directories marked PRESERVE above
4. Validate builds after migration (nix flake check, darwin/nixos configs)
5. Test GitHub Actions still functional (CI/CD workflows intact)
6. Test Cloudflare deployment still operational (docs site deploys)

**Zero-Regression Requirement:**
- All PRESERVE components must function identically pre/post-migration
- GitHub Actions workflows execute successfully
- Cloudflare deployment to docs.cameronraysmith.com operational
- TypeScript monorepo builds successfully
```

**Evidence Required:**
- Complete preservation checklist in markdown format
- All components from AC1-AC4 included
- Clear PRESERVE vs REPLACE directives for each component
- Migration strategy summary for Story 2.3+ execution

**Validation:**
- Checklist includes all GitHub Actions workflows (AC1)
- Checklist includes TypeScript monorepo components (AC2)
- Checklist includes Cloudflare deployment config (AC3)
- Checklist includes any additional infra components (AC4)
- Migration actions clear (PRESERVE/REPLACE)
- Story 2.3+ execution guidance provided

---

### AC6: Files to Preserve Clearly Mapped

**Requirement:** Document which files in infra must NOT be overwritten by test-clan files.

**File Mapping Required:**

Create explicit file/directory exclusion list for Story 2.3+ migration.

**Evidence Required:**
- Explicit exclusion list for directories and files
- Clear directives for Story 2.3+ (what NOT to overwrite)
- Verification commands to validate preservation
- Git diff commands to confirm exclusions honored

**Validation:**
- All PRESERVE components from AC1-AC4 in exclusion list
- Verification commands provided for post-migration validation
- Story 2.3+ has actionable guidance (which files to skip)
- Git diff verification ensures preservation

---

### AC7: Checklist Reviewed and Approved

**Requirement:** Preservation checklist reviewed and approved for use in Story 2.3 branch creation.

**Review Process:**
1. Story 2.1 developer creates preservation checklist (AC5 deliverable)
2. Developer validates checklist completeness against AC1-AC6
3. Developer confirms all critical infra components documented
4. Story 2.1 marked "drafted" → "ready-for-dev" after checklist finalized
5. SM/user reviews checklist before Story 2.3 execution begins

**Approval Criteria:**
- Checklist includes ALL GitHub Actions workflows (AC1)
- Checklist includes ALL TypeScript monorepo components (AC2)
- Checklist includes ALL Cloudflare deployment config (AC3)
- Checklist includes any additional infra-unique components (AC4)
- File exclusion list actionable for Story 2.3 migration (AC6)
- Migration strategy clear and follows Epic 2 "rip the band-aid" approach

**Evidence Required:**
- Preservation checklist finalized and saved to docs/notes/development/work-items/
- Story 2.1 status updated to "ready-for-dev" (checklist complete)
- Checklist ready for Story 2.3 consumption

**Validation:**
- All ACs 1-6 satisfied in final checklist
- Story 2.1 developer confirms checklist complete
- Story 2.1 ready for SM review (if required)
- Story 2.3 can proceed using preservation checklist
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Epic 2 Definition -->
      <doc path="docs/notes/development/epics/epic-2-infrastructure-architecture-migration.md" title="Epic 2: Infrastructure Architecture Migration" section="Full Document">
        Epic 2 master document defining "rip the band-aid" migration strategy from nixos-unified to dendritic+clan architecture. 4 phases, 13 stories. Story 2.1 is first Phase 1 story, blocks Stories 2.2-2.3. Migration philosophy: fast and pragmatic, trust git safety net, Epic 1 was discovery/Epic 2 is application. Preserve infra-specific components (GitHub Actions, TypeScript, Cloudflare) while replacing nix configs from test-clan.
      </doc>

      <!-- Epic 1 Retrospective - Critical "Rip the Band-Aid" Strategy Section -->
      <doc path="docs/notes/development/epic-1-retro-2025-11-20.md" title="Epic 1 Retrospective" section="Epic 2 Preview and Dependencies (lines 363-461)">
        Lines 405-421 define "rip the band-aid" migration strategy for Epic 2. Create clan-01 branch, copy validated nix configs from test-clan → infra (filesystem cp operations), preserve infra-specific components (GitHub Actions CI/CD, TypeScript monorepo, Cloudflare deployment), replace all nix configurations. Philosophy: fast and pragmatic > slow and careful. Story 2.1 identifies components to preserve (action items #6-7).
      </doc>

      <!-- Architecture Documentation - Epic 1 Validated Patterns -->
      <doc path="docs/notes/development/architecture/index.md" title="Architecture Index" section="Table of Contents">
        Architecture documentation structure covering all Epic 1 validated patterns: dendritic flake-parts, clan inventory, sops-nix two-tier secrets, home-manager Pattern A, five-layer overlays, zerotier heterogeneous networking, deployment architecture. References for Epic 2 migration technical decisions.
      </doc>

      <doc path="docs/notes/development/architecture/deployment-architecture.md" title="Deployment Architecture" section="CI/CD Integration">
        Documents CI/CD integration patterns including GitHub Actions workflows for package testing, releases, and deployments. Reference for understanding existing infra CI/CD infrastructure that must be preserved during Epic 2 migration.
      </doc>

      <!-- PRD - Epic 2 Functional Requirements -->
      <doc path="docs/notes/development/PRD/functional-requirements.md" title="Functional Requirements" section="FR-2: Production Integration (Phase 1)">
        Epic 2 Phase 1 functional requirements defining scope of home-manager migration foundation and production integration goals. Story 2.1 preservation checklist enables safe execution of FR-2 requirements.
      </doc>

      <doc path="docs/notes/development/PRD/success-criteria.md" title="Success Criteria" section="Overall Migration Success">
        Zero-regression requirement across all phases: all functionality preserved during migration, validated at each phase boundary. Story 2.1 preservation checklist critical for meeting zero-regression requirement.
      </doc>

      <!-- Sprint Status - Story 2.1 Context -->
      <doc path="docs/notes/development/sprint-status.yaml" title="Sprint Status" section="Epic 2 Development Status (lines 318-368)">
        Epic 2 status tracking: Epic 2 contexted (ready for Phase 1), Story 2.1 drafted (first backlog story), blocks Story 2.2 (diff analysis) and Story 2.3 (migration execution). Epic 2 revised scope documented with 4 phases, 13 stories, "rip the band-aid" strategy notes.
      </doc>
    </docs>
    <code>
      <!-- Infra-Specific Components to Preserve -->
      <artifact path=".github/workflows/" kind="directory" symbol="GitHub Actions CI/CD" lines="N/A" reason="7 workflow files (64 KB total) managing package releases, testing, Cloudflare deployment automation - unique to infra, NOT in test-clan">
        Workflows: ci.yaml (41 KB main CI pipeline), deploy-docs.yaml (4.6 KB Cloudflare Pages deployment), package-release.yaml (5.7 KB release automation), package-test.yaml (4.5 KB testing), pr-check.yaml (480 B PR validation), pr-merge.yaml (648 B merge automation), test-composite-actions.yaml (7.4 KB composite action testing). Migration action: MUST PRESERVE - Story 2.3 MUST NOT overwrite.
      </artifact>

      <artifact path="package.json" kind="file" symbol="Root Package Manifest" lines="1-120" reason="TypeScript monorepo root configuration - semantic-release setup, workspace configuration, build scripts - unique to infra">
        Monorepo root using bun@1.1.38, workspaces: packages/*, semantic-release with conventional commits, scripts: test-release, preview-version. Migration action: MUST PRESERVE - Story 2.3 MUST NOT overwrite.
      </artifact>

      <artifact path="packages/docs/" kind="directory" symbol="TypeScript Documentation Website" lines="N/A" reason="Astro+Starlight documentation website source code for docs.cameronraysmith.com - unique to infra">
        Documentation website: @infra/docs package, Astro v5.15.1 + Starlight v0.36.1, deployed to infra.cameronraysmith.net via Cloudflare Workers. Build scripts: dev (astro dev), build (astro build), deploy (astro build + wrangler deploy). Source in packages/docs/src/, config: astro.config.ts, wrangler.jsonc. Migration action: MUST PRESERVE - entire packages/docs/ directory.
      </artifact>

      <artifact path="packages/docs/wrangler.jsonc" kind="file" symbol="Cloudflare Workers Config" lines="1-60" reason="Cloudflare deployment configuration for docs site - routes to infra.cameronraysmith.net custom domain">
        Wrangler configuration: name "infra-docs", main "./dist/_worker.js/index.js", assets directory "./dist", custom_domain route to "infra.cameronraysmith.net". Deployment target: infra.cameronraysmith.net. Migration action: MUST PRESERVE (covered by packages/docs/ preservation).
      </artifact>

      <artifact path=".github/workflows/deploy-docs.yaml" kind="file" symbol="Cloudflare Deployment Workflow" lines="1-80" reason="GitHub Actions workflow automating Cloudflare Pages deployment of docs site">
        Workflow: Deploy docs to Cloudflare, triggers: workflow_dispatch (manual) + workflow_call (reusable), environments: preview (branch-based) + production (infra.cameronraysmith.net), uses Nix for builds, deploys via wrangler. Integration with packages/docs/ build process. Migration action: MUST PRESERVE (covered by .github/workflows/ preservation).
      </artifact>

      <artifact path="scripts/" kind="directory" symbol="Infra Automation Scripts" lines="N/A" reason="Custom scripts for CI, sops management, nix operations - infra-specific tooling">
        Scripts: bisect-nixpkgs.sh (10 KB nixpkgs bisecting), preview-version.sh (1.6 KB version preview), inspect-derivation.sh (1.6 KB derivation inspection), validate-mcp-servers.sh (5.7 KB MCP validation), verify-no-secrets-in-store.sh (4.4 KB secrets verification), verify-system.sh (3.4 KB system validation), ci/ subdirectory (CI helpers), sops/ subdirectory (secrets helpers). Migration action: PRESERVE if referenced by GitHub Actions or docs build, REPLACE if purely nix-related.
      </artifact>

      <artifact path="docs/notes/development/" kind="directory" symbol="Development Documentation" lines="N/A" reason="PRD, Architecture, Epics, Sprint status, Work items - project management documentation unique to infra">
        Development docs: PRD/ (sharded), Architecture/ (sharded), Epics/ (sharded), sprint-status.yaml, work-items/ (stories), epic-1-retro-2025-11-20.md, go-no-go-decision.md. ~3,000+ lines Epic 1 documentation. Migration action: MUST PRESERVE - Story 2.3 MUST NOT overwrite docs/notes/.
      </artifact>

      <artifact path="README.md" kind="file" symbol="Repository README" lines="1-50" reason="Infra-specific README describing nixos-unified architecture, directory-based autowiring, multi-channel overlays">
        README describes current nixos-unified architecture, links to docs.cameronraysmith.net, Quick Start with make bootstrap, Features listing directory-based autowiring. Post-Epic 2 migration will need updating to describe dendritic+clan architecture. Migration action: PRESERVE - manual update post-migration to describe new architecture.
      </artifact>

      <!-- Nix Configurations - Safe to Replace from test-clan -->
      <artifact path="flake.nix" kind="file" symbol="Nix Flake Root" lines="N/A" reason="Current nixos-unified flake - will be REPLACED with test-clan dendritic+clan pattern">
        Current nixos-unified architecture flake. Migration action: REPLACE from test-clan in Story 2.3 - part of "rip the band-aid" nix config replacement.
      </artifact>

      <artifact path="modules/" kind="directory" symbol="Nix Modules" lines="N/A" reason="Current module structure - will be REPLACED with test-clan dendritic structure">
        Current modules directory. Migration action: REPLACE from test-clan modules/ (dendritic flake-parts structure, import-tree auto-discovery, namespace exports).
      </artifact>

      <artifact path="hosts/" kind="directory" symbol="Host Configurations" lines="N/A" reason="Current host configs - will be REPLACED with test-clan machine configs">
        Current host configurations (blackphos, stibnite, etc.). Migration action: REPLACE from test-clan hosts/ (dendritic host modules).
      </artifact>

      <artifact path="home-manager/" kind="directory" symbol="Home-Manager Configs" lines="N/A" reason="Current home-manager - will be REPLACED with test-clan Pattern A home configs">
        Current home-manager configurations. Migration action: REPLACE from test-clan home-manager/ (Pattern A dendritic aggregates, portable user modules).
      </artifact>

      <artifact path="overlays/" kind="directory" symbol="Package Overlays" lines="N/A" reason="Current overlays - will be REPLACED with test-clan five-layer overlay architecture">
        Current overlay structure. Migration action: REPLACE from test-clan overlays/ (five-layer architecture: inputs, hotfixes, pkgs-by-name, overrides, flakeInputs).
      </artifact>

      <artifact path="secrets/" kind="directory" symbol="Secrets Management" lines="N/A" reason="Current secrets - will be REPLACED with test-clan sops-nix two-tier secrets">
        Current secrets configuration. Migration action: REPLACE from test-clan secrets/ (two-tier architecture: system clan vars, user-level sops-nix).
      </artifact>
    </code>
    <dependencies>
      <typescript>
        <package name="astro" version="^5.15.1" reason="Documentation site framework">
          Astro framework powering docs.cameronraysmith.net static site generation with Starlight theme integration.
        </package>
        <package name="@astrojs/starlight" version="^0.36.1" reason="Documentation theme">
          Starlight documentation theme for Astro providing structured docs UI for infra documentation website.
        </package>
        <package name="wrangler" version="^4.45.0" reason="Cloudflare Workers deployment">
          Cloudflare Wrangler CLI for deploying docs site to Cloudflare Workers at infra.cameronraysmith.net.
        </package>
        <package name="semantic-release" version="^25.0.1" reason="Automated versioning and release">
          Semantic-release for automated package versioning, changelog generation, GitHub release creation across monorepo.
        </package>
        <package name="@biomejs/biome" version="^2.3.0" reason="Linting and formatting">
          Biome for TypeScript/JavaScript linting and formatting in docs package.
        </package>
        <package name="@playwright/test" version="^1.56.1" reason="E2E testing">
          Playwright for end-to-end testing of documentation website.
        </package>
        <package name="vitest" version="^4.0.3" reason="Unit testing">
          Vitest for unit testing of documentation website components.
        </package>
      </typescript>
      <nix>
        <note>
          Nix dependencies are managed via flake inputs and will be REPLACED during Epic 2 Story 2.3 migration from test-clan. Current nixos-unified dependencies include: nixpkgs (multiple channels), flake-parts, disko, sops-nix, home-manager. Post-migration will include: dendritic flake-parts, clan-core, import-tree, lazyvim-nix, catppuccin-nix, nix-ai-tools.
        </note>
      </nix>
      <github-actions>
        <secret name="CLOUDFLARE_API_TOKEN" reason="Cloudflare deployment authentication">
          Secret used by deploy-docs.yaml workflow to authenticate with Cloudflare Workers for automated deployment.
        </secret>
        <secret name="NPM_TOKEN" reason="npm registry authentication" status="inferred">
          Likely used by package-release.yaml workflow for publishing packages to npm registry (if applicable).
        </secret>
      </github-actions>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint category="Migration Strategy" priority="CRITICAL">
      "Rip the Band-Aid" Approach: Epic 2 Story 2.3 will create clan-01 branch and copy nix configs from test-clan → infra using filesystem cp operations. Story 2.1 preservation checklist MUST document all components to EXCLUDE from copying to prevent destroying infra-unique infrastructure.
    </constraint>

    <constraint category="Zero-Regression Requirement" priority="CRITICAL">
      All PRESERVE components must function identically pre/post-migration. GitHub Actions workflows execute successfully, Cloudflare deployment to docs.cameronraysmith.com operational, TypeScript monorepo builds successfully. Validation commands must be provided in preservation checklist.
    </constraint>

    <constraint category="Story Type" priority="HIGH">
      Story 2.1 is Discovery and Documentation ONLY - no code changes, no branch creation, no file copying. Tasks: Read files, list directories, analyze configurations. Deliverable: Preservation checklist markdown document. Stories 2.2-2.3 handle execution.
    </constraint>

    <constraint category="Test-Clan Comparison" priority="HIGH">
      test-clan repository contains ONLY nix configurations (dendritic+clan architecture, home-manager, secrets, overlays). test-clan does NOT have: GitHub Actions, TypeScript monorepo, Cloudflare deployment, development docs. Story 2.1 identifies the delta (infra-specific components not in test-clan).
    </constraint>

    <constraint category="Epic 2 Dependencies" priority="HIGH">
      Story 2.1 blocks Story 2.2 (stibnite vs blackphos diff analysis) and Story 2.3 (home-manager Pattern A migration). Story 2.3 cannot execute without Story 2.1 preservation checklist - checklist is the safety mechanism for "rip the band-aid" migration.
    </constraint>

    <constraint category="Documentation Quality" priority="MEDIUM">
      Preservation checklist must meet Epic 1 Story 1.14 documentation quality standards: comprehensive evidence, clear rationale, actionable next steps. Each component documented with: file paths, purpose, migration action (PRESERVE/REPLACE), Story 2.3+ directives.
    </constraint>

    <constraint category="File Path Format" priority="MEDIUM">
      All file paths in preservation checklist must be project-relative (strip /Users/crs58/projects/nix-workspace/infra/ prefix). Example: .github/workflows/ not /Users/.../infra/.github/workflows/. Enables portable documentation across development environments.
    </constraint>
  </constraints>

  <interfaces>
    <interface name="Story 2.1 Deliverable → Story 2.3 Input" kind="documentation artifact" signature="Preservation Checklist Markdown Document">
      <definition>
        Story 2.1 produces preservation checklist at docs/notes/development/work-items/story-2-1-preservation-checklist.md

        Story 2.3 consumes checklist to determine:
        1. Which directories to EXCLUDE when copying from test-clan (e.g., .github/, packages/, docs/notes/)
        2. Which files to PRESERVE (e.g., package.json, README.md, wrangler.jsonc)
        3. Which components to REPLACE (e.g., flake.nix, modules/, hosts/, home-manager/, overlays/, secrets/)
        4. Verification commands to run post-migration (git diff main..clan-01 -- [PRESERVE path])
      </definition>
      <path>docs/notes/development/work-items/story-2-1-preservation-checklist.md</path>
    </interface>

    <interface name="Preservation Checklist Format" kind="markdown document structure" signature="Standardized Checklist Sections">
      <definition>
        Preservation checklist structure:

        1. Header: Story 2.1 deliverable, generation date, purpose
        2. Critical Infrastructure (MUST PRESERVE): GitHub Actions CI/CD, TypeScript monorepo, Cloudflare deployment, development docs, other infra-unique components
        3. Safe to Replace: Nix configurations (flake.nix, modules/, hosts/, home-manager/, overlays/, secrets/), build artifacts (node_modules/, result/, .direnv/)
        4. Migration Strategy Summary: Story 2.3 execution plan, zero-regression requirement, directives
        5. Exclusion List: Directories to skip, files to skip, verification commands

        Each component entry includes: directory/file path, purpose, migration action (PRESERVE/REPLACE), Story 2.3+ directive
      </definition>
      <path>docs/notes/development/work-items/story-2-1-preservation-checklist.md</path>
    </interface>

    <interface name="GitHub Actions Workflows" kind="CI/CD automation" signature="7 Workflow Files">
      <definition>
        GitHub Actions workflows at .github/workflows/:
        - ci.yaml: Main CI pipeline for nix builds and tests
        - deploy-docs.yaml: Cloudflare Pages deployment automation
        - package-release.yaml: Package release automation with semantic-release
        - package-test.yaml: Package testing workflows
        - pr-check.yaml: PR validation checks
        - pr-merge.yaml: PR merge automation
        - test-composite-actions.yaml: Composite action testing

        Migration constraint: MUST be preserved during Epic 2 migration, Story 2.3 MUST NOT overwrite .github/ directory
      </definition>
      <path>.github/workflows/</path>
    </interface>

    <interface name="Cloudflare Deployment" kind="documentation website hosting" signature="Wrangler + GitHub Actions Integration">
      <definition>
        Cloudflare deployment mechanism:
        1. packages/docs/: Astro+Starlight documentation source
        2. packages/docs/wrangler.jsonc: Cloudflare Workers config (route to infra.cameronraysmith.net)
        3. .github/workflows/deploy-docs.yaml: Automated deployment workflow
        4. Deployment target: https://infra.cameronraysmith.net (custom domain)
        5. Build command: astro build (in packages/docs/)
        6. Deploy command: wrangler deploy (uploads dist/ to Cloudflare Workers)

        Migration constraint: Entire chain must be preserved (packages/docs/ + wrangler.jsonc + deploy-docs.yaml)
      </definition>
      <path>packages/docs/ + .github/workflows/deploy-docs.yaml</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Story 2.1 is a discovery and documentation story, NOT an implementation story - no traditional testing required.

      Validation approach:
      1. Checklist Completeness: All ACs 1-7 addressed in final preservation checklist
      2. Component Coverage: All infra-specific components identified (GitHub Actions, TypeScript, Cloudflare, docs/notes/)
      3. Migration Action Clarity: PRESERVE vs REPLACE directives explicit for each component
      4. Story 2.3 Readiness: Exclusion list actionable, verification commands provided

      Post-migration validation (Story 2.3 responsibility):
      1. Git diff verification: git diff main..clan-01 -- [PRESERVE path] shows no changes
      2. GitHub Actions validation: Workflows execute successfully on clan-01 branch
      3. TypeScript build validation: npm run build succeeds in packages/docs/ on clan-01 branch
      4. Cloudflare deployment validation: docs.cameronraysmith.com deploys from clan-01 branch
      5. Zero-regression confirmation: All PRESERVE components function identically
    </standards>
    <locations>
      Story 2.1 deliverable location: docs/notes/development/work-items/story-2-1-preservation-checklist.md

      Story 2.3 will execute validation commands from preservation checklist:
      - git diff main..clan-01 -- .github/workflows/ (should show no changes)
      - git diff main..clan-01 -- package.json (should show no changes)
      - git diff main..clan-01 -- packages/docs/ (should show no changes)
      - git diff main..clan-01 -- docs/notes/development/ (should show no changes)
      - npm run build in packages/docs/ (should succeed)
      - GitHub Actions workflows execute (should succeed)
    </locations>
    <ideas>
      <!-- AC1: GitHub Actions Workflows Documented -->
      <test id="AC1-validation" ac="AC1" type="checklist-completeness">
        Validate preservation checklist includes all 7 GitHub Actions workflows: ci.yaml, deploy-docs.yaml, package-release.yaml, package-test.yaml, pr-check.yaml, pr-merge.yaml, test-composite-actions.yaml. Each workflow documented with purpose, triggers, dependencies, PRESERVE action.
      </test>

      <!-- AC2: TypeScript Monorepo Structure Documented -->
      <test id="AC2-validation" ac="AC2" type="checklist-completeness">
        Validate preservation checklist includes TypeScript monorepo components: root package.json, packages/docs/ directory, wrangler.jsonc, build scripts (dev, build, deploy), Astro+Starlight dependencies. PRESERVE action documented for package.json and packages/docs/.
      </test>

      <!-- AC3: Cloudflare Deployment Configuration Documented -->
      <test id="AC3-validation" ac="AC3" type="checklist-completeness">
        Validate preservation checklist includes Cloudflare deployment: wrangler.jsonc location (packages/docs/wrangler.jsonc), deployment target (infra.cameronraysmith.net), deploy-docs.yaml workflow integration. PRESERVE action documented (covered by packages/docs/ and .github/workflows/ preservation).
      </test>

      <!-- AC4: Infra-Unique Infrastructure Identified -->
      <test id="AC4-validation" ac="AC4" type="checklist-completeness">
        Validate preservation checklist includes additional infra components: scripts/ directory (automation scripts), docs/notes/development/ (PRD, Architecture, Epics, Sprint status), README.md (infra-specific). Each component documented with purpose, migration action (PRESERVE/ADAPT/REPLACE).
      </test>

      <!-- AC5: Preservation Checklist Created -->
      <test id="AC5-validation" ac="AC5" type="deliverable-exists">
        Validate preservation checklist file exists at docs/notes/development/work-items/story-2-1-preservation-checklist.md. Contains sections: Critical Infrastructure (MUST PRESERVE), Safe to Replace, Migration Strategy Summary. All components from AC1-AC4 included with clear PRESERVE vs REPLACE directives.
      </test>

      <!-- AC6: Files to Preserve Clearly Mapped -->
      <test id="AC6-validation" ac="AC6" type="checklist-completeness">
        Validate preservation checklist includes explicit exclusion list: directories to skip (.github/workflows/, docs/notes/development/, packages/), files to skip (package.json, README.md), safe to overwrite (flake.nix, modules/, hosts/, home-manager/, overlays/, secrets/). Verification commands provided (git diff main..clan-01 -- [PRESERVE path]).
      </test>

      <!-- AC7: Checklist Reviewed and Approved -->
      <test id="AC7-validation" ac="AC7" type="completeness-review">
        Validate preservation checklist completeness against AC1-AC6: all critical infra components documented, PRESERVE vs REPLACE directives clear, Story 2.3 execution guidance actionable, zero-regression requirement documented. Ready for Story 2.3 consumption.
      </test>

      <!-- Story 2.3 Post-Migration Validation Tests -->
      <test id="preserve-github-actions" ac="AC1" type="post-migration-validation">
        After Story 2.3 migration, verify .github/workflows/ preserved: git diff main..clan-01 -- .github/workflows/ shows no changes. All 7 workflows execute successfully on clan-01 branch.
      </test>

      <test id="preserve-typescript-monorepo" ac="AC2" type="post-migration-validation">
        After Story 2.3 migration, verify TypeScript monorepo preserved: git diff main..clan-01 -- package.json shows no changes, git diff main..clan-01 -- packages/docs/ shows no changes. npm run build succeeds in packages/docs/.
      </test>

      <test id="preserve-cloudflare-deployment" ac="AC3" type="post-migration-validation">
        After Story 2.3 migration, verify Cloudflare deployment operational: docs.cameronraysmith.com accessible, deploy-docs.yaml workflow executes successfully, site content matches expected documentation.
      </test>

      <test id="preserve-development-docs" ac="AC4" type="post-migration-validation">
        After Story 2.3 migration, verify development documentation preserved: git diff main..clan-01 -- docs/notes/development/ shows no changes. PRD, Architecture, Epics, Sprint status all intact.
      </test>

      <test id="replace-nix-configs" ac="AC5+AC6" type="post-migration-validation">
        After Story 2.3 migration, verify nix configs replaced: git diff main..clan-01 -- flake.nix shows dendritic+clan pattern, modules/ structure matches test-clan, hosts/ configs updated, home-manager/ uses Pattern A, overlays/ has five-layer architecture, secrets/ has sops-nix two-tier.
      </test>

      <test id="zero-regression-validation" ac="ALL" type="post-migration-validation">
        After Story 2.3 migration, validate zero regressions: GitHub Actions workflows execute, Cloudflare deployment succeeds, TypeScript builds pass, development docs accessible, all PRESERVE components function identically to pre-migration state.
      </test>
    </ideas>
  </tests>
</story-context>
