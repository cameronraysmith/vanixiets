<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>Prepare clan-01 branch for migration</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/2-2-prepare-clan-01-branch.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to create and prepare the `clan-01` branch for Epic 2 wholesale migration execution</iWant>
    <soThat>I have a clean, documented checkpoint before applying destructive config replacement from test-clan</soThat>
    <tasks>
      Task 1: Verify Current State on clan Branch (AC1, AC2)
      - Checkout clan branch
      - Verify working directory clean (git status, git diff, git diff --staged)
      - Verify Story 2.1 artifacts committed (preservation checklist, story file, sprint-status)
      - Note current commit SHA for verification

      Task 2: Create clan-01 Branch (AC1)
      - Create clan-01 branch from clan HEAD (git checkout -b clan-01)
      - Verify branch creation successful
      - Verify working directory still clean

      Task 3: Document Branch Purpose and Lifecycle (AC3)
      - Choose documentation method (Option A: git config, Option B: README)
      - Document branch purpose and lifecycle
      - If Option A: git config branch.clan-01.description
      - If Option B: Update README or create branch-strategy.md

      Task 4: Verify Branch Creation (AC4)
      - Verify zero commits between branches (git log clan..clan-01)
      - Verify file tree identical (git diff clan..clan-01)
      - Verify commit SHAs match (git show-ref)
      - Document verification results

      Task 5: Validate Story 2.3 Readiness (AC5)
      - Verify all ACs satisfied (AC1-AC4)
      - Verify Story 2.1 deliverables accessible
      - Confirm no blocking issues
      - Mark Story 2.2 complete
    </tasks>
  </story>

  <acceptanceCriteria>
    AC1: clan-01 Branch Created from clan HEAD
    - Create clan-01 branch from clan branch HEAD with zero divergence
    - Evidence: git branch shows clan-01, git log clan..clan-01 shows 0 commits, git status clean

    AC2: Working Directory Clean (Story 2.1 Changes Committed)
    - Verify no uncommitted changes from Story 2.1
    - Story 2.1 artifacts committed: preservation checklist, story file, sprint-status
    - Evidence: git status "nothing to commit", git diff shows no changes

    AC3: Branch Purpose Documented
    - Document clan-01 purpose, lifecycle, merge target
    - Option A: git config branch.clan-01.description (recommended)
    - Option B: README or docs/notes/development/branch-strategy.md
    - Evidence: Purpose accessible via git config or file

    AC4: Branch Creation Verified (Zero Divergence)
    - Verify clan-01 identical to clan at creation
    - Commands: git log clan..clan-01, git log clan-01..clan, git diff clan..clan-01
    - Evidence: 0 commits, no file differences, commit SHAs match

    AC5: Story 2.3 Ready to Proceed
    - AC1-AC4 satisfied, Story 2.1 accessible, no blocking issues
    - Story 2.2 marked done in sprint-status.yaml
    - Story 2.3 can begin wholesale migration
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Epic 2 Migration Strategy -->
      <doc>
        <path>docs/notes/development/epic-1-retro-2025-11-20.md</path>
        <title>Epic 1 Retrospective</title>
        <section>Epic 2 Preview and Dependencies (lines 405-421)</section>
        <snippet>"Rip the band-aid" approach: Create clan-01 branch in infra, replace nix configs wholesale from test-clan. Philosophy: Fast and pragmatic > slow and careful. Epic 1 was discovery/validation, Epic 2 is application of proven patterns.</snippet>
      </doc>

      <!-- Epic 2 Description -->
      <doc>
        <path>docs/notes/development/epics/epic-2-infrastructure-architecture-migration.md</path>
        <title>Epic 2: Infrastructure Architecture Migration</title>
        <section>Epic Goal and Migration Strategy</section>
        <snippet>Epic 2 applies validated test-clan patterns to infra across 4 phases (13 stories). Story 2.1 complete (preservation checklist), Story 2.2 current (branch prep), Story 2.3 next (wholesale migration).</snippet>
      </doc>

      <!-- Story 2.1 Completion Status -->
      <doc>
        <path>docs/notes/development/work-items/story-2-1-preservation-checklist.md</path>
        <title>Story 2.1 Preservation Checklist</title>
        <section>Complete preservation checklist (887 lines)</section>
        <snippet>Story 2.1 COMPLETE and APPROVED (9.8/10 quality). Documents all infra-specific components requiring preservation during Epic 2 migration. Story 2.3 will use this checklist for migration guidance.</snippet>
      </doc>

      <!-- Sprint Status -->
      <doc>
        <path>docs/notes/development/sprint-status.yaml</path>
        <title>Sprint Status Tracking</title>
        <section>Epic 2 Phase 1 Progress</section>
        <snippet>story-2-1: done (preservation checklist complete), story-2-2: drafted (current story), story-2-3: backlog (next - wholesale migration), story-2-4: backlog (secrets migration).</snippet>
      </doc>
    </docs>

    <code>
      <!-- No code artifacts - git workflow story only -->
    </code>

    <dependencies>
      <!-- Git commands only - no package dependencies -->
      <git>
        <command>git checkout clan</command>
        <command>git status</command>
        <command>git diff</command>
        <command>git diff --staged</command>
        <command>git checkout -b clan-01</command>
        <command>git log --oneline clan..clan-01</command>
        <command>git log --oneline clan-01..clan</command>
        <command>git diff clan..clan-01</command>
        <command>git show-ref | grep "refs/heads/clan"</command>
        <command>git rev-parse HEAD</command>
        <command>git config branch.clan-01.description "..."</command>
      </git>
    </dependencies>
  </artifacts>

  <constraints>
    Story Type: Git Workflow (Branch Preparation)
    - NO nix configuration edits
    - NO code changes
    - NO Story 2.3 execution (branch creation only)
    - NO test-clan codebase analysis needed
    - Git commands only (checkout, branch, status, log, diff, config)

    Epic 2 "Rip the Band-Aid" Strategy:
    - clan-01 branch = migration execution environment
    - clan branch = planning/discovery (Story 2.1 complete)
    - Fast and pragmatic > slow and careful
    - Trust git branch/diff/history as safety net

    Prerequisites:
    - Story 2.1 complete and committed âœ…
    - Working directory clean (no uncommitted changes)
    - Current branch: clan

    Story Sequencing:
    - Story 2.1: COMPLETE (preservation checklist approved)
    - Story 2.2: CURRENT (branch preparation)
    - Story 2.3: NEXT (wholesale migration using Story 2.1 checklist)

    Branch Purpose:
    - clan branch: Epic 2 planning/discovery (Story 2.1 done here)
    - clan-01 branch: Epic 2 migration execution (Stories 2.3-2.13)
    - Merge target: main branch (after Epic 2 validation complete)

    Rollback Strategy:
    - If Epic 2 migration fails: Delete clan-01, recreate from clan HEAD, retry
    - Git isolation provides safety net
  </constraints>

  <interfaces>
    <!-- No API/interface signatures - git workflow story only -->
  </interfaces>

  <tests>
    <standards>
      Git workflow stories use validation commands instead of traditional tests. Verification approach: (1) Branch creation validation via git branch --list, (2) Zero divergence validation via git log/diff, (3) Documentation validation via git config or file content, (4) Working directory validation via git status.
    </standards>

    <locations>
      Git commands executed at repository root: /Users/crs58/projects/nix-workspace/infra/
    </locations>

    <ideas>
      Test Idea 1 (AC1): Verify clan-01 branch created - git branch --list clan-01 returns clan-01
      Test Idea 2 (AC1): Verify zero divergence at creation - git log --oneline clan..clan-01 shows 0 commits
      Test Idea 3 (AC2): Verify working directory clean - git status shows "nothing to commit, working tree clean"
      Test Idea 4 (AC2): Verify Story 2.1 artifacts committed - git log shows preservation checklist commits
      Test Idea 5 (AC3): Verify branch purpose documented - git config branch.clan-01.description returns purpose string (if Option A)
      Test Idea 6 (AC4): Verify branches identical - git diff clan..clan-01 shows no output
      Test Idea 7 (AC4): Verify commit SHAs match - git show-ref shows same SHA for clan and clan-01
      Test Idea 8 (AC5): Verify all ACs satisfied - AC1-AC4 validation results documented in completion notes
    </ideas>
  </tests>
</story-context>
