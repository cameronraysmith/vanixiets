# Epic 2 Retrospective - Infrastructure Architecture Migration

**Date:** 2025-11-28
**Epic:** Epic 2 - Infrastructure Architecture Migration
**Status:** COMPLETE (14/14 stories done)
**Format:** Lightweight (pattern application epic, not discovery)

---

## Executive Summary

Epic 2 successfully migrated the infra repository from nixos-unified architecture to dendritic flake-parts + clan-core architecture by applying validated patterns from Epic 1's test-clan repository.
The "rip the band-aid" strategy enabled completion in 8 days with 14 stories across 4 phases.

**Duration:** 2025-11-20 to 2025-11-28 (8 days)
**Stories:** 14/14 complete (100%)
**Commits:** ~525 during Epic 2 period

---

## Epic 2 Delivery Summary

### Phase 1: Home-Manager Foundation (Stories 2.1-2.4)

- Story 2.1: Preservation checklist created (887 lines)
- Story 2.2: clan-01 branch prepared
- Story 2.3: Wholesale migration from test-clan executed
- Story 2.4: Two-tier secrets architecture applied, all home-manager configs migrated

### Phase 2: Darwin Workstations (Stories 2.5-2.8)

- Story 2.5: blackphos config validated and migration gaps fixed
- Story 2.6: stibnite config created (single-user pattern)
- Story 2.7: Both workstations activated from infra clan-01 branch
- Story 2.8: Obsolete configs cleaned up (found already removed)

### Phase 3: VPS Migration (Stories 2.9-2.10)

- Story 2.9: cinnabar (zerotier controller) switched to infra - high-risk, zero incidents
- Story 2.10: electrum (zerotier peer) switched to infra

### Phase 4: Validation & Future Machines (Stories 2.11-2.14)

- Story 2.11: Test harness and CI stabilized (9 iterative fixes, all-green)
- Story 2.12: Found already complete in test-clan (planning artifact)
- Story 2.13: rosegold config created (janettesmith + cameron dual-user)
- Story 2.14: argentum config created (christophersmith + cameron dual-user)

---

## What Went Well

### 1. Pattern Reuse from Epic 1

Epic 1's comprehensive validation (7 HIGH confidence patterns) enabled rapid Epic 2 execution.
The rosegold and argentum configs in Phase 4 followed the blackphos template with zero surprises.

**Evidence:**
- Story 2.13 review: "Implementation follows established patterns from blackphos and raquel templates"
- Story 2.14 review: "No HIGH, MEDIUM, or LOW severity findings"

### 2. Story 2.13 Quality Iteration

Story 2.13 underwent 4 revisions before implementation, catching critical issues:
- Two-tier secrets paths (CRITICAL)
- nix-unit test updates missing (CRITICAL)
- ssh-to-age pattern not documented (CRITICAL)
- UID strategy unclear (MEDIUM)

Story 2.14 then executed smoothly with zero revisions, benefiting from the 2.13 learnings.

### 3. CI Stabilization

Story 2.11 required 9 iterative CI fixes but achieved all-green CI with proper content-addressed caching.
Technical debt resolved rather than carried forward.

### 4. ssh-to-age Discovery

Correct pattern for deriving age keys from SSH keys was discovered and documented:
- SSH public key -> ssh-to-age -> age public key (stored in repo)
- Private key stays with user -> ssh-to-age -private-key (runtime decryption)

Pattern now used consistently for janettesmith and christophersmith.

### 5. Dual-User Pattern Scaling

The blackphos template scaled cleanly to rosegold and argentum:
- Primary user: basic, 6 aggregates, NO ai
- cameron admin: 7 aggregates + ai, manages homebrew

---

## What Could Be Improved

### Issues Identified (Not Actionable)

1. **Story 2.12 planning artifact** - Was marked backlog but already done in test-clan
2. **Story 2.13 initial draft gaps** - Required 4 corrections before implementation
3. **Epic 2 definition ambiguity** - "blackphos template" didn't specify dual vs single user
4. **Context verification** - Could have caught Story 2.12 state earlier

### Assessment

These issues are idiosyncratic and difficult to use to inform future development.
There's always a balance between time spent reviewing plans for correctness versus diving into development and dealing with unforeseen issues as they arise.

**Conclusion:** No new process needed. Current approach of iterate-as-needed is appropriate.

---

## Key Takeaways

1. **Pattern reuse worked** - Epic 1 validation enabled 8-day Epic 2 execution with 14/14 stories complete

2. **Iterative story refinement is valuable** - Story 2.13's 4 revisions prevented implementation bugs; Story 2.14 benefited immediately

3. **No new process needed** - Issues were idiosyncratic; current approach of iterate-as-needed is appropriate

4. **Operational details emerge in context** - nh CLI, justfile recipes, deployment patterns surface during story drafting when relevant

---

## Action Items

None - current process is working well.

---

## Epic 3-4 Readiness

**Readiness Level:** HIGH

- rosegold config created and validated (Story 2.13)
- argentum config created and validated (Story 2.14)
- Deployment pattern proven (blackphos, stibnite in Story 2.7)
- Operational context (nh CLI, justfile recipes) will be captured during story drafting

**Epic 3:** Deploy rosegold (janettesmith's darwin workstation)
**Epic 4:** Deploy argentum (christophersmith's darwin workstation)

---

## Retrospective Metadata

**Facilitated by:** Bob (Scrum Master)
**Format:** Lightweight retrospective (30-45 minutes)
**Rationale:** Epic 2 was primarily migration/configuration work applying patterns validated in Epic 1

**Participants:**
- Dev (Project Lead)
- Alice (Product Owner)
- Bob (Scrum Master)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)

---

## References

- Sprint status: `docs/notes/development/sprint-status.yaml`
- Epic 2 definition: `docs/notes/development/epics/epic-2-infrastructure-architecture-migration.md`
- Epic 1 retrospective: `docs/notes/development/epic-1-retro-2025-11-20.md`
- Story 2.13 (exemplar): `docs/notes/development/work-items/2-13-rosegold-configuration-creation.md`
- Story 2.14: `docs/notes/development/work-items/2-14-argentum-configuration-creation.md`
