# generated: 2025-11-07
# project: infra
# project_key: infra
# tracking_system: file-system
# story_location: {project-root}/docs/notes/development/work-items

# STATUS DEFINITIONS:
# ==================
# Epic Status:
#   - backlog: Epic exists in epic file but not contexted
#   - contexted: Epic tech context created (required before drafting stories)
#
# Story Status:
#   - backlog: Story only exists in epic file
#   - drafted: Story file created in stories folder
#   - ready-for-dev: Draft approved and story context created
#   - in-progress: Developer actively working on implementation
#   - review: Under SM review (via code-review workflow)
#   - done: Story completed
#
# Retrospective Status:
#   - optional: Can be completed but not required
#   - completed: Retrospective has been done
#
# WORKFLOW NOTES:
# ===============
# - Epics should be 'contexted' before stories can be 'drafted'
# - Stories can be worked in parallel if team capacity allows
# - SM typically drafts next story after previous one is 'done' to incorporate learnings
# - Dev moves story to 'review', SM reviews, then Dev moves to 'done'
#
# MIGRATION-SPECIFIC NOTES:
# =========================
# - This is a progressive rollout infrastructure migration with 6 phases (Phase 0-5)
# - Phase 0 includes INFRASTRUCTURE DEPLOYMENT (Hetzner + GCP VMs) in test-clan
# - Each phase includes: implementation + stability validation (1-2 weeks)
# - Stories within phases are largely sequential, not parallelizable
# - Each phase must reach stability gate before next phase begins
# - Phase 0 has a GO/NO-GO decision gate that determines entire migration approach
# - Primary workstation (stibnite) requires 4-6 weeks cumulative stability before migration
#
# STABILITY GATES:
# ================
# - Epic 1 (Story 1.14): GO/CONDITIONAL GO/NO-GO decision determines entire approach
# - Epic 1 (Story 1.12): Infrastructure stable 1 week minimum before Phase 1
# - Epic 2 (Story 2.6): cinnabar stable 1-2 weeks → proceed to blackphos
# - Epic 3 (Story 3.5): blackphos stable 1-2 weeks → proceed to rosegold
# - Epic 4 (Story 4.3): rosegold stable 1-2 weeks → proceed to argentum
# - Epic 5 (Story 5.2): argentum stable 1-2 weeks, cumulative 4-6+ weeks → proceed to stibnite
# - Epic 6 (Story 6.3): stibnite stable 1-2 weeks → proceed to cleanup
#
# ZERO-REGRESSION REQUIREMENT:
# ============================
# All functionality must be preserved during migration. Validate at every phase.

generated: 2025-11-07
project: infra
project_key: infra
tracking_system: file-system
story_location: "{project-root}/docs/notes/development/work-items"

development_status:
  # Epic 1: Architectural Validation + Infrastructure Deployment (Phase 0 - test-clan)
  # Strategic decision (2025-11-05): Story 1.2 complete (Outcome A) - implement test harness + dendritic refactoring NOW
  # Rationale: Test strategy enables risk-free refactoring, validates architecture during Phase 0, benefits Epic 2+
  # Flow: 1.1-1.5 (complete) → 1.6 (test harness) → 1.7 (dendritic refactor) → 1.8-1.14 (GCP + validation)
  epic-1: backlog
  1-1-prepare-existing-test-clan-repository-for-validation: done
  # Story 1.2: DONE - Outcome A (Already Compliant) - No refactoring needed, architecture validated
  1-2-implement-dendritic-flake-parts-pattern-in-test-clan: done
  # Story 1.3: COMPLETE - Inventory configured, ready for Story 1.4
  1-3-configure-clan-inventory-and-service-instances-for-test-vm: done
  # Story 1.4: APPROVED - Review corrected, cx43 at $9.99/month per user direction, all ACs satisfied
  1-4-create-hetzner-terraform-config-and-host-modules: done
  # Story 1.5: DONE - APPROVED ✅ - All 13 ACs validated, ZFS encryption bug discovered and documented
  1-5-deploy-hetzner-vm-and-validate-stack: done
  # Story 1.6: DONE - Test harness implemented with 18 tests (12 nix-unit + 4 validation + 2 integration)
  # Implementation evolved to hybrid approach in modules/checks/ with auto-discovery (superior to original plan)
  1-6-implement-comprehensive-test-harness-for-test-clan: done
  # Story 1.7: DONE - Pure dendritic flake-parts pattern achieved with zero regressions
  # All feature tests passing (TC-008, TC-009), Step 2.5 deferred (manual machine registration retained)
  1-7-execute-dendritic-refactoring-in-test-clan-using-test-harness: done
  # Story 1.8: DONE - Configuration build complete, APPROVED ✅
  # Successfully migrated blackphos to test-clan dendritic + clan pattern
  # AC1-AC4 complete: module structure, home-manager, clan inventory validated
  # AC5-AC7 deferred: physical deployment awaits access to blackphos hardware
  # Architectural gap identified: crs58/raquel configs inline (not reusable across platforms)
  # Course correction executed (2025-11-12): Story 1.8A inserted to restore modular pattern
  # Review outcome: APPROVE - All configuration objectives achieved, proper course correction
  1-8-migrate-blackphos-from-infra-to-test-clan: done
  # Story 1.8A: DONE ✅ - Extract Portable Home-Manager Modules (CRITICAL PATH)
  # Extracted crs58/raquel into portable modules (modules/home/users/{crs58,raquel}/)
  # Exported to dendritic namespace: flake.modules.homeManager."users/{username}"
  # Exposed standalone homeConfigurations.{crs58,raquel} for nh home switch workflow
  # Refactored blackphos to import from namespace (46 lines removed, zero regression validated)
  # Package diff: 270 packages preserved exactly, all functionality intact
  # Added test coverage: TC-018 (home-module-exports), TC-019 (home-configurations-exposed)
  # Pattern documented in architecture.md with validation evidence
  # Successfully unblocked Story 1.9: crs58 module ready for cinnabar NixOS reuse
  # Implementation time: ~2 hours, all 8 acceptance criteria satisfied
  1-8a-extract-portable-home-manager-modules: done
  # Story 1.9: DONE ✅ APPROVED ✅ - Rename test VMs to production names (cinnabar/electrum)
  # All 7 ACs validated: VMs renamed, clan inventory updated, zerotier network operational
  # Bidirectional connectivity confirmed (1-12ms latency), 14/14 tests passing
  # Zerotier network: db4344343b14b903 (cinnabar controller + electrum peer)
  # Key learning: clan machines update uploads vars but doesn't restart services
  # Context generated 2025-11-13 with 17 doc refs (7 internal + 10 external examples)
  # Review (2025-11-13): APPROVED - 3 advisory notes (documentation improvements), zero blockers
  1-9-rename-vms-cinnabar-electrum-establish-zerotier: done
  # Story 1.10: DONE ✅ (2025-11-14) - Complete Migrations and Establish Clean Foundation
  # Split from original 1.10 to optimize sizing (10-15h vs 18-27h original)
  # Completes blackphos migration, deploys cameron user to cinnabar, refines dendritic patterns
  # Critical: cinnabar user config BLOCKS Story 1.12 (heterogeneous networking validation)
  # Foundation for Story 1.11 (type-safe home-manager architecture)
  # REVIEW #1 (2025-11-13): CHANGES REQUESTED - Technical excellent, documentation gaps (AC15-AC16)
  # IMPLEMENTATION: Created migration-patterns.md (424 lines), dendritic-patterns.md (651 lines), completed story notes
  # REVIEW #2 (2025-11-13): APPROVED ✅ - All CRITICAL gaps resolved, documentation exceeds requirements
  # 16/16 ACs satisfied, 7/7 tasks complete, production-ready documentation, zero regressions
  # User approved story-done (2025-11-14) - VPS deployment deferred to separate infrastructure task
  1-10-complete-migrations-establish-clean-foundation: done
  # Story 1.10A: DONE ✅ APPROVED ✅ (2025-11-14) - Migrate User Management to Clan Inventory Pattern
  # DISCOVERED STORY - Architectural validation enhancement from party-mode review
  # Implementation: 3.5 hours across 11 atomic commits (846b61e-fa90429)
  # Pattern migration: Direct NixOS → clan inventory users service + vars-based password management
  # Two-instance pattern: user-cameron (modern machines), user-crs58 (legacy machines)
  # Functional validation COMPLETE: VPS deployment successful (cinnabar IP: 49.13.68.78)
  # Validated end-to-end: SSH login, shell (zsh), sudo, git config, home-manager packages
  # Post-review improvements: Critical SSH keys fix (6364610), home directory auto-detection (e629e8e)
  # Test suite: 10 checks passing (TC-024 vars validation added), zero regressions
  # Documentation: user-management.md (327 lines) + adding-users.md (436 lines)
  # REVIEW (2025-11-14): APPROVE - All 11 ACs implemented, 6/6 tasks verified, production-ready
  # Strategic value validated: Pattern ready for Epic 2-6 scaling (6 machines × 4+ users)
  # Estimated time savings: 6-12 hours in Epic 2-6 (inventory pattern vs direct config)
  1-10a-migrate-user-management-inventory: done
  # Story 1.10B: DONE ✅ (2025-11-14) - Migrate Home-Manager Module Ecosystem from infra to test-clan
  # DISCOVERED STORY - Configuration completeness gap via comprehensive blackphos audit
  # Implementation: 18 commits across 2 sessions (71dde62-d4ef3a2)
  # Priority 1-3 modules migrated (17 total): dev env (7) + AI tooling (4) + shell/terminal (6)
  # Pattern B implemented (underscore directories + plain HM modules)
  # CRITICAL ARCHITECTURAL LIMITATIONS DISCOVERED (dev notes lines 767-1031):
  #   - 11 features DISABLED (SSH signing, MCP API keys, GLM wrapper, tmux theme, custom packages)
  #   - darwinConfigurations.blackphos.system FAILS TO BUILD (lazyvim integration broken)
  #   - No flake context access (plain modules cannot access flake.inputs, flake.config)
  #   - sops-nix completely incompatible (requires flake.config lookups)
  # Functional status: 85% (core functionality present, secrets/themes/packages disabled)
  # homeConfigurations.crs58/raquel build successfully, darwinConfigurations FAILS
  # Party Mode investigation (9 agents): UNANIMOUS refactor to Pattern A (both references use Pattern A)
  # Story 1.10BA inserted to refactor Pattern B → Pattern A before Story 1.10C
  # Strategic value: Provided empirical evidence that Pattern B is architectural dead end
  1-10b-migrate-home-manager-modules: done
  # Story 1.10BA: DONE (2025-11-14) - Refactor Home-Manager Modules from Pattern B to Pattern A
  # ✅ SCOPE ADJUSTED: Feature restoration (original AC17-AC20) moved to Story 1.10D
  # Structural Pattern A migration COMPLETE: All 16 modules use explicit flake.modules = { ... } pattern
  # Aggregate organization validated: development (7), ai (4), shell (6) following drupol reference
  # All 3 critical builds passing: crs58, raquel, blackphos (darwinConfigurations build FIXED)
  # Pattern A benefits validated: flake context access, aggregate namespaces, industry-standard
  # Actual effort: ~4 hours (vs 8-10h estimated - structural work only, features deferred to 1.10D)
  # Party Mode architectural review validated empirically
  # Feature restoration deferred rationale: test-clan uses clan vars (not sops-nix), requires Story 1.10C infrastructure first
  # Dependencies: Story 1.10B (done), Blocks: Story 1.10C (modules have flake context), Story 1.10D (deferred features)
  # Strategic value achieved: Validates Pattern A at scale, unblocks Story 1.10C, provides Epic 2-6 pattern
  1-10ba-refactor-pattern-a: done
  # Story 1.10C: DISCOVERED STORY (2025-11-14) - Migrate Secrets from sops-nix to Clan Vars
  # Secrets management gap identified - Story 1.8 deferred, Story 1.10 never addressed (0% secrets coverage)
  # infra has 6 sops-nix encrypted files (signing keys, API keys), test-clan has zero clan vars generators
  # Physical deployment would fail (no SSH signing keys, no MCP API keys, no GLM API key)
  # Pattern B migration: Vars generators in user modules (modules/home/users/*/vars.nix)
  # Secrets inventory: signing keys (regenerable), API keys (prompt-based), bitwarden email
  # Module access pattern updates: git.nix, jujutsu.nix, mcp-servers.nix, claude-code-wrappers.nix, rbw.nix
  # Clan vars IS sops-nix (declarative interface wrapper), darwin-compatible, recommended by clan-core
  # UPDATE (Post-Story 1.10BA): Pattern A provides flake context for clan vars access (sops-nix re-enabled)
  # Estimated effort: 4-6 hours (2h setup + 1-2h access patterns + 1h validation + 1h docs)
  # Dependencies: Story 1.10BA (done), Blocks: Story 1.10D (features need secrets), Story 1.12 (deployment needs secrets)
  1-10c-migrate-secrets-clan-vars: backlog
  # Story 1.10D: NEW STORY (2025-11-14) - Enable Features Using Clan Vars and Flake Inputs
  # Feature enablement deferred from Story 1.10BA (original AC17-AC20) - requires clan vars infrastructure first
  # Enable 11 disabled features from Story 1.10B using Pattern A + clan vars architecture
  # Category A (5 features): SSH signing (git, jujutsu), MCP API keys (3 servers) via clan vars
  # Category B (3 features): GLM wrapper, claude-code package, ccstatusline via flake.inputs
  # Category C (3 features): catppuccin tmux theme (36-line config) via flake.inputs
  # Access patterns: config.clan.core.vars.generators.X.files.Y.path (secrets), flake.inputs.X.packages (packages)
  # Validates Pattern A + clan vars work for production features (not just minimal structure)
  # Estimated effort: 2-3 hours (30min SSH + 30min MCP + 1h packages/themes + 1h validation/docs)
  # Dependencies: Story 1.10C (clan vars infrastructure), Blocks: Story 1.12 (deployment needs features)
  # Strategic value: Completes Pattern A + clan vars validation (structure + secrets + features), Epic 2-6 reference
  1-10d-enable-features-clan-vars: backlog
  # Story 1.11: ENHANCED (2025-11-12) - Refine home-manager architecture and document patterns
  # Now includes type-safe home-manager architecture implementation (phases 1-5)
  # Implements homeHosts options with type validation, smart resolution app, CI checks
  # Reference: docs/notes/development/home-manager-type-safe-architecture.md
  # Updated effort: 12-18 hours (9-14h architecture + 3-4h documentation)
  # Establishes production-ready pattern for Epic 2+ (all 6 machines)
  1-11-refine-home-manager-architecture-and-document-patterns: backlog
  # Story 1.12: GO/NO-GO decision based on expanded validation (nixos + darwin + transformation)
  1-12-execute-go-no-go-decision-framework: backlog
  epic-1-retrospective: optional

  # Epic 2: VPS Infrastructure Foundation (Phase 1 - cinnabar)
  epic-2: backlog
  2-1-apply-phase-0-patterns-to-nix-config-and-setup-terraform-terranix: backlog
  2-2-create-cinnabar-host-configuration-with-disko-and-luks: backlog
  2-3-configure-zerotier-controller-and-essential-clan-services-for-cinnabar: backlog
  2-4-initialize-clan-secrets-and-generate-vars-for-cinnabar: backlog
  2-5-deploy-cinnabar-vps-via-terraform-and-clan-machines-install: backlog
  2-6-validate-cinnabar-infrastructure-and-zerotier-controller: backlog
  epic-2-retrospective: optional

  # Epic 3: First Darwin Migration (Phase 2 - blackphos)
  epic-3: backlog
  3-1-convert-darwin-modules-to-dendritic-flake-parts-pattern-for-blackphos: backlog
  3-2-add-blackphos-to-clan-inventory-with-zerotier-peer-role: backlog
  3-3-generate-clan-vars-and-deploy-blackphos-configuration: backlog
  3-4-validate-blackphos-functionality-and-network-connectivity: backlog
  3-5-document-darwin-patterns-and-monitor-stability: backlog
  epic-3-retrospective: optional

  # Epic 4: Multi-Darwin Validation (Phase 3 - rosegold)
  epic-4: backlog
  4-1-create-rosegold-configuration-using-blackphos-patterns: backlog
  4-2-add-rosegold-to-clan-inventory-and-deploy: backlog
  4-3-validate-3-machine-network-and-multi-darwin-coordination: backlog
  epic-4-retrospective: optional

  # Epic 5: Third Darwin Host (Phase 4 - argentum)
  epic-5: backlog
  5-1-create-argentum-configuration-and-deploy-to-4-machine-network: backlog
  5-2-validate-4-machine-network-and-assess-stibnite-readiness: backlog
  epic-5-retrospective: optional

  # Epic 6: Primary Workstation Migration (Phase 5 - stibnite)
  epic-6: backlog
  6-1-validate-pre-migration-readiness-and-create-stibnite-configuration: backlog
  6-2-deploy-stibnite-and-validate-all-daily-workflows: backlog
  6-3-complete-5-machine-network-and-monitor-productivity: backlog
  epic-6-retrospective: optional

  # Epic 7: Legacy Cleanup (Phase 6)
  epic-7: backlog
  7-1-remove-nixos-unified-infrastructure: backlog
  7-2-finalize-secrets-migration-strategy: backlog
  7-3-update-documentation-and-finalize-migration: backlog
  epic-7-retrospective: optional
