# generated: 2025-11-07
# project: infra
# project_key: infra
# tracking_system: file-system
# story_location: {project-root}/docs/notes/development/work-items

# STATUS DEFINITIONS:
# ==================
# Epic Status:
#   - backlog: Epic exists in epic file but not contexted
#   - contexted: Epic tech context created (required before drafting stories)
#
# Story Status:
#   - backlog: Story only exists in epic file
#   - drafted: Story file created in stories folder
#   - ready-for-dev: Draft approved and story context created
#   - in-progress: Developer actively working on implementation
#   - review: Under SM review (via code-review workflow)
#   - done: Story completed
#
# Retrospective Status:
#   - optional: Can be completed but not required
#   - completed: Retrospective has been done
#
# WORKFLOW NOTES:
# ===============
# - Epics should be 'contexted' before stories can be 'drafted'
# - Stories can be worked in parallel if team capacity allows
# - SM typically drafts next story after previous one is 'done' to incorporate learnings
# - Dev moves story to 'review', SM reviews, then Dev moves to 'done'
#
# MIGRATION-SPECIFIC NOTES:
# =========================
# - This is a progressive rollout infrastructure migration with 6 phases (Phase 0-5)
# - Phase 0 includes INFRASTRUCTURE DEPLOYMENT (Hetzner + GCP VMs) in test-clan
# - Each phase includes: implementation + stability validation (1-2 weeks)
# - Stories within phases are largely sequential, not parallelizable
# - Each phase must reach stability gate before next phase begins
# - Phase 0 has a GO/NO-GO decision gate that determines entire migration approach
# - Primary workstation (stibnite) requires 4-6 weeks cumulative stability before migration
#
# STABILITY GATES:
# ================
# - Epic 1 (Story 1.14): GO/CONDITIONAL GO/NO-GO decision determines entire approach
# - Epic 1 (Story 1.12): Infrastructure stable 1 week minimum before Phase 1
# - Epic 2 (Story 2.6): cinnabar stable 1-2 weeks → proceed to blackphos
# - Epic 3 (Story 3.5): blackphos stable 1-2 weeks → proceed to rosegold
# - Epic 4 (Story 4.3): rosegold stable 1-2 weeks → proceed to argentum
# - Epic 5 (Story 5.2): argentum stable 1-2 weeks, cumulative 4-6+ weeks → proceed to stibnite
# - Epic 6 (Story 6.3): stibnite stable 1-2 weeks → proceed to cleanup
#
# ZERO-REGRESSION REQUIREMENT:
# ============================
# All functionality must be preserved during migration. Validate at every phase.

generated: 2025-11-07
project: infra
project_key: infra
tracking_system: file-system
story_location: "{project-root}/docs/notes/development/work-items"

development_status:
  # Epic 1: Architectural Validation + Infrastructure Deployment (Phase 0 - test-clan)
  # Strategic decision (2025-11-05): Story 1.2 complete (Outcome A) - implement test harness + dendritic refactoring NOW
  # Rationale: Test strategy enables risk-free refactoring, validates architecture during Phase 0, benefits Epic 2+
  # Flow: 1.1-1.5 (complete) → 1.6 (test harness) → 1.7 (dendritic refactor) → 1.8-1.14 (GCP + validation)
  epic-1: backlog
  1-1-prepare-existing-test-clan-repository-for-validation: done
  # Story 1.2: DONE - Outcome A (Already Compliant) - No refactoring needed, architecture validated
  1-2-implement-dendritic-flake-parts-pattern-in-test-clan: done
  # Story 1.3: COMPLETE - Inventory configured, ready for Story 1.4
  1-3-configure-clan-inventory-and-service-instances-for-test-vm: done
  # Story 1.4: APPROVED - Review corrected, cx43 at $9.99/month per user direction, all ACs satisfied
  1-4-create-hetzner-terraform-config-and-host-modules: done
  # Story 1.5: DONE - APPROVED ✅ - All 13 ACs validated, ZFS encryption bug discovered and documented
  1-5-deploy-hetzner-vm-and-validate-stack: done
  # Story 1.6: DONE - Test harness implemented with 18 tests (12 nix-unit + 4 validation + 2 integration)
  # Implementation evolved to hybrid approach in modules/checks/ with auto-discovery (superior to original plan)
  1-6-implement-comprehensive-test-harness-for-test-clan: done
  # Story 1.7: DONE - Pure dendritic flake-parts pattern achieved with zero regressions
  # All feature tests passing (TC-008, TC-009), Step 2.5 deferred (manual machine registration retained)
  1-7-execute-dendritic-refactoring-in-test-clan-using-test-harness: done
  # Story 1.8: DONE - Configuration build complete, APPROVED ✅
  # Successfully migrated blackphos to test-clan dendritic + clan pattern
  # AC1-AC4 complete: module structure, home-manager, clan inventory validated
  # AC5-AC7 deferred: physical deployment awaits access to blackphos hardware
  # Architectural gap identified: crs58/raquel configs inline (not reusable across platforms)
  # Course correction executed (2025-11-12): Story 1.8A inserted to restore modular pattern
  # Review outcome: APPROVE - All configuration objectives achieved, proper course correction
  1-8-migrate-blackphos-from-infra-to-test-clan: done
  # Story 1.8A: DONE ✅ - Extract Portable Home-Manager Modules (CRITICAL PATH)
  # Extracted crs58/raquel into portable modules (modules/home/users/{crs58,raquel}/)
  # Exported to dendritic namespace: flake.modules.homeManager."users/{username}"
  # Exposed standalone homeConfigurations.{crs58,raquel} for nh home switch workflow
  # Refactored blackphos to import from namespace (46 lines removed, zero regression validated)
  # Package diff: 270 packages preserved exactly, all functionality intact
  # Added test coverage: TC-018 (home-module-exports), TC-019 (home-configurations-exposed)
  # Pattern documented in architecture.md with validation evidence
  # Successfully unblocked Story 1.9: crs58 module ready for cinnabar NixOS reuse
  # Implementation time: ~2 hours, all 8 acceptance criteria satisfied
  1-8a-extract-portable-home-manager-modules: done
  # Story 1.9: READY - Rename test VMs to production names (cinnabar/electrum)
  # Can now import crs58 home module from Story 1.8A for cinnabar NixOS config
  # Pattern proven: flake.modules.homeManager."users/crs58" works cross-platform
  1-9-rename-vms-cinnabar-electrum-establish-zerotier: backlog
  # Story 1.10: Integrate blackphos (nix-darwin) into zerotier network with cinnabar/electrum (nixos)
  # Validates heterogeneous networking across platforms
  1-10-integrate-blackphos-into-zerotier-network: backlog
  # Story 1.11: ENHANCED (2025-11-12) - Refine home-manager architecture and document patterns
  # Now includes type-safe home-manager architecture implementation (phases 1-5)
  # Implements homeHosts options with type validation, smart resolution app, CI checks
  # Reference: docs/notes/development/home-manager-type-safe-architecture.md
  # Updated effort: 12-18 hours (9-14h architecture + 3-4h documentation)
  # Establishes production-ready pattern for Epic 2+ (all 6 machines)
  1-11-refine-home-manager-architecture-and-document-patterns: backlog
  # Story 1.12: GO/NO-GO decision based on expanded validation (nixos + darwin + transformation)
  1-12-execute-go-no-go-decision-framework: backlog
  epic-1-retrospective: optional

  # Epic 2: VPS Infrastructure Foundation (Phase 1 - cinnabar)
  epic-2: backlog
  2-1-apply-phase-0-patterns-to-nix-config-and-setup-terraform-terranix: backlog
  2-2-create-cinnabar-host-configuration-with-disko-and-luks: backlog
  2-3-configure-zerotier-controller-and-essential-clan-services-for-cinnabar: backlog
  2-4-initialize-clan-secrets-and-generate-vars-for-cinnabar: backlog
  2-5-deploy-cinnabar-vps-via-terraform-and-clan-machines-install: backlog
  2-6-validate-cinnabar-infrastructure-and-zerotier-controller: backlog
  epic-2-retrospective: optional

  # Epic 3: First Darwin Migration (Phase 2 - blackphos)
  epic-3: backlog
  3-1-convert-darwin-modules-to-dendritic-flake-parts-pattern-for-blackphos: backlog
  3-2-add-blackphos-to-clan-inventory-with-zerotier-peer-role: backlog
  3-3-generate-clan-vars-and-deploy-blackphos-configuration: backlog
  3-4-validate-blackphos-functionality-and-network-connectivity: backlog
  3-5-document-darwin-patterns-and-monitor-stability: backlog
  epic-3-retrospective: optional

  # Epic 4: Multi-Darwin Validation (Phase 3 - rosegold)
  epic-4: backlog
  4-1-create-rosegold-configuration-using-blackphos-patterns: backlog
  4-2-add-rosegold-to-clan-inventory-and-deploy: backlog
  4-3-validate-3-machine-network-and-multi-darwin-coordination: backlog
  epic-4-retrospective: optional

  # Epic 5: Third Darwin Host (Phase 4 - argentum)
  epic-5: backlog
  5-1-create-argentum-configuration-and-deploy-to-4-machine-network: backlog
  5-2-validate-4-machine-network-and-assess-stibnite-readiness: backlog
  epic-5-retrospective: optional

  # Epic 6: Primary Workstation Migration (Phase 5 - stibnite)
  epic-6: backlog
  6-1-validate-pre-migration-readiness-and-create-stibnite-configuration: backlog
  6-2-deploy-stibnite-and-validate-all-daily-workflows: backlog
  6-3-complete-5-machine-network-and-monitor-productivity: backlog
  epic-6-retrospective: optional

  # Epic 7: Legacy Cleanup (Phase 6)
  epic-7: backlog
  7-1-remove-nixos-unified-infrastructure: backlog
  7-2-finalize-secrets-migration-strategy: backlog
  7-3-update-documentation-and-finalize-migration: backlog
  epic-7-retrospective: optional
