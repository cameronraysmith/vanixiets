# Secrets and Vars Architecture

**Last Updated**: 2025-11-19 (Story 1.10C validation)
**Status**: Validated in production deployment (cinnabar, electrum)

This document explains the two-tier secrets architecture used in test-clan, validated through Epic 1 deployment.

## Overview

The repository uses a two-tier secrets architecture that separates system-level and user-level secret management:

**Tier 1: Clan Vars (system-level)**
- Purpose: Generated secrets for machine infrastructure
- Examples: SSH host keys, zerotier identities, ZFS/LUKS passphrases, Tor hidden service keys
- Encryption: Machine age keys (stored in `sops/machines/<machine>/key.json`)
- Deployment: `/run/secrets/vars/` on machines via clan-core
- Management: `clan vars generate`, `clan vars fix`
- Generator-driven: Values auto-generated by clan generators, not manually created

**Tier 2: sops-nix (user-level)**
- Purpose: User identity secrets for home-manager configurations
- Examples: GitHub tokens, SSH signing keys, API keys, Bitwarden emails
- Encryption: User age keys derived from Bitwarden SSH keys
- Deployment: Home-manager sops integration
- Management: `sops` CLI with `.sops.yaml` rules
- Manually created: Values provided by users, encrypted via sops

## Age Key Types

Three distinct age key types correspond to different encryption scopes:

### 1. Repository Dev Key (Shared)
- **Purpose**: Shared key for all developers to decrypt any secret
- **Storage**: Bitwarden item `sops-dev-ssh`
- **Derivation**: `bw get item "sops-dev-ssh" | jq -r '.sshKey.publicKey' | ssh-to-age`
- **Usage**: Emergency access, CI/CD decryption, admin operations
- **Public key**: `age1vy7wsnf8eg5229evq3ywup285jzk9cntsx5hhddjtwsjh0kf4c6s9fmalv`

### 2. User Identity Keys (Per-user)
- **Purpose**: User-specific secrets (home-manager sops files)
- **Storage**: Bitwarden items `sops-{username}-ssh`
- **Derivation**: SSH private key → age private key via `ssh-to-age -private-key`
- **Deployed to**: `~/.config/sops/age/keys.txt` on user's workstation
- **Three contexts**:
  1. Clan user: `sops/users/{username}/key.json` (age public key)
  2. User workstation: `~/.config/sops/age/keys.txt` (age private key)
  3. sops-nix config: `.sops.yaml` (age public key for encryption rules)

### 3. Machine Keys (Per-machine)
- **Purpose**: Machine-level system secrets (clan vars)
- **Storage**: `sops/machines/<machine>/key.json` in repository
- **Derivation**: `age-keygen` generates during sops-nix module initialization on machine
- **Deployed to**: `/var/lib/sops-nix/key.txt` on deployed machine
- **Critical distinction**: NOT derived from SSH host keys; independent age keypair

## SSH-to-Age Derivation Pattern

Age keys are deterministically derived from SSH keys using the `ssh-to-age` tool.

**Properties:**
- **Deterministic**: Same SSH key always produces same age key
- **One-way**: Cannot derive SSH key from age key
- **Format validation**: Age public keys must match `^age1[a-z0-9]{58}$`

**Derivation workflow:**
```bash
# From SSH private key → age private key
ssh_priv=$(bw get item "sops-admin-user-ssh" | jq -r '.sshKey.privateKey')
age_priv=$(echo "$ssh_priv" | ssh-to-age -private-key)
# Output: AGE-SECRET-KEY-... (uppercase, 74 chars)

# From SSH public key → age public key
ssh_pub=$(bw get item "sops-admin-user-ssh" | jq -r '.sshKey.publicKey')
age_pub=$(echo "$ssh_pub" | ssh-to-age)
# Output: age1... (lowercase, 62 chars)

# Verify: derive public from private
age-keygen -y <<< "$age_priv"
# Should match age_pub
```

**Source of truth**: Bitwarden vault contains SSH keys; age keys are ephemeral derivations.

## Clan Vars Generation and Re-encryption

Clan vars are generated by clan-core generators and encrypted with machine age keys.

### Generation Process
```bash
# Initial generation (creates new secrets)
clan vars generate <machine>

# Generated vars stored in:
# vars/per-machine/<machine>/<generator>/<file>/secret
# vars/shared/<generator>/<file>/secret
```

### Re-encryption (Key Rotation)
When machine age keys change, vars must be re-encrypted WITHOUT regenerating values:

```bash
# Re-encrypt vars with new keys (preserves plaintext values)
clan vars fix <machine>
```

**Critical property**: `clan vars fix` performs SOPS `updatekeys` operation, which re-encrypts with new age public keys while preserving original plaintext values.

**Use cases:**
- Machine age key rotation
- Adding machines to shared vars
- Correcting age key mismatches

## Machine Age Keys vs SSH Host Keys

**Common mistake**: Using `ssh-keyscan` to get machine age keys.

**Wrong workflow:**
```bash
# ❌ Gets SSH host key, not sops-nix age key
ssh-keyscan -t ed25519 <machine-ip> | ssh-to-age
```

**Correct workflow:**
```bash
# ✅ Get actual sops-nix age key from deployed machine
ssh root@<machine> 'cat /var/lib/sops-nix/key.txt | age-keygen -y'

# Or use clan CLI
clan secrets machines get <machine>
```

**Why this matters**: SSH host keys (`/etc/ssh/ssh_host_ed25519_key.pub`) and sops-nix age keys (`/var/lib/sops-nix/key.txt`) are different keypairs with different purposes:
- SSH host key: Identifies machine for SSH connections
- sops-nix age key: Decrypts clan vars secrets

## sops-nix Configuration and Multi-user Encryption

The `.sops.yaml` file defines encryption rules for user-level secrets.

### Structure
```yaml
keys:
  # Anchors for age public keys
  - &admin age1vy7wsnf8eg5229evq3ywup285jzk9cntsx5hhddjtwsjh0kf4c6s9fmalv
  - &crs58-user age1vn8fpkmkzkjttcuc3prq3jrp7t5fsrdqey74ydu5p88keqmcupvs8jtmv8
  - &raquel-user age12w0rmmskrds6m334w7qrcmpms5lpe3llah6wf8ry5jtatvuxku2sarl8ut

creation_rules:
  # Per-user encryption rules
  - path_regex: secrets/home-manager/users/crs58/.*\.yaml$
    key_groups:
      - age:
          - *admin
          - *crs58-user
```

**Multi-user encryption**: Secrets encrypted with multiple age keys can be decrypted by ANY corresponding private key.

## Age Key Correspondence Validation

User age keys must correspond across three contexts for sops-nix to work correctly.

**Three contexts:**
1. **Clan user**: `sops/users/{username}/key.json` (age public key for clan vars)
2. **Workstation**: `~/.config/sops/age/keys.txt` (age private key for sops decryption)
3. **sops-nix config**: `.sops.yaml` (age public key for encryption rules)

**Validation workflow:**
```bash
# Context 1: Clan user public key
clan_age=$(jq -r '.[0].publickey' sops/users/<user>/key.json)

# Context 2: Workstation private key → public
work_age=$(age-keygen -y < <(grep "AGE-SECRET-KEY" ~/.config/sops/age/keys.txt | tail -1))

# Context 3: sops-nix config
sops_age=$(grep "<user>-user" .sops.yaml | awk '{print $NF}')

# Verify all match
if [ "$clan_age" = "$work_age" ] && [ "$work_age" = "$sops_age" ]; then
  echo "✅ Age keys correspond across all contexts"
else
  echo "❌ Mismatch detected - re-derive from Bitwarden"
fi
```

## Configuration Predicates vs Global Config

**Architectural constraint**: Machine definitions use independent nixpkgs instances evaluated in clan-core context.

**What works:**
```nix
# ✅ Predicate-based config (per-package decisions)
nixpkgs.config.allowUnfreePredicate = pkg: builtins.elem (lib.getName pkg) [
  "terraform"
  "vault"
];
```

**What doesn't work:**
```nix
# ❌ Global config (evaluated before nixpkgs instantiation)
nixpkgs.config.allowUnfree = true;
# Error: attribute 'config' missing
```

**Why**: Machines get fresh nixpkgs instances via `import <nixpkgs> { }` in clan evaluation phase, not from shared flake-level nixpkgs.
Global config requires access to outer flake-parts config, which isn't available.

**See**: `docs/architecture/evaluation-flow-diagram.md` for nixpkgs instantiation contexts.

## Deployment and Runtime Behavior

### Clan Vars Deployment
1. `clan vars generate <machine>` creates encrypted secrets in `vars/`
2. `clan machines update <machine>` deploys configuration + vars
3. sops-nix module decrypts vars using `/var/lib/sops-nix/key.txt`
4. Decrypted secrets appear in `/run/secrets/vars/<generator>/<file>`
5. NixOS modules reference via `config.clan.core.vars.generators.<generator>.files.<file>.value`

### sops-nix Secrets Deployment
1. User creates/edits `secrets/home-manager/users/<user>/secrets.yaml`
2. `sops -e -i` encrypts with age keys from `.sops.yaml`
3. Home-manager activation decrypts using `~/.config/sops/age/keys.txt`
4. Decrypted secrets appear in `~/.config/sops/secrets/<secret-name>`
5. Home-manager modules reference via `config.sops.secrets.<secret-name>.path`

### SSH Daemon and Host Key Updates

**Critical behavior**: SSH daemon loads host keys into memory at startup.

**Issue**: When clan vars updates SSH host key files, sshd doesn't automatically reload.

**Symptom after `clan vars fix <machine>`:**
```
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
```

**Cause**: sshd configuration points to `/run/secrets/vars/openssh/ssh.id_ed25519`, but systemd only restarts services when configuration changes, not when secret file contents change.

**Solution**:
```bash
ssh root@<machine> 'systemctl restart sshd'
```

**Post-restart verification**:
```bash
# Verify host key matches vars
ssh-keyscan -t ed25519 <machine-ip>
nix eval .#nixosConfigurations.<machine>.config.clan.core.vars.generators.openssh.files.\"ssh.id_ed25519.pub\".value --raw
```

## Security Considerations

**Tier 1 (Clan vars):**
- Secrets deployed to `/run/secrets/` (tmpfs, cleared on reboot)
- Machine age key stored in `/var/lib/sops-nix/key.txt` (persistent, needs encrypted filesystem)
- Only root has read access to age private key

**Tier 2 (sops-nix):**
- User age private keys in `~/.config/sops/age/keys.txt` (persistent, mode 600)
- Decrypted secrets in `~/.config/sops/secrets/` (symlinks to /run/user/<uid>/secrets)
- Only user has read access to private key and decrypted secrets

**Bitwarden as source of truth:**
- SSH keys in Bitwarden vault (encrypted, 2FA protected)
- Age keys are ephemeral derivations, can be regenerated from SSH keys
- Rotating SSH key in Bitwarden invalidates all derived age keys

## References

- **Operational guides**: `docs/guides/age-key-management.md`, `docs/guides/machine-management.md`
- **User onboarding**: `docs/guides/adding-users.md`
- **Evaluation flow**: `docs/architecture/evaluation-flow-diagram.md`
- **Story validation**: `infra/docs/notes/development/work-items/1-10c-establish-sops-nix-secrets-home-manager.md`
- **External tools**: [sops-nix](https://github.com/Mic92/sops-nix), [age](https://age-encryption.org/), [ssh-to-age](https://github.com/Mic92/ssh-to-age)
