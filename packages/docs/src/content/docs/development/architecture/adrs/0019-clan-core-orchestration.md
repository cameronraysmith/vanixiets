---
title: "ADR-0019: Clan-Core Orchestration"
---

**Status**: Accepted
**Date**: 2024-11-20
**Scope**: Multi-machine coordination and deployment
**Related**: [ADR-0011: SOPS secrets management](0011-sops-secrets-management/), [ADR-0018: Dendritic flake-parts architecture](0018-dendritic-flake-parts-architecture/)

## Context

This infrastructure manages a heterogeneous fleet of 8 machines across 2 platforms (4 darwin laptops, 4 nixos servers) with 5 users.
Multi-machine coordination requires unified deployment, secrets management, and service orchestration.

### Coordination requirements

**Machine fleet composition**:
- 4 darwin laptops: stibnite, blackphos, rosegold, argentum
- 2 Hetzner VPS: cinnabar (zerotier controller), electrum
- 2 GCP instances: galena (CPU), scheelite (GPU)
- Cross-platform: darwin (aarch64-darwin) and linux (x86_64-linux)

**Deployment needs**:
- Unified command interface for all machines
- Initial installation (bare metal or VM)
- Configuration updates across fleet
- Rollback capability

**Secrets management needs**:
- SSH host key generation per machine
- Zerotier network identities
- LUKS/ZFS encryption passphrases
- Service-specific credentials
- Multi-user secrets isolation

**Service coordination needs**:
- Zerotier VPN mesh (controller + peers)
- User accounts across machines
- SSH known hosts synchronization
- Emergency access patterns

### Prior approach limitations

Before clan-core, multi-machine coordination required:
- Manual deployment scripts per machine
- Separate secrets management (sops-nix only, no generated secrets)
- Ad-hoc service coordination
- No inventory abstraction

## Decision

Adopt **clan-core** for multi-machine orchestration, secrets generation, and service coordination.

### Mental model

Clan is **"Kubernetes for NixOS"**.
It coordinates deployment across machines but doesn't replace the underlying NixOS module system, home-manager, or infrastructure provisioning tools.

- Kubernetes orchestrates containers but doesn't replace Docker
- Clan orchestrates NixOS deployments but doesn't replace NixOS modules

### What clan manages

**Machine registry** via `clan.machines.*`:

```nix
# modules/clan/machines.nix
clan.machines = {
  stibnite = {
    nixpkgs.hostPlatform = "aarch64-darwin";
    imports = [ config.flake.modules.darwin."machines/darwin/stibnite" ];
  };
  cinnabar = {
    nixpkgs.hostPlatform = "x86_64-linux";
    imports = [ config.flake.modules.nixos."machines/nixos/cinnabar" ];
  };
};
```

**Inventory system** via `clan.inventory.*`:

```nix
# modules/clan/inventory/services/zerotier.nix
inventory.instances.zerotier = {
  roles.controller.machines."cinnabar" = { };
  roles.peer.machines = {
    "electrum" = { };
    "stibnite" = { };
    "blackphos" = { };
  };
};
```

**Vars and generators** (Tier 1 secrets):
- SSH host keys
- Zerotier network identities
- LUKS/ZFS encryption passphrases
- Service-specific credentials

Generated via `clan vars generate`, stored encrypted in `vars/` directory.

**Deployment tooling**:
- `clan machines install <machine>` - Initial installation
- `clan machines update <machine>` - Configuration updates
- `clan vars generate` - Generate/regenerate secrets

### What clan does NOT manage

| Capability | Managed by | Relationship to clan |
|------------|------------|---------------------|
| Cloud infrastructure provisioning | **Terranix/Terraform** | Clan deploys TO infrastructure that terranix creates |
| User environment configuration | **Home-Manager** | Deployed WITH clan, not BY clan |
| User-level secrets | **sops-nix** | Tier 2 secrets, parallel to clan vars |
| NixOS/darwin system configuration | **NixOS modules** | Clan imports and deploys configs, doesn't define them |
| Nixpkgs overlays and config | **Flake-level** | Outside clan scope entirely |

### Two-tier secrets architecture

**Tier 1: Clan vars (system-level)**:
- Generated by clan vars system
- Machine-specific secrets
- Examples: SSH host keys, zerotier identities, LUKS passphrases
- Managed via: `clan vars generate`
- Storage: `vars/` directory, encrypted

**Tier 2: sops-nix (user-level)**:
- Manually created via sops CLI
- User-specific secrets
- Examples: GitHub tokens, API keys, signing keys
- Managed via: `sops secrets/users/username.sops.yaml`
- Storage: `secrets/` directory, encrypted with age

See [ADR-0011](0011-sops-secrets-management/) for sops-nix details.

### Service orchestration pattern

Services coordinated via inventory instances:

```nix
# Zerotier with controller/peer roles
inventory.instances.zerotier = {
  roles.controller.machines."cinnabar" = { };
  roles.peer.machines."stibnite" = { };
};

# User with default role across machines
inventory.instances.user-cameron = {
  roles.default.machines = {
    "cinnabar" = { };
    "galena" = { };
    "scheelite" = { };
  };
};
```

Each service instance can have multiple roles assigned to different machines.
Clan modules handle the coordination logic.

## Alternatives considered

### colmena

**Rejected**.

colmena provides deployment orchestration but:
- Less integrated secrets management (requires separate sops-nix setup)
- No built-in service inventory abstraction
- No generated secrets (vars) capability
- darwin support less mature

clan-core's inventory and vars systems provide tighter integration for this use case.

### deploy-rs

**Rejected**.

deploy-rs focuses on deployment mechanics but:
- Deployment only - no secrets generation
- No service orchestration abstractions
- Requires additional tooling for multi-machine coordination
- No inventory concept

clan-core provides deployment plus orchestration in one tool.

### morph

**Rejected**.

morph provides deployment and secrets but:
- Less active development (compared to clan-core)
- Smaller community and ecosystem
- No darwin support
- No inventory abstraction

clan-core has active development by Chaos Computer Club members with regular releases.

### Manual coordination

**Rejected**.

Manual scripts and ad-hoc coordination:
- Doesn't scale to 8 machines
- Error-prone secret management
- No declarative service coordination
- Inconsistent deployment procedures across machines

Fleet growth from 2 to 8 machines made manual coordination untenable.

### NixOps

**Not evaluated in depth**.

NixOps legacy tool with:
- Complex stateful deployment model
- Less active development
- Heavier weight than needed

clan-core's stateless approach aligned better with this infrastructure's needs.

## Consequences

### Positive

**Unified deployment interface**:
All machines (darwin, nixos, VPS, local) deploy with same commands.
`clan machines update stibnite` works identically to `clan machines update cinnabar`.

**Generated secrets eliminate manual key management**:
SSH host keys, zerotier identities generated automatically.
No manual key creation for new machines.
`clan vars generate` handles secret lifecycle.

**Service inventory enables multi-machine coordination**:
Zerotier controller/peer topology declaratively defined.
User accounts assigned to machines via inventory.
Adding machine to service: one line in inventory.

**Two-tier secrets complements sops-nix**:
System secrets (clan vars) and user secrets (sops-nix) have clear separation.
Each tier optimized for its use case.
No overlap or confusion about which system manages what.

**Active development and community**:
clan-core maintained by Chaos Computer Club members.
Regular releases, responsive issue handling.
Growing ecosystem of clan modules.

**Flake-parts integration**:
Clan is a flake-parts module.
Integrates naturally with dendritic pattern (see [ADR-0018](0018-dendritic-flake-parts-architecture/)).
No architectural impedance mismatch.

### Negative

**darwin support requires workarounds**:
clan-core zerotier module is NixOS-specific (systemd dependencies).
Darwin machines use homebrew + activation script pattern.
Documented workaround (101-line module) but not native.

**Learning curve for clan concepts**:
Inventory, vars, generators are new abstractions.
Documentation improving but not as comprehensive as NixOS.
Contributors need to understand clan patterns.

**Vars encryption tied to age keys**:
Vars system uses age encryption.
Key management required (same keys as sops-nix).
Lost keys require secret regeneration.

**Deployment requires network access**:
`clan machines update` requires SSH to target.
No offline deployment capability.
VPN (zerotier) must be operational for remote machines.

### Neutral

**Terranix still handles infrastructure**:
Clan deploys to VMs, doesn't create them.
Terranix/terraform provisioning unchanged.
Clear separation of concerns.

**Home-manager unchanged**:
Home-manager configurations defined in dendritic modules.
Clan deploys full system config including home-manager.
No home-manager-specific clan integration.

**NixOS modules unchanged**:
System configuration still uses standard NixOS modules.
Clan imports and deploys configs.
Module authoring skills transfer directly.

## Validation evidence

### Epic 1 (November 2024)

Clan validated in test-clan repository:

- **Story 1.3**: Clan inventory configured for Hetzner VMs
- **Story 1.5**: VM deployment via clan (`clan machines install hetzner-vm`)
- **Story 1.9**: Zerotier network coordination (controller + peer roles)
- **Story 1.10A**: User management via clan inventory pattern
- **Story 1.12**: Heterogeneous deployment (darwin + nixos)

**Metrics from GO/NO-GO decision**:
- 3 machines operational (cinnabar, electrum, blackphos)
- Zerotier network db4344343b14b903 coordinated
- Pattern confidence: HIGH

### Epic 2 (November 2024)

Production deployment:

- **Stories 2.5-2.7**: Darwin workstations deployed via clan
- **Stories 2.9-2.10**: VPS deployment switched to clan
- **Stories 2.13-2.14**: New machines added to inventory

### Epic 7 (December 2024)

GCP infrastructure:

- **Story 7.3**: GCP nodes integrated into clan inventory
- **Story 7.4**: GPU compute (scheelite) orchestrated via clan

**Result**: 8-machine fleet fully operational under clan orchestration.

## References

### Internal

- [Clan Integration concept documentation](/concepts/clan-integration)
- [ADR-0011: SOPS secrets management](0011-sops-secrets-management/)
- [ADR-0018: Dendritic flake-parts architecture](0018-dendritic-flake-parts-architecture/)
- [ADR-0020: Dendritic + Clan integration](0020-dendritic-clan-integration/)
- Epic 1 GO/NO-GO decision: `docs/notes/development/go-no-go-decision.md`

### External

- [Clan documentation](https://clan.lol/) - Official clan-core docs
- [clan-core repository](https://github.com/clan-lol/clan-core) - Source code
- [clan-infra](https://git.clan.lol/clan/clan-infra) - Production reference
- [qubasa-clan-infra](https://github.com/qubasa/dotfiles) - Developer personal clan
- [mic92-clan-dotfiles](https://github.com/Mic92/dotfiles) - Developer personal clan
- [pinpox-clan-nixos](https://github.com/pinpox/nixos) - Developer personal clan
