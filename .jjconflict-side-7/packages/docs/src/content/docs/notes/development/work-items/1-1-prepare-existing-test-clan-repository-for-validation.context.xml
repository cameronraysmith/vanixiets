<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1</storyId>
    <title>Prepare existing test-clan repository for validation</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/notes/development/work-items/1-1-prepare-existing-test-clan-repository-for-validation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to review and prepare the existing test-clan repository for nix dendritic flake-parts + clan validation</iWant>
    <soThat>I can validate the architectural combination in isolation before infrastructure deployment</soThat>
    <tasks>
- [ ] Review existing test-clan repository state (AC: #1)
  - [ ] Navigate to ~/projects/nix-workspace/test-clan/
  - [ ] Check git status and current branch
  - [ ] Review existing flake.nix structure
  - [ ] Identify existing modules/ organization
  - [ ] Document current state for baseline

- [ ] Create/confirm working branch for validation work (AC: #1)
  - [ ] Create branch: `git checkout -b phase-0-validation` or confirm on main
  - [ ] Ensure clean working state before modifications

- [ ] Update flake inputs for dendritic + clan integration (AC: #2)
  - [ ] Add clan-core input: `git+https://git.clan.lol/clan/clan-core` following nixpkgs/flake-parts
  - [ ] Add import-tree input: `github:vic/import-tree`
  - [ ] Configure input follows for clan-core: nixpkgs, flake-parts, sops-nix, home-manager
  - [ ] Verify flake.lock updates after input changes

- [ ] Configure flake-parts.lib.mkFlake structure (AC: #2)
  - [ ] Update flake.nix outputs to use `flake-parts.lib.mkFlake { inherit inputs; }`
  - [ ] Add import-tree auto-discovery: `(inputs.import-tree ./modules)`
  - [ ] Verify flake structure follows dendritic pattern

- [ ] Import clan-core flakeModules.default (AC: #3)
  - [ ] Add `inputs.clan-core.flakeModules.default` to imports list
  - [ ] Verify clan flakeModule loads without conflicts

- [ ] Create/verify dendritic modules/ directory structure (AC: #4)
  - [ ] Create modules/base/ for foundation modules (nix settings)
  - [ ] Create modules/hosts/ for machine-specific configurations
  - [ ] Create modules/flake-parts/ for flake-level configuration
  - [ ] Verify directory structure matches dendritic pattern from integration-plan.md

- [ ] Test flake evaluation (AC: #5)
  - [ ] Run: `nix flake check`
  - [ ] Fix any evaluation errors discovered
  - [ ] Run: `nix flake show` to verify outputs structure
  - [ ] Verify no warnings or critical issues

- [ ] Update README.md with Phase 0 validation documentation (AC: #6)
  - [ ] Document purpose: Phase 0 architectural validation environment
  - [ ] Document scope: Testing dendritic flake-parts + clan integration before infrastructure commitment
  - [ ] Document structure: Module organization, flake inputs, intended outcomes
  - [ ] Note disposable nature: Experimental repository, failure is acceptable and informative
  - [ ] Reference integration-plan.md for migration context

- [ ] Verify clean git state (AC: #7)
  - [ ] Stage changes: `git add .`
  - [ ] Commit with atomic message: "chore(phase-0): prepare test-clan for dendritic + clan validation"
  - [ ] Verify working tree clean: `git status`
  - [ ] Ready for Story 1.2 (dendritic pattern implementation)
    </tasks>
  </story>

  <acceptanceCriteria>
1. Existing test-clan repository at ~/projects/nix-workspace/test-clan/ reviewed and working branch created/confirmed
2. flake.nix updated to use flake-parts.lib.mkFlake with required inputs: nixpkgs, flake-parts, clan-core, import-tree
3. Clan-core flakeModules.default imported
4. modules/ directory structure verified/created: modules/base/, modules/hosts/, modules/flake-parts/
5. Flake evaluates without errors: `nix flake check`
6. README.md updated to document Phase 0 validation purpose and scope
7. Git working state clean and ready for iterative development
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/notes/development/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-1: Architectural Integration (Phase 0 validation)</section>
        <snippet>FR-1.1: test-clan repository shall integrate clan-core flakeModules with dendritic flake-parts pattern (or hybrid approach if conflicts discovered). Flake shall use `import-tree ./modules` for automatic module discovery.</snippet>
      </doc>
      <doc>
        <path>docs/notes/development/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.1: Prepare existing test-clan repository for validation</section>
        <snippet>Existing fledgling repository at ~/projects/nix-workspace/test-clan/ can be used/adapted for Phase 0 validation. This is the entry point to the entire migration - if this foundation isn't solid, everything built on it will be unstable.</snippet>
      </doc>
      <doc>
        <path>docs/notes/clan/integration-plan.md</path>
        <title>Clan Integration Plan</title>
        <section>Phase 0: Pattern validation (test-clan/)</section>
        <snippet>Repository: ~/projects/nix-workspace/test-clan/ (experimental, main branch). Objective: Determine optimal balance of dendritic flake-parts pattern with clan functionality. Foundation: clan + flake-parts (proven), Experiment: How much dendritic optimization is compatible?</snippet>
      </doc>
      <doc>
        <path>docs/notes/clan/integration-plan.md</path>
        <title>Clan Integration Plan</title>
        <section>Directory structure (target state)</section>
        <snippet>modules/ structure: base/ (Foundation modules), nixos/ (NixOS-specific), darwin/ (Darwin-specific), shell/ (Shell tools), dev/ (Development tools), hosts/ (Machine-specific), flake-parts/ (Flake-level configuration), terranix/ (Terraform), users/ (User configurations)</snippet>
      </doc>
      <doc>
        <path>docs/notes/clan/migration-assessment.md</path>
        <title>Migration Assessment</title>
        <section>test-clan (Phase 0: validation environment)</section>
        <snippet>Strategic value: Risk reduction (proves dendritic + clan integration before infrastructure investment), Pattern discovery (identifies integration challenges in safe environment), Reference implementation (provides proven patterns for cinnabar deployment), No production impact (isolated testing)</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/flake.nix</path>
        <kind>flake configuration</kind>
        <symbol>outputs</symbol>
        <lines>1-40</lines>
        <reason>Existing test-clan flake structure using vanilla clan pattern (no dendritic yet) - needs to be updated to flake-parts.lib.mkFlake with import-tree</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/clan.nix</path>
        <kind>clan configuration</kind>
        <symbol>meta, inventory</symbol>
        <lines>1-59</lines>
        <reason>Existing clan inventory configuration with template structure - shows baseline clan setup before dendritic integration</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/test-clan/modules/gnome.nix</path>
        <kind>module</kind>
        <symbol>gnome.nix</symbol>
        <lines>N/A</lines>
        <reason>Existing module structure (only gnome.nix present) - needs to be organized into dendritic pattern (base/, hosts/, flake-parts/)</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/drupol-dendritic-infra/flake.nix</path>
        <kind>dendritic flake example</kind>
        <symbol>outputs</symbol>
        <lines>58</lines>
        <reason>Canonical dendritic flake structure: `inputs.flake-parts.lib.mkFlake { inherit inputs; } (inputs.import-tree ./modules)` - target pattern for test-clan</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/clan-infra/flake.nix</path>
        <kind>clan + flake-parts example</kind>
        <symbol>outputs</symbol>
        <lines>59-80</lines>
        <reason>Production clan-infra pattern: flake-parts.lib.mkFlake with inputs.clan-core.flakeModules.default import - shows how clan integrates with flake-parts</reason>
      </artifact>
      <artifact>
        <path>~/projects/nix-workspace/clan-infra/machines/flake-module.nix</path>
        <kind>clan inventory configuration</kind>
        <symbol>clan.inventory.instances</symbol>
        <lines>15-96</lines>
        <reason>Production clan inventory examples: emergency-access, zerotier, sshd, matrix-synapse service instances with roles - demonstrates clan service instance patterns</reason>
      </artifact>
    </code>
    <dependencies>
      <nix>
        <input name="nixpkgs">nixos-unstable or nixpkgs-unstable</input>
        <input name="flake-parts">hercules-ci/flake-parts (module system foundation)</input>
        <input name="clan-core">git+https://git.clan.lol/clan/clan-core (multi-machine coordination)</input>
        <input name="import-tree">github:vic/import-tree (automatic module discovery)</input>
      </nix>
    </dependencies>
  </artifacts>

  <constraints>
- Story 1.1 creates STRUCTURE only, not pattern implementation (that's Story 1.2)
- This is experimental - failure is acceptable and informative
- Zero-regression mandate does NOT apply to test-clan (experimental environment)
- Solo operator workflow - no team coordination required
- Local validation only - no CI for Phase 0
- Expected execution time: 1-2 hours
- First story in epic - no predecessor context to inherit
  </constraints>

  <interfaces>
    <interface>
      <name>flake-parts.lib.mkFlake</name>
      <kind>Nix flake API</kind>
      <signature>mkFlake { inherit inputs; } (attrset or function returning attrset)</signature>
      <path>N/A (flake-parts library function)</path>
    </interface>
    <interface>
      <name>import-tree</name>
      <kind>Nix flake function</kind>
      <signature>import-tree ./path-to-modules (recursively imports all .nix files as flake-parts modules)</signature>
      <path>N/A (import-tree library function)</path>
    </interface>
    <interface>
      <name>clan-core.flakeModules.default</name>
      <kind>flake-parts module</kind>
      <signature>Provides clan.* namespace options (meta.name, inventory.machines, inventory.instances, specialArgs, secrets)</signature>
      <path>clan-core flake output</path>
    </interface>
    <interface>
      <name>clan.inventory.machines</name>
      <kind>Clan inventory API</kind>
      <signature>attrset of { tags = list of strings; machineClass = "nixos" | "darwin"; }</signature>
      <path>Defined in clan.nix or modules/flake-parts/clan.nix</path>
    </interface>
    <interface>
      <name>clan.inventory.instances</name>
      <kind>Clan service instance API</kind>
      <signature>attrset of { module = { name, input }; roles.<role>.machines.<machine> = {}; roles.<role>.tags.<tag> = {}; }</signature>
      <path>Defined in clan.nix or modules/flake-parts/clan.nix</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
**Local validation commands for Phase 0:**
- `nix flake check` - Validates flake syntax and evaluation
- `nix flake show` - Shows flake outputs structure
- `nix eval .#flake.modules.nixos --apply builtins.attrNames` - Verifies dendritic module namespace
- `nix eval .#clan.inventory --json | jq .` - Validates clan inventory structure
- `nix build .#nixosConfigurations.test-vm.config.system.build.toplevel` - Builds test configuration

**No automated testing infrastructure for Phase 0** - manual validation sufficient for experimental repository. CI expansion deferred to post-migration.
    </standards>
    <locations>
N/A (Story 1.1 is setup/skeleton only, no test files created)
    </locations>
    <ideas>
- Flake evaluation test: verify flake.nix evaluates without errors after adding inputs
- import-tree discovery test: verify import-tree finds all modules in modules/ directory
- Clan inventory validation test: verify clan.inventory.machines and clan.inventory.instances evaluate correctly
- Module namespace test: verify flake.modules.* namespace is created (even if empty)
- Flake structure test: verify outputs include nixosConfigurations (from clan flakeModule)
    </ideas>
  </tests>
</story-context>
