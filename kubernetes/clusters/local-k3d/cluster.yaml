# ctlptl cluster configuration for local k3d development cluster
# This configuration creates a single-node k3d cluster (k3s v1.31) with:
# - Static subnet 192.168.100.0/24 for predictable IPs:
#   - .2 = k3d-serverlb (load balancer container)
#   - .3 = k3d-dev-server-0 (k3s node, where servicelb binds)
#   sslip.io domains use .3: *.192.168.100.3.sslip.io resolves to k3s node
# - Disabled Flannel (for Cilium CNI - pod networking)
# - k3s kube-proxy enabled (Cilium kube-proxy replacement has eBPF issues in k3d)
# - Disabled Traefik (using Cilium Gateway API for ingress)
# - ServiceLB enabled (klipper-lb assigns node IPs to LoadBalancer services)
# - Ports 80/443 exposed for Gateway API ingress via servicelb
# - K3D_FIX_MOUNTS=1 environment variable for OrbStack compatibility
# - Host volume mount at /manifests for CI ArgoCD file:// repo access
apiVersion: ctlptl.dev/v1alpha1
kind: Cluster
name: k3d-dev
product: k3d
k3d:
  v1alpha5Simple:
    servers: 1
    subnet: "192.168.100.0/24"
    image: rancher/k3s:v1.31.4-k3s1
    volumes:
      - volume: /tmp/k3d-manifests:/manifests
        nodeFilters:
          - server:*
    env:
      - envVar: K3D_FIX_MOUNTS=1
        nodeFilters:
          - server:*
          - agent:*
    ports:
      - port: 80:80
        nodeFilters:
          - loadbalancer
      - port: 443:443
        nodeFilters:
          - loadbalancer
    options:
      k3s:
        extraArgs:
          - arg: --flannel-backend=none
            nodeFilters:
              - server:*
          - arg: --disable-network-policy
            nodeFilters:
              - server:*
          - arg: --disable=traefik
            nodeFilters:
              - server:*
