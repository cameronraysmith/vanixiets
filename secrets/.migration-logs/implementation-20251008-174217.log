# Key Migration Implementation Log
# Started: $(date)
# Branch: 06-sops-update
# Planning docs version: 2.2

## Pre-flight Verification
- Bitwarden CLI: 2025.9.0 ✅
- ssh-to-age: Available ✅
- jq: 1.8.1 ✅
- gh CLI: Authenticated ✅
- nix develop + just: 1.42.4 ✅
- SSH to orb-nixos: Working ✅
- Current host: stibnite ✅
- Planning docs: Version 2.2 ✅
- Documentation: Gap closure complete ✅


## Current State Discovery (Phase 0)

### Users in config.nix
- cameron: baseIdentity.sshKey (admin)
- crs58: baseIdentity.sshKey (admin) 
- runner: baseIdentity.sshKey (non-admin)
- jovyan: baseIdentity.sshKey
- raquel: raquel.sshKey (distinct, non-admin)

Result: 5 users → 2 unique SSH keys → 2 Bitwarden entries needed

### Host configurations
Darwin hosts:
- stibnite.nix (real host, current machine)
- blackphos.nix (real host, production)

NixOS hosts:
- orb-nixos/ (real host, development VM)
- blackphos-nixos.nix (CI test config - NO KEY)
- stibnite-nixos.nix (CI test config - NO KEY)

Result: 3 real hosts + 2 CI test configs → 3 Bitwarden entries needed

### Current .sops.yaml keys
- &admin: age1vy7wsnf8eg5229evq3ywup285jzk9cntsx5hhddjtwsjh0kf4c6s9fmalv (recovery)
- &crs58: age1whsxa8rlfm8c9hgjc2yafq5dvuvkz58pfd85nyuzdcjndufgfucs7ll3ke (user)
- &stibnite: age18rgyca7ptr6djqn5h7rhgu4yuv9258v5wflg7tefgvxr06nz7cgsw7qgmy (host)
- &orb-nixos: age1609ngcyxj8x5fyjkdctkzxdws9e38yy28l88lvs0echtv0kdy5aslcqm3w (host)

Missing:
- blackphos host key (not in .sops.yaml)
- Separate user identity keys (baseIdentity vs raquel)
- Repository keys (dev, ci)

### Current secrets files
- secrets/shared.yaml
- secrets/test.yaml
- secrets/users/crs58/NP3W1uaSSCXgMAJGatirTtTsHWnnxJNp-config.yaml

### Current justfile
Has [group('secrets')] with various recipes including validate-secrets.
Need to add: validate-sops-user-keys, validate-sops-host-keys, validate-sops-repo-keys, validate-sops-correspondences

