{"id":"nix-10i","title":"Add nixos-generators flake input","description":"Add nixos-generators to flake.nix inputs.","status":"closed","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-16T22:09:39.872847-05:00","created_by":"Cameron Smith","updated_at":"2026-01-16T22:12:56.32702-05:00","closed_at":"2026-01-16T22:12:56.32702-05:00","close_reason":"Implemented in 6ed635a6","dependencies":[{"issue_id":"nix-10i","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-16T22:09:59.29405-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-1hy","title":"Update Colima module for custom VM images","description":"Add diskImage option to modules/darwin/colima.nix to support custom NixOS qcow2 images via --disk-image flag. Update colima-init helper script to conditionally pass the flag when configured.\n\nFiles to modify:\n- modules/darwin/colima.nix","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-16T22:09:46.951668-05:00","created_by":"Cameron Smith","updated_at":"2026-01-17T21:26:18.340219-05:00","closed_at":"2026-01-17T21:26:18.340219-05:00","close_reason":"Won't fix: Colima cannot use custom VM images. Pivoting to incus.","dependencies":[{"issue_id":"nix-1hy","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-16T22:10:00.901557-05:00","created_by":"Cameron Smith"}],"comments":[{"id":7,"issue_id":"nix-1hy","author":"Cameron Smith","text":"Closed as won't-fix. Discovery: Colima's --disk-image flag validates SHA-512 hashes against official images only (from https://github.com/abiosoft/colima-...). Custom NixOS images are rejected. The Colima home-manager module cannot be extended to support custom VM images. Local development pivoting to incus which accepts custom qcow2 images via 'incus image import'. Rescoped nix-50f.3 and nix-50f.4 from Colima to incus profiles.","created_at":"2026-01-18T02:26:07Z"}]}
{"id":"nix-2hd","title":"Cilium pod-to-host networking broken","description":"## Root Cause Investigation\n\n**Environment:**\n- NixOS k3s VM in Incus on macOS (aarch64)\n- Cilium: 1.18.6\n\n**Symptoms:**\n- Pods cannot reach cilium_host - 100% packet loss\n- Host → Pod traffic works (health checks succeed)\n- Cilium monitor shows packets sent to 'stack' but kernel ICMP counters never increment\n\n**Investigation findings (2026-01-19):**\n\nKernel config, BPF JIT, rp_filter all verified correct.\n\n**Configuration tests (all failed to resolve):**\n- TCX vs Legacy TC attachment: same behavior\n- Tunnel (geneve) vs Native routing: same behavior\n- Host: BPF vs Host: Legacy routing: same behavior\n\n**Kernel upgrade test:**\n- Upgraded from 6.12.65 LTS to 6.18.5 latest\n- Issue persists with identical trace pattern\n- Kernel version is NOT the root cause\n\n**Consistent trace pattern across all configurations:**\n```\n-\u003e stack flow 0x0, identity X-\u003ehost state new ifindex 0 orig-ip 0.0.0.0: \u003cpod-ip\u003e -\u003e \u003ccilium_host-ip\u003e icmp EchoRequest\n```\n- flow 0x0 (zero flow ID)\n- ifindex 0 (no interface specified)\n- orig-ip 0.0.0.0 (metadata missing)\n- Packet never reaches kernel (ICMP counters unchanged)\n\n**Root cause:**\nBPF stack delivery is broken in **Incus/QEMU/Colima nested virtualization** on ARM64. The issue is environment-specific, not kernel or Cilium configuration related.\n\n**Next steps:**\n1. Test on bare-metal ARM64 or native Linux VM (not nested)\n2. Test on x86_64 Colima/Incus to isolate ARM64 emulation factor\n3. Consider filing Cilium issue with nested virtualization context\n4. Workaround: use x86_64-linux VMs via Rosetta instead of native aarch64","status":"in_progress","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-18T22:19:49.285691-05:00","created_by":"Cameron Smith","updated_at":"2026-01-19T01:34:21.614214-05:00","dependencies":[{"issue_id":"nix-2hd","depends_on_id":"nix-50f.6","type":"discovered-from","created_at":"2026-01-18T22:19:56.461578-05:00","created_by":"Cameron Smith"}],"comments":[{"id":12,"issue_id":"nix-2hd","author":"Cameron Smith","text":"Architecture evaluation complete (2026-01-19):\n\nEvaluated alternatives to address broken Cilium eBPF in Incus/Colima nested virtualization:\n\n1. OrbStack: NOT VIABLE - No custom CNI support (issue #742 open since Oct 2023)\n2. kind + ctlptl: RECOMMENDED - Cilium compatible, x86_64 via Rosetta, avoids nested virt\n3. k3d: VIABLE - Similar to kind, better if prod uses k3s  \n4. Native aarch64 without Cilium: FALLBACK - Reduced parity, validates in CI only\n\nRoot cause confirmed: macOS Hypervisor.framework lacks nested virtualization support.\nCilium eBPF in ARM64 nested virt is unsupported edge case (OrbStack issue #39930 shows similar).\n\nRecommendation: Adopt x86_64 kind with Rosetta translation. This:\n- Restores functional Cilium networking\n- Provides architecture parity with Hetzner\n- Avoids nested virtualization entirely\n- Accepts limited eBPF (container runtime constraints)\n\nADR-005 drafted: docs/notes/development/kubernetes/decisions/ADR-005-local-cluster-architecture-revision.md\n\nNext steps: Create implementation issue for kind + ctlptl integration.","created_at":"2026-01-19T06:52:06Z"}]}
{"id":"nix-50f","title":"Local Development Cluster","description":"Local k3s development environment on macOS following four-phase architecture.\n\nImplements architecture decisions from ADR-001: dual Colima VMs (k3s-dev + k3s-capi), x86_64-linux via Rosetta for production parity, sslip.io DNS, step-ca local TLS, sops-secrets-operator, Cilium CNI.\n\nComponents: NixOS VM image, Colima profiles, k3s server module, Cilium CNI, step-ca ACME, cert-manager, sops-secrets-operator, storage provisioners, easykubenix stage configuration.\n\nReferences:\n- docs/notes/development/kubernetes/decisions/ADR-001-local-dev-architecture.md\n- docs/notes/development/kubernetes/workflows/01-environment-setup.md\n- docs/notes/development/kubernetes/workflows/02-local-development.md","status":"open","priority":1,"issue_type":"epic","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:03.588324-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T22:48:24.317388-05:00"}
{"id":"nix-50f.1","title":"NixOS VM image for k3s local development","description":"Build aarch64-linux NixOS VM image for local k3s development cluster. This image runs the local ClusterAPI bootstrap cluster on Apple Silicon (via Colima/incus) that will provision and transfer management to x86_64-linux production clusters on Hetzner. Architecture independence between bootstrap (aarch64) and target (x86_64) clusters is a deliberate design choice documented in ADR-002.","status":"closed","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:49.658333-05:00","created_by":"Cameron Smith","updated_at":"2026-01-17T22:55:03.247634-05:00","closed_at":"2026-01-17T22:55:03.247634-05:00","close_reason":"Implemented unified incus image builder (c56149b5). Dual outputs: k3s-local-image (incus tarball) and k3s-local-qcow (raw qcow2). Verified: build → import → launch works.","dependencies":[{"issue_id":"nix-50f.1","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:49.658981-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.1","depends_on_id":"nix-50f.2","type":"blocks","created_at":"2026-01-15T20:37:55.319723-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.1","depends_on_id":"nix-10i","type":"blocks","created_at":"2026-01-16T22:09:56.036388-05:00","created_by":"Cameron Smith"}],"comments":[{"id":3,"issue_id":"nix-50f.1","author":"Cameron Smith","text":"Implementation checkpoint: 2026-01-16\n\nCompleted:\n- Created modules/images/k3s-local.nix using nixos-generators\n- Format: qcow-efi (UEFI boot)\n- Target: x86_64-linux (production parity with Hetzner)\n- Imports k3s-server module via deferred module composition\n- SSH access, nix flakes enabled, 60GB disk\n\nKey fix: Removed virtualisation.rosetta config. That module is for\naarch64-linux guests wanting to run x86_64 binaries. For x86_64-linux\nVMs on Apple Silicon, Rosetta translation happens at the hypervisor\nlevel (Virtualization.framework), not in the guest.\n\nDry-run build succeeds (238 derivations).\nBuild command: nix build .#k3s-local-image\n\nNext: Full build test, then Colima profile configuration (nix-50f.3)","created_at":"2026-01-17T04:35:24Z"},{"id":4,"issue_id":"nix-50f.1","author":"Cameron Smith","text":"Reopening to change architecture from x86_64-linux to aarch64-linux for local ClusterAPI bootstrap cluster","created_at":"2026-01-17T15:57:12Z"},{"id":8,"issue_id":"nix-50f.1","author":"Cameron Smith","text":"Ready for aarch64 build. Module already targets aarch64-linux (modules/images/k3s-local.nix:28). Post-build workflow: incus image import → incus launch → cluster exists. Colima path abandoned per nix-1hy closure.","created_at":"2026-01-18T02:26:38Z"},{"id":9,"issue_id":"nix-50f.1","author":"Cameron Smith","text":"Follow-up fixes applied (8230dd6c): incus agent enabled, SSH keys from userIdentities.crs58, ARM64 serial console. Image rebuild required.","created_at":"2026-01-18T05:55:47Z"}]}
{"id":"nix-50f.10","title":"nix-csi driver module","description":"Create nix-csi module for dynamic Nix store closure mounting as ephemeral volumes. DaemonSet deployment with privileged pods, bidirectional mount propagation. Single-node mode for local, optional cache StatefulSet for production.\n\nFiles to create:\n- modules/k8s/nix-csi/default.nix\n\nReference: docs/notes/development/kubernetes/components/nix-csi.md","status":"open","priority":3,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:57.999205-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:36:57.999205-05:00","dependencies":[{"issue_id":"nix-50f.10","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:57.999786-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.10","depends_on_id":"nix-50f.9","type":"blocks","created_at":"2026-01-15T20:38:01.374161-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-50f.11","title":"easykubenix stage configuration (local)","description":"Create local stage configuration for easykubenix that composes all infrastructure modules with local-specific overrides. Wire kluctl targets in .kluctl.yaml.\n\nFiles to create:\n- clusters/local/default.nix (local stage entry point)\n- .kluctl.yaml (kluctl target configuration)\n- flake.nix additions for k8s-manifests-local output\n\nReference: docs/notes/development/kubernetes/workflows/02-local-development.md","status":"open","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:58.875854-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:36:58.875854-05:00","dependencies":[{"issue_id":"nix-50f.11","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:58.876426-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.11","depends_on_id":"nix-50f.5","type":"blocks","created_at":"2026-01-15T20:38:02.814998-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.11","depends_on_id":"nix-50f.7","type":"blocks","created_at":"2026-01-15T20:38:03.386843-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.11","depends_on_id":"nix-50f.8","type":"blocks","created_at":"2026-01-15T20:38:04.802081-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.11","depends_on_id":"nix-50f.13","type":"blocks","created_at":"2026-01-17T11:06:07.368105-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-50f.12","title":"Local cluster verification and testing","description":"Verify local development cluster matches architecture. Test: VM image boot, k3s startup, Cilium CNI activation, pod scheduling, cert-manager ACME flow with step-ca, sops secret decryption, storage provisioning.\n\nVerification checklist:\n- colima ssh --profile k3s-dev (SSH access)\n- systemctl status k3s (k3s running)\n- kubectl get nodes (Ready state)\n- kubectl get pods -n kube-system (Cilium running)\n- kubectl get certificates (cert issuance)\n\nReference: docs/notes/development/kubernetes/workflows/02-local-development.md","status":"open","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:59.534041-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:36:59.534041-05:00","dependencies":[{"issue_id":"nix-50f.12","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:59.534642-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.12","depends_on_id":"nix-50f.11","type":"blocks","created_at":"2026-01-15T20:38:15.215816-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.12","depends_on_id":"nix-50f.3","type":"blocks","created_at":"2026-01-15T20:38:15.814737-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-50f.13","title":"ArgoCD easykubenix module","description":"Create easykubenix module for ArgoCD installation as Phase 3b infrastructure. ArgoCD must be deployed via easykubenix/kluctl before nixidy can manage applications. Follow helm.releases pattern from hetzkube (similar to cilium, metrics-server). Register Application, AppProject, ApplicationSet CRDs in apiMappings.","status":"open","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-17T11:04:40.225909-05:00","created_by":"Cameron Smith","updated_at":"2026-01-17T11:04:40.225909-05:00","dependencies":[{"issue_id":"nix-50f.13","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-17T11:04:40.227162-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-50f.14","title":"nixidy local cluster integration","description":"Configure nixidy for local development cluster. Generate ArgoCD Application CRs pointing to git repository. Test full Phase 4 workflow: nixidy switch generates manifests, ArgoCD syncs applications. Verify self-updating pattern where ArgoCD manages its own configuration via nixidy-generated Application CR.","status":"open","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-17T11:04:46.297141-05:00","created_by":"Cameron Smith","updated_at":"2026-01-17T11:04:46.297141-05:00","dependencies":[{"issue_id":"nix-50f.14","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-17T11:04:46.298727-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.14","depends_on_id":"nix-50f.13","type":"blocks","created_at":"2026-01-17T11:06:13.16171-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-50f.15","title":"Document bootstrap architecture and Phase 3b/4 workflow","description":"Create ADR-002 for bootstrap architecture independence (aarch64 local -\u003e x86_64 production). Create easykubenix-modules.md component guide. Update reference-architecture.md to clarify ArgoCD as Phase 3b infrastructure and nixidy dependency. Document experimental ClusterAPI transfer point between ArgoCD installation and nixidy application deployment.","status":"closed","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-17T11:04:58.161857-05:00","created_by":"Cameron Smith","updated_at":"2026-01-17T11:07:09.697986-05:00","closed_at":"2026-01-17T11:07:09.697986-05:00","close_reason":"Completed: ADR-002 (948e346b), easykubenix-modules.md (afb99547), reference-architecture.md updates","dependencies":[{"issue_id":"nix-50f.15","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-17T11:04:58.163141-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-50f.16","title":"Cloud-init networking and port forwarding for multi-cluster support","description":"Implement the three-layer networking architecture documented in ADR-004 to support multiple local k3s clusters from a single NixOS image with deterministic IP addresses and predictable port mappings.\n\n**Problem:**\n- Current k3s-local.nix image uses DHCP, resulting in unpredictable IPs\n- No port forwarding from macOS localhost to incus VMs inside Colima\n- Cannot run multiple clusters (k3s-dev, k3s-capi) without IP collisions\n- Network topology (macOS → Colima → incusbr0 → VMs) requires relay forwarding\n\n**Solution (per ADR-004):**\n\n1. **k3s-local.nix**: Enable cloud-init, configure systemd-networkd to accept network-config from cloud-init metadata, DHCP fallback\n\n2. **incus.nix**: Parameterize profiles with `user.network-config` (cloud-init network v2) and `user.meta-data` (hostname). IP scheme: 192.100.0.(10+N)\n\n3. **colima.nix**: Add `clusters` option for port forwarding via Lima provision scripts + systemd socat services. Port scheme: base_port + cluster_index\n\n**Port mapping:**\n| Cluster | API | HTTP | HTTPS | SSH |\n|---------|-----|------|-------|-----|\n| k3s-dev | 6443 | 8080 | 8443 | 2210 |\n| k3s-capi | 6444 | 8081 | 8444 | 2211 |\n\n**Architecture note:**\nLocal clusters run aarch64-linux (native Apple Silicon). The k3s-capi bootstrap cluster will provision x86_64-linux Hetzner VMs via ClusterAPI. The pivot transfers ClusterAPI resources, not the VM image itself.\n\n**Files to modify:**\n- modules/images/k3s-local.nix (cloud-init support)\n- modules/home/development/incus.nix (parameterized profiles with network-config)\n- modules/darwin/colima.nix (port forwarding configuration)\n- modules/machines/darwin/stibnite/default.nix (cluster port forward definitions)\n\n**References:**\n- ADR-004: Local cluster networking architecture\n- ADR-001: Local development architecture","status":"tombstone","priority":1,"issue_type":"feature","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-18T14:50:20.134901-05:00","created_by":"Cameron Smith","updated_at":"2026-01-18T14:58:14.064196-05:00","dependencies":[{"issue_id":"nix-50f.16","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-18T14:50:20.13605-05:00","created_by":"Cameron Smith"}],"deleted_at":"2026-01-18T14:58:14.064196-05:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"feature"}
{"id":"nix-50f.17","title":"Cloud-init networking and port forwarding for multi-cluster support","description":"Implement cloud-init based networking and Colima port forwarding to support multiple k3s clusters from a single NixOS image.\n\n## Architecture (ADR-004)\n\nThree-layer approach:\n1. **k3s-local.nix image**: Enable cloud-init, systemd-networkd with DHCP fallback, hostname from metadata\n2. **incus.nix profiles**: Supply user.network-config (static IP) and user.meta-data (hostname) per cluster\n3. **colima.nix**: Parameterized port forwarding via Lima provision scripts\n\n## IP Assignment\n- k3s-dev: 192.100.0.10\n- k3s-capi: 192.100.0.11\n- Pattern: 192.100.0.(10+N)\n\n## Port Mapping (per cluster)\n| Port | k3s-dev | k3s-capi | Service |\n|------|---------|----------|---------|\n| API  | 6443    | 6444     | kube-apiserver |\n| HTTP | 8080    | 8081     | Ingress |\n| HTTPS| 8443    | 8444     | Ingress |\n| SSH  | 2210    | 2211     | Node access |\n\n## Files to modify\n- modules/images/k3s-local.nix (cloud-init support)\n- modules/home/development/incus.nix (parameterized profiles with network-config)\n- modules/darwin/colima.nix (port forwarding option)\n- modules/machines/darwin/stibnite/default.nix (configure port forwards)\n\n## Rationale\n- Single image avoids duplication\n- Cloud-init is standard VM configuration injection pattern\n- Predictable ports enable reliable tooling (kubeconfig, scripts)\n- Version-controlled for reproducibility\n\n## Architecture note\nLocal clusters use aarch64-linux (native Apple Silicon). Production Hetzner clusters use x86_64-linux. ClusterAPI bootstrap (k3s-capi) will need to account for this architecture difference when provisioning x86_64 worker nodes.\n\nReference: docs/notes/development/kubernetes/decisions/ADR-004-local-cluster-networking.md","notes":"Implemented in 10a63f0a (stibnite config), dfa6d834 (colima portForwards), e940d997 (incus profiles), 9471e78a (k3s-local cloud-init)","status":"closed","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-18T14:51:26.42692-05:00","created_by":"Cameron Smith","updated_at":"2026-01-18T15:05:08.09255-05:00","closed_at":"2026-01-18T15:05:02.251818-05:00","close_reason":"Closed","dependencies":[{"issue_id":"nix-50f.17","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-18T14:51:26.430192-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.17","depends_on_id":"nix-50f.1","type":"depends-on","created_at":"2026-01-18T14:51:46.35108-05:00","created_by":"Cameron Smith"}],"comments":[{"id":10,"issue_id":"nix-50f.17","author":"Cameron Smith","text":"Implementation complete with additional discoveries:\n\nCommits:\n- 9471e78a feat(images): add cloud-init support to k3s-local.nix\n- e940d997 feat(incus): parameterize k3s profiles with cloud-init config\n- dfa6d834 feat(colima): add port forwarding option with Lima provision scripts\n- 10a63f0a feat(stibnite): configure k3s-dev port forwards and incus profile\n- a98e7709 feat(colima): add nestedVirtualization option for incus VMs\n- 5e2ae065 feat(stibnite): enable nestedVirtualization for incus VMs\n- 339ff3d2 fix(incus): use 0.0.0.0/0 instead of default for cloud-init route\n\nDiscoveries during implementation:\n1. Nested virtualization (KVM) required for incus VMs - needs M3/M4 + macOS 15+\n2. cloud-init v25.2 bug: \"to: default\" not supported, use \"to: 0.0.0.0/0\" instead\n3. incus profile activation timing: Colima must be running before home-manager switch\n4. Interface name for incus VMs with virtio: enp5s0\n\nVerified working:\n- Static IP: 192.100.0.10\n- Hostname: k3s-dev  \n- Port forwards: 6443 (API), 8080 (HTTP), 8443 (HTTPS), 2210 (SSH)\n- kubectl access from macOS\n- k3s node status: NotReady (pending Cilium CNI - nix-50f.5)","created_at":"2026-01-19T02:21:33Z"}]}
{"id":"nix-50f.2","title":"Shared k3s server NixOS module","description":"Create a NixOS configuration module that composes the nixpkgs `services.k3s` module with system-level settings for both local development and Hetzner production. This is a configuration wrapper, not a replacement for the nixpkgs k3s module.\n\nThe module configures:\n- `services.k3s.*`: disable bundled components (flannel, traefik, servicelb, local-storage, metrics-server), clustering, graceful shutdown\n- `boot.kernelModules`: br_netfilter, nf_conntrack, overlay, ip_tables, ip6_tables\n- `boot.kernel.sysctl`: IPv4/IPv6 forwarding, bridge netfilter, Cilium-specific settings\n- `networking.firewall`: k3s API (6443), kubelet (10250), VXLAN overlay\n- `virtualisation.containerd.settings`: systemd cgroups, CNI bin_dir\n- `environment.systemPackages`: kubectl, cilium-cli, helm\n\nFiles to create:\n- modules/nixos/k3s-server/default.nix (composes sub-modules)\n- modules/nixos/k3s-server/kernel.nix (kernelModules + sysctl)\n- modules/nixos/k3s-server/networking.nix (firewall + containerd + CNI)\n- modules/nixos/k3s-server/packages.nix (kubectl, helm, cilium-cli)\n\nReference: docs/notes/development/kubernetes/components/nixos-k3s-server.md","status":"closed","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:50.531457-05:00","created_by":"Cameron Smith","updated_at":"2026-01-16T23:18:51.810662-05:00","closed_at":"2026-01-16T23:18:51.810662-05:00","close_reason":"Completed: k3s-server module with kernel, networking, packages, and main default.nix","dependencies":[{"issue_id":"nix-50f.2","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:50.532011-05:00","created_by":"Cameron Smith"}],"comments":[{"id":1,"issue_id":"nix-50f.2","author":"Cameron Smith","text":"Checkpoint: 2026-01-16 session\n\nDone:\n- Session orientation and context priming complete\n- Identified prerequisites: nixos-generators input (nix-10i) and Colima imagePath (nix-1hy)\n- Created and wired prerequisite issues\n- Completed nix-10i (nixos-generators input added in 6ed635a6)\n\nContext gathered (exploration agents):\n- modules/nixos/ has only nvidia.nix and app.nix — k3s-server/ needs creation\n- Reference patterns from hetzkube and sini-dendritic documented\n- Colima module exists at modules/darwin/colima.nix but lacks --image-path support\n- rosetta-builder is available for x86_64-linux builds\n\nRemaining:\n- Create modules/nixos/k3s-server/default.nix with kernel modules, sysctl, k3s config\n- Optionally create modules/nixos/k3s-server/containerd.nix (may not be needed if using k3s-bundled containerd)\n- Expose via flakeModules pattern\n\nKey references:\n- docs/notes/development/kubernetes/components/nixos-k3s-server.md (complete spec)\n- ~/projects/sciops-workspace/hetzkube/nixos/kubernetes.nix (ClusterAPI patterns)\n- ~/projects/nix-workspace/sini-dendritic-k8s-nix-config/ (dendritic module org)\n\nSuggested next steps:\n- Read docs/notes/development/kubernetes/components/nixos-k3s-server.md for spec\n- Create modules/nixos/k3s-server/default.nix following hetzkube/sini patterns\n- Test with nix eval before completing","created_at":"2026-01-17T03:14:59Z"},{"id":2,"issue_id":"nix-50f.2","author":"Cameron Smith","text":"Session checkpoint: 2026-01-16\n\nCompleted:\n- Updated spec with easykubenix integration docs (CIDR alignment, two-layer architecture, etcd CoW)\n- Created modules/nixos/k3s-server/ with four files:\n  - kernel.nix: 8 kernel modules + sysctl settings for Kubernetes networking\n  - networking.nix: firewall rules, containerd config, CNI plugin installation\n  - packages.nix: kubectl, k9s, cilium-cli, kubernetes-helm\n  - default.nix: options + services.k3s configuration + sub-module composition\n- All sub-modules wrapped in lib.mkIf config.k3s-server.enable\n- Verified with nix eval: enable=true → 8 modules, enable=false → 0 modules\n- Exposed via flake.modules.nixos.k3s-server for import-tree discovery\n\nKey design decisions:\n- Uses nixpkgs services.k3s (not custom) with configuration wrapper\n- Environment-based clustering via options (clusterCidr, serviceCidr)\n- CNI bin_dir = /opt/cni/bin (easykubenix/Cilium alignment)\n- Disables: flannel, kube-proxy, network-policy, cloud-controller for Cilium\n\nNext: nix-50f.1 (NixOS VM image) can proceed - it imports k3s-server module","created_at":"2026-01-17T04:00:29Z"}]}
{"id":"nix-50f.3","title":"incus k3s-dev profile configuration","description":"Configure incus k3s-dev profile for local development: 4 CPU, 8 GiB RAM, 60 GiB disk. Profile uses custom NixOS VM image from nix-50f.1.\n\nincus runs inside Colima VM (colima start --runtime incus). Profile configures the nested k3s-dev VM.\n\nFiles to create:\n- modules/home/development/incus.nix (home-manager incus profile configuration)\n- YAML profile for k3s-dev VM (version-controlled)\n\nConfiguration: bridged networking, resource limits, SSH access\n\nReference: docs/notes/development/kubernetes/workflows/01-environment-setup.md","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:51.218434-05:00","created_by":"Cameron Smith","updated_at":"2026-01-18T00:55:54.441767-05:00","closed_at":"2026-01-18T00:55:54.441767-05:00","close_reason":"Implemented incus profile module (df0c1f82). Profile: security.secureboot=false, 4 CPU, 8GB RAM, bridged to incusbr0. Applied via home-manager activation.","dependencies":[{"issue_id":"nix-50f.3","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:51.219001-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.3","depends_on_id":"nix-50f.1","type":"blocks","created_at":"2026-01-15T20:37:55.927176-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.3","depends_on_id":"nix-1hy","type":"blocks","created_at":"2026-01-16T22:09:57.314031-05:00","created_by":"Cameron Smith"}],"comments":[{"id":5,"issue_id":"nix-50f.3","author":"Cameron Smith","text":"Rescoped from Colima to incus. Discovery: Colima --disk-image flag validates SHA-512 hashes against official images only, rejecting custom NixOS images. incus accepts custom qcow2 images via 'incus image import'. Foundation path: nix-50f.1 (aarch64 image) → incus image import → incus launch → cluster exists.","created_at":"2026-01-18T02:25:23Z"}]}
{"id":"nix-50f.4","title":"incus k3s-capi profile configuration","description":"Configure Colima k3s-capi profile for ClusterAPI bootstrap: 6 CPU, 12 GiB RAM, 80 GiB disk. Ephemeral profile used only during cluster provisioning, destroyed after pivot.\n\nFiles to modify:\n- modules/darwin/colima.nix (add k3s-capi profile)\n\nReference: docs/notes/development/kubernetes/workflows/01-environment-setup.md, docs/notes/development/kubernetes/workflows/03-clusterapi-bootstrap.md","status":"open","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:52.280495-05:00","created_by":"Cameron Smith","updated_at":"2026-01-17T21:25:36.654452-05:00","dependencies":[{"issue_id":"nix-50f.4","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:52.28107-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.4","depends_on_id":"nix-50f.1","type":"blocks","created_at":"2026-01-15T20:37:56.524-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.4","depends_on_id":"nix-50f.17","type":"depends-on","created_at":"2026-01-18T14:51:50.198004-05:00","created_by":"Cameron Smith"}],"comments":[{"id":6,"issue_id":"nix-50f.4","author":"Cameron Smith","text":"Rescoped from Colima to incus. Same rationale as nix-50f.3: Colima cannot use custom VM images. This profile will configure incus for the ClusterAPI management cluster.","created_at":"2026-01-18T02:25:43Z"}]}
{"id":"nix-50f.5","title":"Cilium CNI easykubenix module","description":"Create Cilium CNI module for easykubenix/kubenix. Configure: kubeProxyReplacement=true, routingMode=tunnel, tunnelProtocol=geneve, IPAM mode kubernetes. Local: k8sServiceHost=127.0.0.1, Hubble disabled. Production: k8sServiceHost=control-plane-VIP, full Hubble.\n\nFiles to create:\n- modules/k8s/cilium/default.nix (Helm values + API mappings)\n- modules/k8s/cilium/network-policies.nix (default policies)\n\nReference: docs/notes/development/kubernetes/components/cilium-cni.md","status":"closed","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:53.504204-05:00","created_by":"Cameron Smith","updated_at":"2026-01-18T21:45:53.29663-05:00","closed_at":"2026-01-18T21:45:53.29663-05:00","close_reason":"Implemented in d4f78034. Cilium deployed to k3s-dev, node transitioned NotReady→Ready. Module pattern: kubernetes/modules/cilium/, bridge: modules/kubernetes.nix, output: nix build .#k8s-manifests-local","dependencies":[{"issue_id":"nix-50f.5","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:53.504777-05:00","created_by":"Cameron Smith"}],"comments":[{"id":11,"issue_id":"nix-50f.5","author":"Cameron Smith","text":"Context from nix-50f.17 implementation:\n\nk3s-dev cluster is running and accessible:\n- kubeconfig at /tmp/k3s-dev-kubeconfig.yaml (or extract via incus exec k3s-dev -- cat /etc/rancher/k3s/k3s.yaml)\n- Node status: NotReady (waiting for CNI)\n- kubectl verified working from macOS via port forward\n\nOnce Cilium is deployed, node should transition to Ready.","created_at":"2026-01-19T02:21:40Z"}]}
{"id":"nix-50f.6","title":"step-ca local ACME server module","description":"Create step-ca module for local TLS development. Provides ACME endpoint for cert-manager identical workflow to production Let's Encrypt. Helm chart deployment with badger DB, 1Gi PVC storage.\n\nFiles to create:\n- modules/k8s/step-ca/default.nix (Helm values)\n- modules/k8s/step-ca/root-ca.nix (CA certificate distribution)\n\nReference: docs/notes/development/kubernetes/components/step-ca-tls.md","status":"closed","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:54.221797-05:00","created_by":"Cameron Smith","updated_at":"2026-01-18T22:20:04.321375-05:00","closed_at":"2026-01-18T22:20:04.321375-05:00","close_reason":"Implementation complete. Module, PKI, sops secrets all working. Verification blocked by nix-2hd (Cilium pod networking issue). Manifests build successfully, step-ca pod created but pending due to upstream networking.","dependencies":[{"issue_id":"nix-50f.6","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:54.222356-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.6","depends_on_id":"nix-50f.5","type":"blocks","created_at":"2026-01-15T20:37:57.369849-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-50f.7","title":"cert-manager easykubenix module","description":"Create cert-manager module for automated TLS certificate lifecycle. Configure CRDs, API mappings (Certificate, ClusterIssuer, etc.). Local: ClusterIssuer for step-ca with HTTP01 solver, sslip.io DNS. Production: Let's Encrypt with DNS01 solver via Cloudflare.\n\nFiles to create:\n- modules/k8s/cert-manager/default.nix (Helm values + CRDs)\n- modules/k8s/cert-manager/issuers.nix (ClusterIssuer definitions)\n\nReference: docs/notes/development/kubernetes/components/cert-manager.md","status":"open","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:55.719245-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:36:55.719245-05:00","dependencies":[{"issue_id":"nix-50f.7","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:55.719985-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.7","depends_on_id":"nix-50f.5","type":"blocks","created_at":"2026-01-15T20:37:58.017296-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.7","depends_on_id":"nix-50f.6","type":"blocks","created_at":"2026-01-15T20:37:58.679044-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-50f.8","title":"sops-secrets-operator module","description":"Create sops-secrets-operator module for Kubernetes-native secret management using age encryption. Configure RBAC, age key mounting, SopsSecret CRD support. Aligned with existing sops-nix patterns for hosts.\n\nFiles to create:\n- modules/k8s/sops-secrets-operator/default.nix (operator deployment)\n- k8s/secrets/.sops.yaml (encryption rules with dev/ci age keys)\n\nReference: docs/notes/development/kubernetes/components/sops-secrets-operator.md","status":"open","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:56.501177-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:36:56.501177-05:00","dependencies":[{"issue_id":"nix-50f.8","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:56.501738-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.8","depends_on_id":"nix-50f.5","type":"blocks","created_at":"2026-01-15T20:37:59.511382-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-50f.9","title":"local-path-provisioner storage module","description":"Create local-path-provisioner module for default storage class in local and production clusters. Provides hostPath-based PVs for single-node and simple multi-node scenarios.\n\nFiles to create:\n- modules/k8s/local-path-provisioner/default.nix\n\nReference: docs/notes/development/kubernetes/architecture/reference-architecture.md","status":"open","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:57.156638-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:36:57.156638-05:00","dependencies":[{"issue_id":"nix-50f.9","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-15T20:36:57.157204-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-50f.9","depends_on_id":"nix-50f.5","type":"blocks","created_at":"2026-01-15T20:38:00.22332-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-5i8","title":"test-explicit-repo","description":"testing with explicit repo","status":"closed","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-17T11:03:12.820344-05:00","created_by":"Cameron Smith","updated_at":"2026-01-17T11:12:49.366332-05:00","closed_at":"2026-01-17T11:12:49.366332-05:00","close_reason":"Test issue created during debugging, removing"}
{"id":"nix-di5","title":"Documentation update for k3d architecture","description":"Update all kubernetes documentation to reflect k3d + ctlptl as primary local development approach.\n\n## Scope\nBased on comprehensive inventory (2026-01-19), the following documents require updates:\n\n### ADRs (5 files)\n- ADR-001: Add revision note linking to ADR-005\n- ADR-002: Add context about k3d superseding VM approach\n- ADR-003: Review for module organization implications\n- ADR-004: Revise networking section for Docker bridge (vs socat chain)\n- ADR-005: DONE - Updated to recommend k3d (this session)\n\n### Workflows (5 files)\n- 01-environment-setup.md: Add k3d/ctlptl installation, update Colima references\n- 02-local-development.md: Create 02b-local-development-k3d.md alternative\n- 03-clusterapi-bootstrap.md: Review k3s-capi profile references\n- 04-hetzner-deployment.md: Minimal changes (production path)\n- 05-gitops-operations.md: Review cluster-specific networking\n\n### Reference Architecture (1 file)\n- reference-architecture.md: Update diagram, parity statements, command table\n\n### Components (8 files)\n- cilium-cni.md: Update local development tuning for k3d\n- Others: Review for Colima/Incus specific references\n\n### Index (1 file)\n- README.md: Update quick start commands, architecture overview\n\n### CLAUDE.md (2 files)\n- Project CLAUDE.md: Update architecture documentation section\n- Symlink source: /Users/crs58/projects/sciexp/planning/contexts/vanixiets.md\n\n## Approach\n1. Update critical path first: CLAUDE.md, README.md, reference-architecture.md\n2. Create new k3d workflow document\n3. Add revision notes to superseded ADRs\n4. Update component docs as needed\n5. Archive Colima/Incus patterns in appendix\n\n## Acceptance Criteria\n- All Colima/Incus hardcoded references updated or annotated\n- k3d + ctlptl documented as primary approach\n- Decision trail clear from ADR-005 through documentation\n- CLAUDE.md accurately reflects current architecture\n\n## References\n- ADR-005: docs/notes/development/kubernetes/decisions/ADR-005-local-cluster-architecture-revision.md\n- nix-tv8: k3d + ctlptl implementation\n- nix-2hd: Cilium investigation (motivation)","status":"open","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T12:34:19.959165-05:00","created_by":"Cameron Smith","updated_at":"2026-01-19T12:34:19.959165-05:00","dependencies":[{"issue_id":"nix-di5","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-19T12:34:27.113584-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-di5","depends_on_id":"nix-tv8","type":"depends-on","created_at":"2026-01-19T12:34:27.295687-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-l2a","title":"Hetzner Kubernetes Control Plane","description":"Prepare a Hetzner VM to serve as the k3s control plane node for ClusterAPI-managed cluster. Includes terranix configuration, NixOS k3s server module, clan integration for secrets and multi-machine management, and ClusterAPI prerequisites for self-management after pivot. Reference: modules/machines/nixos/cinnabar/, modules/terranix/hetzner.nix, docs/notes/development/kubernetes/workflows/03-clusterapi-bootstrap.md, docs/notes/development/kubernetes/workflows/04-hetzner-deployment.md","status":"open","priority":1,"issue_type":"epic","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:36:04.507054-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:36:04.507054-05:00"}
{"id":"nix-l2a.1","title":"terranix configuration for kube-control VM","description":"Create terranix configuration for Hetzner kube-control VM. Define cpx31 server (4 vCPU, 8GB), fsn1 location, Debian-12 base image, enable flag pattern for conditional provisioning.\n\nFiles to create/modify:\n- modules/terranix/hetzner.nix (add kube-control machine definition)\n- modules/terranix/variables.nix (terranix input variables)\n\nPattern reference: modules/terranix/hetzner.nix (existing cinnabar config)\nReference: docs/notes/development/kubernetes/workflows/04-hetzner-deployment.md","status":"open","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:37:28.572649-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:37:28.572649-05:00","dependencies":[{"issue_id":"nix-l2a.1","depends_on_id":"nix-l2a","type":"parent-child","created_at":"2026-01-15T20:37:28.573351-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-l2a.10","title":"nixidy production cluster integration","description":"Configure nixidy for Hetzner production cluster. Adapt local nixidy configuration for production environment (Let's Encrypt TLS, Cloudflare DNS, production secrets). Document optimal ClusterAPI transfer point - likely between Phase 3b (ArgoCD install) and Phase 4 (nixidy applications).","status":"open","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-17T11:04:52.358661-05:00","created_by":"Cameron Smith","updated_at":"2026-01-17T11:04:52.358661-05:00","dependencies":[{"issue_id":"nix-l2a.10","depends_on_id":"nix-l2a","type":"parent-child","created_at":"2026-01-17T11:04:52.360209-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-l2a.2","title":"NixOS machine module for kube-control","description":"Create NixOS machine configuration for kube-control following cinnabar pattern. Import srvos modules (hardware-hetzner-cloud, server), k3s-server module, configure networking and firewall rules.\n\nFiles to create:\n- modules/machines/nixos/kube-control/default.nix\n\nImports: srvos hardware-hetzner-cloud, srvos server, k3s-server module\nFirewall: TCP 6443, 10250, 2379-2380, 4240-4244; UDP 8472, 4789\n\nPattern reference: modules/machines/nixos/cinnabar/\nReference: docs/notes/development/kubernetes/workflows/04-hetzner-deployment.md","status":"open","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:37:29.388839-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:37:29.388839-05:00","dependencies":[{"issue_id":"nix-l2a.2","depends_on_id":"nix-l2a","type":"parent-child","created_at":"2026-01-15T20:37:29.389607-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.2","depends_on_id":"nix-l2a.1","type":"blocks","created_at":"2026-01-15T20:38:16.394774-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.2","depends_on_id":"nix-50f.2","type":"blocks","created_at":"2026-01-15T20:38:17.185052-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-l2a.3","title":"disko storage configuration for kube-control","description":"Create disko configuration for kube-control with appropriate storage layout. Configure partitions for /boot, root, and k3s data persistence (/var/lib/rancher/k3s, /var/lib/kubelet, /etc/rancher/k3s).\n\nFiles to create:\n- modules/machines/nixos/kube-control/disko.nix\n\nReference: modules/machines/nixos/cinnabar/ (existing disko pattern)","status":"open","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:37:30.271648-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:37:30.271648-05:00","dependencies":[{"issue_id":"nix-l2a.3","depends_on_id":"nix-l2a","type":"parent-child","created_at":"2026-01-15T20:37:30.272251-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.3","depends_on_id":"nix-l2a.1","type":"blocks","created_at":"2026-01-15T20:38:17.776615-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-l2a.4","title":"clan secrets integration for kube-control","description":"Configure clan secrets for kube-control machine. Setup sops-nix integration for k3s-token, age keys, and other sensitive configuration. Ensure secrets available during NixOS installation and updates.\n\nFiles to create/modify:\n- modules/machines/nixos/kube-control/secrets.nix\n- sops/secrets/kube-control/ directory\n\nReference: modules/machines/nixos/cinnabar/ (existing secrets pattern)","status":"open","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:37:31.001947-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:37:31.001947-05:00","dependencies":[{"issue_id":"nix-l2a.4","depends_on_id":"nix-l2a","type":"parent-child","created_at":"2026-01-15T20:37:31.002548-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.4","depends_on_id":"nix-l2a.2","type":"blocks","created_at":"2026-01-15T20:38:18.500061-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-l2a.5","title":"k3s server production configuration","description":"Configure k3s server for production Hetzner deployment. Settings: multi-node capable (etcd for HA later), external apiserver endpoint, TLS SANs for public IP and DNS name, token management via sops-nix.\n\nFiles to modify:\n- modules/nixos/k3s-server/default.nix (production options)\n- modules/machines/nixos/kube-control/default.nix (production overrides)\n\nReference: docs/notes/development/kubernetes/components/nixos-k3s-server.md","status":"open","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:37:31.866919-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:37:31.866919-05:00","dependencies":[{"issue_id":"nix-l2a.5","depends_on_id":"nix-l2a","type":"parent-child","created_at":"2026-01-15T20:37:31.867495-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.5","depends_on_id":"nix-50f.2","type":"blocks","created_at":"2026-01-15T20:38:19.143898-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-l2a.6","title":"ClusterAPI prerequisites for self-management","description":"Prepare kube-control for ClusterAPI self-management after pivot. Ensure clusterctl, kubectl available, configure RBAC for ClusterAPI controllers, document pivot procedure from k3s-capi bootstrap cluster.\n\nFiles to create:\n- modules/k8s/cluster-api/default.nix (ClusterAPI controller config)\n- modules/k8s/cluster-api/hetzner-provider.nix (CAPH configuration)\n\nReference: docs/notes/development/kubernetes/workflows/03-clusterapi-bootstrap.md","status":"open","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:37:32.536283-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:37:32.536283-05:00","dependencies":[{"issue_id":"nix-l2a.6","depends_on_id":"nix-l2a","type":"parent-child","created_at":"2026-01-15T20:37:32.536853-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.6","depends_on_id":"nix-l2a.5","type":"blocks","created_at":"2026-01-15T20:38:20.37781-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-l2a.7","title":"easykubenix stage configuration (full/production)","description":"Create full/production stage configuration for easykubenix with production-specific settings. Cilium with full Hubble, Let's Encrypt ClusterIssuer, external-dns Cloudflare integration, CI age key for sops.\n\nFiles to create:\n- clusters/full/default.nix (production stage entry point)\n- flake.nix additions for k8s-manifests-full output\n\nReference: docs/notes/development/kubernetes/workflows/04-hetzner-deployment.md","status":"open","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:37:33.611982-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:37:33.611982-05:00","dependencies":[{"issue_id":"nix-l2a.7","depends_on_id":"nix-l2a","type":"parent-child","created_at":"2026-01-15T20:37:33.61257-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.7","depends_on_id":"nix-50f.5","type":"blocks","created_at":"2026-01-15T20:38:21.152924-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.7","depends_on_id":"nix-50f.7","type":"blocks","created_at":"2026-01-15T20:38:21.77111-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.7","depends_on_id":"nix-50f.8","type":"blocks","created_at":"2026-01-15T20:38:22.475642-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.7","depends_on_id":"nix-l2a.8","type":"blocks","created_at":"2026-01-15T20:38:23.077198-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-l2a.8","title":"external-dns Cloudflare module","description":"Create external-dns module for automatic DNS record management via Cloudflare. Configure Cloudflare API token from sops-secrets-operator, zone filtering, record sync policies.\n\nFiles to create:\n- modules/k8s/external-dns/default.nix\n\nReference: docs/notes/development/kubernetes/workflows/04-hetzner-deployment.md","status":"open","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:37:34.644089-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:37:34.644089-05:00","dependencies":[{"issue_id":"nix-l2a.8","depends_on_id":"nix-l2a","type":"parent-child","created_at":"2026-01-15T20:37:34.644657-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.8","depends_on_id":"nix-50f.8","type":"blocks","created_at":"2026-01-15T20:38:28.461068-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-l2a.9","title":"Hetzner cluster deployment verification","description":"Verify Hetzner control plane deployment matches architecture. Test four-phase deployment: terranix → clan → easykubenix → verification. Validate k3s API, Cilium CNI, cert-manager with Let's Encrypt, sops secret decryption.\n\nVerification checklist:\n- tofu apply (VM provisioned)\n- clan machines install (NixOS deployed)\n- kluctl deploy (infrastructure deployed)\n- kubectl get nodes (Ready state)\n- kubectl get pods -A (all Running)\n- kubectl get certificates (Let's Encrypt certs)\n\nReference: docs/notes/development/kubernetes/workflows/04-hetzner-deployment.md","status":"open","priority":2,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-15T20:37:36.062705-05:00","created_by":"Cameron Smith","updated_at":"2026-01-15T20:37:36.062705-05:00","dependencies":[{"issue_id":"nix-l2a.9","depends_on_id":"nix-l2a","type":"parent-child","created_at":"2026-01-15T20:37:36.063239-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.9","depends_on_id":"nix-l2a.7","type":"blocks","created_at":"2026-01-15T20:38:30.134982-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-l2a.9","depends_on_id":"nix-l2a.4","type":"blocks","created_at":"2026-01-15T20:38:30.842215-05:00","created_by":"Cameron Smith"}]}
{"id":"nix-tv8","title":"k3d + ctlptl local cluster integration","description":"Implement k3d cluster with ctlptl for local development, replacing current Incus VM approach.\n\n## Rationale\nADR-005 analysis determined that Cilium eBPF is fundamentally broken in Incus/Colima nested virtualization on ARM64. The k3d + ctlptl approach:\n- Avoids nested virtualization entirely (containers, not VMs)\n- Uses k3s distribution (matches Hetzner production)\n- Restores functional Cilium networking (limited eBPF, but functional)\n- Leverages OrbStack performance (user's Docker override)\n\n## k3d Advantages over kind\n- Production parity: k3d uses k3s (same as Hetzner production)\n- 80% faster startup than kind\n- Lower memory footprint (423-502 MiB vs kind's higher usage)\n- Native ARM64 support without emulation\n\n## Implementation\n1. Add k3d and ctlptl to dev shell (modules/dev-shell.nix)\n2. Create k3d cluster configuration:\n   - K3D_FIX_MOUNTS=1 for Cilium BPF mount propagation\n   - --flannel-backend=none for custom CNI\n   - --disable-network-policy, --disable-kube-proxy for Cilium\n   - --disable=traefik, --disable=servicelb\n   - Port mappings for API, ingress, services\n3. Integrate ctlptl YAML configuration (following Kargo patterns)\n4. Deploy Cilium via existing easykubenix modules\n5. Update workflow docs (02b-local-development-k3d.md)\n\n## Acceptance Criteria\n- k3d cluster starts successfully on aarch64-darwin via OrbStack\n- Cilium deploys and pods reach cilium_host (resolves nix-2hd)\n- easykubenix manifests deploy via kluctl\n- kubectl access works from macOS\n- Multi-node cluster option documented\n\n## References\n- ADR-005: docs/notes/development/kubernetes/decisions/ADR-005-local-cluster-architecture-revision.md\n- Kargo patterns: ~/projects/sciops-workspace/kargo/hack/k3d/\n- nix-2hd: Cilium investigation (motivation)\n- nix-50f: Local Development Cluster epic","status":"open","priority":1,"issue_type":"task","owner":"cameron.ray.smith@gmail.com","created_at":"2026-01-19T01:54:06.708705-05:00","created_by":"Cameron Smith","updated_at":"2026-01-19T12:32:12.104182-05:00","dependencies":[{"issue_id":"nix-tv8","depends_on_id":"nix-50f","type":"parent-child","created_at":"2026-01-19T01:54:16.158121-05:00","created_by":"Cameron Smith"},{"issue_id":"nix-tv8","depends_on_id":"nix-2hd","type":"discovered-from","created_at":"2026-01-19T01:54:16.348315-05:00","created_by":"Cameron Smith"}]}
